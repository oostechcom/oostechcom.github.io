<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-4.18.0-80.el8_v4l2-framework | oosTech.com</title>
  <meta name="description" content="Chinese translated version of Documentation&#x2F;media&#x2F;media_kapi.rst If you have any comment or update to the content, please contact theoriginal document maintainer directly.  However, if you have a prob">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-4.18.0-80.el8_v4l2-framework">
<meta property="og:url" content="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_v4l2-framework/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="Chinese translated version of Documentation&#x2F;media&#x2F;media_kapi.rst If you have any comment or update to the content, please contact theoriginal document maintainer directly.  However, if you have a prob">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:modified_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_v4l2-framework/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_mpc5200/" class="title">Kernel-3.10.0-957.el7_mpc5200</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_6pack/" class="title">Kernel-3.10.0-957.el7_6pack</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#a%C2%BB%C2%A5a%C2%B8%C2%8Ba%C2%B8%C2%BAae%C2%AD%C2%A3ae%C2%96%C2%87"><span class="toc-number">1.</span> <span class="toc-text">ä»¥ä¸ä¸ºæ­£æ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#V4L2-e%C2%A9%C2%B1a%C2%8A%C2%A8ae%C2%A1%C2%86ae%C2%9E%C2%B6ae%C2%A6%C2%82e%C2%A7%C2%88"><span class="toc-number"></span> <span class="toc-text">V4L2 é©±å¨æ¡æ¶æ¦è§</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#a%C2%BB%C2%8Bc%C2%BB%C2%8D"><span class="toc-number">1.</span> <span class="toc-text">ä»ç»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#e%C2%A9%C2%B1a%C2%8A%C2%A8c%C2%BB%C2%93ae%C2%9E%C2%84"><span class="toc-number">2.</span> <span class="toc-text">é©±å¨ç»æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ae%C2%A1%C2%86ae%C2%9E%C2%B6c%C2%BB%C2%93ae%C2%9E%C2%84"><span class="toc-number">3.</span> <span class="toc-text">æ¡æ¶ç»æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#v4l2-device-c%C2%BB%C2%93ae%C2%9E%C2%84a%C2%BD%C2%93"><span class="toc-number">4.</span> <span class="toc-text">v4l2_device ç»æä½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#v4l2-subdevc%C2%BB%C2%93ae%C2%9E%C2%84a%C2%BD%C2%93"><span class="toc-number">5.</span> <span class="toc-text">v4l2_subdevç»æä½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V4L2-a%C2%AD%C2%90e%C2%AE%C2%BEa%C2%A4%C2%87c%C2%94%C2%A8ae%C2%88%C2%B7c%C2%A9%C2%BAe%C2%97%C2%B4API"><span class="toc-number">6.</span> <span class="toc-text">V4L2 å­è®¾å¤ç¨æ·ç©ºé´API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I2C-a%C2%AD%C2%90e%C2%AE%C2%BEa%C2%A4%C2%87e%C2%A9%C2%B1a%C2%8A%C2%A8"><span class="toc-number">7.</span> <span class="toc-text">I2C å­è®¾å¤é©±å¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#video-devicec%C2%BB%C2%93ae%C2%9E%C2%84a%C2%BD%C2%93"><span class="toc-number">8.</span> <span class="toc-text">video_deviceç»æä½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#v4l2-file-operations-a%C2%B8%C2%8Ee%C2%94%C2%81"><span class="toc-number">9.</span> <span class="toc-text">v4l2_file_operations ä¸é</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#video-deviceae%C2%B3%C2%A8a%C2%86OE"><span class="toc-number">10.</span> <span class="toc-text">video_deviceæ³¨å</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#video-device-ae%C2%B3%C2%A8e%C2%94%C2%80"><span class="toc-number">11.</span> <span class="toc-text">video_device æ³¨é</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#video-device-e%C2%BE%C2%85a%C2%8A%C2%A9a%C2%87%C2%BDae%C2%95%C2%B0"><span class="toc-number">12.</span> <span class="toc-text">video_device è¾å©å½æ°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#e%C2%A7%C2%86e%C2%A2%C2%91c%C2%BC%C2%93a%C2%86%C2%B2e%C2%BE%C2%85a%C2%8A%C2%A9a%C2%87%C2%BDae%C2%95%C2%B0"><span class="toc-number">13.</span> <span class="toc-text">è§é¢ç¼å²è¾å©å½æ°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#v4l2-fh-c%C2%BB%C2%93ae%C2%9E%C2%84a%C2%BD%C2%93"><span class="toc-number">14.</span> <span class="toc-text">v4l2_fh ç»æä½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V4L2-a%C2%BA%C2%8Ba%C2%BB%C2%B6aeoe%C2%BAa%C2%88%C2%B6"><span class="toc-number">15.</span> <span class="toc-text">V4L2 äºä»¶æºå¶</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-4.18.0-80.el8_v4l2-framework" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-4.18.0-80.el8_v4l2-framework
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_v4l2-framework/" class="article-date">
	 published: <time datetime="2021-02-18T16:00:00.000Z" itemprop="datePublished">2021-02-19</time>
	</a>
</span>

        
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_v4l2-framework/" class="article-date">
	   updated: <time datetime="2021-02-18T16:00:00.000Z" itemprop="dateUpdated">2021-02-19</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/02/19/Kernel-4.18.0-80.el8_v4l2-framework/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>Chinese translated version of Documentation/media/media_kapi.rst</p>
<p>If you have any comment or update to the content, please contact the<br>original document maintainer directly.  However, if you have a problem<br>communicating in English you can also ask the Chinese maintainer for<br>help.  Contact the Chinese maintainer if this translation is outdated<br>or if there is a problem with the translation.</p>
<p>Maintainer: Mauro Carvalho Chehab <a href="mailto:&#109;&#x63;&#104;&#x65;&#104;&#97;&#98;&#64;&#x6b;&#x65;&#x72;&#110;&#x65;&#108;&#x2e;&#111;&#114;&#103;">&#109;&#x63;&#104;&#x65;&#104;&#97;&#98;&#64;&#x6b;&#x65;&#x72;&#110;&#x65;&#108;&#x2e;&#111;&#114;&#103;</a><br>Chinese maintainer: Fu Wei <a href="mailto:&#x74;&#101;&#107;&#x6b;&#x61;&#x6d;&#97;&#x6e;&#110;&#105;&#110;&#106;&#97;&#64;&#103;&#109;&#x61;&#x69;&#x6c;&#46;&#x63;&#x6f;&#x6d;">&#x74;&#101;&#107;&#x6b;&#x61;&#x6d;&#97;&#x6e;&#110;&#105;&#110;&#106;&#97;&#64;&#103;&#109;&#x61;&#x69;&#x6c;&#46;&#x63;&#x6f;&#x6d;</a></p>
<hr>
<p>Documentation/media/media_kapi.rst çä¸­æç¿»è¯</p>
<p>å¦ææ³è¯è®ºææ´æ°æ¬æçåå®¹ï¼è¯·ç´æ¥èç³»åææ¡£çç»´æ¤èãå¦æä½ ä½¿ç¨è±æ<br>äº¤æµæå°é¾çè¯ï¼ä¹å¯ä»¥åä¸­æçç»´æ¤èæ±å©ãå¦ææ¬ç¿»è¯æ´æ°ä¸åæ¶æèç¿»<br>è¯å­å¨é®é¢ï¼è¯·èç³»ä¸­æçç»´æ¤èã<br>è±æçç»´æ¤èï¼ Mauro Carvalho Chehab <a href="mailto:&#x6d;&#99;&#x68;&#101;&#104;&#x61;&#98;&#64;&#107;&#101;&#114;&#110;&#101;&#x6c;&#x2e;&#111;&#x72;&#x67;">&#x6d;&#99;&#x68;&#101;&#104;&#x61;&#98;&#64;&#107;&#101;&#114;&#110;&#101;&#x6c;&#x2e;&#111;&#x72;&#x67;</a><br>ä¸­æçç»´æ¤èï¼ åç Fu Wei <a href="mailto:&#x74;&#x65;&#107;&#x6b;&#x61;&#109;&#97;&#x6e;&#110;&#x69;&#110;&#x6a;&#97;&#64;&#103;&#x6d;&#97;&#105;&#108;&#46;&#x63;&#x6f;&#x6d;">&#x74;&#x65;&#107;&#x6b;&#x61;&#109;&#97;&#x6e;&#110;&#x69;&#110;&#x6a;&#97;&#64;&#103;&#x6d;&#97;&#105;&#108;&#46;&#x63;&#x6f;&#x6d;</a><br>ä¸­æçç¿»è¯èï¼ åç Fu Wei <a href="mailto:&#116;&#101;&#x6b;&#x6b;&#x61;&#x6d;&#97;&#110;&#x6e;&#x69;&#110;&#x6a;&#x61;&#64;&#x67;&#x6d;&#97;&#x69;&#108;&#x2e;&#99;&#111;&#109;">&#116;&#101;&#x6b;&#x6b;&#x61;&#x6d;&#97;&#110;&#x6e;&#x69;&#110;&#x6a;&#x61;&#64;&#x67;&#x6d;&#97;&#x69;&#108;&#x2e;&#99;&#111;&#109;</a><br>ä¸­æçæ ¡è¯èï¼ åç Fu Wei <a href="mailto:&#116;&#101;&#x6b;&#107;&#x61;&#x6d;&#97;&#110;&#x6e;&#x69;&#110;&#x6a;&#97;&#x40;&#103;&#109;&#x61;&#x69;&#108;&#x2e;&#99;&#111;&#109;">&#116;&#101;&#x6b;&#107;&#x61;&#x6d;&#97;&#110;&#x6e;&#x69;&#110;&#x6a;&#97;&#x40;&#103;&#109;&#x61;&#x69;&#108;&#x2e;&#99;&#111;&#109;</a></p>
<h2 id="a»¥a¸a¸ºae­£ae"><a href="#a»¥a¸a¸ºae­£ae" class="headerlink" title="ä»¥ä¸ä¸ºæ­£æ"></a>ä»¥ä¸ä¸ºæ­£æ</h2><h1 id="V4L2-e©±a¨ae¡ae¶ae¦e§"><a href="#V4L2-e©±a¨ae¡ae¶ae¦e§" class="headerlink" title="V4L2 é©±å¨æ¡æ¶æ¦è§"></a>V4L2 é©±å¨æ¡æ¶æ¦è§</h1><p>æ¬ææ¡£æè¿° V4L2 æ¡æ¶ææä¾çåç§ç»æåå®ä»¬ä¹é´çå³ç³»ã</p>
<h2 id="a»c»"><a href="#a»c»" class="headerlink" title="ä»ç»"></a>ä»ç»</h2><p>å¤§é¨åç°ä»£ V4L2 è®¾å¤ç±å¤ä¸ª IC ç»æï¼å¨ /dev ä¸å¯¼åºå¤ä¸ªè®¾å¤èç¹ï¼<br>å¹¶åæ¶åå»ºé V4L2 è®¾å¤ï¼å¦ DVBãALSAãFBãI2C åçº¢å¤è¾å¥è®¾å¤ï¼ã<br>ç±äºè¿ç§ç¡¬ä»¶çå¤ææ§ï¼V4L2 é©±å¨ä¹åå¾éå¸¸å¤æã</p>
<p>å°¤å¶æ¯ V4L2 å¿é¡»æ¯æ IC å®ç°é³è§é¢çå¤è·¯å¤ç¨åç¼è§£ç ï¼è¿å°±æ´å¢å äºå¶<br>å¤ææ§ãéå¸¸è¿äº IC éè¿ä¸ä¸ªæå¤ä¸ª I2C æ»çº¿è¿æ¥å°ä¸»æ¡¥é©±å¨å¨ï¼ä½ä¹å¯<br>ä½¿ç¨å¶ä»æ»çº¿ãè¿äºè®¾å¤ç§°ä¸ºâå­è®¾å¤âã</p>
<p>é¿æä»¥æ¥ï¼è¿ä¸ªæ¡æ¶ä»éäºéè¿ video_device ç»æä½åå»º V4L è®¾å¤èç¹ï¼<br>å¹¶ä½¿ç¨ video_buf å¤çè§é¢ç¼å²ï¼æ³¨ï¼æ¬æä¸è®¨è®º video_buf æ¡æ¶ï¼ã</p>
<p>è¿æå³çææé©±å¨å¿é¡»èªå·±è®¾ç½®è®¾å¤å®ä¾å¹¶è¿æ¥å°å­è®¾å¤ãå¶ä¸­ä¸é¨åè¦æ­£ç¡®å°<br>å®ææ¯æ¯è¾å¤æçï¼ä½¿å¾è®¸å¤é©±å¨é½æ²¡ææ­£ç¡®å°å®ç°ã</p>
<p>ç±äºæ¡æ¶çç¼ºå¤±ï¼æå¾å¤éç¨ä»£ç é½ä¸å¯éå¤å©ç¨ã</p>
<p>å æ­¤ï¼è¿ä¸ªæ¡æ¶æå»ºææé©±å¨é½éè¦çåºæ¬ç»æåï¼èç»ä¸çæ¡æ¶å°ä½¿éç¨ä»£ç <br>åå»ºæå®ç¨å½æ°å¹¶å¨ææé©±å¨ä¸­å±äº«åå¾æ´å å®¹æã</p>
<h2 id="e©±a¨c»ae"><a href="#e©±a¨c»ae" class="headerlink" title="é©±å¨ç»æ"></a>é©±å¨ç»æ</h2><p>ææ V4L2 é©±å¨é½æå¦ä¸ç»æï¼</p>
<ol>
<li><p>æ¯ä¸ªè®¾å¤å®ä¾çç»æä½–åå«å¶è®¾å¤ç¶æã</p>
</li>
<li><p>åå§ååæ§å¶å­è®¾å¤çæ¹æ³ï¼å¦ææï¼ã</p>
</li>
<li><p>åå»º V4L2 è®¾å¤èç¹ (/dev/videoXã/dev/vbiX å /dev/radioX)<br>å¹¶è·è¸ªè®¾å¤èç¹çç¹å®æ°æ®ã</p>
</li>
<li><p>ç¹å®æä»¶å¥æç»æä½–åå«æ¯ä¸ªæä»¶å¥æçæ°æ®ã</p>
</li>
<li><p>è§é¢ç¼å²å¤çã</p>
</li>
</ol>
<p>ä»¥ä¸æ¯å®ä»¬çåç¥å³ç³»å¾ï¼</p>
<pre><code>device instancesï¼è®¾å¤å®ä¾ï¼
  |
  +-sub-device instancesï¼å­è®¾å¤å®ä¾ï¼
  |
  \-V4L2 device nodesï¼V4L2 è®¾å¤èç¹ï¼
  |
  \-filehandle instancesï¼æä»¶å¥æå®ä¾ï¼
</code></pre>
<h2 id="ae¡ae¶c»ae"><a href="#ae¡ae¶c»ae" class="headerlink" title="æ¡æ¶ç»æ"></a>æ¡æ¶ç»æ</h2><p>è¯¥æ¡æ¶éå¸¸ç±»ä¼¼é©±å¨ç»æï¼å®æä¸ä¸ª v4l2_device ç»æç¨äºä¿å­è®¾å¤<br>å®ä¾çæ°æ®ï¼ä¸ä¸ª v4l2_subdev ç»æä½ä»£è¡¨å­è®¾å¤å®ä¾ï¼video_device<br>ç»æä½ä¿å­ V4L2 è®¾å¤èç¹çæ°æ®ï¼å°æ¥ v4l2_fh ç»æä½å°è·è¸ªæä»¶å¥æ<br>å®ä¾ï¼ææªå°æªå®ç°ï¼ã</p>
<p>V4L2 æ¡æ¶ä¹å¯ä¸åªä½æ¡æ¶æ´åï¼å¯éçï¼ãå¦æé©±å¨è®¾ç½®äº v4l2_device<br>ç»æä½ç mdev åï¼å­è®¾å¤åè§é¢èç¹çå¥å£å°èªå¨åºç°å¨åªä½æ¡æ¶ä¸­ã</p>
<h2 id="v4l2-device-c»aea½"><a href="#v4l2-device-c»aea½" class="headerlink" title="v4l2_device ç»æä½"></a>v4l2_device ç»æä½</h2><p>æ¯ä¸ªè®¾å¤å®ä¾é½éè¿ v4l2_device (v4l2-device.h)ç»æä½æ¥è¡¨ç¤ºã<br>ç®åè®¾å¤å¯ä»¥ä»åéè¿ä¸ªç»æä½ï¼ä½å¨å¤§å¤æ°æåµä¸ï¼é½ä¼å°è¿ä¸ªç»æä½<br>åµå¥å°ä¸ä¸ªæ´å¤§çç»æä½ä¸­ã</p>
<p>ä½ å¿é¡»æ³¨åè¿ä¸ªè®¾å¤å®ä¾ï¼</p>
<pre><code>v4l2_device_register(struct device *dev, struct v4l2_device *v4l2_dev);
</code></pre>
<p>æ³¨åæä½å°ä¼åå§å v4l2_device ç»æä½ãå¦æ dev-&gt;driver_data å<br>ä¸º NULLï¼å°±å°å¶æå v4l2_devã</p>
<p>éè¦ä¸åªä½æ¡æ¶æ´åçé©±å¨å¿é¡»æå¨è®¾ç½® dev-&gt;driver_dataï¼æååå«<br>v4l2_device ç»æä½å®ä¾çé©±å¨ç¹å®è®¾å¤ç»æä½ãè¿å¯ä»¥å¨æ³¨å V4L2 è®¾å¤<br>å®ä¾åéè¿ dev_set_drvdata() å½æ°å®æãåæ¶å¿é¡»è®¾ç½® v4l2_device<br>ç»æä½ç mdev åï¼æåéå½çåå§åå¹¶æ³¨åè¿ç media_device å®ä¾ã</p>
<p>å¦æ v4l2_dev-&gt;name ä¸ºç©ºï¼åå®å°è¢«è®¾ç½®ä¸ºä» dev ä¸­è¡çåºçå¼ï¼ä¸ºäº<br>æ´å ç²¾ç¡®ï¼å½¢å¼ä¸ºé©±å¨ååè· bus_idï¼ãå¦æä½ å¨è°ç¨ v4l2_device_register<br>åå·²ç»è®¾ç½®å¥½äºï¼åä¸ä¼è¢«ä¿®æ¹ãå¦æ dev ä¸º NULLï¼åä½ <em>å¿é¡»</em>å¨è°ç¨<br>v4l2_device_register åè®¾ç½® v4l2_dev-&gt;nameã</p>
<p>ä½ å¯ä»¥åºäºé©±å¨ååé©±å¨çå¨å± atomic_t ç±»åçå®ä¾ç¼å·ï¼éè¿<br>v4l2_device_set_name() è®¾ç½® nameãè¿æ ·ä¼çæç±»ä¼¼ ivtv0ãivtv1 ç­<br>åå­ãè¥é©±å¨åä»¥æ°å­ç»å°¾ï¼åä¼å¨ç¼å·åé©±å¨åé´æå¥ä¸ä¸ªç ´æå·ï¼å¦ï¼<br>cx18-0ãcx18-1 ç­ãæ­¤å½æ°è¿åå®ä¾ç¼å·ã</p>
<p>ç¬¬ä¸ä¸ª âdevâ åæ°éå¸¸æ¯ä¸ä¸ªæå pci_devãusb_interface æ<br>platform_device çæéãå¾å°ä½¿å¶ä¸º NULLï¼é¤éæ¯ä¸ä¸ªISAè®¾å¤æè<br>å½ä¸ä¸ªè®¾å¤åå»ºäºå¤ä¸ª PCI è®¾å¤ï¼ä½¿å¾ v4l2_dev æ æ³ä¸ä¸ä¸ªç¹å®çç¶è®¾å¤<br>å³èã</p>
<p>ä½ ä¹å¯ä»¥æä¾ä¸ä¸ª notify() åè°ï¼ä½¿å­è®¾å¤å¯ä»¥è°ç¨å®å®ç°äºä»¶éç¥ã<br>ä½è¿ä¸ªè®¾ç½®ä¸å­è®¾å¤ç¸å³ãå­è®¾å¤æ¯æçä»»ä½éç¥å¿é¡»å¨<br>include/media/<subdevice>.h ä¸­å®ä¹ä¸ä¸ªæ¶æ¯å¤´ã</p>
<p>æ³¨é v4l2_device ä½¿ç¨å¦ä¸å½æ°ï¼</p>
<pre><code>v4l2_device_unregister(struct v4l2_device *v4l2_dev);
</code></pre>
<p>å¦æ dev-&gt;driver_data åæå v4l2_devï¼å°ä¼è¢«éç½®ä¸º NULLãæ³¨éåæ¶<br>ä¼èªå¨ä»è®¾å¤ä¸­æ³¨éææå­è®¾å¤ã</p>
<p>å¦æä½ æä¸ä¸ªç­ææè®¾å¤ï¼å¦USBè®¾å¤ï¼ï¼åå½æ­å¼åçæ¶ï¼ç¶è®¾å¤å°æ æã<br>ç±äº v4l2_device æä¸ä¸ªæåç¶è®¾å¤çæéå¿é¡»è¢«æ¸é¤ï¼åæ¶æ å¿ç¶è®¾å¤<br>å·²æ¶å¤±ï¼æä»¥å¿é¡»è°ç¨ä»¥ä¸å½æ°ï¼</p>
<pre><code>v4l2_device_disconnect(struct v4l2_device *v4l2_dev);
</code></pre>
<p>è¿ä¸ªå½æ°å¹¶<em>ä¸</em>æ³¨éå­è®¾å¤ï¼å æ­¤ä½ ä¾ç¶è¦è°ç¨ v4l2_device_unregister()<br>å½æ°ãå¦æä½ çé©±å¨å¨å¹¶éç­ææçï¼å°±æ²¡æå¿è¦è°ç¨ v4l2_device_disconnect()ã</p>
<p>ææ¶ä½ éè¦éåææè¢«ç¹å®é©±å¨æ³¨åçè®¾å¤ãè¿éå¸¸åçå¨å¤ä¸ªè®¾å¤é©±å¨ä½¿ç¨<br>åä¸ä¸ªç¡¬ä»¶çæåµä¸ãå¦ï¼ivtvfb é©±å¨æ¯ä¸ä¸ªä½¿ç¨ ivtv ç¡¬ä»¶çå¸§ç¼å²é©±å¨ï¼<br>åæ¶ alsa é©±å¨ä¹ä½¿ç¨æ­¤ç¡¬ä»¶ã</p>
<p>ä½ å¯ä»¥ä½¿ç¨å¦ä¸ä¾ç¨éåæææ³¨åçè®¾å¤ï¼</p>
<p>static int callback(struct device *dev, void *p)<br>{<br>    struct v4l2_device *v4l2_dev = dev_get_drvdata(dev);</p>
<pre><code>/* æµè¯è¿ä¸ªè®¾å¤æ¯å¦å·²ç»åå§å */
if (v4l2_dev == NULL)
    return 0;
...
return 0;
</code></pre>
<p>}</p>
<p>int iterate(void *p)<br>{<br>    struct device_driver *drv;<br>    int err;</p>
<pre><code>/* å¨PCI æ»çº¿ä¸æ¥æ¾ivtvé©±å¨ã
   pci_bus_typeæ¯å¨å±ç. å¯¹äºUSBæ»çº¿ä½¿ç¨usb_bus_typeã */
drv = driver_find(&quot;ivtv&quot;, &amp;pci_bus_type);
/* éåææçivtvè®¾å¤å®ä¾ */
err = driver_for_each_device(drv, NULL, p, callback);
put_driver(drv);
return err;
</code></pre>
<p>}</p>
<p>ææ¶ä½ éè¦ä¸ä¸ªè®¾å¤å®ä¾çè¿è¡è®¡æ°ãè¿ä¸ªéå¸¸ç¨äºæ å°ä¸ä¸ªè®¾å¤å®ä¾å°ä¸ä¸ª<br>æ¨¡åéæ©æ°ç»çç´¢å¼ã</p>
<p>æ¨èæ¹æ³å¦ä¸ï¼</p>
<p>static atomic_t drv_instance = ATOMIC_INIT(0);</p>
<p>static int drv_probe(struct pci_dev *pdev, const struct pci_device_id *pci_id)<br>{<br>    …<br>    state-&gt;instance = atomic_inc_return(&amp;drv_instance) - 1;<br>}</p>
<p>å¦æä½ æå¤ä¸ªè®¾å¤èç¹ï¼å¯¹äºç­ææè®¾å¤ï¼ç¥éä½æ¶æ³¨é v4l2_device ç»æä½<br>å°±æ¯è¾å°é¾ãä¸ºæ­¤ v4l2_device æå¼ç¨è®¡æ°æ¯æãå½è°ç¨ video_register_device<br>æ¶å¢å å¼ç¨è®¡æ°ï¼èè®¾å¤èç¹éæ¾æ¶åå°å¼ç¨è®¡æ°ãå½å¼ç¨è®¡æ°ä¸ºé¶ï¼å<br>v4l2_device çrelease() åè°å°è¢«æ§è¡ãä½ å°±å¯ä»¥å¨æ­¤æ¶åæåçæ¸çå·¥ä½ã</p>
<p>å¦æåå»ºäºå¶ä»è®¾å¤èç¹ï¼æ¯å¦ ALSAï¼ï¼åä½ å¯ä»¥éè¿ä»¥ä¸å½æ°æå¨å¢å<br>å¼ç¨è®¡æ°ï¼</p>
<p>void v4l2_device_get(struct v4l2_device *v4l2_dev);</p>
<p>æ:</p>
<p>int v4l2_device_put(struct v4l2_device *v4l2_dev);</p>
<p>ç±äºå¼ç¨ææ¯åå§åä¸º 1 ï¼ä½ ä¹éè¦å¨ disconnect() åè°ï¼å¯¹äº USB è®¾å¤ï¼ä¸­<br>è°ç¨ v4l2_device_putï¼æè remove() åè°ï¼ä¾å¦å¯¹äº PCI è®¾å¤ï¼ï¼å¦å<br>å¼ç¨è®¡æ°å°æ°¸è¿ä¸ä¼ä¸º 0 ã</p>
<h2 id="v4l2-subdevc»aea½"><a href="#v4l2-subdevc»aea½" class="headerlink" title="v4l2_subdevç»æä½"></a>v4l2_subdevç»æä½</h2><p>è®¸å¤é©±å¨éè¦ä¸å­è®¾å¤éä¿¡ãè¿äºè®¾å¤å¯ä»¥å®æåç§ä»»å¡ï¼ä½éå¸¸ä»ä»¬è´è´£<br>é³è§é¢å¤ç¨åç¼è§£ç ãå¦ç½ç»æåå¤´çå­è®¾å¤éå¸¸æ¯ä¼ æå¨åæåå¤´æ§å¶å¨ã</p>
<p>è¿äºä¸è¬ä¸º I2C æ¥å£è®¾å¤ï¼ä½å¹¶ä¸ä¸å®é½æ¯ãä¸ºäºç»é©±å¨æä¾è°ç¨å­è®¾å¤ç<br>ç»ä¸æ¥å£ï¼v4l2_subdev ç»æä½ï¼v4l2-subdev.hï¼äº§çäºã</p>
<p>æ¯ä¸ªå­è®¾å¤é©±å¨é½å¿é¡»æä¸ä¸ª v4l2_subdev ç»æä½ãè¿ä¸ªç»æä½å¯ä»¥åç¬<br>ä»£è¡¨ä¸ä¸ªç®åçå­è®¾å¤ï¼ä¹å¯ä»¥åµå¥å°ä¸ä¸ªæ´å¤§çç»æä½ä¸­ï¼ä¸æ´å¤è®¾å¤ç¶æ<br>ä¿¡æ¯ä¿å­å¨ä¸èµ·ãéå¸¸æä¸ä¸ªä¸çº§è®¾å¤ç»æä½ï¼æ¯å¦ï¼i2c_clientï¼åå«äº<br>åæ ¸åå»ºçè®¾å¤æ°æ®ãå»ºè®®ä½¿ç¨ v4l2_set_subdevdata() å°è¿ä¸ªç»æä½ç<br>æéä¿å­å¨ v4l2_subdev çç§ææ°æ®å(dev_priv)ä¸­ãè¿ä½¿å¾éè¿ v4l2_subdev<br>æ¾å°å®éçä½å±æ»çº¿ç¹å®è®¾å¤æ°æ®åå¾å®¹æã</p>
<p>ä½ åæ¶éè¦ä¸ä¸ªä»ä½å±ç»æä½è·å v4l2_subdev æéçæ¹æ³ãå¯¹äºå¸¸ç¨ç<br>i2c_client ç»æä½ï¼i2c_set_clientdata() å½æ°å¯ç¨äºä¿å­ä¸ä¸ª v4l2_subdev<br>æéï¼å¯¹äºå¶ä»æ»çº¿ä½ å¯è½éè¦ä½¿ç¨å¶ä»ç¸å³å½æ°ã</p>
<p>æ¡¥é©±å¨ä¸­ä¹åºä¿å­æ¯ä¸ªå­è®¾å¤çç§ææ°æ®ï¼æ¯å¦ä¸ä¸ªæåç¹å®æ¡¥çåè®¾å¤ç§æ<br>æ°æ®çæéãä¸ºæ­¤ v4l2_subdev ç»æä½æä¾ä¸»æºç§ææ°æ®å(host_priv)ï¼<br>å¹¶å¯éè¿ v4l2_get_subdev_hostdata() å v4l2_set_subdev_hostdata()<br>è®¿é®ã</p>
<p>ä»æ»çº¿æ¡¥é©±å¨çè§è§ï¼é©±å¨å è½½å­è®¾å¤æ¨¡åå¹¶ä»¥æç§æ¹å¼è·å¾ v4l2_subdev<br>ç»æä½æéãå¯¹äº i2c æ»çº¿è®¾å¤ç¸å¯¹ç®åï¼è°ç¨ i2c_get_clientdata()ã<br>å¯¹äºå¶ä»æ»çº¿ä¹éè¦åç±»ä¼¼çæä½ãéå¯¹ I2C æ»çº¿ä¸çå­è®¾å¤è¾å©å½æ°å¸®ä½ <br>å®æäºå¤§é¨åå¤æçå·¥ä½ã</p>
<p>æ¯ä¸ª v4l2_subdev é½åå«å­è®¾å¤é©±å¨éè¦å®ç°çå½æ°æéï¼å¦æå¯¹æ­¤è®¾å¤<br>ä¸éç¨ï¼å¯ä¸ºNULLï¼ãç±äºå­è®¾å¤å¯å®æè®¸å¤ä¸åçå·¥ä½ï¼èå¨ä¸ä¸ªåºå¤§ç<br>å½æ°æéç»æä½ä¸­éå¸¸ä»æå°æ°æç¨çå½æ°å®ç°å¶åè½è¯å®ä¸åéãæä»¥ï¼<br>å½æ°æéæ ¹æ®å¶å®ç°çåè½è¢«åç±»ï¼æ¯ä¸ç±»é½æèªå·±çå½æ°æéç»æä½ã</p>
<p>é¡¶å±å½æ°æéç»æä½åå«äºæååç±»å½æ°æéç»æä½çæéï¼å¦æå­è®¾å¤é©±å¨<br>ä¸æ¯æè¯¥ç±»å½æ°ä¸­çä»»ä½ä¸ä¸ªåè½ï¼åæåè¯¥ç±»ç»æä½çæéä¸ºNULLã</p>
<p>è¿äºç»æä½å®ä¹å¦ä¸ï¼</p>
<p>struct v4l2_subdev_core_ops {<br>    int (*log_status)(struct v4l2_subdev *sd);<br>    int (*init)(struct v4l2_subdev *sd, u32 val);<br>    …<br>};</p>
<p>struct v4l2_subdev_tuner_ops {<br>    …<br>};</p>
<p>struct v4l2_subdev_audio_ops {<br>    …<br>};</p>
<p>struct v4l2_subdev_video_ops {<br>    …<br>};</p>
<p>struct v4l2_subdev_pad_ops {<br>    …<br>};</p>
<p>struct v4l2_subdev_ops {<br>    const struct v4l2_subdev_core_ops  *core;<br>    const struct v4l2_subdev_tuner_ops *tuner;<br>    const struct v4l2_subdev_audio_ops *audio;<br>    const struct v4l2_subdev_video_ops *video;<br>    const struct v4l2_subdev_pad_ops *video;<br>};</p>
<p>å¶ä¸­ coreï¼æ ¸å¿ï¼å½æ°ééå¸¸å¯ç¨äºææå­è®¾å¤ï¼å¶ä»ç±»å«çå®ç°ä¾èµäº<br>å­è®¾å¤ãå¦è§é¢è®¾å¤å¯è½ä¸æ¯æé³é¢æä½å½æ°ï¼åä¹äº¦ç¶ã</p>
<p>è¿æ ·çè®¾ç½®å¨éå¶äºå½æ°æéæ°éçåæ¶ï¼è¿ä½¿å¢å æ°çæä½å½æ°ååç±»<br>åå¾è¾ä¸ºå®¹æã</p>
<p>å­è®¾å¤é©±å¨å¯ä½¿ç¨å¦ä¸å½æ°åå§å v4l2_subdev ç»æä½ï¼</p>
<pre><code>v4l2_subdev_init(sd, &amp;ops);
</code></pre>
<p>ç¶åï¼ä½ å¿é¡»ç¨ä¸ä¸ªå¯ä¸çåå­åå§å subdev-&gt;nameï¼å¹¶åå§åæ¨¡åç<br>owner åãè¥ä½¿ç¨ i2c è¾å©å½æ°ï¼è¿äºé½ä¼å¸®ä½ å¤çå¥½ã</p>
<p>è¥éååªä½æ¡æ¶æ´åï¼ä½ å¿é¡»è°ç¨ media_entity_pads_init() åå§å v4l2_subdev<br>ç»æä½ä¸­ç media_entity ç»æä½ï¼entity åï¼ï¼</p>
<pre><code>struct media_pad *pads = &amp;my_sd-&gt;pads;
int err;

err = media_entity_pads_init(&amp;sd-&gt;entity, npads, pads);
</code></pre>
<p>pads æ°ç»å¿é¡»é¢ååå§åãæ é¡»æå¨è®¾ç½® media_entity ç type å<br>name åï¼ä½å¦æå¿è¦ï¼revision åå¿é¡»åå§åã</p>
<p>å½ï¼ä»»ä½ï¼å­è®¾å¤èç¹è¢«æå¼/å³é­ï¼å¯¹ entity çå¼ç¨å°è¢«èªå¨è·å/éæ¾ã</p>
<p>å¨å­è®¾å¤è¢«æ³¨éä¹åï¼ä¸è¦å¿è®°æ¸ç media_entity ç»æä½ï¼</p>
<pre><code>media_entity_cleanup(&amp;sd-&gt;entity);
</code></pre>
<p>å¦æå­è®¾å¤é©±å¨è¶åäºå¤çè§é¢å¹¶æ´åè¿äºåªä½æ¡æ¶ï¼å¿é¡»ä½¿ç¨ v4l2_subdev_pad_ops<br>æ¿ä»£ v4l2_subdev_video_ops å®ç°æ ¼å¼ç¸å³çåè½ã</p>
<p>è¿ç§æåµä¸ï¼å­è®¾å¤é©±å¨åºè¯¥è®¾ç½® link_validate åï¼ä»¥æä¾å®èªèº«çé¾æ¥<br>éªè¯å½æ°ãé¾æ¥éªè¯å½æ°åºå¯¹ç®¡éï¼ä¸¤ç«¯é¾æ¥çé½æ¯ V4L2 å­è®¾å¤ï¼ä¸­çæ¯ä¸ª<br>é¾æ¥è°ç¨ãé©±å¨è¿è¦è´è´£éªè¯å­è®¾å¤åè§é¢èç¹é´æ ¼å¼éç½®çæ­£ç¡®æ§ã</p>
<p>å¦æ link_validate æä½æ²¡æè®¾ç½®ï¼é»è®¤ç v4l2_subdev_link_validate_default()<br>å½æ°å°ä¼è¢«è°ç¨ãè¿ä¸ªå½æ°ä¿è¯å®½ãé«ååªä½æ»çº¿åç´ æ ¼å¼å¨é¾æ¥çæ¶åä¸¤ç«¯<br>é½ä¸è´ãå­è®¾å¤é©±å¨é¤äºå®ä»¬èªå·±çæ£æµå¤ï¼ä¹å¯ä»¥èªç±ä½¿ç¨è¿ä¸ªå½æ°ä»¥æ§è¡<br>ä¸é¢æå°çæ£æ¥ã</p>
<p>è®¾å¤ï¼æ¡¥ï¼é©±å¨ç¨åºå¿é¡»å v4l2_device æ³¨å v4l2_subdevï¼</p>
<pre><code>int err = v4l2_device_register_subdev(v4l2_dev, sd);
</code></pre>
<p>å¦æå­è®¾å¤æ¨¡åå¨å®æ³¨ååæ¶å¤±ï¼è¿ä¸ªæä½å¯è½å¤±è´¥ãå¨è¿ä¸ªå½æ°æåè¿ååï¼<br>subdev-&gt;dev åå°±æåäº v4l2_deviceã</p>
<p>å¦æ v4l2_device ç¶è®¾å¤ç mdev åä¸ºé NULL å¼ï¼åå­è®¾å¤å®ä½å°è¢«èªå¨<br>æ³¨åä¸ºåªä½è®¾å¤ã</p>
<p>æ³¨éå­è®¾å¤åå¯ç¨å¦ä¸å½æ°ï¼</p>
<pre><code>v4l2_device_unregister_subdev(sd);
</code></pre>
<p>æ­¤åï¼å­è®¾å¤æ¨¡åå°±å¯å¸è½½ï¼ä¸ sd-&gt;dev == NULLã</p>
<p>æ³¨åä¹è®¾å¤åï¼å¯éè¿ä»¥ä¸æ¹å¼ç´æ¥è°ç¨å¶æä½å½æ°ï¼</p>
<pre><code>err = sd-&gt;ops-&gt;core-&gt;g_std(sd, &amp;norm);
</code></pre>
<p>ä½ä½¿ç¨å¦ä¸å®ä¼æ¯è¾å®¹æä¸åéï¼</p>
<pre><code>err = v4l2_subdev_call(sd, core, g_std, &amp;norm);
</code></pre>
<p>è¿ä¸ªå®å°ä¼å NULL æéæ£æ¥ï¼å¦æ subdev ä¸º NULLï¼åè¿å-ENODEVï¼å¦æ<br>subdev-&gt;core æ subdev-&gt;core-&gt;g_std ä¸º NULLï¼åè¿å -ENOIOCTLCMDï¼<br>å¦åå°è¿å subdev-&gt;ops-&gt;core-&gt;g_std ops è°ç¨çå®éç»æã</p>
<p>ææ¶ä¹å¯è½åæ¶è°ç¨æææä¸ç³»åå­è®¾å¤çæä¸ªæä½å½æ°ï¼</p>
<pre><code>v4l2_device_call_all(v4l2_dev, 0, core, g_std, &amp;norm);
</code></pre>
<p>ä»»ä½ä¸æ¯ææ­¤æä½çå­è®¾å¤é½ä¼è¢«è·³è¿ï¼å¹¶å¿½ç¥éè¯¯è¿åå¼ãä½å¦æä½ éè¦<br>æ£æ¥åºéç ï¼åå¯ä½¿ç¨å¦ä¸å½æ°ï¼</p>
<pre><code>err = v4l2_device_call_until_err(v4l2_dev, 0, core, g_std, &amp;norm);
</code></pre>
<p>é¤ -ENOIOCTLCMD å¤çä»»ä½éè¯¯é½ä¼è·³åºå¾ªç¯å¹¶è¿åéè¯¯å¼ãå¦æï¼é¤ -ENOIOCTLCMD<br>å¤ï¼æ²¡æéè¯¯åçï¼åè¿å 0ã</p>
<p>å¯¹äºä»¥ä¸ä¸¤ä¸ªå½æ°çç¬¬äºä¸ªåæ°ä¸ºç» IDãå¦æä¸º 0ï¼åææå­è®¾å¤é½ä¼æ§è¡<br>è¿ä¸ªæä½ãå¦æä¸ºé 0 å¼ï¼ååªæé£äºç» ID å¹éçå­è®¾å¤æä¼æ§è¡æ­¤æä½ã<br>å¨æ¡¥é©±å¨æ³¨åä¸ä¸ªå­è®¾å¤åï¼å¯ä»¥è®¾ç½® sd-&gt;grp_id ä¸ºä»»ä½ææå¼ï¼é»è®¤å¼ä¸º<br>0ï¼ãè¿ä¸ªå¼å±äºæ¡¥é©±å¨ï¼ä¸å­è®¾å¤é©±å¨å°ä¸ä¼ä¿®æ¹åä½¿ç¨å®ã</p>
<p>ç» ID èµäºäºæ¡¥é©±å¨æ´å¤å¯¹äºå¦ä½è°ç¨åè°çæ§å¶ãä¾å¦ï¼çµè·¯æ¿ä¸æå¤ä¸ª<br>é³é¢è¯çï¼æ¯ä¸ªé½ææ¹åé³éçè½åãä½å½ç¨æ·æ³è¦æ¹åé³éçæ¶åï¼éå¸¸<br>åªæä¸ä¸ªä¼è¢«å®éä½¿ç¨ãä½ å¯ä»¥å¯¹è¿æ ·çå­è®¾å¤è®¾ç½®ç» ID ä¸ºï¼ä¾å¦ AUDIO_CONTROLLERï¼<br>å¹¶å¨è°ç¨ v4l2_device_call_all() æ¶æå®å®ä¸ºç» ID å¼ãè¿å°±ä¿è¯äºåªæ<br>éè¦çå­è®¾å¤æä¼æ§è¡è¿ä¸ªåè°ã</p>
<p>å¦æå­è®¾å¤éè¦éç¥å®ç v4l2_device ç¶è®¾å¤ä¸ä¸ªäºä»¶ï¼å¯ä»¥è°ç¨<br>v4l2_subdev_notify(sd, notification, arg)ãè¿ä¸ªå®æ£æ¥æ¯å¦æä¸ä¸ª<br>notify() åè°è¢«æ³¨åï¼å¦ææ²¡æï¼è¿å -ENODEVãå¦åè¿å notify() è°ç¨<br>ç»æã</p>
<p>ä½¿ç¨ v4l2_subdev çå¥½å¤å¨äºå®æ¯ä¸ä¸ªéç¨ç»æä½ï¼ä¸ä¸åå«ä»»ä½åºå±ç¡¬ä»¶<br>ä¿¡æ¯ãææé©±å¨å¯ä»¥åå«å¤ä¸ª I2C æ»çº¿çå­è®¾å¤ï¼ä½ä¹æå­è®¾å¤æ¯éè¿ GPIO<br>æ§å¶ãè¿ä¸ªåºå«ä»å¨éç½®è®¾å¤æ¶æå³ç³»ï¼ä¸æ¦å­è®¾å¤æ³¨åå®æï¼å¯¹äº v4l2<br>å­ç³»ç»æ¥è¯´å°±å®å¨éæäºã</p>
<h2 id="V4L2-a­e®¾a¤c¨ae·c©ºe´API"><a href="#V4L2-a­e®¾a¤c¨ae·c©ºe´API" class="headerlink" title="V4L2 å­è®¾å¤ç¨æ·ç©ºé´API"></a>V4L2 å­è®¾å¤ç¨æ·ç©ºé´API</h2><p>é¤äºéè¿ v4l2_subdev_ops ç»æå¯¼åºçåæ ¸ APIï¼V4L2 å­è®¾å¤ä¹å¯ä»¥ç´æ¥<br>éè¿ç¨æ·ç©ºé´åºç¨ç¨åºæ¥æ§å¶ã</p>
<p>å¯ä»¥å¨ /dev ä¸­åå»ºåä¸º v4l-subdevX è®¾å¤èç¹ï¼ä»¥éè¿å¶ç´æ¥è®¿é®å­è®¾å¤ã<br>å¦æå­è®¾å¤æ¯æç¨æ·ç©ºé´ç´æ¥éç½®ï¼å¿é¡»å¨æ³¨ååè®¾ç½® V4L2_SUBDEV_FL_HAS_DEVNODE<br>æ å¿ã</p>
<p>æ³¨åå­è®¾å¤ä¹åï¼ v4l2_device é©±å¨ä¼éè¿è°ç¨ v4l2_device_register_subdev_nodes()<br>å½æ°ä¸ºææå·²æ³¨åå¹¶è®¾ç½®äº V4L2_SUBDEV_FL_HAS_DEVNODE çå­è®¾å¤åå»º<br>è®¾å¤èç¹ãè¿äºè®¾å¤èç¹ä¼å¨å­è®¾å¤æ³¨éæ¶èªå¨å é¤ã</p>
<p>è¿äºè®¾å¤èç¹å¤ç V4L2 API çä¸ä¸ªå­éã</p>
<p>VIDIOC_QUERYCTRL<br>VIDIOC_QUERYMENU<br>VIDIOC_G_CTRL<br>VIDIOC_S_CTRL<br>VIDIOC_G_EXT_CTRLS<br>VIDIOC_S_EXT_CTRLS<br>VIDIOC_TRY_EXT_CTRLS</p>
<pre><code>è¿äº ioctls æ§å¶ä¸ V4L2 ä¸­å®ä¹çä¸è´ãä»ä»¬è¡ä¸ºç¸åï¼å¯ä¸ç
ä¸åæ¯ä»ä»¬åªå¤çå­è®¾å¤çæ§å¶å®ç°ãæ ¹æ®é©±å¨ç¨åºï¼è¿äºæ§å¶ä¹
å¯ä»¥éè¿ä¸ä¸ªï¼æå¤ä¸ªï¼ V4L2 è®¾å¤èç¹è®¿é®ã
</code></pre>
<p>VIDIOC_DQEVENT<br>VIDIOC_SUBSCRIBE_EVENT<br>VIDIOC_UNSUBSCRIBE_EVENT</p>
<pre><code>è¿äº  ioctls äºä»¶ä¸ V4L2 ä¸­å®ä¹çä¸è´ãä»ä»¬è¡ä¸ºç¸åï¼å¯ä¸ç
ä¸åæ¯ä»ä»¬åªå¤çå­è®¾å¤äº§ççäºä»¶ãæ ¹æ®é©±å¨ç¨åºï¼è¿äºäºä»¶ä¹
å¯ä»¥éè¿ä¸ä¸ªï¼æå¤ä¸ªï¼ V4L2 è®¾å¤èç¹ä¸æ¥ã

è¦ä½¿ç¨äºä»¶éç¥çå­è®¾å¤é©±å¨ï¼å¨æ³¨åå­è®¾å¤åå¿é¡»å¨ v4l2_subdev::flags
ä¸­è®¾ç½® V4L2_SUBDEV_USES_EVENTS å¹¶å¨ v4l2_subdev::nevents
ä¸­åå§åäºä»¶éåæ·±åº¦ãæ³¨åå®æåï¼äºä»¶ä¼å¨ v4l2_subdev::devnode
è®¾å¤èç¹ä¸­åéå¸¸ä¸æ ·è¢«æéã

ä¸ºæ­£ç¡®æ¯æäºä»¶æºå¶ï¼poll() æä»¶æä½ä¹åºè¢«å®ç°ã
</code></pre>
<p>ç§æ ioctls</p>
<pre><code>ä¸å¨ä»¥ä¸åè¡¨ä¸­çææ ioctls ä¼éè¿ core::ioctl æä½ç´æ¥ä¼ é
ç»å­è®¾å¤é©±å¨ã
</code></pre>
<h2 id="I2C-a­e®¾a¤e©±a¨"><a href="#I2C-a­e®¾a¤e©±a¨" class="headerlink" title="I2C å­è®¾å¤é©±å¨"></a>I2C å­è®¾å¤é©±å¨</h2><p>ç±äºè¿äºé©±å¨å¾å¸¸è§ï¼æä»¥åç¹æä¾äºç¹å®çè¾å©å½æ°(v4l2-common.h)è®©è¿äº<br>è®¾å¤çä½¿ç¨æ´å å®¹æã</p>
<p>æ·»å  v4l2_subdev æ¯æçæ¨èæ¹æ³æ¯è®© I2C é©±å¨å° v4l2_subdev ç»æä½<br>åµå¥å°ä¸ºæ¯ä¸ª I2C è®¾å¤å®ä¾åå»ºçç¶æç»æä½ä¸­ãèæç®åçè®¾å¤æ²¡æç¶æ<br>ç»æä½ï¼æ­¤æ¶å¯ä»¥ç´æ¥åå»ºä¸ä¸ª v4l2_subdev ç»æä½ã</p>
<p>ä¸ä¸ªå¸åçç¶æç»æä½å¦ä¸æç¤ºï¼âchipnameâç¨è¯çåä»£æ¿ï¼ï¼</p>
<p>struct chipname_state {<br>    struct v4l2_subdev sd;<br>    …  /* éå çç¶æå*/<br>};</p>
<p>åå§å v4l2_subdev ç»æä½çæ¹æ³å¦ä¸ï¼</p>
<pre><code>v4l2_i2c_subdev_init(&amp;state-&gt;sd, client, subdev_ops);
</code></pre>
<p>è¿ä¸ªå½æ°å°å¡«å v4l2_subdev ç»æä½ä¸­çææåï¼å¹¶ä¿è¯ v4l2_subdev å<br>i2c_client é½æåå½¼æ­¤ã</p>
<p>åæ¶ï¼ä½ ä¹åºè¯¥ä¸ºä» v4l2_subdev æéæ¾å° chipname_state ç»æä½æé<br>æ·»å ä¸ä¸ªè¾å©åèå½æ°ã</p>
<p>static inline struct chipname_state *to_state(struct v4l2_subdev *sd)<br>{<br>    return container_of(sd, struct chipname_state, sd);<br>}</p>
<p>ä½¿ç¨ä»¥ä¸å½æ°å¯ä»¥éè¿ v4l2_subdev ç»æä½æéè·å¾ i2c_client ç»æä½<br>æéï¼</p>
<pre><code>struct i2c_client *client = v4l2_get_subdevdata(sd);
</code></pre>
<p>èä»¥ä¸å½æ°åç¸åï¼éè¿ i2c_client ç»æä½æéè·å¾ v4l2_subdev ç»æä½<br>æéï¼</p>
<pre><code>struct v4l2_subdev *sd = i2c_get_clientdata(client);
</code></pre>
<p>å½ remove()å½æ°è¢«è°ç¨åï¼å¿é¡»ä¿è¯åè°ç¨ v4l2_device_unregister_subdev(sd)ã<br>æ­¤æä½å°ä¼ä»æ¡¥é©±å¨ä¸­æ³¨éå­è®¾å¤ãå³ä½¿å­è®¾å¤æ²¡ææ³¨åï¼è°ç¨æ­¤å½æ°ä¹æ¯<br>å®å¨çã</p>
<p>å¿é¡»è¿æ ·åçåå æ¯ï¼å½æ¡¥é©±å¨æ³¨é i2c ééå¨æ¶ï¼remove()åè°å½æ°<br>ä¼è¢«é£ä¸ªééå¨ä¸ç i2c è®¾å¤è°ç¨ãæ­¤åï¼ç¸åºç v4l2_subdev ç»æä½<br>å°±ä¸å­å¨äºï¼ææå®ä»¬å¿é¡»åè¢«æ³¨éãå¨ remove()åè°å½æ°ä¸­è°ç¨<br>v4l2_device_unregister_subdev(sd)ï¼å¯ä»¥ä¿è¯æ§è¡æ»æ¯æ­£ç¡®çã</p>
<p>æ¡¥é©±å¨ä¹æä¸äºè¾ç»å½æ°å¯ç¨ï¼</p>
<p>struct v4l2_subdev *sd = v4l2_i2c_new_subdev(v4l2_dev, adapter,<br>           “module_foo”, “chipid”, 0x36, NULL);</p>
<p>è¿ä¸ªå½æ°ä¼å è½½ç»å®çæ¨¡åï¼å¦ææ²¡ææ¨¡åéè¦å è½½ï¼å¯ä»¥ä¸º NULLï¼ï¼<br>å¹¶ç¨ç»å®ç i2c ééå¨ç»æä½æéï¼i2c_adapterï¼å å¨ä»¶å°åï¼chip/addressï¼<br>ä½ä¸ºåæ°è°ç¨ i2c_new_device()ãå¦æä¸åé¡ºå©ï¼åå°±å¨ v4l2_device<br>ä¸­æ³¨åäºå­è®¾å¤ã</p>
<p>ä½ ä¹å¯ä»¥å©ç¨ v4l2_i2c_new_subdev()çæåä¸ä¸ªåæ°ï¼ä¼ éä¸ä¸ªå¯è½ç<br>I2C å°åæ°ç»ï¼è®©å½æ°èªå¨æ¢æµãè¿äºæ¢æµå°ååªæå¨åä¸ä¸ªåæ°ä¸º 0 ç<br>æåµä¸ä½¿ç¨ãéé¶åæ°æå³çä½ ç¥éåç¡®ç i2c å°åï¼æä»¥æ­¤æ¶æ é¡»è¿è¡<br>æ¢æµã</p>
<p>å¦æåºéï¼ä¸¤ä¸ªå½æ°é½è¿å NULLã</p>
<p>æ³¨æï¼ä¼ éç» v4l2_i2c_new_subdev()ç chipid éå¸¸ä¸æ¨¡ååä¸è´ã<br>å®åè®¸ä½ æå®ä¸ä¸ªè¯ççåä½ï¼æ¯å¦âsaa7114âæâsaa7115âãä¸è¬éè¿<br>i2c é©±å¨èªå¨æ¢æµãchipid çä½¿ç¨æ¯å¨ä»åéè¦æ·±å¥äºè§£çäºæãè¿ä¸ªä¸<br>i2c é©±å¨ä¸åï¼è¾å®¹ææ··æ·ãè¦ç¥éæ¯æåªäºè¯çåä½ï¼ä½ å¯ä»¥æ¥é i2c<br>é©±å¨ä»£ç ç i2c_device_id è¡¨ï¼ä¸é¢ååºäºææå¯è½æ¯æçè¯çã</p>
<p>è¿æä¸¤ä¸ªè¾å©å½æ°ï¼</p>
<p>v4l2_i2c_new_subdev_cfgï¼è¿ä¸ªå½æ°æ·»å æ°ç irq å platform_data<br>åæ°ï¼å¹¶æâaddrâåâprobed_addrsâåæ°ï¼å¦æ addr éé¶ï¼åè¢«ä½¿ç¨<br>ï¼ä¸æ¢æµåä½ï¼ï¼å¦å probed_addrs ä¸­çå°åå°ç¨äºèªå¨æ¢æµã</p>
<p>ä¾å¦ï¼ä»¥ä¸ä»£ç å°ä¼æ¢æµå°åï¼0x10ï¼ï¼</p>
<p>struct v4l2_subdev *sd = v4l2_i2c_new_subdev_cfg(v4l2_dev, adapter,<br>           “module_foo”, “chipid”, 0, NULL, 0, I2C_ADDRS(0x10));</p>
<p>v4l2_i2c_new_subdev_board ä½¿ç¨ä¸ä¸ª i2c_board_info ç»æä½ï¼å°å¶<br>æ¿ä»£ irqãplatform_data å add råæ°ä¼ éç» i2c é©±å¨ã</p>
<p>å¦æå­è®¾å¤æ¯æ s_config æ ¸å¿æä½ï¼è¿ä¸ªæä½ä¼å¨å­è®¾å¤éç½®å¥½ä¹åä»¥ irq å<br>platform_data ä¸ºåæ°è°ç¨ãæ©æç v4l2_i2c_new_(probed_)subdev å½æ°<br>åæ ·ä¹ä¼è°ç¨ s_configï¼ä½ä»å¨ irq ä¸º 0 ä¸ platform_data ä¸º NULL æ¶ã</p>
<h2 id="video-devicec»aea½"><a href="#video-devicec»aea½" class="headerlink" title="video_deviceç»æä½"></a>video_deviceç»æä½</h2><p>å¨ /dev ç®å½ä¸çå®éè®¾å¤èç¹æ ¹æ® video_device ç»æä½(v4l2-dev.h)<br>åå»ºãæ­¤ç»æä½æ¢å¯ä»¥å¨æåéä¹å¯ä»¥åµå¥å°ä¸ä¸ªæ´å¤§çç»æä½ä¸­ã</p>
<p>å¨æåéæ¹æ³å¦ä¸ï¼</p>
<pre><code>struct video_device *vdev = video_device_alloc();

if (vdev == NULL)
    return -ENOMEM;

vdev-&gt;release = video_device_release;
</code></pre>
<p>å¦æå°å¶åµå¥å°ä¸ä¸ªå¤§ç»æä½ä¸­ï¼åå¿é¡»èªå·±å®ç° release()åè°ã</p>
<pre><code>struct video_device *vdev = &amp;my_vdev-&gt;vdev;

vdev-&gt;release = my_vdev_release;
</code></pre>
<p>release()åè°å¿é¡»è¢«è®¾ç½®ï¼ä¸å¨æåä¸ä¸ª video_device ç¨æ·éåºä¹å<br>è¢«è°ç¨ã</p>
<p>é»è®¤ç video_device_release()åè°åªæ¯è°ç¨ kfree æ¥éæ¾ä¹ååéç<br>åå­ã</p>
<p>ä½ åºè¯¥è®¾ç½®è¿äºåï¼</p>
<ul>
<li><p>v4l2_dev: è®¾ç½®ä¸º v4l2_device ç¶è®¾å¤ã</p>
</li>
<li><p>name: è®¾ç½®ä¸ºå¯ä¸çæè¿°æ§è®¾å¤åã</p>
</li>
<li><p>fops: è®¾ç½®ä¸ºå·²æç v4l2_file_operations ç»æä½ã</p>
</li>
<li><p>ioctl_ops: å¦æä½ ä½¿ç¨v4l2_ioctl_ops æ¥ç®å ioctl çç»´æ¤<br>(å¼ºçå»ºè®®ä½¿ç¨ï¼ä¸å°æ¥å¯è½åä¸ºå¼ºå¶æ§ç!)ï¼ç¶åè®¾ç½®ä½ èªå·±ç<br>v4l2_ioctl_ops ç»æä½.</p>
</li>
<li><p>lock: å¦æä½ è¦å¨é©±å¨ä¸­å®ç°ææçéæä½ï¼åè®¾ä¸º NULL ãå¦å<br>å°±è¦è®¾ç½®ä¸ä¸ªæå struct mutex_lock ç»æä½çæéï¼è¿ä¸ªéå°<br>å¨ unlocked_ioctl æä»¶æä½è¢«è°ç¨åç±åæ ¸è·å¾ï¼å¹¶å¨è°ç¨è¿åå<br>éæ¾ãè¯¦è§ä¸ä¸èã</p>
</li>
<li><p>prio: ä¿æå¯¹ä¼åçº§çè·è¸ªãç¨äºå®ç° VIDIOC_G/S_PRIORITYãå¦æ<br>è®¾ç½®ä¸º NULLï¼åä¼ä½¿ç¨ v4l2_device ä¸­ç v4l2_prio_state ç»æä½ã<br>å¦æè¦å¯¹æ¯ä¸ªè®¾å¤èç¹ï¼ç»ï¼å®ç°ç¬ç«çä¼åçº§ï¼å¯ä»¥å°å¶æåèªå·±<br>å®ç°ç v4l2_prio_state ç»æä½ã</p>
</li>
<li><p>parent: ä»å¨ä½¿ç¨ NULL ä½ä¸ºç¶è®¾å¤ç»æä½åæ°æ³¨å v4l2_device æ¶<br>è®¾ç½®æ­¤åæ°ãåªæå¨ä¸ä¸ªç¡¬ä»¶è®¾å¤åå«å¤ä¸ä¸ª PCI è®¾å¤ï¼å±äº«åä¸ä¸ª<br>v4l2_device æ ¸å¿æ¶æä¼åçã</p>
<p>cx88 é©±å¨å°±æ¯ä¸ä¸ªä¾å­ï¼ä¸ä¸ª v4l2_device ç»æä½æ ¸å¿ï¼è¢«ä¸ä¸ªè£¸ç<br>è§é¢ PCI è®¾å¤(cx8800)åä¸ä¸ª MPEG PCI è®¾å¤(cx8802)å±ç¨ãç±äº<br>v4l2_device æ æ³ä¸ç¹å®ç PCI è®¾å¤å³èï¼æææ²¡æè®¾ç½®ç¶è®¾å¤ãä½å½<br>video_device éç½®åï¼å°±ç¥éä½¿ç¨åªä¸ªç¶ PCI è®¾å¤äºã</p>
</li>
</ul>
<p>å¦æä½ ä½¿ç¨ v4l2_ioctl_opsï¼ååºè¯¥å¨ v4l2_file_operations ç»æä½ä¸­<br>è®¾ç½® .unlocked_ioctl æå video_ioctl2ã</p>
<p>è¯·å¿ä½¿ç¨ .ioctlï¼å®å·²è¢«åºå¼ï¼ä»åå°æ¶å¤±ã</p>
<p>æäºæåµä¸ä½ è¦åè¯æ ¸å¿ï¼ä½ å¨ v4l2_ioctl_ops æå®çæä¸ªå½æ°åºè¢«å¿½ç¥ã<br>ä½ å¯ä»¥å¨ video_device_register è¢«è°ç¨åéè¿ä»¥ä¸å½æ°æ è®°è¿ä¸ª ioctlsã</p>
<p>void v4l2_disable_ioctl(struct video_device *vdev, unsigned int cmd);</p>
<p>åºäºå¤é¨å ç´ ï¼ä¾å¦æä¸ªæ¿å¡å·²è¢«ä½¿ç¨ï¼ï¼å¨ä¸åå»ºæ°ç»æä½çæåµä¸ï¼ä½ æ³<br>è¦å³é­ v4l2_ioctl_ops ä¸­æä¸ªç¹æ§å¾å¾éè¦è¿ä¸ªæºå¶ã</p>
<p>v4l2_file_operations ç»æä½æ¯ file_operations çä¸ä¸ªå­éãå¶ä¸»è¦<br>åºå«å¨äºï¼å  inode åæ°ä»æªè¢«ä½¿ç¨ï¼å®å°è¢«å¿½ç¥ã</p>
<p>å¦æéè¦ä¸åªä½æ¡æ¶æ´åï¼ä½ å¿é¡»éè¿è°ç¨ media_entity_pads_init() åå§å<br>åµå¥å¨ video_device ç»æä½ä¸­ç media_entityï¼entity åï¼ç»æä½ï¼</p>
<pre><code>struct media_pad *pad = &amp;my_vdev-&gt;pad;
int err;

err = media_entity_pads_init(&amp;vdev-&gt;entity, 1, pad);
</code></pre>
<p>pads æ°ç»å¿é¡»é¢ååå§åãæ²¡æå¿è¦æå¨è®¾ç½® media_entity ç type å<br>name åã</p>
<p>å½ï¼ä»»ä½ï¼å­è®¾å¤èç¹è¢«æå¼/å³é­ï¼å¯¹ entity çå¼ç¨å°è¢«èªå¨è·å/éæ¾ã</p>
<h2 id="v4l2-file-operations-a¸e"><a href="#v4l2-file-operations-a¸e" class="headerlink" title="v4l2_file_operations ä¸é"></a>v4l2_file_operations ä¸é</h2><p>ä½ å¯ä»¥å¨ video_device ç»æä½ä¸­è®¾ç½®ä¸ä¸ªæå mutex_lock çæéãéå¸¸<br>è¿æ¢å¯æ¯ä¸ä¸ªé¡¶å±äºæ¥éä¹å¯ä¸ºè®¾å¤èç¹èªèº«çäºæ¥éãé»è®¤æåµä¸ï¼æ­¤é<br>ç¨äº unlocked_ioctlï¼ä½ä¸ºäºä½¿ç¨ ioctls ä½ éè¿ä»¥ä¸å½æ°å¯ç¦ç¨éå®ï¼</p>
<pre><code>void v4l2_disable_ioctl_locking(struct video_device *vdev, unsigned int cmd);
</code></pre>
<p>ä¾å¦: v4l2_disable_ioctl_locking(vdev, VIDIOC_DQBUF);</p>
<p>ä½ å¿é¡»å¨æ³¨å video_device åè°ç¨è¿ä¸ªå½æ°ã</p>
<p>ç¹å«æ¯å¯¹äº USB é©±å¨ç¨åºï¼æäºå½ä»¤ï¼å¦è®¾ç½®æ§å¶ï¼éè¦å¾é¿çæ¶é´ï¼å¯è½<br>éè¦èªè¡ä¸ºç¼å²åºéåç ioctls å®ç°éå®ã</p>
<p>å¦æä½ éè¦æ´ç»ç²åº¦çéï¼ä½ å¿é¡»è®¾ç½® mutex_lock ä¸º NULLï¼å¹¶å®å¨èªå·±å®ç°<br>éæºå¶ã</p>
<p>è¿å®å¨ç±é©±å¨å¼åèå³å®ä½¿ç¨ä½ç§æ¹æ³ãç¶èï¼å¦æä½ çé©±å¨å­å¨é¿å»¶æ¶æä½<br>ï¼ä¾å¦ï¼æ¹å USB æåå¤´çæåæ¶é´å¯è½éè¦è¾é¿æ¶é´ï¼ï¼èä½ åæ³è®©ç¨æ·<br>å¨ç­å¾é¿å»¶æ¶æä½å®ææé´åå¶ä»çäºï¼åä½ æå¥½èªå·±å®ç°éæºå¶ã</p>
<p>å¦ææå®ä¸ä¸ªéï¼åææ ioctl æä½å°å¨è¿ä¸ªéçä½ç¨ä¸ä¸²è¡æ§è¡ãå¦æä½ <br>ä½¿ç¨ videobufï¼åå¿é¡»å°åä¸ä¸ªéä¼ éç» videobuf éååå§åå½æ°ï¼å¦<br>videobuf å¿é¡»ç­å¾ä¸å¸§çå°è¾¾ï¼åå¯ä¸´æ¶è§£éå¹¶å¨è¿ä¹åéæ°ä¸éãå¦æé©±å¨<br>ä¹å¨ä»£ç æ§è¡æé´ç­å¾ï¼åå¯ååæ ·çå·¥ä½ï¼ä¸´æ¶è§£éï¼åä¸éï¼è®©å¶ä»è¿ç¨<br>å¯ä»¥å¨ç¬¬ä¸ä¸ªè¿ç¨é»å¡æ¶è®¿é®è®¾å¤èç¹ã</p>
<p>å¨ä½¿ç¨ videobuf2 çæåµä¸ï¼å¿é¡»å®ç° wait_prepare å wait_finish åè°<br>å¨éå½çæ¶åè§£é/å éãè¿ä¸æ­¥æ¥è¯´ï¼å¦æä½ å¨ video_device ç»æä½ä¸­ä½¿ç¨<br>éï¼åå¿é¡»å¨ wait_prepare å wait_finish ä¸­å¯¹è¿ä¸ªäºæ¥éè¿è¡è§£é/å éã</p>
<p>ç­ææçæ­å¼å®ç°ä¹å¿é¡»å¨è°ç¨ v4l2_device_disconnect åè·å¾éã</p>
<h2 id="video-deviceae³¨aOE"><a href="#video-deviceae³¨aOE" class="headerlink" title="video_deviceæ³¨å"></a>video_deviceæ³¨å</h2><p>æ¥ä¸æ¥ä½ éè¦æ³¨åè§é¢è®¾å¤ï¼è¿ä¼ä¸ºä½ åå»ºä¸ä¸ªå­ç¬¦è®¾å¤ã</p>
<pre><code>err = video_register_device(vdev, VFL_TYPE_GRABBER, -1);
if (err) &#123;
    video_device_release(vdev); /* or kfree(my_vdev); */
    return err;
&#125;
</code></pre>
<p>å¦æ v4l2_device ç¶è®¾å¤ç mdev åä¸ºé NULL å¼ï¼è§é¢è®¾å¤å®ä½å°èªå¨<br>æ³¨åä¸ºåªä½è®¾å¤ã</p>
<p>æ³¨ååªç§è®¾å¤æ¯æ ¹æ®ç±»åï¼typeï¼åæ°ãå­å¨ä»¥ä¸ç±»åï¼</p>
<p>VFL_TYPE_GRABBER: ç¨äºè§é¢è¾å¥/è¾åºè®¾å¤ç videoX<br>VFL_TYPE_VBI: ç¨äºåç´æ¶éæ°æ®ç vbiX (ä¾å¦ï¼éèå¼å­å¹ï¼å¾æçµè§)<br>VFL_TYPE_RADIO: ç¨äºå¹¿æ­è°è°å¨ç radioX</p>
<p>æåä¸ä¸ªåæ°è®©ä½ ç¡®å®ä¸ä¸ªææ§å¶è®¾å¤çè®¾å¤èç¹å·æ°é(ä¾å¦ videoX ä¸­ç X)ã<br>éå¸¸ä½ å¯ä»¥ä¼ å¥-1ï¼è®© v4l2 æ¡æ¶èªå·±éæ©ç¬¬ä¸ä¸ªç©ºé²çç¼å·ãä½æ¯ææ¶ç¨æ·<br>éè¦éæ©ä¸ä¸ªç¹å®çèç¹å·ãé©±å¨åè®¸ç¨æ·éè¿é©±å¨æ¨¡ååæ°éæ©ä¸ä¸ªç¹å®ç<br>è®¾å¤èç¹å·æ¯å¾æ®éçãè¿ä¸ªç¼å·å°ä¼ä¼ éç»è¿ä¸ªå½æ°ï¼ä¸ video_register_device<br>å°ä¼è¯å¾éæ©è¿ä¸ªè®¾å¤èç¹å·ãå¦æè¿ä¸ªç¼å·è¢«å ç¨ï¼ä¸ä¸ä¸ªç©ºé²çè®¾å¤èç¹<br>ç¼å·å°è¢«éä¸­ï¼å¹¶ååæ ¸æ¥å¿ä¸­åéä¸ä¸ªè­¦åä¿¡æ¯ã</p>
<p>å¦ä¸ä¸ªä½¿ç¨åºæ¯æ¯å½é©±å¨åå»ºå¤ä¸ªè®¾å¤æ¶ãè¿ç§æåµä¸ï¼å¯¹ä¸åçè§é¢è®¾å¤å¨<br>ç¼å·ä¸ä½¿ç¨ä¸åçèå´æ¯å¾æç¨çãä¾å¦ï¼è§é¢æè·è®¾å¤ä» 0 å¼å§ï¼è§é¢<br>è¾åºè®¾å¤ä» 16 å¼å§ãæä»¥ä½ å¯ä»¥ä½¿ç¨æåä¸ä¸ªåæ°æ¥æå®è®¾å¤èç¹å·æå°å¼ï¼<br>è v4l2 æ¡æ¶ä¼è¯å¾éæ©ç¬¬ä¸ä¸ªçç©ºé²ç¼å·ï¼ç­äºæå¤§äºä½ æä¾çç¼å·ï¼ã<br>å¦æå¤±è´¥ï¼åå®ä¼å°±éæ©ç¬¬ä¸ä¸ªç©ºé²çç¼å·ã</p>
<p>ç±äºè¿ç§æåµä¸ï¼ä½ ä¼å¿½ç¥æ æ³éæ©ç¹å®è®¾å¤èç¹å·çè­¦åï¼åå¯è°ç¨<br>video_register_device_no_warn() å½æ°é¿åè­¦åä¿¡æ¯çäº§çã</p>
<p>åªè¦è®¾å¤èç¹è¢«åå»ºï¼ä¸äºå±æ§ä¹ä¼åæ¶åå»ºãå¨ /sys/class/video4linux<br>ç®å½ä¸­ä½ ä¼æ¾å°è¿äºè®¾å¤ãä¾å¦è¿å¥å¶ä¸­ç video0 ç®å½ï¼ä½ ä¼çå°ânameâå<br>âindexâå±æ§ãânameâå±æ§å¼å°±æ¯ video_device ç»æä½ä¸­çânameâåã</p>
<p>âindexâå±æ§å¼å°±æ¯è®¾å¤èç¹çç´¢å¼å¼ï¼æ¯æ¬¡è°ç¨ video_register_device()ï¼<br>ç´¢å¼å¼é½éå¢ 1 ãç¬¬ä¸ä¸ªè§é¢è®¾å¤èç¹æ»æ¯ä»ç´¢å¼å¼ 0 å¼å§ã</p>
<p>ç¨æ·å¯ä»¥è®¾ç½® udev è§åï¼å©ç¨ç´¢å¼å±æ§çæè±å¨çè®¾å¤åï¼ä¾å¦ï¼ç¨âmpegXâ<br>ä»£è¡¨ MPEG è§é¢æè·è®¾å¤èç¹ï¼ã</p>
<p>å¨è®¾å¤æåæ³¨ååï¼å°±å¯ä»¥ä½¿ç¨è¿äºåï¼</p>
<ul>
<li>vfl_type: ä¼ éç» video_register_device çè®¾å¤ç±»åã</li>
<li>minor: å·²ææ´¾çæ¬¡è®¾å¤å·ã</li>
<li>num: è®¾å¤èç¹ç¼å· (ä¾å¦ videoX ä¸­ç X)ã</li>
<li>index: è®¾å¤ç´¢å¼å·ã</li>
</ul>
<p>å¦ææ³¨åå¤±è´¥ï¼ä½ å¿é¡»è°ç¨ video_device_release() æ¥éæ¾å·²åéç<br>video_device ç»æä½ï¼å¦æ video_device æ¯åµå¥å¨èªå·±åå»ºçç»æä½ä¸­ï¼<br>ä½ ä¹å¿é¡»éæ¾å®ãvdev-&gt;release() åè°ä¸ä¼å¨æ³¨åå¤±è´¥ä¹åè¢«è°ç¨ï¼<br>ä½ ä¹ä¸åºè¯å¾å¨æ³¨åå¤±è´¥åæ³¨éè®¾å¤ã</p>
<h2 id="video-device-ae³¨e"><a href="#video-device-ae³¨e" class="headerlink" title="video_device æ³¨é"></a>video_device æ³¨é</h2><p>å½è§é¢è®¾å¤èç¹å·²è¢«ç§»é¤ï¼ä¸è®ºæ¯å¸è½½é©±å¨è¿æ¯USBè®¾å¤æ­å¼ï¼ä½ é½åºæ³¨é<br>å®ä»¬ï¼</p>
<pre><code>video_unregister_device(vdev);
</code></pre>
<p>è¿ä¸ªæä½å°ä» sysfs ä¸­ç§»é¤è®¾å¤èç¹ï¼å¯¼è´ udev å°å¶ä» /dev ä¸­ç§»é¤ï¼ã</p>
<p>video_unregister_device() è¿åä¹åï¼å°±æ æ³å®ææå¼æä½ãå°½ç®¡å¦æ­¤ï¼<br>USB è®¾å¤çæåµåä¸åï¼æäºåºç¨ç¨åºå¯è½ä¾ç¶æå¼çå¶ä¸­ä¸ä¸ªå·²æ³¨éè®¾å¤<br>èç¹ãæä»¥å¨æ³¨éä¹åï¼æææä»¶æä½ï¼å½ç¶é¤äº release ï¼ä¹åºè¿åéè¯¯å¼ã</p>
<p>å½æåä¸ä¸ªè§é¢è®¾å¤èç¹çç¨æ·éåºï¼å vdev-&gt;release() åè°ä¼è¢«è°ç¨ï¼<br>å¹¶ä¸ä½ å¯ä»¥åæåçæ¸çæä½ã</p>
<p>ä¸è¦å¿è®°æ¸çä¸è§é¢è®¾å¤ç¸å³çåªä½å¥å£ï¼å¦æè¢«åå§åè¿ï¼ï¼</p>
<pre><code>media_entity_cleanup(&amp;vdev-&gt;entity);
</code></pre>
<p>è¿å¯ä»¥å¨ release åè°ä¸­å®æã</p>
<h2 id="video-device-e¾a©a½ae°"><a href="#video-device-e¾a©a½ae°" class="headerlink" title="video_device è¾å©å½æ°"></a>video_device è¾å©å½æ°</h2><p>ä¸äºæç¨çè¾å©å½æ°å¦ä¸ï¼</p>
<ul>
<li>file/video_device ç§ææ°æ®</li>
</ul>
<p>ä½ å¯ä»¥ç¨ä»¥ä¸å½æ°å¨ video_device ç»æä½ä¸­è®¾ç½®/è·åé©±å¨ç§ææ°æ®ï¼</p>
<p>void *video_get_drvdata(struct video_device *vdev);<br>void video_set_drvdata(struct video_device *vdev, void *data);</p>
<p>æ³¨æï¼å¨è°ç¨ video_register_device() åæ§è¡ video_set_drvdata()<br>æ¯å®å¨çã</p>
<p>èä»¥ä¸å½æ°ï¼</p>
<p>struct video_device *video_devdata(struct file *file);</p>
<p>è¿å file ç»æä½ä¸­æ¥æçç video_device æéã</p>
<p>video_drvdata è¾å©å½æ°ç»åäº video_get_drvdata å video_devdata<br>çåè½ï¼</p>
<p>void *video_drvdata(struct file *file);</p>
<p>ä½ å¯ä»¥ä½¿ç¨å¦ä¸ä»£ç ä» video_device ç»æä½ä¸­è·å v4l2_device ç»æä½<br>æéï¼</p>
<p>struct v4l2_device *v4l2_dev = vdev-&gt;v4l2_dev;</p>
<ul>
<li>è®¾å¤èç¹å</li>
</ul>
<p>video_device è®¾å¤èç¹å¨åæ ¸ä¸­çåç§°å¯ä»¥éè¿ä»¥ä¸å½æ°è·å¾</p>
<p>const char *video_device_node_name(struct video_device *vdev);</p>
<p>è¿ä¸ªåå­è¢«ç¨æ·ç©ºé´å·¥å·ï¼ä¾å¦ udevï¼ä½ä¸ºæç¤ºä¿¡æ¯ä½¿ç¨ãåºå°½å¯è½ä½¿ç¨<br>æ­¤åè½ï¼èéè®¿é® video_device::num å video_device::minor åã</p>
<h2 id="e§e¢c¼a²e¾a©a½ae°"><a href="#e§e¢c¼a²e¾a©a½ae°" class="headerlink" title="è§é¢ç¼å²è¾å©å½æ°"></a>è§é¢ç¼å²è¾å©å½æ°</h2><p>v4l2 æ ¸å¿ API æä¾äºä¸ä¸ªå¤çè§é¢ç¼å²çæ åæ¹æ³(ç§°ä¸ºâvideobufâ)ã<br>è¿äºæ¹æ³ä½¿é©±å¨å¯ä»¥éè¿ç»ä¸çæ¹å¼å®ç° read()ãmmap() å overlay()ã<br>ç®åå¨è®¾å¤ä¸æ¯æè§é¢ç¼å²çæ¹æ³æåæ£/èé DMA(videobuf-dma-sg)ã<br>çº¿æ§ DMA(videobuf-dma-contig)ä»¥åå¤§å¤ç¨äº USB è®¾å¤çç¨ vmalloc<br>åéçç¼å²(videobuf-vmalloc)ã</p>
<p>è¯·åé Documentation/media/kapi/v4l2-videobuf.rstï¼ä»¥è·å¾æ´å¤å³äº videobuf<br>å±çä½¿ç¨ä¿¡æ¯ã</p>
<h2 id="v4l2-fh-c»aea½"><a href="#v4l2-fh-c»aea½" class="headerlink" title="v4l2_fh ç»æä½"></a>v4l2_fh ç»æä½</h2><p>v4l2_fh ç»æä½æä¾ä¸ä¸ªä¿å­ç¨äº V4L2 æ¡æ¶çæä»¶å¥æç¹å®æ°æ®çç®åæ¹æ³ã<br>å¦æ video_device æ å¿ï¼æ°é©±å¨<br>å¿é¡»ä½¿ç¨ v4l2_fh ç»æä½ï¼å ä¸ºå®ä¹ç¨äºå®ç°ä¼åçº§å¤çï¼VIDIOC_G/S_PRIORITYï¼ã</p>
<p>v4l2_fh çç¨æ·ï¼ä½äº V4l2 æ¡æ¶ä¸­ï¼å¹¶éé©±å¨ï¼å¯éè¿æµè¯<br>video_device-&gt;flags ä¸­ç V4L2_FL_USES_V4L2_FH ä½å¾ç¥é©±å¨æ¯å¦ä½¿ç¨<br>v4l2_fh ä½ä¸ºä»ç file-&gt;private_data æéãè¿ä¸ªä½ä¼å¨è°ç¨ v4l2_fh_init()<br>æ¶è¢«è®¾ç½®ã</p>
<p>v4l2_fh ç»æä½ä½ä¸ºé©±å¨èªèº«æä»¶å¥æç»æä½çä¸é¨åè¢«åéï¼ä¸é©±å¨å¨<br>å¶æå¼å½æ°ä¸­å° file-&gt;private_data æåå®ã</p>
<p>å¨è®¸å¤æåµä¸ï¼v4l2_fh ç»æä½ä¼åµå¥å°ä¸ä¸ªæ´å¤§çç»æä½ä¸­ãè¿éæåµä¸ï¼<br>åºè¯¥å¨ open() ä¸­è°ç¨ v4l2_fh_init+v4l2_fh_addï¼å¹¶å¨ release() ä¸­<br>è°ç¨ v4l2_fh_del+v4l2_fh_exitã</p>
<p>é©±å¨å¯ä»¥éè¿ä½¿ç¨ container_of å®æåä»ä»¬èªå·±çæä»¶å¥æç»æä½ãä¾å¦ï¼</p>
<p>struct my_fh {<br>    int blah;<br>    struct v4l2_fh fh;<br>};</p>
<p>…</p>
<p>int my_open(struct file *file)<br>{<br>    struct my_fh *my_fh;<br>    struct video_device *vfd;<br>    int ret;</p>
<pre><code>...

my_fh = kzalloc(sizeof(*my_fh), GFP_KERNEL);

...

v4l2_fh_init(&amp;my_fh-&gt;fh, vfd);

...

file-&gt;private_data = &amp;my_fh-&gt;fh;
v4l2_fh_add(&amp;my_fh-&gt;fh);
return 0;
</code></pre>
<p>}</p>
<p>int my_release(struct file *file)<br>{<br>    struct v4l2_fh *fh = file-&gt;private_data;<br>    struct my_fh *my_fh = container_of(fh, struct my_fh, fh);</p>
<pre><code>...
v4l2_fh_del(&amp;my_fh-&gt;fh);
v4l2_fh_exit(&amp;my_fh-&gt;fh);
kfree(my_fh);
return 0;
</code></pre>
<p>}</p>
<p>ä»¥ä¸æ¯ v4l2_fh å½æ°ä½¿ç¨çç®ä»ï¼</p>
<p>void v4l2_fh_init(struct v4l2_fh *fh, struct video_device *vdev)</p>
<p>  åå§åæä»¶å¥æãè¿<em>å¿é¡»</em>å¨é©±å¨ç v4l2_file_operations-&gt;open()<br>  å½æ°ä¸­æ§è¡ã</p>
<p>void v4l2_fh_add(struct v4l2_fh *fh)</p>
<p>  æ·»å ä¸ä¸ª v4l2_fh å° video_device æä»¶å¥æåè¡¨ãä¸æ¦æä»¶å¥æ<br>  åå§åå®æå°±å¿é¡»è°ç¨ã</p>
<p>void v4l2_fh_del(struct v4l2_fh *fh)</p>
<p>  ä» video_device() ä¸­è§£é¤æä»¶å¥æçå³èãæä»¶å¥æçéåºå½æ°ä¹<br>  å°è¢«è°ç¨ã</p>
<p>void v4l2_fh_exit(struct v4l2_fh *fh)</p>
<p>  æ¸çæä»¶å¥æãå¨æ¸çå® v4l2_fh åï¼ç¸å³åå­ä¼è¢«éæ¾ã</p>
<p>å¦æ v4l2_fh ä¸æ¯åµå¥å¨å¶ä»ç»æä½ä¸­çï¼åå¯ä»¥ç¨è¿äºè¾å©å½æ°ï¼</p>
<p>int v4l2_fh_open(struct file *filp)</p>
<p>  åéä¸ä¸ª v4l2_fh ç»æä½ç©ºé´ï¼åå§åå¹¶å°å¶æ·»å å° file ç»æä½ç¸å³ç<br>  video_device ç»æä½ä¸­ã</p>
<p>int v4l2_fh_release(struct file *filp)</p>
<p>  ä» file ç»æä½ç¸å³ç video_device ç»æä½ä¸­å é¤ v4l2_fh ï¼æ¸ç<br>  v4l2_fh å¹¶éæ¾ç©ºé´ã</p>
<p>è¿ä¸¤ä¸ªå½æ°å¯ä»¥æå¥å° v4l2_file_operation ç open() å release()<br>æä½ä¸­ã</p>
<p>æäºé©±å¨éè¦å¨ç¬¬ä¸ä¸ªæä»¶å¥ææå¼åæåä¸ä¸ªæä»¶å¥æå³é­çæ¶ååäº<br>å·¥ä½ãæä»¥å å¥äºä¸¤ä¸ªè¾å©å½æ°ä»¥æ£æ¥ v4l2_fh ç»æä½æ¯å¦æ¯ç¸å³è®¾å¤<br>èç¹æå¼çå¯ä¸æä»¶å¥æã</p>
<p>int v4l2_fh_is_singular(struct v4l2_fh *fh)</p>
<p>  å¦ææ­¤æä»¶å¥ææ¯å¯ä¸æå¼çæä»¶å¥æï¼åè¿å 1 ï¼å¦åè¿å 0 ã</p>
<p>int v4l2_fh_is_singular_file(struct file *filp)</p>
<p>  åè½ç¸åï¼ä½éè¿ filp-&gt;private_data è°ç¨ v4l2_fh_is_singularã</p>
<h2 id="V4L2-aºa»¶aeoeºa¶"><a href="#V4L2-aºa»¶aeoeºa¶" class="headerlink" title="V4L2 äºä»¶æºå¶"></a>V4L2 äºä»¶æºå¶</h2><p>V4L2 äºä»¶æºå¶æä¾äºä¸ä¸ªéç¨çæ¹æ³å°äºä»¶ä¼ éå°ç¨æ·ç©ºé´ãé©±å¨å¿é¡»ä½¿ç¨<br>v4l2_fh æè½æ¯æ V4L2 äºä»¶æºå¶ã</p>
<p>äºä»¶éè¿ä¸ä¸ªç±»ååéæ© ID æ¥å®ä¹ãID å¯¹åºä¸ä¸ª V4L2 å¯¹è±¡ï¼ä¾å¦<br>ä¸ä¸ªæ§å¶ IDãå¦ææªä½¿ç¨ï¼å ID ä¸º 0ã</p>
<p>å½ç¨æ·è®¢éä¸ä¸ªäºä»¶ï¼é©±å¨ä¼ä¸ºæ­¤åéä¸äº kevent ç»æä½ãæä»¥æ¯ä¸ª<br>äºä»¶ç»ï¼ç±»åãIDï¼é½ä¼æèªå·±çä¸å¥ kevent ç»æä½ãè¿ä¿è¯äºå¦æ<br>ä¸ä¸ªé©±å¨ç­æ¶é´åäº§çäºè®¸å¤åç±»äºä»¶ï¼ä¸ä¼è¦çå¶ä»ç±»åçäºä»¶ã</p>
<p>ä½å¦æä½ æ¶å°çäºä»¶æ°éå¤§äºåç±»äºä»¶ kevent çä¿å­æ°éï¼åææ©ç<br>äºä»¶å°è¢«ä¸¢å¼ï¼å¹¶å å¥æ°äºä»¶ã</p>
<p>æ­¤å¤ï¼v4l2_subscribed_event ç»æä½åé¨æå¯ä¾é©±å¨è®¾ç½®ç merge() å<br>replace() åè°ï¼è¿äºåè°ä¼å¨æ°äºä»¶äº§çä¸æ²¡æå¤ä½ç©ºé´çæ¶åè¢«è°ç¨ã<br>replace() åè°è®©ä½ å¯ä»¥å°æ©æäºä»¶çåè·æ¿æ¢ä¸ºæ°äºä»¶çåè·ï¼å°æ©æ<br>åè·çç¸å³æ°æ®åå¹¶å°æ¿æ¢è¿æ¥çæ°åè·ä¸­ãå½è¯¥ç±»åçäºä»¶ä»åéäºä¸ä¸ª<br>kevent ç»æä½æ¶ï¼å®å°è¢«è°ç¨ãmerge() åè°è®©ä½ å¯ä»¥åå¹¶ææ©çäºä»¶åè·<br>å°å¨å®ä¹åçé£ä¸ªäºä»¶åè·ä¸­ãå½è¯¥ç±»åçäºä»¶åéäºä¸¤ä¸ªææ´å¤ kevent<br>ç»æä½æ¶ï¼å®å°è¢«è°ç¨ã</p>
<p>è¿ç§æ¹æ³ä¸ä¼æç¶æä¿¡æ¯ä¸¢å¤±ï¼åªä¼å¯¼è´ä¸­é´æ­¥éª¤ä¿¡æ¯ä¸¢å¤±ã</p>
<p>å³äº replace/merge åè°çä¸ä¸ªä¸éçä¾å­å¨ v4l2-event.c ä¸­ï¼ç¨äº<br>æ§å¶äºä»¶ç ctrls_replace() å ctrls_merge() åè°ã</p>
<p>æ³¨æï¼è¿äºåè°å¯ä»¥å¨ä¸­æ­ä¸ä¸æä¸­è°ç¨ï¼æä»¥å®ä»¬å¿é¡»å°½å¿«å®æå¹¶éåºã</p>
<p>æç¨çå½æ°ï¼</p>
<p>void v4l2_event_queue(struct video_device *vdev, const struct v4l2_event *ev)</p>
<p>  å°äºä»¶å å¥è§é¢è®¾å¤çéåãé©±å¨ä»è´è´£å¡«å type å data åã<br>  å¶ä»åç± V4L2 å¡«åã</p>
<p>int v4l2_event_subscribe(struct v4l2_fh *fh,<br>             struct v4l2_event_subscription *sub, unsigned elems,<br>             const struct v4l2_subscribed_event_ops *ops)</p>
<p>  video_device-&gt;ioctl_ops-&gt;vidioc_subscribe_event å¿é¡»æ£æµé©±å¨è½<br>  äº§çç¹å® id çäºä»¶ãç¶åè°ç¨ v4l2_event_subscribe() æ¥è®¢éè¯¥äºä»¶ã</p>
<p>  elems åæ°æ¯è¯¥äºä»¶çéåå¤§å°ãè¥ä¸º 0ï¼V4L2 æ¡æ¶å°ä¼ï¼æ ¹æ®äºä»¶ç±»åï¼<br>  å¡«åé»è®¤å¼ã</p>
<p>  ops åæ°åè®¸é©±å¨æå®ä¸ç³»ååè°ï¼</p>
<ul>
<li>add:     å½æ·»å ä¸ä¸ªæ°çå¬èæ¶è°ç¨ï¼éå¤è®¢éåä¸ä¸ªäºä»¶ï¼æ­¤åè°<pre><code>     ä»è¢«æ§è¡ä¸æ¬¡ï¼ã
</code></pre>
</li>
<li>del:     å½ä¸ä¸ªçå¬èåæ­¢çå¬æ¶è°ç¨ã</li>
<li>replace: ç¨âæ°âäºä»¶æ¿æ¢âæ©æâäºä»¶ã</li>
<li>merge:   å°âæ©æâäºä»¶åå¹¶å°âæ°âäºä»¶ä¸­ã<br>è¿åä¸ªè°ç¨é½æ¯å¯éçï¼å¦æä¸æ³æå®ä»»ä½åè°ï¼å ops å¯ä¸º NULLã</li>
</ul>
<p>int v4l2_event_unsubscribe(struct v4l2_fh *fh,<br>               struct v4l2_event_subscription *sub)</p>
<p>  v4l2_ioctl_ops ç»æä½ä¸­ç vidioc_unsubscribe_event åè°å½æ°ã<br>  é©±å¨ç¨åºå¯ä»¥ç´æ¥ä½¿ç¨ v4l2_event_unsubscribe() å®ç°éè®¢äºä»¶è¿ç¨ã</p>
<p>  ç¹æ®ç V4L2_EVENT_ALL ç±»åï¼å¯ç¨äºéè®¢ææäºä»¶ãé©±å¨å¯è½å¨ç¹æ®<br>  æåµä¸éè¦åæ­¤æä½ã</p>
<p>int v4l2_event_pending(struct v4l2_fh *fh)</p>
<p>  è¿åæªå³äºä»¶çæ°éãæå©äºå®ç°è½®è¯¢ï¼pollï¼æä½ã</p>
<p>äºä»¶éè¿ poll ç³»ç»è°ç¨ä¼ éå°ç¨æ·ç©ºé´ãé©±å¨å¯ç¨<br>v4l2_fh-&gt;wait (wait_queue_head_t ç±»å)ä½ä¸ºåæ°è°ç¨ poll_wait()ã</p>
<p>äºä»¶åä¸ºæ åäºä»¶åç§æäºä»¶ãæ°çæ åäºä»¶å¿é¡»ä½¿ç¨å¯ç¨çæå°äºä»¶ç±»å<br>ç¼å·ãé©±å¨å¿é¡»ä»ä»ä»¬æ¬ç±»åçç¼å·èµ·å§å¤åéäºä»¶ãç±»åçç¼å·èµ·å§ä¸º<br>V4L2_EVENT_PRIVATE_START + n * 1000 ï¼å¶ä¸­ n ä¸ºå¯ç¨æå°ç¼å·ãæ¯ä¸ª<br>ç±»åä¸­çç¬¬ä¸ä¸ªäºä»¶ç±»åç¼å·æ¯ä¸ºä»¥åçä½¿ç¨ä¿ççï¼æä»¥ç¬¬ä¸ä¸ªå¯ç¨äºä»¶<br>ç±»åç¼å·æ¯âclass base + 1âã</p>
<p>V4L2 äºä»¶æºå¶çä½¿ç¨å®ä¾å¯ä»¥å¨ OMAP3 ISP çé©±å¨<br>(drivers/media/video/omap3isp)ä¸­æ¾å°ã</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_v4l2-framework/" title="Kernel-4.18.0-80.el8_v4l2-framework" target="_blank" rel="external">http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_v4l2-framework/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_ncr53c8xx/" title="Kernel-4.18.0-80.el8_ncr53c8xx"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_allwinner,sunxi-nmi/" title="Kernel-4.18.0-80.el8_allwinner,sunxi-nmi"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>