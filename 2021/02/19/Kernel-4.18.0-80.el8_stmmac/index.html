<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-4.18.0-80.el8_stmmac | oosTech.com</title>
  <meta name="description" content="STMicroelectronics 10&#x2F;100&#x2F;1000 Synopsys Ethernet driver  Copyright (C) 2007-2015  STMicroelectronics LtdAuthor: Giuseppe Cavallaro &amp;#112;&amp;#101;&amp;#x70;&amp;#x70;&amp;#101;&amp;#x2e;&amp;#x63;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x6c;">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-4.18.0-80.el8_stmmac">
<meta property="og:url" content="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_stmmac/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="STMicroelectronics 10&#x2F;100&#x2F;1000 Synopsys Ethernet driver  Copyright (C) 2007-2015  STMicroelectronics LtdAuthor: Giuseppe Cavallaro &amp;#112;&amp;#101;&amp;#x70;&amp;#x70;&amp;#101;&amp;#x2e;&amp;#x63;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x6c;">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:modified_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_stmmac/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ethtool-S-ethX"><span class="toc-number">1.</span> <span class="toc-text">ethtool -S ethX</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-4.18.0-80.el8_stmmac" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-4.18.0-80.el8_stmmac
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_stmmac/" class="article-date">
	 published: <time datetime="2021-02-18T16:00:00.000Z" itemprop="datePublished">2021-02-19</time>
	</a>
</span>

        
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_stmmac/" class="article-date">
	   updated: <time datetime="2021-02-18T16:00:00.000Z" itemprop="dateUpdated">2021-02-19</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/02/19/Kernel-4.18.0-80.el8_stmmac/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <pre><code>   STMicroelectronics 10/100/1000 Synopsys Ethernet driver
</code></pre>
<p>Copyright (C) 2007-2015  STMicroelectronics Ltd<br>Author: Giuseppe Cavallaro <a href="mailto:&#112;&#101;&#x70;&#x70;&#101;&#x2e;&#x63;&#x61;&#x76;&#x61;&#x6c;&#x6c;&#97;&#114;&#x6f;&#x40;&#115;&#x74;&#x2e;&#x63;&#x6f;&#x6d;">&#112;&#101;&#x70;&#x70;&#101;&#x2e;&#x63;&#x61;&#x76;&#x61;&#x6c;&#x6c;&#97;&#114;&#x6f;&#x40;&#115;&#x74;&#x2e;&#x63;&#x6f;&#x6d;</a></p>
<p>This is the driver for the MAC 10/100/1000 on-chip Ethernet controllers<br>(Synopsys IP blocks).</p>
<p>Currently this network device driver is for all STi embedded MAC/GMAC<br>(i.e. 7xxx/5xxx SoCs), SPEAr (arm), Loongson1B (mips) and XLINX XC2V3000<br>FF1152AMT0221 D1215994A VIRTEX FPGA board.</p>
<p>DWC Ether MAC 10/100/1000 Universal version 3.70a (and older) and DWC Ether<br>MAC 10/100 Universal version 4.0 have been used for developing this driver.</p>
<p>This driver supports both the platform bus and PCI.</p>
<p>Please, for more information also visit: <a target="_blank" rel="noopener" href="http://www.stlinux.com/">www.stlinux.com</a></p>
<ol>
<li>Kernel Configuration<br>The kernel configuration option is STMMAC_ETH:<br>Device Drivers —&gt; Network device support —&gt; Ethernet (1000 Mbit) —&gt;<br>STMicroelectronics 10/100/1000 Ethernet driver (STMMAC_ETH)</li>
</ol>
<p>CONFIG_STMMAC_PLATFORM: is to enable the platform driver.<br>CONFIG_STMMAC_PCI: is to enable the pci driver.</p>
<ol start="2">
<li><p>Driver parameters list:<br> debug: message level (0: no output, 16: all);<br> phyaddr: to manually provide the physical address to the PHY device;<br> buf_sz: DMA buffer size;<br> tc: control the HW FIFO threshold;<br> watchdog: transmit timeout (in milliseconds);<br> flow_ctrl: Flow control ability [on/off];<br> pause: Flow Control Pause Time;<br> eee_timer: tx EEE timer;<br> chain_mode: select chain mode instead of ring.</p>
</li>
<li><p>Command line options<br>Driver parameters can be also passed in command line by using:<br> stmmaceth=watchdog:100,chain_mode=1</p>
</li>
<li><p>Driver information and notes</p>
</li>
</ol>
<p>4.1) Transmit process<br>The xmit method is invoked when the kernel needs to transmit a packet; it sets<br>the descriptors in the ring and informs the DMA engine, that there is a packet<br>ready to be transmitted.<br>By default, the driver sets the NETIF_F_SG bit in the features field of the<br>net_device structure, enabling the scatter-gather feature. This is true on<br>chips and configurations where the checksum can be done in hardware.<br>Once the controller has finished transmitting the packet, timer will be<br>scheduled to release the transmit resources.</p>
<p>4.2) Receive process<br>When one or more packets are received, an interrupt happens. The interrupts<br>are not queued, so the driver has to scan all the descriptors in the ring during<br>the receive process.<br>This is based on NAPI, so the interrupt handler signals only if there is work<br>to be done, and it exits.<br>Then the poll method will be scheduled at some future point.<br>The incoming packets are stored, by the DMA, in a list of pre-allocated socket<br>buffers in order to avoid the memcpy (zero-copy).</p>
<p>4.3) Interrupt mitigation<br>The driver is able to mitigate the number of its DMA interrupts<br>using NAPI for the reception on chips older than the 3.50.<br>New chips have an HW RX-Watchdog used for this mitigation.<br>Mitigation parameters can be tuned by ethtool.</p>
<p>4.4) WOL<br>Wake up on Lan feature through Magic and Unicast frames are supported for the<br>GMAC core.</p>
<p>4.5) DMA descriptors<br>Driver handles both normal and alternate descriptors. The latter has been only<br>tested on DWC Ether MAC 10/100/1000 Universal version 3.41a and later.</p>
<p>STMMAC supports DMA descriptor to operate both in dual buffer (RING)<br>and linked-list(CHAINED) mode. In RING each descriptor points to two<br>data buffer pointers whereas in CHAINED mode they point to only one data<br>buffer pointer. RING mode is the default.</p>
<p>In CHAINED mode each descriptor will have pointer to next descriptor in<br>the list, hence creating the explicit chaining in the descriptor itself,<br>whereas such explicit chaining is not possible in RING mode.</p>
<p>4.5.1) Extended descriptors<br>The extended descriptors give us information about the Ethernet payload<br>when it is carrying PTP packets or TCP/UDP/ICMP over IP.<br>These are not available on GMAC Synopsys chips older than the 3.50.<br>At probe time the driver will decide if these can be actually used.<br>This support also is mandatory for PTPv2 because the extra descriptors<br>are used for saving the hardware timestamps and Extended Status.</p>
<p>4.6) Ethtool support<br>Ethtool is supported.</p>
<p>For example, driver statistics (including RMON), internal errors can be taken<br>using:</p>
<h1 id="ethtool-S-ethX"><a href="#ethtool-S-ethX" class="headerlink" title="ethtool -S ethX"></a>ethtool -S ethX</h1><p>command</p>
<p>4.7) Jumbo and Segmentation Offloading<br>Jumbo frames are supported and tested for the GMAC.<br>The GSO has been also added but it’s performed in software.<br>LRO is not supported.</p>
<p>4.8) Physical<br>The driver is compatible with Physical Abstraction Layer to be connected with<br>PHY and GPHY devices.</p>
<p>4.9) Platform information<br>Several information can be passed through the platform and device-tree.</p>
<p>struct plat_stmmacenet_data {<br>    char *phy_bus_name;<br>    int bus_id;<br>    int phy_addr;<br>    int interface;<br>    struct stmmac_mdio_bus_data *mdio_bus_data;<br>    struct stmmac_dma_cfg *dma_cfg;<br>    int clk_csr;<br>    int has_gmac;<br>    int enh_desc;<br>    int tx_coe;<br>    int rx_coe;<br>    int bugged_jumbo;<br>    int pmt;<br>    int force_sf_dma_mode;<br>    int force_thresh_dma_mode;<br>    int riwt_off;<br>    int max_speed;<br>    int maxmtu;<br>    void (*fix_mac_speed)(void *priv, unsigned int speed);<br>    void (*bus_setup)(void __iomem *ioaddr);<br>    int (*init)(struct platform_device *pdev, void *priv);<br>    void (*exit)(struct platform_device *pdev, void *priv);<br>    void *bsp_priv;<br>    int has_gmac4;<br>    bool tso_en;<br>};</p>
<p>Where:<br> o phy_bus_name: phy bus name to attach to the stmmac.<br> o bus_id: bus identifier.<br> o phy_addr: the physical address can be passed from the platform.<br>        If it is set to -1 the driver will automatically<br>        detect it at run-time by probing all the 32 addresses.<br> o interface: PHY device’s interface.<br> o mdio_bus_data: specific platform fields for the MDIO bus.<br> o dma_cfg: internal DMA parameters<br>   o pbl: the Programmable Burst Length is maximum number of beats to<br>       be transferred in one DMA transaction.<br>       GMAC also enables the 4xPBL by default. (8xPBL for GMAC 3.50 and newer)<br>   o txpbl/rxpbl: GMAC and newer supports independent DMA pbl for tx/rx.<br>   o pblx8: Enable 8xPBL (4xPBL for core rev &lt; 3.50). Enabled by default.<br>   o fixed_burst/mixed_burst/aal<br> o clk_csr: fixed CSR Clock range selection.<br> o has_gmac: uses the GMAC core.<br> o enh_desc: if sets the MAC will use the enhanced descriptor structure.<br> o tx_coe: core is able to perform the tx csum in HW.<br> o rx_coe: the supports three check sum offloading engine types:<br>       type_1, type_2 (full csum) and no RX coe.<br> o bugged_jumbo: some HWs are not able to perform the csum in HW for<br>        over-sized frames due to limited buffer sizes.<br>        Setting this flag the csum will be done in SW on<br>        JUMBO frames.<br> o pmt: core has the embedded power module (optional).<br> o force_sf_dma_mode: force DMA to use the Store and Forward mode<br>             instead of the Threshold.<br> o force_thresh_dma_mode: force DMA to use the Threshold mode other than<br>             the Store and Forward mode.<br> o riwt_off: force to disable the RX watchdog feature and switch to NAPI mode.<br> o fix_mac_speed: this callback is used for modifying some syscfg registers<br>         (on ST SoCs) according to the link speed negotiated by the<br>         physical layer .<br> o bus_setup: perform HW setup of the bus. For example, on some ST platforms<br>         this field is used to configure the AMBA  bridge to generate more<br>         efficient STBus traffic.<br> o init/exit: callbacks used for calling a custom initialization;<br>         this is sometime necessary on some platforms (e.g. ST boxes)<br>         where the HW needs to have set some PIO lines or system cfg<br>         registers.  init/exit callbacks should not use or modify<br>         platform data.<br> o bsp_priv: another private pointer.<br> o has_gmac4: uses GMAC4 core.<br> o tso_en: Enables TSO (TCP Segmentation Offload) feature.</p>
<p>For MDIO bus The we have:</p>
<p> struct stmmac_mdio_bus_data {<br>    int (*phy_reset)(void *priv);<br>    unsigned int phy_mask;<br>    int *irqs;<br>    int probed_phy_irq;<br> };</p>
<p>Where:<br> o phy_reset: hook to reset the phy device attached to the bus.<br> o phy_mask: phy mask passed when register the MDIO bus within the driver.<br> o irqs: list of IRQs, one per PHY.<br> o probed_phy_irq: if irqs is NULL, use this for probed PHY.</p>
<p>For DMA engine we have the following internal fields that should be<br>tuned according to the HW capabilities.</p>
<p>struct stmmac_dma_cfg {<br>    int pbl;<br>    int txpbl;<br>    int rxpbl;<br>    bool pblx8;<br>    int fixed_burst;<br>    int mixed_burst;<br>    bool aal;<br>};</p>
<p>Where:<br> o pbl: Programmable Burst Length (tx and rx)<br> o txpbl: Transmit Programmable Burst Length. Only for GMAC and newer.<br>     If set, DMA tx will use this value rather than pbl.<br> o rxpbl: Receive Programmable Burst Length. Only for GMAC and newer.<br>     If set, DMA rx will use this value rather than pbl.<br> o pblx8: Enable 8xPBL (4xPBL for core rev &lt; 3.50). Enabled by default.<br> o fixed_burst: program the DMA to use the fixed burst mode<br> o mixed_burst: program the DMA to use the mixed burst mode<br> o aal: Address-Aligned Beats</p>
<hr>
<p>Below an example how the structures above are using on ST platforms.</p>
<p> static struct plat_stmmacenet_data stxYYY_ethernet_platform_data = {<br>    .has_gmac = 0,<br>    .enh_desc = 0,<br>    .fix_mac_speed = stxYYY_ethernet_fix_mac_speed,<br>                |<br>                |-&gt; to write an internal syscfg<br>                |   on this platform when the<br>                |   link speed changes from 10 to<br>                |   100 and viceversa<br>    .init = &amp;stmmac_claim_resource,<br>                |<br>                |-&gt; On ST SoC this calls own “PAD”<br>                |   manager framework to claim<br>                |   all the resources necessary<br>                |   (GPIO …). The .custom_cfg field<br>                |   is used to pass a custom config.<br>};</p>
<p>Below the usage of the stmmac_mdio_bus_data: on this SoC, in fact,<br>there are two MAC cores: one MAC is for MDIO Bus/PHY emulation<br>with fixed_link support.</p>
<p>static struct stmmac_mdio_bus_data stmmac1_mdio_bus = {<br>    .phy_reset = phy_reset;<br>        |<br>        |-&gt; function to provide the phy_reset on this board<br>    .phy_mask = 0,<br>};</p>
<p>static struct fixed_phy_status stmmac0_fixed_phy_status = {<br>    .link = 1,<br>    .speed = 100,<br>    .duplex = 1,<br>};</p>
<p>During the board’s device_init we can configure the first<br>MAC for fixed_link by calling:<br>  fixed_phy_add(PHY_POLL, 1, &amp;stmmac0_fixed_phy_status, -1);<br>and the second one, with a real PHY device attached to the bus,<br>by using the stmmac_mdio_bus_data structure (to provide the id, the<br>reset procedure etc).</p>
<p>Note that, starting from new chips, where it is available the HW capability<br>register, many configurations are discovered at run-time for example to<br>understand if EEE, HW csum, PTP, enhanced descriptor etc are actually<br>available. As strategy adopted in this driver, the information from the HW<br>capability register can replace what has been passed from the platform.</p>
<p>4.10) Device-tree support.</p>
<p>Please see the following document:<br>    Documentation/devicetree/bindings/net/stmmac.txt</p>
<p>4.11) This is a summary of the content of some relevant files:<br> o stmmac_main.c: implements the main network device driver;<br> o stmmac_mdio.c: provides MDIO functions;<br> o stmmac_pci: this is the PCI driver;<br> o stmmac_platform.c: this the platform driver (OF supported);<br> o stmmac_ethtool.c: implements the ethtool support;<br> o stmmac.h: private driver structure;<br> o common.h: common definitions and VFTs;<br> o mmc_core.c/mmc.h: Management MAC Counters;<br> o stmmac_hwtstamp.c: HW timestamp support for PTP;<br> o stmmac_ptp.c: PTP 1588 clock;<br> o stmmac_pcs.h: Physical Coding Sublayer common implementation;<br> o dwmac-<XXX>.c: these are for the platform glue-logic file; e.g. dwmac-sti.c<br>   for STMicroelectronics SoCs.</p>
<ul>
<li><p>GMAC 3.x<br>o descs.h: descriptor structure definitions;<br>o dwmac1000_core.c: dwmac GiGa core functions;<br>o dwmac1000_dma.c: dma functions for the GMAC chip;<br>o dwmac1000.h: specific header file for the dwmac GiGa;<br>o dwmac100_core: dwmac 100 core code;<br>o dwmac100_dma.c: dma functions for the dwmac 100 chip;<br>o dwmac1000.h: specific header file for the MAC;<br>o dwmac_lib.c: generic DMA functions;<br>o enh_desc.c: functions for handling enhanced descriptors;<br>o norm_desc.c: functions for handling normal descriptors;<br>o chain_mode.c/ring_mode.c:: functions to manage RING/CHAINED modes;</p>
</li>
<li><p>GMAC4.x generation<br>o dwmac4_core.c: dwmac GMAC4.x core functions;<br>o dwmac4_desc.c: functions for handling GMAC4.x descriptors;<br>o dwmac4_descs.h: descriptor definitions;<br>o dwmac4_dma.c: dma functions for the GMAC4.x chip;<br>o dwmac4_dma.h: dma definitions for the GMAC4.x chip;<br>o dwmac4.h: core definitions for the GMAC4.x chip;<br>o dwmac4_lib.c: generic GMAC4.x functions;</p>
</li>
</ul>
<p>4.12) TSO support (GMAC4.x)</p>
<p>TSO (Tcp Segmentation Offload) feature is supported by GMAC 4.x chip family.<br>When a packet is sent through TCP protocol, the TCP stack ensures that<br>the SKB provided to the low level driver (stmmac in our case) matches with<br>the maximum frame len (IP header + TCP header + payload &lt;= 1500 bytes (for<br>MTU set to 1500)). It means that if an application using TCP want to send a<br>packet which will have a length (after adding headers) &gt; 1514 the packet<br>will be split in several TCP packets: The data payload is split and headers<br>(TCP/IP ..) are added. It is done by software.</p>
<p>When TSO is enabled, the TCP stack doesn’t care about the maximum frame<br>length and provide SKB packet to stmmac as it is. The GMAC IP will have to<br>perform the segmentation by it self to match with maximum frame length.</p>
<p>This feature can be enabled in device tree through “snps,tso” entry.</p>
<ol start="5">
<li>Debug Information</li>
</ol>
<p>The driver exports many information i.e. internal statistics,<br>debug information, MAC and DMA registers etc.</p>
<p>These can be read in several ways depending on the<br>type of the information actually needed.</p>
<p>For example a user can be use the ethtool support<br>to get statistics: e.g. using: ethtool -S ethX<br>(that shows the Management counters (MMC) if supported)<br>or sees the MAC/DMA registers: e.g. using: ethtool -d ethX</p>
<p>Compiling the Kernel with CONFIG_DEBUG_FS the driver will export the following<br>debugfs entries:</p>
<p>/sys/kernel/debug/stmmaceth/descriptors_status<br>  To show the DMA TX/RX descriptor rings</p>
<p>Developer can also use the “debug” module parameter to get further debug<br>information (please see: NETIF Msg Level).</p>
<ol start="6">
<li>Energy Efficient Ethernet</li>
</ol>
<p>Energy Efficient Ethernet(EEE) enables IEEE 802.3 MAC sublayer along<br>with a family of Physical layer to operate in the Low power Idle(LPI)<br>mode. The EEE mode supports the IEEE 802.3 MAC operation at 100Mbps,<br>1000Mbps &amp; 10Gbps.</p>
<p>The LPI mode allows power saving by switching off parts of the<br>communication device functionality when there is no data to be<br>transmitted &amp; received. The system on both the side of the link can<br>disable some functionalities &amp; save power during the period of low-link<br>utilization. The MAC controls whether the system should enter or exit<br>the LPI mode &amp; communicate this to PHY.</p>
<p>As soon as the interface is opened, the driver verifies if the EEE can<br>be supported. This is done by looking at both the DMA HW capability<br>register and the PHY devices MCD registers.<br>To enter in Tx LPI mode the driver needs to have a software timer<br>that enable and disable the LPI mode when there is nothing to be<br>transmitted.</p>
<ol start="7">
<li>Precision Time Protocol (PTP)<br>The driver supports the IEEE 1588-2002, Precision Time Protocol (PTP),<br>which enables precise synchronization of clocks in measurement and<br>control systems implemented with technologies such as network<br>communication.</li>
</ol>
<p>In addition to the basic timestamp features mentioned in IEEE 1588-2002<br>Timestamps, new GMAC cores support the advanced timestamp features.<br>IEEE 1588-2008 that can be enabled when configure the Kernel.</p>
<ol start="8">
<li>SGMII/RGMII support<br>New GMAC devices provide own way to manage RGMII/SGMII.<br>This information is available at run-time by looking at the<br>HW capability register. This means that the stmmac can manage<br>auto-negotiation and link status w/o using the PHYLIB stuff.<br>In fact, the HW provides a subset of extended registers to<br>restart the ANE, verify Full/Half duplex mode and Speed.<br>Thanks to these registers, it is possible to look at the<br>Auto-negotiated Link Parter Ability.</li>
</ol>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_stmmac/" title="Kernel-4.18.0-80.el8_stmmac" target="_blank" rel="external">http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_stmmac/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_stm32/" title="Kernel-4.18.0-80.el8_stm32"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_stmp3xxx-rtc/" title="Kernel-4.18.0-80.el8_stmp3xxx-rtc"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>