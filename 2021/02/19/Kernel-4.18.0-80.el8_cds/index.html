<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-4.18.0-80.el8_cds | oosTech.com</title>
  <meta name="description" content="Linux for S&#x2F;390 and zSeries Common Device Support (CDS)Device Driver I&#x2F;O Support Routines Authors : Ingo Adlung      Cornelia Huck Copyright, IBM Corp. 1999-2002 Introduction This document describes t">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-4.18.0-80.el8_cds">
<meta property="og:url" content="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_cds/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="Linux for S&#x2F;390 and zSeries Common Device Support (CDS)Device Driver I&#x2F;O Support Routines Authors : Ingo Adlung      Cornelia Huck Copyright, IBM Corp. 1999-2002 Introduction This document describes t">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:modified_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_cds/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_mpc5200/" class="title">Kernel-3.10.0-957.el7_mpc5200</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_6pack/" class="title">Kernel-3.10.0-957.el7_6pack</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-4.18.0-80.el8_cds" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-4.18.0-80.el8_cds
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_cds/" class="article-date">
	 published: <time datetime="2021-02-18T16:00:00.000Z" itemprop="datePublished">2021-02-19</time>
	</a>
</span>

        
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_cds/" class="article-date">
	   updated: <time datetime="2021-02-18T16:00:00.000Z" itemprop="dateUpdated">2021-02-19</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/02/19/Kernel-4.18.0-80.el8_cds/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>Linux for S/390 and zSeries</p>
<p>Common Device Support (CDS)<br>Device Driver I/O Support Routines</p>
<p>Authors : Ingo Adlung<br>      Cornelia Huck</p>
<p>Copyright, IBM Corp. 1999-2002</p>
<p>Introduction</p>
<p>This document describes the common device support routines for Linux/390.<br>Different than other hardware architectures, ESA/390 has defined a unified<br>I/O access method. This gives relief to the device drivers as they don’t<br>have to deal with different bus types, polling versus interrupt<br>processing, shared versus non-shared interrupt processing, DMA versus port<br>I/O (PIO), and other hardware features more. However, this implies that<br>either every single device driver needs to implement the hardware I/O<br>attachment functionality itself, or the operating system provides for a<br>unified method to access the hardware, providing all the functionality that<br>every single device driver would have to provide itself.</p>
<p>The document does not intend to explain the ESA/390 hardware architecture in<br>every detail.This information can be obtained from the ESA/390 Principles of<br>Operation manual (IBM Form. No. SA22-7201).</p>
<p>In order to build common device support for ESA/390 I/O interfaces, a<br>functional layer was introduced that provides generic I/O access methods to<br>the hardware. </p>
<p>The common device support layer comprises the I/O support routines defined<br>below. Some of them implement common Linux device driver interfaces, while<br>some of them are ESA/390 platform specific.</p>
<p>Note:<br>In order to write a driver for S/390, you also need to look into the interface<br>described in Documentation/s390/driver-model.txt.</p>
<p>Note for porting drivers from 2.4:<br>The major changes are:</p>
<ul>
<li>The functions use a ccw_device instead of an irq (subchannel).</li>
<li>All drivers must define a ccw_driver (see driver-model.txt) and the associated<br>functions.</li>
<li>request_irq() and free_irq() are no longer done by the driver.</li>
<li>The oper_handler is (kindof) replaced by the probe() and set_online() functions<br>of the ccw_driver.</li>
<li>The not_oper_handler is (kindof) replaced by the remove() and set_offline()<br>functions of the ccw_driver.</li>
<li>The channel device layer is gone.</li>
<li>The interrupt handlers must be adapted to use a ccw_device as argument.<br>Moreover, they don’t return a devstat, but an irb.</li>
<li>Before initiating an io, the options must be set via ccw_device_set_options().</li>
<li>Instead of calling read_dev_chars()/read_conf_data(), the driver issues<br>the channel program and handles the interrupt itself.</li>
</ul>
<p>ccw_device_get_ciw()<br>   get commands from extended sense data.</p>
<p>ccw_device_start()<br>ccw_device_start_timeout()<br>ccw_device_start_key()<br>ccw_device_start_key_timeout()<br>   initiate an I/O request.</p>
<p>ccw_device_resume()<br>   resume channel program execution.</p>
<p>ccw_device_halt()<br>   terminate the current I/O request processed on the device.</p>
<p>do_IRQ()<br>   generic interrupt routine. This function is called by the interrupt entry<br>   routine whenever an I/O interrupt is presented to the system. The do_IRQ()<br>   routine determines the interrupt status and calls the device specific<br>   interrupt handler according to the rules (flags) defined during I/O request<br>   initiation with do_IO().</p>
<p>The next chapters describe the functions other than do_IRQ() in more details.<br>The do_IRQ() interface is not described, as it is called from the Linux/390<br>first level interrupt handler only and does not comprise a device driver<br>callable interface. Instead, the functional description of do_IO() also<br>describes the input to the device specific interrupt handler.</p>
<p>Note: All explanations apply also to the 64 bit architecture s390x.</p>
<p>Common Device Support (CDS) for Linux/390 Device Drivers</p>
<p>General Information</p>
<p>The following chapters describe the I/O related interface routines the<br>Linux/390 common device support (CDS) provides to allow for device specific<br>driver implementations on the IBM ESA/390 hardware platform. Those interfaces<br>intend to provide the functionality required by every device driver<br>implementation to allow to drive a specific hardware device on the ESA/390<br>platform. Some of the interface routines are specific to Linux/390 and some<br>of them can be found on other Linux platforms implementations too.<br>Miscellaneous function prototypes, data declarations, and macro definitions<br>can be found in the architecture specific C header file<br>linux/arch/s390/include/asm/irq.h.</p>
<p>Overview of CDS interface concepts</p>
<p>Different to other hardware platforms, the ESA/390 architecture doesn’t define<br>interrupt lines managed by a specific interrupt controller and bus systems<br>that may or may not allow for shared interrupts, DMA processing, etc.. Instead,<br>the ESA/390 architecture has implemented a so called channel subsystem, that<br>provides a unified view of the devices physically attached to the systems.<br>Though the ESA/390 hardware platform knows about a huge variety of different<br>peripheral attachments like disk devices (aka. DASDs), tapes, communication<br>controllers, etc. they can all be accessed by a well defined access method and<br>they are presenting I/O completion a unified way : I/O interruptions. Every<br>single device is uniquely identified to the system by a so called subchannel,<br>where the ESA/390 architecture allows for 64k devices be attached.</p>
<p>Linux, however, was first built on the Intel PC architecture, with its two<br>cascaded 8259 programmable interrupt controllers (PICs), that allow for a<br>maximum of 15 different interrupt lines. All devices attached to such a system<br>share those 15 interrupt levels. Devices attached to the ISA bus system must<br>not share interrupt levels (aka. IRQs), as the ISA bus bases on edge triggered<br>interrupts. MCA, EISA, PCI and other bus systems base on level triggered<br>interrupts, and therewith allow for shared IRQs. However, if multiple devices<br>present their hardware status by the same (shared) IRQ, the operating system<br>has to call every single device driver registered on this IRQ in order to<br>determine the device driver owning the device that raised the interrupt.</p>
<p>Up to kernel 2.4, Linux/390 used to provide interfaces via the IRQ (subchannel).<br>For internal use of the common I/O layer, these are still there. However,<br>device drivers should use the new calling interface via the ccw_device only.</p>
<p>During its startup the Linux/390 system checks for peripheral devices. Each<br>of those devices is uniquely defined by a so called subchannel by the ESA/390<br>channel subsystem. While the subchannel numbers are system generated, each<br>subchannel also takes a user defined attribute, the so called device number.<br>Both subchannel number and device number cannot exceed 65535. During sysfs<br>initialisation, the information about control unit type and device types that<br>imply specific I/O commands (channel command words - CCWs) in order to operate<br>the device are gathered. Device drivers can retrieve this set of hardware<br>information during their initialization step to recognize the devices they<br>support using the information saved in the struct ccw_device given to them.<br>This methods implies that Linux/390 doesn’t require to probe for free (not<br>armed) interrupt request lines (IRQs) to drive its devices with. Where<br>applicable, the device drivers can use issue the READ DEVICE CHARACTERISTICS<br>ccw to retrieve device characteristics in its online routine.</p>
<p>In order to allow for easy I/O initiation the CDS layer provides a<br>ccw_device_start() interface that takes a device specific channel program (one<br>or more CCWs) as input sets up the required architecture specific control blocks<br>and initiates an I/O request on behalf of the device driver. The<br>ccw_device_start() routine allows to specify whether it expects the CDS layer<br>to notify the device driver for every interrupt it observes, or with final status<br>only. See ccw_device_start() for more details. A device driver must never issue<br>ESA/390 I/O commands itself, but must use the Linux/390 CDS interfaces instead.</p>
<p>For long running I/O request to be canceled, the CDS layer provides the<br>ccw_device_halt() function. Some devices require to initially issue a HALT<br>SUBCHANNEL (HSCH) command without having pending I/O requests. This function is<br>also covered by ccw_device_halt().</p>
<p>get_ciw() - get command information word</p>
<p>This call enables a device driver to get information about supported commands<br>from the extended SenseID data.</p>
<p>struct ciw *<br>ccw_device_get_ciw(struct ccw_device *cdev, __u32 cmd);</p>
<p>cdev - The ccw_device for which the command is to be retrieved.<br>cmd  - The command type to be retrieved.</p>
<p>ccw_device_get_ciw() returns:<br>NULL    - No extended data available, invalid device or command not found.<br>!NULL   - The command requested.</p>
<p>ccw_device_start() - Initiate I/O Request</p>
<p>The ccw_device_start() routines is the I/O request front-end processor. All<br>device driver I/O requests must be issued using this routine. A device driver<br>must not issue ESA/390 I/O commands itself. Instead the ccw_device_start()<br>routine provides all interfaces required to drive arbitrary devices.</p>
<p>This description also covers the status information passed to the device<br>driver’s interrupt handler as this is related to the rules (flags) defined<br>with the associated I/O request when calling ccw_device_start().</p>
<p>int ccw_device_start(struct ccw_device *cdev,<br>             struct ccw1 *cpa,<br>             unsigned long intparm,<br>             __u8 lpm,<br>             unsigned long flags);<br>int ccw_device_start_timeout(struct ccw_device *cdev,<br>                 struct ccw1 *cpa,<br>                 unsigned long intparm,<br>                 __u8 lpm,<br>                 unsigned long flags,<br>                 int expires);<br>int ccw_device_start_key(struct ccw_device *cdev,<br>             struct ccw1 *cpa,<br>             unsigned long intparm,<br>             __u8 lpm,<br>             __u8 key,<br>             unsigned long flags);<br>int ccw_device_start_key_timeout(struct ccw_device *cdev,<br>                 struct ccw1 *cpa,<br>                 unsigned long intparm,<br>                 __u8 lpm,<br>                 __u8 key,<br>                 unsigned long flags,<br>                 int expires);</p>
<p>cdev         : ccw_device the I/O is destined for<br>cpa          : logical start address of channel program<br>user_intparm : user specific interrupt information; will be presented<br>           back to the device driver’s interrupt handler. Allows a<br>               device driver to associate the interrupt with a<br>               particular I/O request.<br>lpm          : defines the channel path to be used for a specific I/O<br>               request. A value of 0 will make cio use the opm.<br>key         : the storage key to use for the I/O (useful for operating on a<br>           storage with a storage key != default key)<br>flag         : defines the action to be performed for I/O processing<br>expires      : timeout value in jiffies. The common I/O layer will terminate<br>           the running program after this and call the interrupt handler<br>           with ERR_PTR(-ETIMEDOUT) as irb.</p>
<p>Possible flag values are :</p>
<p>DOIO_ALLOW_SUSPEND       - channel program may become suspended<br>DOIO_DENY_PREFETCH       - don’t allow for CCW prefetch; usually<br>                           this implies the channel program might<br>                           become modified<br>DOIO_SUPPRESS_INTER     - don’t call the handler on intermediate status</p>
<p>The cpa parameter points to the first format 1 CCW of a channel program :</p>
<p>struct ccw1 {<br>      __u8  cmd_code;/* command code <em>/<br>      __u8  flags;   /</em> flags, like IDA addressing, etc. <em>/<br>      __u16 count;   /</em> byte count <em>/<br>      __u32 cda;     /</em> data address */<br>} <strong>attribute</strong> ((packed,aligned(8)));</p>
<p>with the following CCW flags values defined :</p>
<p>CCW_FLAG_DC        - data chaining<br>CCW_FLAG_CC        - command chaining<br>CCW_FLAG_SLI       - suppress incorrect length<br>CCW_FLAG_SKIP      - skip<br>CCW_FLAG_PCI       - PCI<br>CCW_FLAG_IDA       - indirect addressing<br>CCW_FLAG_SUSPEND   - suspend</p>
<p>Via ccw_device_set_options(), the device driver may specify the following<br>options for the device:</p>
<p>DOIO_EARLY_NOTIFICATION  - allow for early interrupt notification<br>DOIO_REPORT_ALL          - report all interrupt conditions</p>
<p>The ccw_device_start() function returns :</p>
<pre><code>  0 - successful completion or request successfully initiated
</code></pre>
<p>-EBUSY    - The device is currently processing a previous I/O request, or there is<br>          a status pending at the device.<br>-ENODEV - cdev is invalid, the device is not operational or the ccw_device is<br>          not online.</p>
<p>When the I/O request completes, the CDS first level interrupt handler will<br>accumulate the status in a struct irb and then call the device interrupt handler.<br>The intparm field will contain the value the device driver has associated with a<br>particular I/O request. If a pending device status was recognized,<br>intparm will be set to 0 (zero). This may happen during I/O initiation or delayed<br>by an alert status notification. In any case this status is not related to the<br>current (last) I/O request. In case of a delayed status notification no special<br>interrupt will be presented to indicate I/O completion as the I/O request was<br>never started, even though ccw_device_start() returned with successful completion.</p>
<p>The irb may contain an error value, and the device driver should check for this<br>first:</p>
<p>-ETIMEDOUT: the common I/O layer terminated the request after the specified<br>            timeout value<br>-EIO:       the common I/O layer terminated the request due to an error state</p>
<p>If the concurrent sense flag in the extended status word (esw) in the irb is<br>set, the field erw.scnt in the esw describes the number of device specific<br>sense bytes available in the extended control word irb-&gt;scsw.ecw[]. No device<br>sensing by the device driver itself is required.</p>
<p>The device interrupt handler can use the following definitions to investigate<br>the primary unit check source coded in sense byte 0 :</p>
<p>SNS0_CMD_REJECT         0x80<br>SNS0_INTERVENTION_REQ   0x40<br>SNS0_BUS_OUT_CHECK      0x20<br>SNS0_EQUIPMENT_CHECK    0x10<br>SNS0_DATA_CHECK         0x08<br>SNS0_OVERRUN            0x04<br>SNS0_INCOMPL_DOMAIN     0x01</p>
<p>Depending on the device status, multiple of those values may be set together.<br>Please refer to the device specific documentation for details.</p>
<p>The irb-&gt;scsw.cstat field provides the (accumulated) subchannel status :</p>
<p>SCHN_STAT_PCI            - program controlled interrupt<br>SCHN_STAT_INCORR_LEN     - incorrect length<br>SCHN_STAT_PROG_CHECK     - program check<br>SCHN_STAT_PROT_CHECK     - protection check<br>SCHN_STAT_CHN_DATA_CHK   - channel data check<br>SCHN_STAT_CHN_CTRL_CHK   - channel control check<br>SCHN_STAT_INTF_CTRL_CHK  - interface control check<br>SCHN_STAT_CHAIN_CHECK    - chaining check</p>
<p>The irb-&gt;scsw.dstat field provides the (accumulated) device status :</p>
<p>DEV_STAT_ATTENTION   - attention<br>DEV_STAT_STAT_MOD    - status modifier<br>DEV_STAT_CU_END      - control unit end<br>DEV_STAT_BUSY        - busy<br>DEV_STAT_CHN_END     - channel end<br>DEV_STAT_DEV_END     - device end<br>DEV_STAT_UNIT_CHECK  - unit check<br>DEV_STAT_UNIT_EXCEP  - unit exception</p>
<p>Please see the ESA/390 Principles of Operation manual for details on the<br>individual flag meanings.</p>
<p>Usage Notes :</p>
<p>ccw_device_start() must be called disabled and with the ccw device lock held.</p>
<p>The device driver is allowed to issue the next ccw_device_start() call from<br>within its interrupt handler already. It is not required to schedule a<br>bottom-half, unless a non deterministically long running error recovery procedure<br>or similar needs to be scheduled. During I/O processing the Linux/390 generic<br>I/O device driver support has already obtained the IRQ lock, i.e. the handler<br>must not try to obtain it again when calling ccw_device_start() or we end in a<br>deadlock situation!</p>
<p>If a device driver relies on an I/O request to be completed prior to start the<br>next it can reduce I/O processing overhead by chaining a NoOp I/O command<br>CCW_CMD_NOOP to the end of the submitted CCW chain. This will force Channel-End<br>and Device-End status to be presented together, with a single interrupt.<br>However, this should be used with care as it implies the channel will remain<br>busy, not being able to process I/O requests for other devices on the same<br>channel. Therefore e.g. read commands should never use this technique, as the<br>result will be presented by a single interrupt anyway.</p>
<p>In order to minimize I/O overhead, a device driver should use the<br>DOIO_REPORT_ALL  only if the device can report intermediate interrupt<br>information prior to device-end the device driver urgently relies on. In this<br>case all I/O interruptions are presented to the device driver until final<br>status is recognized.</p>
<p>If a device is able to recover from asynchronously presented I/O errors, it can<br>perform overlapping I/O using the DOIO_EARLY_NOTIFICATION flag. While some<br>devices always report channel-end and device-end together, with a single<br>interrupt, others present primary status (channel-end) when the channel is<br>ready for the next I/O request and secondary status (device-end) when the data<br>transmission has been completed at the device.</p>
<p>Above flag allows to exploit this feature, e.g. for communication devices that<br>can handle lost data on the network to allow for enhanced I/O processing.</p>
<p>Unless the channel subsystem at any time presents a secondary status interrupt,<br>exploiting this feature will cause only primary status interrupts to be<br>presented to the device driver while overlapping I/O is performed. When a<br>secondary status without error (alert status) is presented, this indicates<br>successful completion for all overlapping ccw_device_start() requests that have<br>been issued since the last secondary (final) status.</p>
<p>Channel programs that intend to set the suspend flag on a channel command word<br>(CCW)  must start the I/O operation with the DOIO_ALLOW_SUSPEND option or the<br>suspend flag will cause a channel program check. At the time the channel program<br>becomes suspended an intermediate interrupt will be generated by the channel<br>subsystem.</p>
<p>ccw_device_resume() - Resume Channel Program Execution </p>
<p>If a device driver chooses to suspend the current channel program execution by<br>setting the CCW suspend flag on a particular CCW, the channel program execution<br>is suspended. In order to resume channel program execution the CIO layer<br>provides the ccw_device_resume() routine. </p>
<p>int ccw_device_resume(struct ccw_device *cdev);</p>
<p>cdev - ccw_device the resume operation is requested for</p>
<p>The ccw_device_resume() function returns:</p>
<pre><code>    0  - suspended channel program is resumed
</code></pre>
<p>-EBUSY     - status pending<br>-ENODEV    - cdev invalid or not-operational subchannel<br>-EINVAL    - resume function not applicable<br>-ENOTCONN  - there is no I/O request pending for completion </p>
<p>Usage Notes:<br>Please have a look at the ccw_device_start() usage notes for more details on<br>suspended channel programs.</p>
<p>ccw_device_halt() - Halt I/O Request Processing</p>
<p>Sometimes a device driver might need a possibility to stop the processing of<br>a long-running channel program or the device might require to initially issue<br>a halt subchannel (HSCH) I/O command. For those purposes the ccw_device_halt()<br>command is provided.</p>
<p>ccw_device_halt() must be called disabled and with the ccw device lock held.</p>
<p>int ccw_device_halt(struct ccw_device *cdev,<br>                    unsigned long intparm);</p>
<p>cdev    : ccw_device the halt operation is requested for<br>intparm : interruption parameter; value is only used if no I/O<br>          is outstanding, otherwise the intparm associated with<br>          the I/O request is returned</p>
<p>The ccw_device_halt() function returns :</p>
<pre><code>  0 - request successfully initiated
</code></pre>
<p>-EBUSY  - the device is currently busy, or status pending.<br>-ENODEV - cdev invalid.<br>-EINVAL - The device is not operational or the ccw device is not online.</p>
<p>Usage Notes :</p>
<p>A device driver may write a never-ending channel program by writing a channel<br>program that at its end loops back to its beginning by means of a transfer in<br>channel (TIC)   command (CCW_CMD_TIC). Usually this is performed by network<br>device drivers by setting the PCI CCW flag (CCW_FLAG_PCI). Once this CCW is<br>executed a program controlled interrupt (PCI) is generated. The device driver<br>can then perform an appropriate action. Prior to interrupt of an outstanding<br>read to a network device (with or without PCI flag) a ccw_device_halt()<br>is required to end the pending operation.</p>
<p>ccw_device_clear() - Terminage I/O Request Processing</p>
<p>In order to terminate all I/O processing at the subchannel, the clear subchannel<br>(CSCH) command is used. It can be issued via ccw_device_clear().</p>
<p>ccw_device_clear() must be called disabled and with the ccw device lock held.</p>
<p>int ccw_device_clear(struct ccw_device *cdev, unsigned long intparm);</p>
<p>cdev:     ccw_device the clear operation is requested for<br>intparm: interruption parameter (see ccw_device_halt())</p>
<p>The ccw_device_clear() function returns:</p>
<pre><code>  0 - request successfully initiated
</code></pre>
<p>-ENODEV - cdev invalid<br>-EINVAL - The device is not operational or the ccw device is not online.</p>
<p>Miscellaneous Support Routines</p>
<p>This chapter describes various routines to be used in a Linux/390 device<br>driver programming environment.</p>
<p>get_ccwdev_lock()</p>
<p>Get the address of the device specific lock. This is then used in<br>spin_lock() / spin_unlock() calls.</p>
<p>__u8 ccw_device_get_path_mask(struct ccw_device *cdev);</p>
<p>Get the mask of the path currently available for cdev.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_cds/" title="Kernel-4.18.0-80.el8_cds" target="_blank" rel="external">http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_cds/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_cdrom/" title="Kernel-4.18.0-80.el8_cdro"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_cgroups/" title="Kernel-4.18.0-80.el8_cgroups"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>