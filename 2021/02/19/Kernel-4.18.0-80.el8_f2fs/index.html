<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-4.18.0-80.el8_f2fs | oosTech.com</title>
  <meta name="description" content="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;WHAT IS Flash-Friendly File System (F2FS)?&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-4.18.0-80.el8_f2fs">
<meta property="og:url" content="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_f2fs/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;WHAT IS Flash-Friendly File System (F2FS)?&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:modified_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_f2fs/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_mpc5200/" class="title">Kernel-3.10.0-957.el7_mpc5200</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_6pack/" class="title">Kernel-3.10.0-957.el7_6pack</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Log-structured-File-System-LFS"><span class="toc-number">1.</span> <span class="toc-text">Log-structured File System (LFS)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wandering-Tree-Problem"><span class="toc-number">2.</span> <span class="toc-text">Wandering Tree Problem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cleaning-Overhead"><span class="toc-number">3.</span> <span class="toc-text">Cleaning Overhead</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flash-Awareness"><span class="toc-number">4.</span> <span class="toc-text">Flash Awareness</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wandering-Tree-Problem-1"><span class="toc-number">5.</span> <span class="toc-text">Wandering Tree Problem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cleaning-Overhead-1"><span class="toc-number">6.</span> <span class="toc-text">Cleaning Overhead</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#insmod-f2fs-ko"><span class="toc-number"></span> <span class="toc-text">insmod f2fs.ko</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mkdir-mnt-f2fs"><span class="toc-number"></span> <span class="toc-text">mkdir &#x2F;mnt&#x2F;f2fs</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mkfs-f2fs-l-label-dev-block-device"><span class="toc-number"></span> <span class="toc-text">mkfs.f2fs -l label &#x2F;dev&#x2F;block_device</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mount-t-f2fs-dev-block-device-mnt-f2fs"><span class="toc-number"></span> <span class="toc-text">mount -t f2fs &#x2F;dev&#x2F;block_device &#x2F;mnt&#x2F;f2fs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mkfs-f2fs"><span class="toc-number">1.</span> <span class="toc-text">mkfs.f2fs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fsck-f2fs"><span class="toc-number">2.</span> <span class="toc-text">fsck.f2fs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dump-f2fs"><span class="toc-number">3.</span> <span class="toc-text">dump.f2fs</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dump-f2fs-i-ino-dev-sdx"><span class="toc-number"></span> <span class="toc-text">dump.f2fs -i [ino] &#x2F;dev&#x2F;sdx</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dump-f2fs-s-0-1-dev-sdx-SIT-dump"><span class="toc-number"></span> <span class="toc-text">dump.f2fs -s 0~-1 &#x2F;dev&#x2F;sdx (SIT dump)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dump-f2fs-a-0-1-dev-sdx-SSA-dump"><span class="toc-number"></span> <span class="toc-text">dump.f2fs -a 0~-1 &#x2F;dev&#x2F;sdx (SSA dump)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#On-disk-Layout"><span class="toc-number">1.</span> <span class="toc-text">On-disk Layout</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#File-System-Metadata-Structure"><span class="toc-number">2.</span> <span class="toc-text">File System Metadata Structure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Index-Structure"><span class="toc-number">3.</span> <span class="toc-text">Index Structure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Directory-Structure"><span class="toc-number">4.</span> <span class="toc-text">Directory Structure</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#of-blocks-in-level-n"><span class="toc-number"></span> <span class="toc-text">of blocks in level #n &#x3D; |</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#of-buckets-in-level-n"><span class="toc-number"></span> <span class="toc-text">of buckets in level #n &#x3D; |</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Default-Block-Allocation"><span class="toc-number">1.</span> <span class="toc-text">Default Block Allocation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cleaning-process"><span class="toc-number">2.</span> <span class="toc-text">Cleaning process</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Write-hint-Policy"><span class="toc-number">3.</span> <span class="toc-text">Write-hint Policy</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-4.18.0-80.el8_f2fs" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-4.18.0-80.el8_f2fs
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_f2fs/" class="article-date">
	 published: <time datetime="2021-02-18T16:00:00.000Z" itemprop="datePublished">2021-02-19</time>
	</a>
</span>

        
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_f2fs/" class="article-date">
	   updated: <time datetime="2021-02-18T16:00:00.000Z" itemprop="dateUpdated">2021-02-19</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/02/19/Kernel-4.18.0-80.el8_f2fs/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>================================================================================<br>WHAT IS Flash-Friendly File System (F2FS)?<br>================================================================================</p>
<p>NAND flash memory-based storage devices, such as SSD, eMMC, and SD cards, have<br>been equipped on a variety systems ranging from mobile to server systems. Since<br>they are known to have different characteristics from the conventional rotating<br>disks, a file system, an upper layer to the storage device, should adapt to the<br>changes from the sketch in the design level.</p>
<p>F2FS is a file system exploiting NAND flash memory-based storage devices, which<br>is based on Log-structured File System (LFS). The design has been focused on<br>addressing the fundamental issues in LFS, which are snowball effect of wandering<br>tree and high cleaning overhead.</p>
<p>Since a NAND flash memory-based storage device shows different characteristic<br>according to its internal geometry or flash memory management scheme, namely FTL,<br>F2FS and its tools support various parameters not only for configuring on-disk<br>layout, but also for selecting allocation and cleaning algorithms.</p>
<p>The following git tree provides the file system formatting tool (mkfs.f2fs),<br>a consistency checking tool (fsck.f2fs), and a debugging tool (dump.f2fs).</p>
<blockquote>
<blockquote>
<p>git://git.kernel.org/pub/scm/linux/kernel/git/jaegeuk/f2fs-tools.git</p>
</blockquote>
</blockquote>
<p>For reporting bugs and sending patches, please use the following mailing list:</p>
<blockquote>
<blockquote>
<p><a href="mailto:&#108;&#x69;&#110;&#x75;&#x78;&#x2d;&#x66;&#x32;&#102;&#x73;&#x2d;&#100;&#101;&#118;&#x65;&#108;&#64;&#108;&#x69;&#x73;&#x74;&#115;&#46;&#x73;&#111;&#117;&#x72;&#99;&#x65;&#102;&#111;&#114;&#x67;&#101;&#x2e;&#x6e;&#101;&#x74;">&#108;&#x69;&#110;&#x75;&#x78;&#x2d;&#x66;&#x32;&#102;&#x73;&#x2d;&#100;&#101;&#118;&#x65;&#108;&#64;&#108;&#x69;&#x73;&#x74;&#115;&#46;&#x73;&#111;&#117;&#x72;&#99;&#x65;&#102;&#111;&#114;&#x67;&#101;&#x2e;&#x6e;&#101;&#x74;</a></p>
</blockquote>
</blockquote>
<p>================================================================================<br>BACKGROUND AND DESIGN ISSUES<br>================================================================================</p>
<h2 id="Log-structured-File-System-LFS"><a href="#Log-structured-File-System-LFS" class="headerlink" title="Log-structured File System (LFS)"></a>Log-structured File System (LFS)</h2><p>“A log-structured file system writes all modifications to disk sequentially in<br>a log-like structure, thereby speeding up  both file writing and crash recovery.<br>The log is the only structure on disk; it contains indexing information so that<br>files can be read back from the log efficiently. In order to maintain large free<br>areas on disk for fast writing, we divide  the log into segments and use a<br>segment cleaner to compress the live information from heavily fragmented<br>segments.” from Rosenblum, M. and Ousterhout, J. K., 1992, “The design and<br>implementation of a log-structured file system”, ACM Trans. Computer Systems<br>10, 1, 26â52.</p>
<h2 id="Wandering-Tree-Problem"><a href="#Wandering-Tree-Problem" class="headerlink" title="Wandering Tree Problem"></a>Wandering Tree Problem</h2><p>In LFS, when a file data is updated and written to the end of log, its direct<br>pointer block is updated due to the changed location. Then the indirect pointer<br>block is also updated due to the direct pointer block update. In this manner,<br>the upper index structures such as inode, inode map, and checkpoint block are<br>also updated recursively. This problem is called as wandering tree problem [1],<br>and in order to enhance the performance, it should eliminate or relax the update<br>propagation as much as possible.</p>
<p>[1] Bityutskiy, A. 2005. JFFS3 design issues. <a target="_blank" rel="noopener" href="http://www.linux-mtd.infradead.org/">http://www.linux-mtd.infradead.org/</a></p>
<h2 id="Cleaning-Overhead"><a href="#Cleaning-Overhead" class="headerlink" title="Cleaning Overhead"></a>Cleaning Overhead</h2><p>Since LFS is based on out-of-place writes, it produces so many obsolete blocks<br>scattered across the whole storage. In order to serve new empty log space, it<br>needs to reclaim these obsolete blocks seamlessly to users. This job is called<br>as a cleaning process.</p>
<p>The process consists of three operations as follows.</p>
<ol>
<li>A victim segment is selected through referencing segment usage table.</li>
<li>It loads parent index structures of all the data in the victim identified by<br>segment summary blocks.</li>
<li>It checks the cross-reference between the data and its parent index structure.</li>
<li>It moves valid data selectively.</li>
</ol>
<p>This cleaning job may cause unexpected long delays, so the most important goal<br>is to hide the latencies to users. And also definitely, it should reduce the<br>amount of valid data to be moved, and move them quickly as well.</p>
<p>================================================================================<br>KEY FEATURES<br>================================================================================</p>
<h2 id="Flash-Awareness"><a href="#Flash-Awareness" class="headerlink" title="Flash Awareness"></a>Flash Awareness</h2><ul>
<li>Enlarge the random write area for better performance, but provide the high<br>spatial locality</li>
<li>Align FS data structures to the operational units in FTL as best efforts</li>
</ul>
<h2 id="Wandering-Tree-Problem-1"><a href="#Wandering-Tree-Problem-1" class="headerlink" title="Wandering Tree Problem"></a>Wandering Tree Problem</h2><ul>
<li>Use a term, ânodeâ, that represents inodes as well as various pointer blocks</li>
<li>Introduce Node Address Table (NAT) containing the locations of all the ânodeâ<br>blocks; this will cut off the update propagation.</li>
</ul>
<h2 id="Cleaning-Overhead-1"><a href="#Cleaning-Overhead-1" class="headerlink" title="Cleaning Overhead"></a>Cleaning Overhead</h2><ul>
<li>Support a background cleaning process</li>
<li>Support greedy and cost-benefit algorithms for victim selection policies</li>
<li>Support multi-head logs for static/dynamic hot and cold data separation</li>
<li>Introduce adaptive logging for efficient block allocation</li>
</ul>
<p>================================================================================<br>MOUNT OPTIONS<br>================================================================================</p>
<p>background_gc=%s       Turn on/off cleaning operations, namely garbage<br>                       collection, triggered in background when I/O subsystem is<br>                       idle. If background_gc=on, it will turn on the garbage<br>                       collection and if background_gc=off, garbage collection<br>                       will be turned off. If background_gc=sync, it will turn<br>                       on synchronous garbage collection running in background.<br>                       Default value for this option is on. So garbage<br>                       collection is on by default.<br>disable_roll_forward   Disable the roll-forward recovery routine<br>norecovery             Disable the roll-forward recovery routine, mounted read-<br>                       only (i.e., -o ro,disable_roll_forward)<br>discard/nodiscard      Enable/disable real-time discard in f2fs, if discard is<br>                       enabled, f2fs will issue discard/TRIM commands when a<br>               segment is cleaned.<br>no_heap                Disable heap-style segment allocation which finds free<br>                       segments for data from the beginning of main area, while<br>               for node from the end of main area.<br>nouser_xattr           Disable Extended User Attributes. Note: xattr is enabled<br>                       by default if CONFIG_F2FS_FS_XATTR is selected.<br>noacl                  Disable POSIX Access Control List. Note: acl is enabled<br>                       by default if CONFIG_F2FS_FS_POSIX_ACL is selected.<br>active_logs=%u         Support configuring the number of active logs. In the<br>                       current design, f2fs supports only 2, 4, and 6 logs.<br>                       Default number is 6.<br>disable_ext_identify   Disable the extension list configured by mkfs, so f2fs<br>                       does not aware of cold files such as media files.<br>inline_xattr           Enable the inline xattrs feature.<br>noinline_xattr         Disable the inline xattrs feature.<br>inline_data            Enable the inline data feature: New created small(&lt;~3.4k)<br>                       files can be written into inode block.<br>inline_dentry          Enable the inline dir feature: data in new created<br>                       directory entries can be written into inode block. The<br>                       space of inode block which is used to store inline<br>                       dentries is limited to ~3.4k.<br>noinline_dentry        Disable the inline dentry feature.<br>flush_merge           Merge concurrent cache_flush commands as much as possible<br>                       to eliminate redundant command issues. If the underlying<br>               device handles the cache_flush command relatively slowly,<br>               recommend to enable this option.<br>nobarrier              This option can be used if underlying storage guarantees<br>                       its cached data should be written to the novolatile area.<br>               If this option is set, no cache_flush commands are issued<br>               but f2fs still guarantees the write ordering of all the<br>               data writes.<br>fastboot               This option is used when a system wants to reduce mount<br>                       time as much as possible, even though normal performance<br>               can be sacrificed.<br>extent_cache           Enable an extent cache based on rb-tree, it can cache<br>                       as many as extent which map between contiguous logical<br>                       address and physical address per inode, resulting in<br>                       increasing the cache hit ratio. Set by default.<br>noextent_cache         Disable an extent cache based on rb-tree explicitly, see<br>                       the above extent_cache mount option.<br>noinline_data          Disable the inline data feature, inline data feature is<br>                       enabled by default.<br>data_flush             Enable data flushing before checkpoint in order to<br>                       persist data of regular and symlink.<br>fault_injection=%d     Enable fault injection in all supported types with<br>                       specified injection rate.<br>mode=%s                Control block allocation mode which supports “adaptive”<br>                       and “lfs”. In “lfs” mode, there should be no random<br>                       writes towards main area.<br>io_bits=%u             Set the bit size of write IO requests. It should be set<br>                       with “mode=lfs”.<br>usrquota               Enable plain user disk quota accounting.<br>grpquota               Enable plain group disk quota accounting.<br>prjquota               Enable plain project quota accounting.<br>usrjquota=<file>       Appoint specified file and type during mount, so that quota<br>grpjquota=<file>       information can be properly updated during recovery flow,<br>prjjquota=<file>       <quota file>: must be in root directory;<br>jqfmt=<quota type>     <quota type>: [vfsold,vfsv0,vfsv1].<br>offusrjquota           Turn off user journelled quota.<br>offgrpjquota           Turn off group journelled quota.<br>offprjjquota           Turn off project journelled quota.<br>quota                  Enable plain user disk quota accounting.<br>noquota                Disable all plain disk quota option.<br>whint_mode=%s          Control which write hints are passed down to block<br>                       layer. This supports “off”, “user-based”, and<br>                       “fs-based”.  In “off” mode (default), f2fs does not pass<br>                       down hints. In “user-based” mode, f2fs tries to pass<br>                       down hints given by users. And in “fs-based” mode, f2fs<br>                       passes down hints with its policy.<br>alloc_mode=%s          Adjust block allocation policy, which supports “reuse”<br>                       and “default”.<br>fsync_mode=%s          Control the policy of fsync. Currently supports “posix”,<br>                       “strict”, and “nobarrier”. In “posix” mode, which is<br>                       default, fsync will follow POSIX semantics and does a<br>                       light operation to improve the filesystem performance.<br>                       In “strict” mode, fsync will be heavy and behaves in line<br>                       with xfs, ext4 and btrfs, where xfstest generic/342 will<br>                       pass, but the performance will regress. “nobarrier” is<br>                       based on “posix”, but doesn’t issue flush command for<br>                       non-atomic files likewise “nobarrier” mount option.<br>test_dummy_encryption  Enable dummy encryption, which provides a fake fscrypt<br>                       context. The fake fscrypt context is used by xfstests.</p>
<p>================================================================================<br>DEBUGFS ENTRIES<br>================================================================================</p>
<p>/sys/kernel/debug/f2fs/ contains information about all the partitions mounted as<br>f2fs. Each file shows the whole f2fs information.</p>
<p>/sys/kernel/debug/f2fs/status includes:</p>
<ul>
<li>major file system information managed by f2fs currently</li>
<li>average SIT information about whole segments</li>
<li>current memory footprint consumed by f2fs.</li>
</ul>
<p>================================================================================<br>SYSFS ENTRIES<br>================================================================================</p>
<p>Information about mounted f2fs file systems can be found in<br>/sys/fs/f2fs.  Each mounted filesystem will have a directory in<br>/sys/fs/f2fs based on its device name (i.e., /sys/fs/f2fs/sda).<br>The files in each per-device directory are shown in table below.</p>
<p>Files in /sys/fs/f2fs/<devname><br>(see also Documentation/ABI/testing/sysfs-fs-f2fs)<br>……………………………………………………………………<br> File                         Content</p>
<p> gc_max_sleep_time            This tuning parameter controls the maximum sleep<br>                              time for the garbage collection thread. Time is<br>                              in milliseconds.</p>
<p> gc_min_sleep_time            This tuning parameter controls the minimum sleep<br>                              time for the garbage collection thread. Time is<br>                              in milliseconds.</p>
<p> gc_no_gc_sleep_time          This tuning parameter controls the default sleep<br>                              time for the garbage collection thread. Time is<br>                              in milliseconds.</p>
<p> gc_idle                      This parameter controls the selection of victim<br>                              policy for garbage collection. Setting gc_idle = 0<br>                              (default) will disable this option. Setting<br>                              gc_idle = 1 will select the Cost Benefit approach<br>                              &amp; setting gc_idle = 2 will select the greedy approach.</p>
<p> gc_urgent                    This parameter controls triggering background GCs<br>                              urgently or not. Setting gc_urgent = 0 [default]<br>                              makes back to default behavior, while if it is set<br>                              to 1, background thread starts to do GC by given<br>                              gc_urgent_sleep_time interval.</p>
<p> gc_urgent_sleep_time         This parameter controls sleep time for gc_urgent.<br>                              500 ms is set by default. See above gc_urgent.</p>
<p> reclaim_segments             This parameter controls the number of prefree<br>                              segments to be reclaimed. If the number of prefree<br>                  segments is larger than the number of segments<br>                  in the proportion to the percentage over total<br>                  volume size, f2fs tries to conduct checkpoint to<br>                  reclaim the prefree segments to free segments.<br>                  By default, 5% over total # of segments.</p>
<p> max_small_discards          This parameter controls the number of discard<br>                  commands that consist small blocks less than 2MB.<br>                  The candidates to be discarded are cached until<br>                  checkpoint is triggered, and issued during the<br>                  checkpoint. By default, it is disabled with 0.</p>
<p> trim_sections                This parameter controls the number of sections<br>                              to be trimmed out in batch mode when FITRIM<br>                              conducts. 32 sections is set by default.</p>
<p> ipu_policy                   This parameter controls the policy of in-place<br>                              updates in f2fs. There are five policies:<br>                               0x01: F2FS_IPU_FORCE, 0x02: F2FS_IPU_SSR,<br>                               0x04: F2FS_IPU_UTIL,  0x08: F2FS_IPU_SSR_UTIL,<br>                               0x10: F2FS_IPU_FSYNC.</p>
<p> min_ipu_util                 This parameter controls the threshold to trigger<br>                              in-place-updates. The number indicates percentage<br>                              of the filesystem utilization, and used by<br>                              F2FS_IPU_UTIL and F2FS_IPU_SSR_UTIL policies.</p>
<p> min_fsync_blocks             This parameter controls the threshold to trigger<br>                              in-place-updates when F2FS_IPU_FSYNC mode is set.<br>                  The number indicates the number of dirty pages<br>                  when fsync needs to flush on its call path. If<br>                  the number is less than this value, it triggers<br>                  in-place-updates.</p>
<p> max_victim_search          This parameter controls the number of trials to<br>                  find a victim segment when conducting SSR and<br>                  cleaning operations. The default value is 4096<br>                  which covers 8GB block address range.</p>
<p> dir_level                    This parameter controls the directory level to<br>                  support large directory. If a directory has a<br>                  number of files, it can reduce the file lookup<br>                  latency by increasing this dir_level value.<br>                  Otherwise, it needs to decrease this value to<br>                  reduce the space overhead. The default value is 0.</p>
<p> ram_thresh                   This parameter controls the memory footprint used<br>                  by free nids and cached nat entries. By default,<br>                  10 is set, which indicates 10 MB / 1 GB RAM.</p>
<p>================================================================================<br>USAGE<br>================================================================================</p>
<ol>
<li><p>Download userland tools and compile them.</p>
</li>
<li><p>Skip, if f2fs was compiled statically inside kernel.<br>Otherwise, insert the f2fs.ko module.</p>
<h1 id="insmod-f2fs-ko"><a href="#insmod-f2fs-ko" class="headerlink" title="insmod f2fs.ko"></a>insmod f2fs.ko</h1></li>
<li><p>Create a directory trying to mount</p>
<h1 id="mkdir-mnt-f2fs"><a href="#mkdir-mnt-f2fs" class="headerlink" title="mkdir /mnt/f2fs"></a>mkdir /mnt/f2fs</h1></li>
<li><p>Format the block device, and then mount as f2fs</p>
<h1 id="mkfs-f2fs-l-label-dev-block-device"><a href="#mkfs-f2fs-l-label-dev-block-device" class="headerlink" title="mkfs.f2fs -l label /dev/block_device"></a>mkfs.f2fs -l label /dev/block_device</h1><h1 id="mount-t-f2fs-dev-block-device-mnt-f2fs"><a href="#mount-t-f2fs-dev-block-device-mnt-f2fs" class="headerlink" title="mount -t f2fs /dev/block_device /mnt/f2fs"></a>mount -t f2fs /dev/block_device /mnt/f2fs</h1></li>
</ol>
<h2 id="mkfs-f2fs"><a href="#mkfs-f2fs" class="headerlink" title="mkfs.f2fs"></a>mkfs.f2fs</h2><p>The mkfs.f2fs is for the use of formatting a partition as the f2fs filesystem,<br>which builds a basic on-disk layout.</p>
<p>The options consist of:<br>-l [label]   : Give a volume label, up to 512 unicode name.<br>-a [0 or 1]  : Split start location of each area for heap-based allocation.<br>               1 is set by default, which performs this.<br>-o [int]     : Set overprovision ratio in percent over volume size.<br>               5 is set by default.<br>-s [int]     : Set the number of segments per section.<br>               1 is set by default.<br>-z [int]     : Set the number of sections per zone.<br>               1 is set by default.<br>-e [str]     : Set basic extension list. e.g. “mp3,gif,mov”<br>-t [0 or 1]  : Disable discard command or not.<br>               1 is set by default, which conducts discard.</p>
<h2 id="fsck-f2fs"><a href="#fsck-f2fs" class="headerlink" title="fsck.f2fs"></a>fsck.f2fs</h2><p>The fsck.f2fs is a tool to check the consistency of an f2fs-formatted<br>partition, which examines whether the filesystem metadata and user-made data<br>are cross-referenced correctly or not.<br>Note that, initial version of the tool does not fix any inconsistency.</p>
<p>The options consist of:<br>  -d debug level [default:0]</p>
<h2 id="dump-f2fs"><a href="#dump-f2fs" class="headerlink" title="dump.f2fs"></a>dump.f2fs</h2><p>The dump.f2fs shows the information of specific inode and dumps SSA and SIT to<br>file. Each file is dump_ssa and dump_sit.</p>
<p>The dump.f2fs is used to debug on-disk data structures of the f2fs filesystem.<br>It shows on-disk inode information recognized by a given inode number, and is<br>able to dump all the SSA and SIT entries into predefined files, ./dump_ssa and<br>./dump_sit respectively.</p>
<p>The options consist of:<br>  -d debug level [default:0]<br>  -i inode no (hex)<br>  -s [SIT dump segno from #1<del>#2 (decimal), for all 0</del>-1]<br>  -a [SSA dump segno from #1<del>#2 (decimal), for all 0</del>-1]</p>
<p>Examples:</p>
<h1 id="dump-f2fs-i-ino-dev-sdx"><a href="#dump-f2fs-i-ino-dev-sdx" class="headerlink" title="dump.f2fs -i [ino] /dev/sdx"></a>dump.f2fs -i [ino] /dev/sdx</h1><h1 id="dump-f2fs-s-0-1-dev-sdx-SIT-dump"><a href="#dump-f2fs-s-0-1-dev-sdx-SIT-dump" class="headerlink" title="dump.f2fs -s 0~-1 /dev/sdx (SIT dump)"></a>dump.f2fs -s 0~-1 /dev/sdx (SIT dump)</h1><h1 id="dump-f2fs-a-0-1-dev-sdx-SSA-dump"><a href="#dump-f2fs-a-0-1-dev-sdx-SSA-dump" class="headerlink" title="dump.f2fs -a 0~-1 /dev/sdx (SSA dump)"></a>dump.f2fs -a 0~-1 /dev/sdx (SSA dump)</h1><p>================================================================================<br>DESIGN<br>================================================================================</p>
<h2 id="On-disk-Layout"><a href="#On-disk-Layout" class="headerlink" title="On-disk Layout"></a>On-disk Layout</h2><p>F2FS divides the whole volume into a number of segments, each of which is fixed<br>to 2MB in size. A section is composed of consecutive segments, and a zone<br>consists of a set of sections. By default, section and zone sizes are set to one<br>segment size identically, but users can easily modify the sizes by mkfs.</p>
<p>F2FS splits the entire volume into six areas, and all the areas except superblock<br>consists of multiple segments as described below.</p>
<pre><code>                                        align with the zone size &lt;-|
             |-&gt; align with the segment size
 _________________________________________________________________________
|            |            |   Segment   |    Node     |   Segment  |      |
| Superblock | Checkpoint |    Info.    |   Address   |   Summary  | Main |
|    (SB)    |   (CP)     | Table (SIT) | Table (NAT) | Area (SSA) |      |
|____________|_____2______|______N______|______N______|______N_____|__N___|
                                                                   .      .
                                                         .                .
                                             .                            .
                                ._________________________________________.
                                |_Segment_|_..._|_Segment_|_..._|_Segment_|
                                .           .
                                ._________._________
                                |_section_|__...__|_
                                .            .
                        .________.
                            |__zone__|
</code></pre>
<ul>
<li><dl><dt>Superblock (SB)</dt><dd>It is located at the beginning of the partition, and there exist two copies<br> to avoid file system crash. It contains basic partition information and some<br> default parameters of f2fs.</dd></dl></li>
<li><dl><dt>Checkpoint (CP)</dt><dd>It contains file system information, bitmaps for valid NAT/SIT sets, orphan<br> inode lists, and summary entries of current active segments.</dd></dl></li>
<li><dl><dt>Segment Information Table (SIT)</dt><dd>It contains segment information such as valid block count and bitmap for the<br> validity of all the blocks.</dd></dl></li>
<li><dl><dt>Node Address Table (NAT)</dt><dd>It is composed of a block address table for all the node blocks stored in<br> Main area.</dd></dl></li>
<li><dl><dt>Segment Summary Area (SSA)</dt><dd>It contains summary entries which contains the owner information of all the<br> data and node blocks stored in Main area.</dd></dl></li>
<li><dl><dt>Main Area</dt><dd>It contains file and directory data including their indices.</dd></dl></li>
</ul>
<p>In order to avoid misalignment between file system and flash-based storage, F2FS<br>aligns the start block address of CP with the segment size. Also, it aligns the<br>start block address of Main area with the zone size by reserving some segments<br>in SSA area.</p>
<p>Reference the following survey for additional technical details.<br><a target="_blank" rel="noopener" href="https://wiki.linaro.org/WorkingGroups/Kernel/Projects/FlashCardSurvey">https://wiki.linaro.org/WorkingGroups/Kernel/Projects/FlashCardSurvey</a></p>
<h2 id="File-System-Metadata-Structure"><a href="#File-System-Metadata-Structure" class="headerlink" title="File System Metadata Structure"></a>File System Metadata Structure</h2><p>F2FS adopts the checkpointing scheme to maintain file system consistency. At<br>mount time, F2FS first tries to find the last valid checkpoint data by scanning<br>CP area. In order to reduce the scanning time, F2FS uses only two copies of CP.<br>One of them always indicates the last valid data, which is called as shadow copy<br>mechanism. In addition to CP, NAT and SIT also adopt the shadow copy mechanism.</p>
<p>For file system consistency, each CP points to which NAT and SIT copies are<br>valid, as shown as below.</p>
<p>  +——–+———-+———+<br>  |   CP   |    SIT   |   NAT   |<br>  +——–+———-+———+<br>  .         .          .          .<br>  .            .              .              .<br>  .               .                 .                 .<br>  +——-+——-+——–+——–+——–+——–+<br>  | CP #0 | CP #1 | SIT #0 | SIT #1 | NAT #0 | NAT #1 |<br>  +——-+——-+——–+——–+——–+——–+<br>     |             ^                          ^<br>     |             |                          |<br>     `—————————————-‘</p>
<h2 id="Index-Structure"><a href="#Index-Structure" class="headerlink" title="Index Structure"></a>Index Structure</h2><p>The key data structure to manage the data locations is a “node”. Similar to<br>traditional file structures, F2FS has three types of node: inode, direct node,<br>indirect node. F2FS assigns 4KB to an inode block which contains 923 data block<br>indices, two direct node pointers, two indirect node pointers, and one double<br>indirect node pointer as described below. One direct node block contains 1018<br>data blocks, and one indirect node block contains also 1018 node blocks. Thus,<br>one inode block (i.e., a file) covers:</p>
<p>  4KB * (923 + 2 * 1018 + 2 * 1018 * 1018 + 1018 * 1018 * 1018) := 3.94TB.</p>
<p>   Inode block (4KB)<br>     |- data (923)<br>     |- direct node (2)<br>     |          <code>- data (1018)      |- indirect node (2)      |            </code>- direct node (1018)<br>     |                       <code>- data (1018)      </code>- double indirect node (1)<br>                         <code>- indirect node (1018)                           </code>- direct node (1018)<br>                                             `- data (1018)</p>
<p>Note that, all the node blocks are mapped by NAT which means the location of<br>each node is translated by the NAT table. In the consideration of the wandering<br>tree problem, F2FS is able to cut off the propagation of node updates caused by<br>leaf data writes.</p>
<h2 id="Directory-Structure"><a href="#Directory-Structure" class="headerlink" title="Directory Structure"></a>Directory Structure</h2><p>A directory entry occupies 11 bytes, which consists of the following attributes.</p>
<ul>
<li>hash        hash value of the file name</li>
<li>ino        inode number</li>
<li>len        the length of file name</li>
<li>type        file type such as directory, symlink, etc</li>
</ul>
<p>A dentry block consists of 214 dentry slots and file names. Therein a bitmap is<br>used to represent whether each dentry is valid or not. A dentry block occupies<br>4KB with the following composition.</p>
<p>  Dentry Block(4 K) = bitmap (27 bytes) + reserved (3 bytes) +<br>                  dentries(11 * 214 bytes) + file name (8 * 214 bytes)</p>
<pre><code>                     [Bucket]
         +--------------------------------+
         |dentry block 1 | dentry block 2 |
         +--------------------------------+
         .               .
   .                             .
</code></pre>
<p>  .       [Dentry Block Structure: 4KB]       .<br>  +——–+———-+———-+————+<br>  | bitmap | reserved | dentries | file names |<br>  +——–+———-+———-+————+<br>  [Dentry Block: 4KB] .   .<br>         .               .<br>            .                          .<br>            +——+——+—–+——+<br>            | hash | ino  | len | type |<br>            +——+——+—–+——+<br>            [Dentry Structure: 11 bytes]</p>
<p>F2FS implements multi-level hash tables for directory structure. Each level has<br>a hash table with dedicated number of hash buckets as shown below. Note that<br>“A(2B)” means a bucket includes 2 data blocks.</p>
<hr>
<p>A : bucket<br>B : block<br>N : MAX_DIR_HASH_DEPTH</p>
<hr>
<p>level #0   | A(2B)<br>           |<br>level #1   | A(2B) - A(2B)<br>           |<br>level #2   | A(2B) - A(2B) - A(2B) - A(2B)<br>     .     |   .       .       .       .<br>level #N/2 | A(2B) - A(2B) - A(2B) - A(2B) - A(2B) - … - A(2B)<br>     .     |   .       .       .       .<br>level #N   | A(4B) - A(4B) - A(4B) - A(4B) - A(4B) - … - A(4B)</p>
<p>The number of blocks and buckets are determined by,</p>
<pre><code>                        ,- 2, if n &lt; MAX_DIR_HASH_DEPTH / 2,
</code></pre>
<h1 id="of-blocks-in-level-n"><a href="#of-blocks-in-level-n" class="headerlink" title="of blocks in level #n = |"></a>of blocks in level #n = |</h1><pre><code>                        `- 4, Otherwise

                         ,- 2^(n + dir_level),
             |        if n + dir_level &lt; MAX_DIR_HASH_DEPTH / 2,
</code></pre>
<h1 id="of-buckets-in-level-n"><a href="#of-buckets-in-level-n" class="headerlink" title="of buckets in level #n = |"></a>of buckets in level #n = |</h1><pre><code>                         `- 2^((MAX_DIR_HASH_DEPTH / 2) - 1),
                      Otherwise
</code></pre>
<p>When F2FS finds a file name in a directory, at first a hash value of the file<br>name is calculated. Then, F2FS scans the hash table in level #0 to find the<br>dentry consisting of the file name and its inode number. If not found, F2FS<br>scans the next hash table in level #1. In this way, F2FS scans hash tables in<br>each levels incrementally from 1 to N. In each levels F2FS needs to scan only<br>one bucket determined by the following equation, which shows O(log(# of files))<br>complexity.</p>
<p>  bucket number to scan in level #n = (hash value) % (# of buckets in level #n)</p>
<p>In the case of file creation, F2FS finds empty consecutive slots that cover the<br>file name. F2FS searches the empty slots in the hash tables of whole levels from<br>1 to N in the same way as the lookup operation.</p>
<p>The following figure shows an example of two cases holding children.<br>       ————–&gt; Dir &lt;————–<br>       |                                 |<br>    child                             child</p>
<pre><code>child - child                     [hole] - child

child - child - child             [hole] - [hole] - child
</code></pre>
<p>   Case 1:                           Case 2:<br>   Number of children = 6,           Number of children = 3,<br>   File size = 7                     File size = 7</p>
<h2 id="Default-Block-Allocation"><a href="#Default-Block-Allocation" class="headerlink" title="Default Block Allocation"></a>Default Block Allocation</h2><p>At runtime, F2FS manages six active logs inside “Main” area: Hot/Warm/Cold node<br>and Hot/Warm/Cold data.</p>
<ul>
<li>Hot node    contains direct node blocks of directories.</li>
<li>Warm node    contains direct node blocks except hot node blocks.</li>
<li>Cold node    contains indirect node blocks</li>
<li>Hot data    contains dentry blocks</li>
<li>Warm data    contains data blocks except hot and cold data blocks</li>
<li>Cold data    contains multimedia data or migrated data blocks</li>
</ul>
<p>LFS has two schemes for free space management: threaded log and copy-and-compac-<br>tion. The copy-and-compaction scheme which is known as cleaning, is well-suited<br>for devices showing very good sequential write performance, since free segments<br>are served all the time for writing new data. However, it suffers from cleaning<br>overhead under high utilization. Contrarily, the threaded log scheme suffers<br>from random writes, but no cleaning process is needed. F2FS adopts a hybrid<br>scheme where the copy-and-compaction scheme is adopted by default, but the<br>policy is dynamically changed to the threaded log scheme according to the file<br>system status.</p>
<p>In order to align F2FS with underlying flash-based storage, F2FS allocates a<br>segment in a unit of section. F2FS expects that the section size would be the<br>same as the unit size of garbage collection in FTL. Furthermore, with respect<br>to the mapping granularity in FTL, F2FS allocates each section of the active<br>logs from different zones as much as possible, since FTL can write the data in<br>the active logs into one allocation unit according to its mapping granularity.</p>
<h2 id="Cleaning-process"><a href="#Cleaning-process" class="headerlink" title="Cleaning process"></a>Cleaning process</h2><p>F2FS does cleaning both on demand and in the background. On-demand cleaning is<br>triggered when there are not enough free segments to serve VFS calls. Background<br>cleaner is operated by a kernel thread, and triggers the cleaning job when the<br>system is idle.</p>
<p>F2FS supports two victim selection policies: greedy and cost-benefit algorithms.<br>In the greedy algorithm, F2FS selects a victim segment having the smallest number<br>of valid blocks. In the cost-benefit algorithm, F2FS selects a victim segment<br>according to the segment age and the number of valid blocks in order to address<br>log block thrashing problem in the greedy algorithm. F2FS adopts the greedy<br>algorithm for on-demand cleaner, while background cleaner adopts cost-benefit<br>algorithm.</p>
<p>In order to identify whether the data in the victim segment are valid or not,<br>F2FS manages a bitmap. Each bit represents the validity of a block, and the<br>bitmap is composed of a bit stream covering whole blocks in main area.</p>
<h2 id="Write-hint-Policy"><a href="#Write-hint-Policy" class="headerlink" title="Write-hint Policy"></a>Write-hint Policy</h2><ol>
<li><p>whint_mode=off. F2FS only passes down WRITE_LIFE_NOT_SET.</p>
</li>
<li><p>whint_mode=user-based. F2FS tries to pass down hints given by<br>users.</p>
</li>
</ol>
<p>User                  F2FS                     Block</p>
<hr>
<pre><code>                  META                     WRITE_LIFE_NOT_SET
                  HOT_NODE                 &quot;
                  WARM_NODE                &quot;
                  COLD_NODE                &quot;
</code></pre>
<p>*ioctl(COLD)          COLD_DATA                WRITE_LIFE_EXTREME<br>*extension list       “                        “</p>
<p>– buffered io<br>WRITE_LIFE_EXTREME    COLD_DATA                WRITE_LIFE_EXTREME<br>WRITE_LIFE_SHORT      HOT_DATA                 WRITE_LIFE_SHORT<br>WRITE_LIFE_NOT_SET    WARM_DATA                WRITE_LIFE_NOT_SET<br>WRITE_LIFE_NONE       “                        “<br>WRITE_LIFE_MEDIUM     “                        “<br>WRITE_LIFE_LONG       “                        “</p>
<p>– direct io<br>WRITE_LIFE_EXTREME    COLD_DATA                WRITE_LIFE_EXTREME<br>WRITE_LIFE_SHORT      HOT_DATA                 WRITE_LIFE_SHORT<br>WRITE_LIFE_NOT_SET    WARM_DATA                WRITE_LIFE_NOT_SET<br>WRITE_LIFE_NONE       “                        WRITE_LIFE_NONE<br>WRITE_LIFE_MEDIUM     “                        WRITE_LIFE_MEDIUM<br>WRITE_LIFE_LONG       “                        WRITE_LIFE_LONG</p>
<ol start="3">
<li>whint_mode=fs-based. F2FS passes down hints with its policy.</li>
</ol>
<p>User                  F2FS                     Block</p>
<hr>
<pre><code>                  META                     WRITE_LIFE_MEDIUM;
                  HOT_NODE                 WRITE_LIFE_NOT_SET
                  WARM_NODE                &quot;
                  COLD_NODE                WRITE_LIFE_NONE
</code></pre>
<p>ioctl(COLD)           COLD_DATA                WRITE_LIFE_EXTREME<br>extension list        “                        “</p>
<p>– buffered io<br>WRITE_LIFE_EXTREME    COLD_DATA                WRITE_LIFE_EXTREME<br>WRITE_LIFE_SHORT      HOT_DATA                 WRITE_LIFE_SHORT<br>WRITE_LIFE_NOT_SET    WARM_DATA                WRITE_LIFE_LONG<br>WRITE_LIFE_NONE       “                        “<br>WRITE_LIFE_MEDIUM     “                        “<br>WRITE_LIFE_LONG       “                        “</p>
<p>– direct io<br>WRITE_LIFE_EXTREME    COLD_DATA                WRITE_LIFE_EXTREME<br>WRITE_LIFE_SHORT      HOT_DATA                 WRITE_LIFE_SHORT<br>WRITE_LIFE_NOT_SET    WARM_DATA                WRITE_LIFE_NOT_SET<br>WRITE_LIFE_NONE       “                        WRITE_LIFE_NONE<br>WRITE_LIFE_MEDIUM     “                        WRITE_LIFE_MEDIUM<br>WRITE_LIFE_LONG       “                        WRITE_LIFE_LONG</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_f2fs/" title="Kernel-4.18.0-80.el8_f2fs" target="_blank" rel="external">http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_f2fs/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_cpusets/" title="Kernel-4.18.0-80.el8_cpusets"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_kernel-options/" title="Kernel-4.18.0-80.el8_kernel-options"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>