<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-4.18.0-80.el8_orangefs | oosTech.com</title>
  <meta name="description" content="ORANGEFSOrangeFS is an LGPL userspace scale-out parallel storage system. It is idealfor large storage problems faced by HPC, BigData, Streaming Video,Genomics, Bioinformatics. Orangefs, originally cal">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-4.18.0-80.el8_orangefs">
<meta property="og:url" content="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_orangefs/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="ORANGEFSOrangeFS is an LGPL userspace scale-out parallel storage system. It is idealfor large storage problems faced by HPC, BigData, Streaming Video,Genomics, Bioinformatics. Orangefs, originally cal">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:modified_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_orangefs/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_mpc5200/" class="title">Kernel-3.10.0-957.el7_mpc5200</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_6pack/" class="title">Kernel-3.10.0-957.el7_6pack</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ORANGEFS"><span class="toc-number">1.</span> <span class="toc-text">ORANGEFS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MAILING-LIST-ARCHIVES"><span class="toc-number">2.</span> <span class="toc-text">MAILING LIST ARCHIVES</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MAILING-LIST-SUBMISSIONS"><span class="toc-number">3.</span> <span class="toc-text">MAILING LIST SUBMISSIONS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DOCUMENTATION"><span class="toc-number">4.</span> <span class="toc-text">DOCUMENTATION</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#USERSPACE-FILESYSTEM-SOURCE"><span class="toc-number">5.</span> <span class="toc-text">USERSPACE FILESYSTEM SOURCE</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RUNNING-ORANGEFS-ON-A-SINGLE-SERVER"><span class="toc-number">6.</span> <span class="toc-text">RUNNING ORANGEFS ON A SINGLE SERVER</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BUILDING-ORANGEFS-ON-A-SINGLE-SERVER"><span class="toc-number">7.</span> <span class="toc-text">BUILDING ORANGEFS ON A SINGLE SERVER</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RUNNING-XFSTESTS"><span class="toc-number">8.</span> <span class="toc-text">RUNNING XFSTESTS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OPTIONS"><span class="toc-number">9.</span> <span class="toc-text">OPTIONS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DEBUGGING"><span class="toc-number">10.</span> <span class="toc-text">DEBUGGING</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PROTOCOL-BETWEEN-KERNEL-MODULE-AND-USERSPACE"><span class="toc-number">11.</span> <span class="toc-text">PROTOCOL BETWEEN KERNEL MODULE AND USERSPACE</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-4.18.0-80.el8_orangefs" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-4.18.0-80.el8_orangefs
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_orangefs/" class="article-date">
	 published: <time datetime="2021-02-18T16:00:00.000Z" itemprop="datePublished">2021-02-19</time>
	</a>
</span>

        
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_orangefs/" class="article-date">
	   updated: <time datetime="2021-02-18T16:00:00.000Z" itemprop="dateUpdated">2021-02-19</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/02/19/Kernel-4.18.0-80.el8_orangefs/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="ORANGEFS"><a href="#ORANGEFS" class="headerlink" title="ORANGEFS"></a>ORANGEFS</h1><p>OrangeFS is an LGPL userspace scale-out parallel storage system. It is ideal<br>for large storage problems faced by HPC, BigData, Streaming Video,<br>Genomics, Bioinformatics.</p>
<p>Orangefs, originally called PVFS, was first developed in 1993 by<br>Walt Ligon and Eric Blumer as a parallel file system for Parallel<br>Virtual Machine (PVM) as part of a NASA grant to study the I/O patterns<br>of parallel programs.</p>
<p>Orangefs features include:</p>
<ul>
<li>Distributes file data among multiple file servers</li>
<li>Supports simultaneous access by multiple clients</li>
<li>Stores file data and metadata on servers using local file system<br>and access methods</li>
<li>Userspace implementation is easy to install and maintain</li>
<li>Direct MPI support</li>
<li>Stateless</li>
</ul>
<h1 id="MAILING-LIST-ARCHIVES"><a href="#MAILING-LIST-ARCHIVES" class="headerlink" title="MAILING LIST ARCHIVES"></a>MAILING LIST ARCHIVES</h1><p><a target="_blank" rel="noopener" href="http://lists.orangefs.org/pipermail/devel_lists.orangefs.org/">http://lists.orangefs.org/pipermail/devel_lists.orangefs.org/</a></p>
<h1 id="MAILING-LIST-SUBMISSIONS"><a href="#MAILING-LIST-SUBMISSIONS" class="headerlink" title="MAILING LIST SUBMISSIONS"></a>MAILING LIST SUBMISSIONS</h1><p><a href="mailto:&#x64;&#101;&#x76;&#x65;&#108;&#x40;&#108;&#x69;&#x73;&#116;&#x73;&#x2e;&#111;&#x72;&#x61;&#x6e;&#x67;&#101;&#102;&#x73;&#46;&#111;&#x72;&#103;">&#x64;&#101;&#x76;&#x65;&#108;&#x40;&#108;&#x69;&#x73;&#116;&#x73;&#x2e;&#111;&#x72;&#x61;&#x6e;&#x67;&#101;&#102;&#x73;&#46;&#111;&#x72;&#103;</a></p>
<h1 id="DOCUMENTATION"><a href="#DOCUMENTATION" class="headerlink" title="DOCUMENTATION"></a>DOCUMENTATION</h1><p><a target="_blank" rel="noopener" href="http://www.orangefs.org/documentation/">http://www.orangefs.org/documentation/</a></p>
<h1 id="USERSPACE-FILESYSTEM-SOURCE"><a href="#USERSPACE-FILESYSTEM-SOURCE" class="headerlink" title="USERSPACE FILESYSTEM SOURCE"></a>USERSPACE FILESYSTEM SOURCE</h1><p><a target="_blank" rel="noopener" href="http://www.orangefs.org/download">http://www.orangefs.org/download</a></p>
<p>Orangefs versions prior to 2.9.3 would not be compatible with the<br>upstream version of the kernel client.</p>
<h1 id="RUNNING-ORANGEFS-ON-A-SINGLE-SERVER"><a href="#RUNNING-ORANGEFS-ON-A-SINGLE-SERVER" class="headerlink" title="RUNNING ORANGEFS ON A SINGLE SERVER"></a>RUNNING ORANGEFS ON A SINGLE SERVER</h1><p>OrangeFS is usually run in large installations with multiple servers and<br>clients, but a complete filesystem can be run on a single machine for<br>development and testing.</p>
<p>On Fedora, install orangefs and orangefs-server.</p>
<p>dnf -y install orangefs orangefs-server</p>
<p>There is an example server configuration file in<br>/etc/orangefs/orangefs.conf.  Change localhost to your hostname if<br>necessary.</p>
<p>To generate a filesystem to run xfstests against, see below.</p>
<p>There is an example client configuration file in /etc/pvfs2tab.  It is a<br>single line.  Uncomment it and change the hostname if necessary.  This<br>controls clients which use libpvfs2.  This does not control the<br>pvfs2-client-core.</p>
<p>Create the filesystem.</p>
<p>pvfs2-server -f /etc/orangefs/orangefs.conf</p>
<p>Start the server.</p>
<p>systemctl start orangefs-server</p>
<p>Test the server.</p>
<p>pvfs2-ping -m /pvfsmnt</p>
<p>Start the client.  The module must be compiled in or loaded before this<br>point.</p>
<p>systemctl start orangefs-client</p>
<p>Mount the filesystem.</p>
<p>mount -t pvfs2 tcp://localhost:3334/orangefs /pvfsmnt</p>
<h1 id="BUILDING-ORANGEFS-ON-A-SINGLE-SERVER"><a href="#BUILDING-ORANGEFS-ON-A-SINGLE-SERVER" class="headerlink" title="BUILDING ORANGEFS ON A SINGLE SERVER"></a>BUILDING ORANGEFS ON A SINGLE SERVER</h1><p>Where OrangeFS cannot be installed from distribution packages, it may be<br>built from source.</p>
<p>You can omit –prefix if you don’t care that things are sprinkled around<br>in /usr/local.  As of version 2.9.6, OrangeFS uses Berkeley DB by<br>default, we will probably be changing the default to LMDB soon.</p>
<p>./configure –prefix=/opt/ofs –with-db-backend=lmdb</p>
<p>make</p>
<p>make install</p>
<p>Create an orangefs config file.</p>
<p>/opt/ofs/bin/pvfs2-genconfig /etc/pvfs2.conf</p>
<p>Create an /etc/pvfs2tab file.</p>
<p>echo tcp://localhost:3334/orangefs /pvfsmnt pvfs2 defaults,noauto 0 0 &gt; <br>    /etc/pvfs2tab</p>
<p>Create the mount point you specified in the tab file if needed.</p>
<p>mkdir /pvfsmnt</p>
<p>Bootstrap the server.</p>
<p>/opt/ofs/sbin/pvfs2-server -f /etc/pvfs2.conf</p>
<p>Start the server.</p>
<p>/opt/osf/sbin/pvfs2-server /etc/pvfs2.conf</p>
<p>Now the server should be running. Pvfs2-ls is a simple<br>test to verify that the server is running.</p>
<p>/opt/ofs/bin/pvfs2-ls /pvfsmnt</p>
<p>If stuff seems to be working, load the kernel module and<br>turn on the client core.</p>
<p>/opt/ofs/sbin/pvfs2-client -p /opt/osf/sbin/pvfs2-client-core</p>
<p>Mount your filesystem.</p>
<p>mount -t pvfs2 tcp://localhost:3334/orangefs /pvfsmnt</p>
<h1 id="RUNNING-XFSTESTS"><a href="#RUNNING-XFSTESTS" class="headerlink" title="RUNNING XFSTESTS"></a>RUNNING XFSTESTS</h1><p>It is useful to use a scratch filesystem with xfstests.  This can be<br>done with only one server.</p>
<p>Make a second copy of the FileSystem section in the server configuration<br>file, which is /etc/orangefs/orangefs.conf.  Change the Name to scratch.<br>Change the ID to something other than the ID of the first FileSystem<br>section (2 is usually a good choice).</p>
<p>Then there are two FileSystem sections: orangefs and scratch.</p>
<p>This change should be made before creating the filesystem.</p>
<p>pvfs2-server -f /etc/orangefs/orangefs.conf</p>
<p>To run xfstests, create /etc/xfsqa.config.</p>
<p>TEST_DIR=/orangefs<br>TEST_DEV=tcp://localhost:3334/orangefs<br>SCRATCH_MNT=/scratch<br>SCRATCH_DEV=tcp://localhost:3334/scratch</p>
<p>Then xfstests can be run</p>
<p>./check -pvfs2</p>
<h1 id="OPTIONS"><a href="#OPTIONS" class="headerlink" title="OPTIONS"></a>OPTIONS</h1><p>The following mount options are accepted:</p>
<p>  acl<br>    Allow the use of Access Control Lists on files and directories.</p>
<p>  intr<br>    Some operations between the kernel client and the user space<br>    filesystem can be interruptible, such as changes in debug levels<br>    and the setting of tunable parameters.</p>
<p>  local_lock<br>    Enable posix locking from the perspective of “this” kernel. The<br>    default file_operations lock action is to return ENOSYS. Posix<br>    locking kicks in if the filesystem is mounted with -o local_lock.<br>    Distributed locking is being worked on for the future.</p>
<h1 id="DEBUGGING"><a href="#DEBUGGING" class="headerlink" title="DEBUGGING"></a>DEBUGGING</h1><p>If you want the debug (GOSSIP) statements in a particular<br>source file (inode.c for example) go to syslog:</p>
<p>  echo inode &gt; /sys/kernel/debug/orangefs/kernel-debug</p>
<p>No debugging (the default):</p>
<p>  echo none &gt; /sys/kernel/debug/orangefs/kernel-debug</p>
<p>Debugging from several source files:</p>
<p>  echo inode,dir &gt; /sys/kernel/debug/orangefs/kernel-debug</p>
<p>All debugging:</p>
<p>  echo all &gt; /sys/kernel/debug/orangefs/kernel-debug</p>
<p>Get a list of all debugging keywords:</p>
<p>  cat /sys/kernel/debug/orangefs/debug-help</p>
<h1 id="PROTOCOL-BETWEEN-KERNEL-MODULE-AND-USERSPACE"><a href="#PROTOCOL-BETWEEN-KERNEL-MODULE-AND-USERSPACE" class="headerlink" title="PROTOCOL BETWEEN KERNEL MODULE AND USERSPACE"></a>PROTOCOL BETWEEN KERNEL MODULE AND USERSPACE</h1><p>Orangefs is a user space filesystem and an associated kernel module.<br>We’ll just refer to the user space part of Orangefs as “userspace”<br>from here on out. Orangefs descends from PVFS, and userspace code<br>still uses PVFS for function and variable names. Userspace typedefs<br>many of the important structures. Function and variable names in<br>the kernel module have been transitioned to “orangefs”, and The Linux<br>Coding Style avoids typedefs, so kernel module structures that<br>correspond to userspace structures are not typedefed.</p>
<p>The kernel module implements a pseudo device that userspace<br>can read from and write to. Userspace can also manipulate the<br>kernel module through the pseudo device with ioctl.</p>
<p>THE BUFMAP:</p>
<p>At startup userspace allocates two page-size-aligned (posix_memalign)<br>mlocked memory buffers, one is used for IO and one is used for readdir<br>operations. The IO buffer is 41943040 bytes and the readdir buffer is<br>4194304 bytes. Each buffer contains logical chunks, or partitions, and<br>a pointer to each buffer is added to its own PVFS_dev_map_desc structure<br>which also describes its total size, as well as the size and number of<br>the partitions.</p>
<p>A pointer to the IO buffer’s PVFS_dev_map_desc structure is sent to a<br>mapping routine in the kernel module with an ioctl. The structure is<br>copied from user space to kernel space with copy_from_user and is used<br>to initialize the kernel module’s “bufmap” (struct orangefs_bufmap), which<br>then contains:</p>
<ul>
<li><p>refcnt - a reference counter</p>
</li>
<li><p>desc_size - PVFS2_BUFMAP_DEFAULT_DESC_SIZE (4194304) - the IO buffer’s<br>partition size, which represents the filesystem’s block size and<br>is used for s_blocksize in super blocks.</p>
</li>
<li><p>desc_count - PVFS2_BUFMAP_DEFAULT_DESC_COUNT (10) - the number of<br>partitions in the IO buffer.</p>
</li>
<li><p>desc_shift - log2(desc_size), used for s_blocksize_bits in super blocks.</p>
</li>
<li><p>total_size - the total size of the IO buffer.</p>
</li>
<li><p>page_count - the number of 4096 byte pages in the IO buffer.</p>
</li>
<li><p>page_array - a pointer to page_count * (sizeof(struct page*)) bytes<br>of kcalloced memory. This memory is used as an array of pointers<br>to each of the pages in the IO buffer through a call to get_user_pages.</p>
</li>
<li><p>desc_array - a pointer to desc_count * (sizeof(struct orangefs_bufmap_desc))<br>bytes of kcalloced memory. This memory is further intialized:</p>
<p>  user_desc is the kernel’s copy of the IO buffer’s ORANGEFS_dev_map_desc<br>  structure. user_desc-&gt;ptr points to the IO buffer.</p>
<p>  pages_per_desc = bufmap-&gt;desc_size / PAGE_SIZE<br>  offset = 0</p>
<pre><code>bufmap-&gt;desc_array[0].page_array = &amp;bufmap-&gt;page_array[offset]
bufmap-&gt;desc_array[0].array_count = pages_per_desc = 1024
bufmap-&gt;desc_array[0].uaddr = (user_desc-&gt;ptr) + (0 * 1024 * 4096)
offset += 1024
                   .
                   .
                   .
bufmap-&gt;desc_array[9].page_array = &amp;bufmap-&gt;page_array[offset]
bufmap-&gt;desc_array[9].array_count = pages_per_desc = 1024
bufmap-&gt;desc_array[9].uaddr = (user_desc-&gt;ptr) +
                                       (9 * 1024 * 4096)
offset += 1024
</code></pre>
</li>
<li><p>buffer_index_array - a desc_count sized array of ints, used to<br>indicate which of the IO buffer’s partitions are available to use.</p>
</li>
<li><p>buffer_index_lock - a spinlock to protect buffer_index_array during update.</p>
</li>
<li><p>readdir_index_array - a five (ORANGEFS_READDIR_DEFAULT_DESC_COUNT) element<br>int array used to indicate which of the readdir buffer’s partitions are<br>available to use.</p>
</li>
<li><p>readdir_index_lock - a spinlock to protect readdir_index_array during<br>update.</p>
</li>
</ul>
<p>OPERATIONS:</p>
<p>The kernel module builds an “op” (struct orangefs_kernel_op_s) when it<br>needs to communicate with userspace. Part of the op contains the “upcall”<br>which expresses the request to userspace. Part of the op eventually<br>contains the “downcall” which expresses the results of the request.</p>
<p>The slab allocator is used to keep a cache of op structures handy.</p>
<p>At init time the kernel module defines and initializes a request list<br>and an in_progress hash table to keep track of all the ops that are<br>in flight at any given time.</p>
<p>Ops are stateful:</p>
<ul>
<li>unknown  - op was just initialized</li>
<li>waiting  - op is on request_list (upward bound)</li>
<li>inprogr  - op is in progress (waiting for downcall)</li>
<li>serviced - op has matching downcall; ok</li>
<li>purged   - op has to start a timer since client-core<pre><code>       exited uncleanly before servicing op
</code></pre>
</li>
<li>given up - submitter has given up waiting for it</li>
</ul>
<p>When some arbitrary userspace program needs to perform a<br>filesystem operation on Orangefs (readdir, I/O, create, whatever)<br>an op structure is initialized and tagged with a distinguishing ID<br>number. The upcall part of the op is filled out, and the op is<br>passed to the “service_operation” function.</p>
<p>Service_operation changes the op’s state to “waiting”, puts<br>it on the request list, and signals the Orangefs file_operations.poll<br>function through a wait queue. Userspace is polling the pseudo-device<br>and thus becomes aware of the upcall request that needs to be read.</p>
<p>When the Orangefs file_operations.read function is triggered, the<br>request list is searched for an op that seems ready-to-process.<br>The op is removed from the request list. The tag from the op and<br>the filled-out upcall struct are copy_to_user’ed back to userspace.</p>
<p>If any of these (and some additional protocol) copy_to_users fail,<br>the op’s state is set to “waiting” and the op is added back to<br>the request list. Otherwise, the op’s state is changed to “in progress”,<br>and the op is hashed on its tag and put onto the end of a list in the<br>in_progress hash table at the index the tag hashed to.</p>
<p>When userspace has assembled the response to the upcall, it<br>writes the response, which includes the distinguishing tag, back to<br>the pseudo device in a series of io_vecs. This triggers the Orangefs<br>file_operations.write_iter function to find the op with the associated<br>tag and remove it from the in_progress hash table. As long as the op’s<br>state is not “canceled” or “given up”, its state is set to “serviced”.<br>The file_operations.write_iter function returns to the waiting vfs,<br>and back to service_operation through wait_for_matching_downcall.</p>
<p>Service operation returns to its caller with the op’s downcall<br>part (the response to the upcall) filled out.</p>
<p>The “client-core” is the bridge between the kernel module and<br>userspace. The client-core is a daemon. The client-core has an<br>associated watchdog daemon. If the client-core is ever signaled<br>to die, the watchdog daemon restarts the client-core. Even though<br>the client-core is restarted “right away”, there is a period of<br>time during such an event that the client-core is dead. A dead client-core<br>can’t be triggered by the Orangefs file_operations.poll function.<br>Ops that pass through service_operation during a “dead spell” can timeout<br>on the wait queue and one attempt is made to recycle them. Obviously,<br>if the client-core stays dead too long, the arbitrary userspace processes<br>trying to use Orangefs will be negatively affected. Waiting ops<br>that can’t be serviced will be removed from the request list and<br>have their states set to “given up”. In-progress ops that can’t<br>be serviced will be removed from the in_progress hash table and<br>have their states set to “given up”.</p>
<p>Readdir and I/O ops are atypical with respect to their payloads.</p>
<ul>
<li><p>readdir ops use the smaller of the two pre-allocated pre-partitioned<br>memory buffers. The readdir buffer is only available to userspace.<br>The kernel module obtains an index to a free partition before launching<br>a readdir op. Userspace deposits the results into the indexed partition<br>and then writes them to back to the pvfs device.</p>
</li>
<li><p>io (read and write) ops use the larger of the two pre-allocated<br>pre-partitioned memory buffers. The IO buffer is accessible from<br>both userspace and the kernel module. The kernel module obtains an<br>index to a free partition before launching an io op. The kernel module<br>deposits write data into the indexed partition, to be consumed<br>directly by userspace. Userspace deposits the results of read<br>requests into the indexed partition, to be consumed directly<br>by the kernel module.</p>
</li>
</ul>
<p>Responses to kernel requests are all packaged in pvfs2_downcall_t<br>structs. Besides a few other members, pvfs2_downcall_t contains a<br>union of structs, each of which is associated with a particular<br>response type.</p>
<p>The several members outside of the union are:</p>
<ul>
<li>int32_t type - type of operation.</li>
<li>int32_t status - return code for the operation.</li>
<li>int64_t trailer_size - 0 unless readdir operation.</li>
<li>char *trailer_buf - initialized to NULL, used during readdir operations.</li>
</ul>
<p>The appropriate member inside the union is filled out for any<br>particular response.</p>
<p>  PVFS2_VFS_OP_FILE_IO<br>    fill a pvfs2_io_response_t</p>
<p>  PVFS2_VFS_OP_LOOKUP<br>    fill a PVFS_object_kref</p>
<p>  PVFS2_VFS_OP_CREATE<br>    fill a PVFS_object_kref</p>
<p>  PVFS2_VFS_OP_SYMLINK<br>    fill a PVFS_object_kref</p>
<p>  PVFS2_VFS_OP_GETATTR<br>    fill in a PVFS_sys_attr_s (tons of stuff the kernel doesn’t need)<br>    fill in a string with the link target when the object is a symlink.</p>
<p>  PVFS2_VFS_OP_MKDIR<br>    fill a PVFS_object_kref</p>
<p>  PVFS2_VFS_OP_STATFS<br>    fill a pvfs2_statfs_response_t with useless info <g>. It is hard for<br>    us to know, in a timely fashion, these statistics about our<br>    distributed network filesystem.</p>
<p>  PVFS2_VFS_OP_FS_MOUNT<br>    fill a pvfs2_fs_mount_response_t which is just like a PVFS_object_kref<br>    except its members are in a different order and “__pad1” is replaced<br>    with “id”.</p>
<p>  PVFS2_VFS_OP_GETXATTR<br>    fill a pvfs2_getxattr_response_t</p>
<p>  PVFS2_VFS_OP_LISTXATTR<br>    fill a pvfs2_listxattr_response_t</p>
<p>  PVFS2_VFS_OP_PARAM<br>    fill a pvfs2_param_response_t</p>
<p>  PVFS2_VFS_OP_PERF_COUNT<br>    fill a pvfs2_perf_count_response_t</p>
<p>  PVFS2_VFS_OP_FSKEY<br>    file a pvfs2_fs_key_response_t</p>
<p>  PVFS2_VFS_OP_READDIR<br>    jamb everything needed to represent a pvfs2_readdir_response_t into<br>    the readdir buffer descriptor specified in the upcall.</p>
<p>Userspace uses writev() on /dev/pvfs2-req to pass responses to the requests<br>made by the kernel side.</p>
<p>A buffer_list containing:</p>
<ul>
<li>a pointer to the prepared response to the request from the<br>kernel (struct pvfs2_downcall_t).</li>
<li>and also, in the case of a readdir request, a pointer to a<br>buffer containing descriptors for the objects in the target<br>directory.<br>… is sent to the function (PINT_dev_write_list) which performs<br>the writev.</li>
</ul>
<p>PINT_dev_write_list has a local iovec array: struct iovec io_array[10];</p>
<p>The first four elements of io_array are initialized like this for all<br>responses:</p>
<p>  io_array[0].iov_base = address of local variable “proto_ver” (int32_t)<br>  io_array[0].iov_len = sizeof(int32_t)</p>
<p>  io_array[1].iov_base = address of global variable “pdev_magic” (int32_t)<br>  io_array[1].iov_len = sizeof(int32_t)</p>
<p>  io_array[2].iov_base = address of parameter “tag” (PVFS_id_gen_t)<br>  io_array[2].iov_len = sizeof(int64_t)</p>
<p>  io_array[3].iov_base = address of out_downcall member (pvfs2_downcall_t)<br>                         of global variable vfs_request (vfs_request_t)<br>  io_array[3].iov_len = sizeof(pvfs2_downcall_t)</p>
<p>Readdir responses initialize the fifth element io_array like this:</p>
<p>  io_array[4].iov_base = contents of member trailer_buf (char *)<br>                         from out_downcall member of global variable<br>                         vfs_request<br>  io_array[4].iov_len = contents of member trailer_size (PVFS_size)<br>                        from out_downcall member of global variable<br>                        vfs_request</p>
<p>Orangefs exploits the dcache in order to avoid sending redundant<br>requests to userspace. We keep object inode attributes up-to-date with<br>orangefs_inode_getattr. Orangefs_inode_getattr uses two arguments to<br>help it decide whether or not to update an inode: “new” and “bypass”.<br>Orangefs keeps private data in an object’s inode that includes a short<br>timeout value, getattr_time, which allows any iteration of<br>orangefs_inode_getattr to know how long it has been since the inode was<br>updated. When the object is not new (new == 0) and the bypass flag is not<br>set (bypass == 0) orangefs_inode_getattr returns without updating the inode<br>if getattr_time has not timed out. Getattr_time is updated each time the<br>inode is updated.</p>
<p>Creation of a new object (file, dir, sym-link) includes the evaluation of<br>its pathname, resulting in a negative directory entry for the object.<br>A new inode is allocated and associated with the dentry, turning it from<br>a negative dentry into a “productive full member of society”. Orangefs<br>obtains the new inode from Linux with new_inode() and associates<br>the inode with the dentry by sending the pair back to Linux with<br>d_instantiate().</p>
<p>The evaluation of a pathname for an object resolves to its corresponding<br>dentry. If there is no corresponding dentry, one is created for it in<br>the dcache. Whenever a dentry is modified or verified Orangefs stores a<br>short timeout value in the dentry’s d_time, and the dentry will be trusted<br>for that amount of time. Orangefs is a network filesystem, and objects<br>can potentially change out-of-band with any particular Orangefs kernel module<br>instance, so trusting a dentry is risky. The alternative to trusting<br>dentries is to always obtain the needed information from userspace - at<br>least a trip to the client-core, maybe to the servers. Obtaining information<br>from a dentry is cheap, obtaining it from userspace is relatively expensive,<br>hence the motivation to use the dentry when possible.</p>
<p>The timeout values d_time and getattr_time are jiffy based, and the<br>code is designed to avoid the jiffy-wrap problem:</p>
<p>“In general, if the clock may have wrapped around more than once, there<br>is no way to tell how much time has elapsed. However, if the times t1<br>and t2 are known to be fairly close, we can reliably compute the<br>difference in a way that takes into account the possibility that the<br>clock may have wrapped between times.”</p>
<pre><code>                  from course notes by instructor Andy Wang
</code></pre>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_orangefs/" title="Kernel-4.18.0-80.el8_orangefs" target="_blank" rel="external">http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_orangefs/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_oracle-dax/" title="Kernel-4.18.0-80.el8_oracle-dax"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_overlayfs/" title="Kernel-4.18.0-80.el8_overlayfs"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>