<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-4.18.0-80.el8_usbmon | oosTech.com</title>
  <meta name="description" content="Introduction  The name “usbmon” in lowercase refers to a facility in kernel which isused to collect traces of I&#x2F;O on the USB bus. This function is analogousto a packet socket used by network monitori">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-4.18.0-80.el8_usbmon">
<meta property="og:url" content="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_usbmon/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="Introduction  The name “usbmon” in lowercase refers to a facility in kernel which isused to collect traces of I&#x2F;O on the USB bus. This function is analogousto a packet socket used by network monitori">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:modified_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_usbmon/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mount-t-debugfs-none-debugs-sys-kernel-debug"><span class="toc-number">1.</span> <span class="toc-text">mount -t debugfs none_debugs &#x2F;sys&#x2F;kernel&#x2F;debug</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#modprobe-usbmon"><span class="toc-number">2.</span> <span class="toc-text">modprobe usbmon</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ls-sys-kernel-debug-usb-usbmon"><span class="toc-number">4.</span> <span class="toc-text">ls &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;usb&#x2F;usbmon</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cat-sys-kernel-debug-usb-usbmon-3u-gt-tmp-1-mon-out"><span class="toc-number">5.</span> <span class="toc-text">cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;usb&#x2F;usbmon&#x2F;3u &gt; &#x2F;tmp&#x2F;1.mon.out</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cat-sys-kernel-debug-usb-usbmon-0u-gt-tmp-1-mon-out"><span class="toc-number">6.</span> <span class="toc-text">cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;usb&#x2F;usbmon&#x2F;0u &gt; &#x2F;tmp&#x2F;1.mon.out</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-4.18.0-80.el8_usbmon" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-4.18.0-80.el8_usbmon
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_usbmon/" class="article-date">
	 published: <time datetime="2021-02-18T16:00:00.000Z" itemprop="datePublished">2021-02-19</time>
	</a>
</span>

        
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_usbmon/" class="article-date">
	   updated: <time datetime="2021-02-18T16:00:00.000Z" itemprop="dateUpdated">2021-02-19</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/02/19/Kernel-4.18.0-80.el8_usbmon/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <ul>
<li>Introduction</li>
</ul>
<p>The name “usbmon” in lowercase refers to a facility in kernel which is<br>used to collect traces of I/O on the USB bus. This function is analogous<br>to a packet socket used by network monitoring tools such as tcpdump(1)<br>or Ethereal. Similarly, it is expected that a tool such as usbdump or<br>USBMon (with uppercase letters) is used to examine raw traces produced<br>by usbmon.</p>
<p>The usbmon reports requests made by peripheral-specific drivers to Host<br>Controller Drivers (HCD). So, if HCD is buggy, the traces reported by<br>usbmon may not correspond to bus transactions precisely. This is the same<br>situation as with tcpdump.</p>
<p>Two APIs are currently implemented: “text” and “binary”. The binary API<br>is available through a character device in /dev namespace and is an ABI.<br>The text API is deprecated since 2.6.35, but available for convenience.</p>
<ul>
<li>How to use usbmon to collect raw text traces</li>
</ul>
<p>Unlike the packet socket, usbmon has an interface which provides traces<br>in a text format. This is used for two purposes. First, it serves as a<br>common trace exchange format for tools while more sophisticated formats<br>are finalized. Second, humans can read it in case tools are not available.</p>
<p>To collect a raw text trace, execute following steps.</p>
<ol>
<li>Prepare</li>
</ol>
<p>Mount debugfs (it has to be enabled in your kernel configuration), and<br>load the usbmon module (if built as module). The second step is skipped<br>if usbmon is built into the kernel.</p>
<h1 id="mount-t-debugfs-none-debugs-sys-kernel-debug"><a href="#mount-t-debugfs-none-debugs-sys-kernel-debug" class="headerlink" title="mount -t debugfs none_debugs /sys/kernel/debug"></a>mount -t debugfs none_debugs /sys/kernel/debug</h1><h1 id="modprobe-usbmon"><a href="#modprobe-usbmon" class="headerlink" title="modprobe usbmon"></a>modprobe usbmon</h1><h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>Verify that bus sockets are present.</p>
<h1 id="ls-sys-kernel-debug-usb-usbmon"><a href="#ls-sys-kernel-debug-usb-usbmon" class="headerlink" title="ls /sys/kernel/debug/usb/usbmon"></a>ls /sys/kernel/debug/usb/usbmon</h1><p>0s  0u  1s  1t  1u  2s  2t  2u  3s  3t  3u  4s  4t  4u<br>#</p>
<p>Now you can choose to either use the socket ‘0u’ (to capture packets on all<br>buses), and skip to step #3, or find the bus used by your device with step #2.<br>This allows to filter away annoying devices that talk continuously.</p>
<ol start="2">
<li>Find which bus connects to the desired device</li>
</ol>
<p>Run “cat /sys/kernel/debug/usb/devices”, and find the T-line which corresponds<br>to the device. Usually you do it by looking for the vendor string. If you have<br>many similar devices, unplug one and compare the two<br>/sys/kernel/debug/usb/devices outputs. The T-line will have a bus number.<br>Example:</p>
<p>T:  Bus=03 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#=  2 Spd=12  MxCh= 0<br>D:  Ver= 1.10 Cls=00(&gt;ifc ) Sub=00 Prot=00 MxPS= 8 #Cfgs=  1<br>P:  Vendor=0557 ProdID=2004 Rev= 1.00<br>S:  Manufacturer=ATEN<br>S:  Product=UC100KM V2.00</p>
<p>“Bus=03” means it’s bus 3. Alternatively, you can look at the output from<br>“lsusb” and get the bus number from the appropriate line. Example:</p>
<p>Bus 003 Device 002: ID 0557:2004 ATEN UC100KM V2.00</p>
<ol start="3">
<li>Start ‘cat’</li>
</ol>
<h1 id="cat-sys-kernel-debug-usb-usbmon-3u-gt-tmp-1-mon-out"><a href="#cat-sys-kernel-debug-usb-usbmon-3u-gt-tmp-1-mon-out" class="headerlink" title="cat /sys/kernel/debug/usb/usbmon/3u &gt; /tmp/1.mon.out"></a>cat /sys/kernel/debug/usb/usbmon/3u &gt; /tmp/1.mon.out</h1><p>to listen on a single bus, otherwise, to listen on all buses, type:</p>
<h1 id="cat-sys-kernel-debug-usb-usbmon-0u-gt-tmp-1-mon-out"><a href="#cat-sys-kernel-debug-usb-usbmon-0u-gt-tmp-1-mon-out" class="headerlink" title="cat /sys/kernel/debug/usb/usbmon/0u &gt; /tmp/1.mon.out"></a>cat /sys/kernel/debug/usb/usbmon/0u &gt; /tmp/1.mon.out</h1><p>This process will read until it is killed. Naturally, the output can be<br>redirected to a desirable location. This is preferred, because it is going<br>to be quite long.</p>
<ol start="4">
<li>Perform the desired operation on the USB bus</li>
</ol>
<p>This is where you do something that creates the traffic: plug in a flash key,<br>copy files, control a webcam, etc.</p>
<ol start="5">
<li>Kill cat</li>
</ol>
<p>Usually it’s done with a keyboard interrupt (Control-C).</p>
<p>At this point the output file (/tmp/1.mon.out in this example) can be saved,<br>sent by e-mail, or inspected with a text editor. In the last case make sure<br>that the file size is not excessive for your favourite editor.</p>
<ul>
<li>Raw text data format</li>
</ul>
<p>Two formats are supported currently: the original, or ‘1t’ format, and<br>the ‘1u’ format. The ‘1t’ format is deprecated in kernel 2.6.21. The ‘1u’<br>format adds a few fields, such as ISO frame descriptors, interval, etc.<br>It produces slightly longer lines, but otherwise is a perfect superset<br>of ‘1t’ format.</p>
<p>If it is desired to recognize one from the other in a program, look at the<br>“address” word (see below), where ‘1u’ format adds a bus number. If 2 colons<br>are present, it’s the ‘1t’ format, otherwise ‘1u’.</p>
<p>Any text format data consists of a stream of events, such as URB submission,<br>URB callback, submission error. Every event is a text line, which consists<br>of whitespace separated words. The number or position of words may depend<br>on the event type, but there is a set of words, common for all types.</p>
<p>Here is the list of words, from left to right:</p>
<ul>
<li><p>URB Tag. This is used to identify URBs, and is normally an in-kernel address<br>of the URB structure in hexadecimal, but can be a sequence number or any<br>other unique string, within reason.</p>
</li>
<li><p>Timestamp in microseconds, a decimal number. The timestamp’s resolution<br>depends on available clock, and so it can be much worse than a microsecond<br>(if the implementation uses jiffies, for example).</p>
</li>
<li><p>Event Type. This type refers to the format of the event, not URB type.<br>Available types are: S - submission, C - callback, E - submission error.</p>
</li>
<li><p>“Address” word (formerly a “pipe”). It consists of four fields, separated by<br>colons: URB type and direction, Bus number, Device address, Endpoint number.<br>Type and direction are encoded with two bytes in the following manner:<br>  Ci Co   Control input and output<br>  Zi Zo   Isochronous input and output<br>  Ii Io   Interrupt input and output<br>  Bi Bo   Bulk input and output<br>Bus number, Device address, and Endpoint are decimal numbers, but they may<br>have leading zeros, for the sake of human readers.</p>
</li>
<li><p>URB Status word. This is either a letter, or several numbers separated<br>by colons: URB status, interval, start frame, and error count. Unlike the<br>“address” word, all fields save the status are optional. Interval is printed<br>only for interrupt and isochronous URBs. Start frame is printed only for<br>isochronous URBs. Error count is printed only for isochronous callback<br>events.</p>
<p>The status field is a decimal number, sometimes negative, which represents<br>a “status” field of the URB. This field makes no sense for submissions, but<br>is present anyway to help scripts with parsing. When an error occurs, the<br>field contains the error code.</p>
<p>In case of a submission of a Control packet, this field contains a Setup Tag<br>instead of an group of numbers. It is easy to tell whether the Setup Tag is<br>present because it is never a number. Thus if scripts find a set of numbers<br>in this word, they proceed to read Data Length (except for isochronous URBs).<br>If they find something else, like a letter, they read the setup packet before<br>reading the Data Length or isochronous descriptors.</p>
</li>
<li><p>Setup packet, if present, consists of 5 words: one of each for bmRequestType,<br>bRequest, wValue, wIndex, wLength, as specified by the USB Specification 2.0.<br>These words are safe to decode if Setup Tag was ‘s’. Otherwise, the setup<br>packet was present, but not captured, and the fields contain filler.</p>
</li>
<li><p>Number of isochronous frame descriptors and descriptors themselves.<br>If an Isochronous transfer event has a set of descriptors, a total number<br>of them in an URB is printed first, then a word per descriptor, up to a<br>total of 5. The word consists of 3 colon-separated decimal numbers for<br>status, offset, and length respectively. For submissions, initial length<br>is reported. For callbacks, actual length is reported.</p>
</li>
<li><p>Data Length. For submissions, this is the requested length. For callbacks,<br>this is the actual length.</p>
</li>
<li><p>Data tag. The usbmon may not always capture data, even if length is nonzero.<br>The data words are present only if this tag is ‘=’.</p>
</li>
<li><p>Data words follow, in big endian hexadecimal format. Notice that they are<br>not machine words, but really just a byte stream split into words to make<br>it easier to read. Thus, the last word may contain from one to four bytes.<br>The length of collected data is limited and can be less than the data length<br>reported in the Data Length word. In the case of an Isochronous input (Zi)<br>completion where the received data is sparse in the buffer, the length of<br>the collected data can be greater than the Data Length value (because Data<br>Length counts only the bytes that were received whereas the Data words<br>contain the entire transfer buffer).</p>
</li>
</ul>
<p>Examples:</p>
<p>An input control transfer to get a port status.</p>
<p>d5ea89a0 3575914555 S Ci:1:001:0 s a3 00 0000 0003 0004 4 &lt;<br>d5ea89a0 3575914560 C Ci:1:001:0 0 4 = 01050000</p>
<p>An output bulk transfer to send a SCSI command 0x28 (READ_10) in a 31-byte<br>Bulk wrapper to a storage device at address 5:</p>
<p>dd65f0e8 4128379752 S Bo:1:005:2 -115 31 = 55534243 ad000000 00800000 80010a28 20000000 20000040 00000000 000000<br>dd65f0e8 4128379808 C Bo:1:005:2 0 31 &gt;</p>
<ul>
<li>Raw binary format and API</li>
</ul>
<p>The overall architecture of the API is about the same as the one above,<br>only the events are delivered in binary format. Each event is sent in<br>the following structure (its name is made up, so that we can refer to it):</p>
<p>struct usbmon_packet {<br>    u64 id;            /*  0: URB ID - from submission to callback <em>/<br>    unsigned char type;    /</em>  8: Same as text; extensible. <em>/<br>    unsigned char xfer_type; /</em>    ISO (0), Intr, Control, Bulk (3) <em>/<br>    unsigned char epnum;    /</em>     Endpoint number and transfer direction <em>/<br>    unsigned char devnum;    /</em>     Device address <em>/<br>    u16 busnum;        /</em> 12: Bus number <em>/<br>    char flag_setup;    /</em> 14: Same as text <em>/<br>    char flag_data;        /</em> 15: Same as text; Binary zero is OK. <em>/<br>    s64 ts_sec;        /</em> 16: gettimeofday <em>/<br>    s32 ts_usec;        /</em> 24: gettimeofday <em>/<br>    int status;        /</em> 28: <em>/<br>    unsigned int length;    /</em> 32: Length of data (submitted or actual) <em>/<br>    unsigned int len_cap;    /</em> 36: Delivered length <em>/<br>    union {            /</em> 40: <em>/<br>        unsigned char setup[SETUP_LEN];    /</em> Only for Control S-type <em>/<br>        struct iso_rec {        /</em> Only for ISO <em>/<br>            int error_count;<br>            int numdesc;<br>        } iso;<br>    } s;<br>    int interval;        /</em> 48: Only for Interrupt and ISO <em>/<br>    int start_frame;    /</em> 52: For ISO <em>/<br>    unsigned int xfer_flags; /</em> 56: copy of URB’s transfer_flags <em>/<br>    unsigned int ndesc;    /</em> 60: Actual number of ISO descriptors <em>/<br>};                /</em> 64 total length */</p>
<p>These events can be received from a character device by reading with read(2),<br>with an ioctl(2), or by accessing the buffer with mmap. However, read(2)<br>only returns first 48 bytes for compatibility reasons.</p>
<p>The character device is usually called /dev/usbmonN, where N is the USB bus<br>number. Number zero (/dev/usbmon0) is special and means “all buses”.<br>Note that specific naming policy is set by your Linux distribution.</p>
<p>If you create /dev/usbmon0 by hand, make sure that it is owned by root<br>and has mode 0600. Otherwise, unprivileged users will be able to snoop<br>keyboard traffic.</p>
<p>The following ioctl calls are available, with MON_IOC_MAGIC 0x92:</p>
<p> MON_IOCQ_URB_LEN, defined as _IO(MON_IOC_MAGIC, 1)</p>
<p>This call returns the length of data in the next event. Note that majority of<br>events contain no data, so if this call returns zero, it does not mean that<br>no events are available.</p>
<p> MON_IOCG_STATS, defined as _IOR(MON_IOC_MAGIC, 3, struct mon_bin_stats)</p>
<p>The argument is a pointer to the following structure:</p>
<p>struct mon_bin_stats {<br>    u32 queued;<br>    u32 dropped;<br>};</p>
<p>The member “queued” refers to the number of events currently queued in the<br>buffer (and not to the number of events processed since the last reset).</p>
<p>The member “dropped” is the number of events lost since the last call<br>to MON_IOCG_STATS.</p>
<p> MON_IOCT_RING_SIZE, defined as _IO(MON_IOC_MAGIC, 4)</p>
<p>This call sets the buffer size. The argument is the size in bytes.<br>The size may be rounded down to the next chunk (or page). If the requested<br>size is out of [unspecified] bounds for this kernel, the call fails with<br>-EINVAL.</p>
<p> MON_IOCQ_RING_SIZE, defined as _IO(MON_IOC_MAGIC, 5)</p>
<p>This call returns the current size of the buffer in bytes.</p>
<p> MON_IOCX_GET, defined as _IOW(MON_IOC_MAGIC, 6, struct mon_get_arg)<br> MON_IOCX_GETX, defined as _IOW(MON_IOC_MAGIC, 10, struct mon_get_arg)</p>
<p>These calls wait for events to arrive if none were in the kernel buffer,<br>then return the first event. The argument is a pointer to the following<br>structure:</p>
<p>struct mon_get_arg {<br>    struct usbmon_packet *hdr;<br>    void <em>data;<br>    size_t alloc;        /</em> Length of data (can be zero) */<br>};</p>
<p>Before the call, hdr, data, and alloc should be filled. Upon return, the area<br>pointed by hdr contains the next event structure, and the data buffer contains<br>the data, if any. The event is removed from the kernel buffer.</p>
<p>The MON_IOCX_GET copies 48 bytes to hdr area, MON_IOCX_GETX copies 64 bytes.</p>
<p> MON_IOCX_MFETCH, defined as _IOWR(MON_IOC_MAGIC, 7, struct mon_mfetch_arg)</p>
<p>This ioctl is primarily used when the application accesses the buffer<br>with mmap(2). Its argument is a pointer to the following structure:</p>
<p>struct mon_mfetch_arg {<br>    uint32_t <em>offvec;    /</em> Vector of events fetched <em>/<br>    uint32_t nfetch;    /</em> Number of events to fetch (out: fetched) <em>/<br>    uint32_t nflush;    /</em> Number of events to flush */<br>};</p>
<p>The ioctl operates in 3 stages.</p>
<p>First, it removes and discards up to nflush events from the kernel buffer.<br>The actual number of events discarded is returned in nflush.</p>
<p>Second, it waits for an event to be present in the buffer, unless the pseudo-<br>device is open with O_NONBLOCK.</p>
<p>Third, it extracts up to nfetch offsets into the mmap buffer, and stores<br>them into the offvec. The actual number of event offsets is stored into<br>the nfetch.</p>
<p> MON_IOCH_MFLUSH, defined as _IO(MON_IOC_MAGIC, 8)</p>
<p>This call removes a number of events from the kernel buffer. Its argument<br>is the number of events to remove. If the buffer contains fewer events<br>than requested, all events present are removed, and no error is reported.<br>This works when no events are available too.</p>
<p> FIONBIO</p>
<p>The ioctl FIONBIO may be implemented in the future, if there’s a need.</p>
<p>In addition to ioctl(2) and read(2), the special file of binary API can<br>be polled with select(2) and poll(2). But lseek(2) does not work.</p>
<ul>
<li>Memory-mapped access of the kernel buffer for the binary API</li>
</ul>
<p>The basic idea is simple:</p>
<p>To prepare, map the buffer by getting the current size, then using mmap(2).<br>Then, execute a loop similar to the one written in pseudo-code below:</p>
<p>   struct mon_mfetch_arg fetch;<br>   struct usbmon_packet *hdr;<br>   int nflush = 0;<br>   for (;;) {<br>      fetch.offvec = vec; // Has N 32-bit words<br>      fetch.nfetch = N;   // Or less than N<br>      fetch.nflush = nflush;<br>      ioctl(fd, MON_IOCX_MFETCH, &amp;fetch);   // Process errors, too<br>      nflush = fetch.nfetch;       // This many packets to flush when done<br>      for (i = 0; i &lt; nflush; i++) {<br>         hdr = (struct ubsmon_packet *) &amp;mmap_area[vec[i]];<br>         if (hdr-&gt;type == ‘@’)     // Filler packet<br>            continue;<br>         caddr_t data = &amp;mmap_area[vec[i]] + 64;<br>         process_packet(hdr, data);<br>      }<br>   }</p>
<p>Thus, the main idea is to execute only one ioctl per N events.</p>
<p>Although the buffer is circular, the returned headers and data do not cross<br>the end of the buffer, so the above pseudo-code does not need any gathering.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_usbmon/" title="Kernel-4.18.0-80.el8_usbmon" target="_blank" rel="external">http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_usbmon/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_usbmisc-imx/" title="Kernel-4.18.0-80.el8_usbmisc-imx"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_usdhi6rol0/" title="Kernel-4.18.0-80.el8_usdhi6rol0"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>