<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-4.18.0-80.el8_carrier | oosTech.com</title>
  <meta name="description" content="FMC Device  Within the Linux bus framework, the FMC device is created andregistered by the carrier driver. For example, the PCI driver for theSPEC card fills a data structure for each SPEC that it dri">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-4.18.0-80.el8_carrier">
<meta property="og:url" content="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_carrier/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="FMC Device  Within the Linux bus framework, the FMC device is created andregistered by the carrier driver. For example, the PCI driver for theSPEC card fills a data structure for each SPEC that it dri">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:modified_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_carrier/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#The-API-Offered-by-Carriers"><span class="toc-number">1.</span> <span class="toc-text">The API Offered by Carriers</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-GPIO-Abstraction"><span class="toc-number">2.</span> <span class="toc-text">The GPIO Abstraction</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-4.18.0-80.el8_carrier" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-4.18.0-80.el8_carrier
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_carrier/" class="article-date">
	 published: <time datetime="2021-02-18T16:00:00.000Z" itemprop="datePublished">2021-02-19</time>
	</a>
</span>

        
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_carrier/" class="article-date">
	   updated: <time datetime="2021-02-18T16:00:00.000Z" itemprop="dateUpdated">2021-02-19</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/02/19/Kernel-4.18.0-80.el8_carrier/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>FMC Device</p>
<hr>
<p>Within the Linux bus framework, the FMC device is created and<br>registered by the carrier driver. For example, the PCI driver for the<br>SPEC card fills a data structure for each SPEC that it drives, and<br>registers an associated FMC device for each card.  The SVEC driver can<br>do exactly the same for the VME carrier (actually, it should do it<br>twice, because the SVEC carries two FMC mezzanines).  Similarly, an<br>Etherbone driver will be able to register its own FMC devices, offering<br>communication primitives through frame exchange.</p>
<p>The contents of the EEPROM within the FMC are used for identification<br>purposes, i.e. for matching the device with its own driver. For this<br>reason the device structure includes a complete copy of the EEPROM<br>(actually, the carrier driver may choose whether or not to return it -<br>for example we most likely won’t have the whole EEPROM available for<br>Etherbone devices.</p>
<p>The following listing shows the current structure defining a device.<br>Please note that all the machinery is in place but some details may<br>still change in the future.  For this reason, there is a version field<br>at the beginning of the structure.  As usual, the minor number will<br>change for compatible changes (like a new flag) and the major number<br>will increase when an incompatible change happens (for example, a<br>change in layout of some fmc data structures).  Device writers should<br>just set it to the value FMC_VERSION, and be ready to get back -EINVAL<br>at registration time.</p>
<pre><code> struct fmc_device &#123;
         unsigned long version;
         unsigned long flags;
         struct module *owner;           /* char device must pin it */
         struct fmc_fru_id id;           /* for EEPROM-based match */
         struct fmc_operations *op;      /* carrier-provided */
         int irq;                        /* according to host bus. 0 == none */
         int eeprom_len;                 /* Usually 8kB, may be less */
         int eeprom_addr;                /* 0x50, 0x52 etc */
         uint8_t *eeprom;                /* Full contents or leading part */
         char *carrier_name;             /* &quot;SPEC&quot; or similar, for special use */
         void *carrier_data;             /* &quot;struct spec *&quot; or equivalent */
         __iomem void *fpga_base;        /* May be NULL (Etherbone) */
         __iomem void *slot_base;        /* Set by the driver */
         struct fmc_device **devarray;   /* Allocated by the bus */
         int slot_id;                    /* Index in the slot array */
         int nr_slots;                   /* Number of slots in this carrier */
         unsigned long memlen;           /* Used for the char device */
         struct device dev;              /* For Linux use */
         struct device *hwdev;           /* The underlying hardware device */
         unsigned long sdbfs_entry;
         struct sdb_array *sdb;
         uint32_t device_id;             /* Filled by the device */
         char *mezzanine_name;           /* Defaults to ``fmc&#39;&#39; */
         void *mezzanine_data;
 &#125;;
</code></pre>
<p>The meaning of most fields is summarized in the code comment above.</p>
<p>The following fields must be filled by the carrier driver before<br>registration:</p>
<ul>
<li><p>version: must be set to FMC_VERSION.</p>
</li>
<li><p>owner: set to MODULE_OWNER.</p>
</li>
<li><p>op: the operations to act on the device.</p>
</li>
<li><p>irq: number for the mezzanine; may be zero.</p>
</li>
<li><p>eeprom_len: length of the following array.</p>
</li>
<li><p>eeprom_addr: 0x50 for first mezzanine and so on.</p>
</li>
<li><p>eeprom: the full content of the I2C EEPROM.</p>
</li>
<li><p>carrier_name.</p>
</li>
<li><p>carrier_data: a unique pointer for the carrier.</p>
</li>
<li><p>fpga_base: the I/O memory address (may be NULL).</p>
</li>
<li><p>slot_id: the index of this slot (starting from zero).</p>
</li>
<li><p>memlen: if fpga_base is valid, the length of I/O memory.</p>
</li>
<li><p>hwdev: to be used in some dev_err() calls.</p>
</li>
<li><p>device_id: a slot-specific unique integer number.</p>
</li>
</ul>
<p>Please note that the carrier should read its own EEPROM memory before<br>registering the device, as well as fill all other fields listed above.</p>
<p>The following fields should not be assigned, because they are filled<br>later by either the bus or the device driver:</p>
<ul>
<li><p>flags.</p>
</li>
<li><p>fru_id: filled by the bus, parsing the eeprom.</p>
</li>
<li><p>slot_base: filled and used by the driver, if useful to it.</p>
</li>
<li><p>devarray: an array og all mezzanines driven by a singe FPGA.</p>
</li>
<li><p>nr_slots: set by the core at registration time.</p>
</li>
<li><p>dev: used by Linux.</p>
</li>
<li><p>sdb: FPGA contents, scanned according to driver’s directions.</p>
</li>
<li><p>sdbfs_entry: SDB entry point in EEPROM: autodetected.</p>
</li>
<li><p>mezzanine_data: available for the driver.</p>
</li>
<li><p>mezzanine_name: filled by fmc-bus during identification.</p>
</li>
</ul>
<p>Note: mezzanine_data may be redundant, because Linux offers the drvdata<br>approach, so the field may be removed in later versions of this bus<br>implementation.</p>
<p>As I write this, she SPEC carrier is already completely functional in<br>the fmc-bus environment, and is a good reference to look at.</p>
<h1 id="The-API-Offered-by-Carriers"><a href="#The-API-Offered-by-Carriers" class="headerlink" title="The API Offered by Carriers"></a>The API Offered by Carriers</h1><p>The carrier provides a number of methods by means of the<br>`fmc_operations’ structure, which currently is defined like this<br>(again, it is a moving target, please refer to the header rather than<br>this document):</p>
<pre><code> struct fmc_operations &#123;
         uint32_t (*readl)(struct fmc_device *fmc, int offset);
         void (*writel)(struct fmc_device *fmc, uint32_t value, int offset);
         int (*reprogram)(struct fmc_device *f, struct fmc_driver *d, char *gw);
         int (*validate)(struct fmc_device *fmc, struct fmc_driver *drv);
         int (*irq_request)(struct fmc_device *fmc, irq_handler_t h,
                            char *name, int flags);
         void (*irq_ack)(struct fmc_device *fmc);
         int (*irq_free)(struct fmc_device *fmc);
         int (*gpio_config)(struct fmc_device *fmc, struct fmc_gpio *gpio,
                            int ngpio);
         int (*read_ee)(struct fmc_device *fmc, int pos, void *d, int l);
         int (*write_ee)(struct fmc_device *fmc, int pos, const void *d, int l);
 &#125;;
</code></pre>
<p>The individual methods perform the following tasks:</p>
<p><code>readl&#39; </code>writel’<br>     These functions access FPGA registers by whatever means the<br>     carrier offers. They are not expected to fail, and most of the time<br>     they will just make a memory access to the host bus. If the<br>     carrier provides a fpga_base pointer, the driver may use direct<br>     access through that pointer. For this reason the header offers the<br>     inline functions fmc_readl and fmc_writel that access fpga_base if<br>     the respective method is NULL. A driver that wants to be portable<br>     and efficient should use fmc_readl and fmc_writel.  For Etherbone,<br>     or other non-local carriers, error-management is still to be<br>     defined.</p>
<p><code>validate&#39;      Module parameters are used to manage different applications for      two or more boards of the same kind. Validation is based on the      busid module parameter, if provided, and returns the matching      index in the associated array. See *note Module Parameters:: in in      doubt. If no match is found, </code>-ENOENT’ is returned; if the user<br>     didn’t pass <code>busid=&#39;, all devices will pass validation.  The value      returned by the validate method can be used as index into other      parameters (for example, some drivers use the </code>lm32=’ parameter in<br>     this way). Such “generic parameters” are documented in *note<br>     Module Parameters::, below. The validate method is used by<br>     `fmc-trivial.ko’, described in *note fmc-trivial::.</p>
<p><code>reprogram&#39;      The carrier enumerates FMC devices by loading a standard (or      golden) FPGA binary that allows EEPROM access. Each driver, then,      will need to reprogram the FPGA by calling this function.  If the      name argument is NULL, the carrier should reprogram the golden      binary. If the gateware name has been overridden through module      parameters (in a carrier-specific way) the file loaded will match      the parameters. Per-device gateware names can be specified using      the </code>gateware=’ parameter, see *note Module Parameters::.  Note:<br>     Clients should call rhe new helper, fmc_reprogram, which both<br>     calls this method and parse the SDB tree of the FPGA.</p>
<p><code>irq_request&#39; </code>irq_ack’<br><code>irq_free&#39;      Interrupt management is carrier-specific, so it is abstracted as      operations. The interrupt number is listed in the device      structure, and for the mezzanine driver the number is only      informative.  The handler will receive the fmc pointer as dev_id;      the flags argument is passed to the Linux request_irq function,      but fmc-specific flags may be added in the future. You&#39;ll most      likely want to pass the </code>IRQF_SHARED’ flag.</p>
<p>`gpio_config’<br>     The method allows to configure a GPIO pin in the carrier, and read<br>     its current value if it is configured as input. See *note The GPIO<br>     Abstraction:: for details.</p>
<p><code>read_ee&#39; </code>write_ee’<br>     Read or write the EEPROM. The functions are expected to be only<br>     called before reprogramming and the carrier should refuse them<br>     with <code>ENODEV&#39; after reprogramming.  The offset is expected to be      within 8kB (the current size), but addresses up to 1MB are      reserved to fit bigger I2C devices in the future. Carriers may      offer access to other internal flash memories using these same      methods: for example the SPEC driver may define that its carrier      I2C memory is seen at offset 1M and the internal SPI flash is seen      at offset 16M.  This multiplexing of several flash memories in the      same address space is carrier-specific and should only be used      by a driver that has verified the </code>carrier_name’ field.</p>
<h1 id="The-GPIO-Abstraction"><a href="#The-GPIO-Abstraction" class="headerlink" title="The GPIO Abstraction"></a>The GPIO Abstraction</h1><p>Support for GPIO pins in the fmc-bus environment is not very<br>straightforward and deserves special discussion.</p>
<p>While the general idea of a carrier-independent driver seems to fly,<br>configuration of specific signals within the carrier needs at least<br>some knowledge of the carrier itself.  For this reason, the specific<br>driver can request to configure carrier-specific GPIO pins, numbered<br>from 0 to at most 4095.  Configuration is performed by passing a<br>pointer to an array of struct fmc_gpio items, as well as the length of<br>the array. This is the data structure:</p>
<pre><code>    struct fmc_gpio &#123;
            char *carrier_name;
            int gpio;
            int _gpio;      /* internal use by the carrier */
            int mode;       /* GPIOF_DIR_OUT etc, from &lt;linux/gpio.h&gt; */
            int irqmode;    /* IRQF_TRIGGER_LOW and so on */
    &#125;;
</code></pre>
<p>By specifying a carrier_name for each pin, the driver may access<br>different pins in different carriers.  The gpio_config method is<br>expected to return the number of pins successfully configured, ignoring<br>requests for other carriers. However, if no pin is configured (because<br>no structure at all refers to the current carrier_name), the operation<br>returns an error so the caller will know that it is running under a<br>yet-unsupported carrier.</p>
<p>So, for example, a driver that has been developed and tested on both<br>the SPEC and the SVEC may request configuration of two different GPIO<br>pins, and expect one such configuration to succeed - if none succeeds<br>it most likely means that the current carrier is a still-unknown one.</p>
<p>If, however, your GPIO pin has a specific known role, you can pass a<br>special number in the gpio field, using one of the following macros:</p>
<pre><code>    #define FMC_GPIO_RAW(x)         (x)             /* 4096 of them */
    #define FMC_GPIO_IRQ(x)         ((x) + 0x1000)  /*  256 of them */
    #define FMC_GPIO_LED(x)         ((x) + 0x1100)  /*  256 of them */
    #define FMC_GPIO_KEY(x)         ((x) + 0x1200)  /*  256 of them */
    #define FMC_GPIO_TP(x)          ((x) + 0x1300)  /*  256 of them */
    #define FMC_GPIO_USER(x)        ((x) + 0x1400)  /*  256 of them */
</code></pre>
<p>Use of virtual GPIO numbers (anything but FMC_GPIO_RAW) is allowed<br>provided the carrier_name field in the data structure is left<br>unspecified (NULL). Each carrier is responsible for providing a mapping<br>between virtual and physical GPIO numbers. The carrier may then use the<br>_gpio field to cache the result of this mapping.</p>
<p>All carriers must map their I/O lines to the sets above starting from<br>zero.  The SPEC, for example, maps interrupt pins 0 and 1, and test<br>points 0 through 3 (even if the test points on the PCB are called<br>5,6,7,8).</p>
<p>If, for example, a driver requires a free LED and a test point (for a<br>scope probe to be plugged at some point during development) it may ask<br>for FMC_GPIO_LED(0) and FMC_GPIO_TP(0). Each carrier will provide<br>suitable GPIO pins.  Clearly, the person running the drivers will know<br>the order used by the specific carrier driver in assigning leds and<br>testpoints, so to make a carrier-dependent use of the diagnostic tools.</p>
<p>In theory, some form of autodetection should be possible: a driver like<br>the wr-nic (which uses IRQ(1) on the SPEC card) should configure<br>IRQ(0), make a test with software-generated interrupts and configure<br>IRQ(1) if the test fails. This probing step should be used because even<br>if the wr-nic gateware is known to use IRQ1 on the SPEC, the driver<br>should be carrier-independent and thus use IRQ(0) as a first bet -<br>actually, the knowledge that IRQ0 may fail is carrier-dependent<br>information, but using it doesn’t make the driver unsuitable for other<br>carriers.</p>
<p>The return value of gpio_config is defined as follows:</p>
<ul>
<li><p>If no pin in the array can be used by the carrier, `-ENODEV’.</p>
</li>
<li><p>If at least one virtual GPIO number cannot be mapped, `-ENOENT’.</p>
</li>
<li><p>On success, 0 or positive. The value returned is the number of<br>high input bits (if no input is configured, the value for success<br>is 0).</p>
</li>
</ul>
<p>While I admit the procedure is not completely straightforward, it<br>allows configuration, input and output with a single carrier operation.<br>Given the typical use case of FMC devices, GPIO operations are not<br>expected to ever by in hot paths, and GPIO access so fare has only been<br>used to configure the interrupt pin, mode and polarity. Especially<br>reading inputs is not expected to be common. If your device has GPIO<br>capabilities in the hot path, you should consider using the kernel’s<br>GPIO mechanisms.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_carrier/" title="Kernel-4.18.0-80.el8_carrier" target="_blank" rel="external">http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_carrier/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_cavium-compact-flash/" title="Kernel-4.18.0-80.el8_cavium-compact-flash"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_capability/" title="Kernel-4.18.0-80.el8_capability"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>