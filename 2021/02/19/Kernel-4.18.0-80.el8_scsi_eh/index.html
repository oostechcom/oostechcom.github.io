<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-4.18.0-80.el8_scsi_eh | oosTech.com</title>
  <meta name="description" content="SCSI EH This document describes SCSI midlayer error handling infrastructure.Please refer to Documentation&#x2F;scsi&#x2F;scsi_mid_low_api.txt for moreinformation regarding SCSI midlayer. TABLE OF CONTENTS [1] H">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-4.18.0-80.el8_scsi_eh">
<meta property="og:url" content="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_scsi_eh/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="SCSI EH This document describes SCSI midlayer error handling infrastructure.Please refer to Documentation&#x2F;scsi&#x2F;scsi_mid_low_api.txt for moreinformation regarding SCSI midlayer. TABLE OF CONTENTS [1] H">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:modified_time" content="2021-02-18T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_scsi_eh/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SCSI-EH"><span class="toc-number">1.</span> <span class="toc-text">SCSI EH</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-4.18.0-80.el8_scsi_eh" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-4.18.0-80.el8_scsi_eh
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_scsi_eh/" class="article-date">
	 published: <time datetime="2021-02-18T16:00:00.000Z" itemprop="datePublished">2021-02-19</time>
	</a>
</span>

        
	<a href="/2021/02/19/Kernel-4.18.0-80.el8_scsi_eh/" class="article-date">
	   updated: <time datetime="2021-02-18T16:00:00.000Z" itemprop="dateUpdated">2021-02-19</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/02/19/Kernel-4.18.0-80.el8_scsi_eh/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="SCSI-EH"><a href="#SCSI-EH" class="headerlink" title="SCSI EH"></a>SCSI EH</h1><p> This document describes SCSI midlayer error handling infrastructure.<br>Please refer to Documentation/scsi/scsi_mid_low_api.txt for more<br>information regarding SCSI midlayer.</p>
<p>TABLE OF CONTENTS</p>
<p>[1] How SCSI commands travel through the midlayer and to EH<br>    [1-1] struct scsi_cmnd<br>    [1-2] How do scmd’s get completed?<br>    [1-2-1] Completing a scmd w/ scsi_done<br>    [1-2-2] Completing a scmd w/ timeout<br>    [1-3] How EH takes over<br>[2] How SCSI EH works<br>    [2-1] EH through fine-grained callbacks<br>    [2-1-1] Overview<br>    [2-1-2] Flow of scmds through EH<br>    [2-1-3] Flow of control<br>    [2-2] EH through transportt-&gt;eh_strategy_handler()<br>    [2-2-1] Pre transportt-&gt;eh_strategy_handler() SCSI midlayer conditions<br>    [2-2-2] Post transportt-&gt;eh_strategy_handler() SCSI midlayer conditions<br>    [2-2-3] Things to consider</p>
<p>[1] How SCSI commands travel through the midlayer and to EH</p>
<p>[1-1] struct scsi_cmnd</p>
<p> Each SCSI command is represented with struct scsi_cmnd (== scmd).  A<br>scmd has two list_head’s to link itself into lists.  The two are<br>scmd-&gt;list and scmd-&gt;eh_entry.  The former is used for free list or<br>per-device allocated scmd list and not of much interest to this EH<br>discussion.  The latter is used for completion and EH lists and unless<br>otherwise stated scmds are always linked using scmd-&gt;eh_entry in this<br>discussion.</p>
<p>[1-2] How do scmd’s get completed?</p>
<p> Once LLDD gets hold of a scmd, either the LLDD will complete the<br>command by calling scsi_done callback passed from midlayer when<br>invoking hostt-&gt;queuecommand() or the block layer will time it out.</p>
<p>[1-2-1] Completing a scmd w/ scsi_done</p>
<p> For all non-EH commands, scsi_done() is the completion callback.  It<br>just calls blk_complete_request() to delete the block layer timer and<br>raise SCSI_SOFTIRQ</p>
<p> SCSI_SOFTIRQ handler scsi_softirq calls scsi_decide_disposition() to<br>determine what to do with the command.  scsi_decide_disposition()<br>looks at the scmd-&gt;result value and sense data to determine what to do<br>with the command.</p>
<ul>
<li><p>SUCCESS<br> scsi_finish_command() is invoked for the command.  The<br> function does some maintenance chores and then calls<br> scsi_io_completion() to finish the I/O.<br> scsi_io_completion() then notifies the block layer on<br> the completed request by calling blk_end_request and<br> friends or figures out what to do with the remainder<br> of the data in case of an error.</p>
</li>
<li><p>NEEDS_RETRY</p>
</li>
<li><p>ADD_TO_MLQUEUE<br> scmd is requeued to blk queue.</p>
</li>
<li><p>otherwise<br> scsi_eh_scmd_add(scmd) is invoked for the command.  See<br> [1-3] for details of this function.</p>
</li>
</ul>
<p>[1-2-2] Completing a scmd w/ timeout</p>
<p> The timeout handler is scsi_times_out().  When a timeout occurs, this<br>function</p>
<ol>
<li><p>invokes optional hostt-&gt;eh_timed_out() callback.  Return value can<br>be one of</p>
<ul>
<li><p>BLK_EH_RESET_TIMER<br>This indicates that more time is required to finish the<br>command.  Timer is restarted.  This action is counted as a<br>retry and only allowed scmd-&gt;allowed + 1(!) times.  Once the<br>limit is reached, action for BLK_EH_DONE is taken instead.</p>
</li>
<li><p>BLK_EH_DONE<br>  eh_timed_out() callback did not handle the command.<br>Step #2 is taken.</p>
</li>
</ul>
</li>
<li><p>scsi_abort_command() is invoked to schedule an asynchrous abort.<br>Asynchronous abort are not invoked for commands which the<br>SCSI_EH_ABORT_SCHEDULED flag is set (this indicates that the command<br>already had been aborted once, and this is a retry which failed),<br>or when the EH deadline is expired. In these case Step #3 is taken.</p>
</li>
<li><p>scsi_eh_scmd_add(scmd, SCSI_EH_CANCEL_CMD) is invoked for the<br>command.  See [1-4] for more information.</p>
</li>
</ol>
<p>[1-3] Asynchronous command aborts</p>
<p> After a timeout occurs a command abort is scheduled from<br> scsi_abort_command(). If the abort is successful the command<br> will either be retried (if the number of retries is not exhausted)<br> or terminated with DID_TIME_OUT.<br> Otherwise scsi_eh_scmd_add() is invoked for the command.<br> See [1-4] for more information.</p>
<p>[1-4] How EH takes over</p>
<p> scmds enter EH via scsi_eh_scmd_add(), which does the following.</p>
<ol>
<li><p>Links scmd-&gt;eh_entry to shost-&gt;eh_cmd_q</p>
</li>
<li><p>Sets SHOST_RECOVERY bit in shost-&gt;shost_state</p>
</li>
<li><p>Increments shost-&gt;host_failed</p>
</li>
<li><p>Wakes up SCSI EH thread if shost-&gt;host_busy == shost-&gt;host_failed</p>
<p>As can be seen above, once any scmd is added to shost-&gt;eh_cmd_q,<br>SHOST_RECOVERY shost_state bit is turned on.  This prevents any new<br>scmd to be issued from blk queue to the host; eventually, all scmds on<br>the host either complete normally, fail and get added to eh_cmd_q, or<br>time out and get added to shost-&gt;eh_cmd_q.</p>
<p>If all scmds either complete or fail, the number of in-flight scmds<br>becomes equal to the number of failed scmds - i.e. shost-&gt;host_busy ==<br>shost-&gt;host_failed.  This wakes up SCSI EH thread.  So, once woken up,<br>SCSI EH thread can expect that all in-flight commands have failed and<br>are linked on shost-&gt;eh_cmd_q.</p>
<p>Note that this does not mean lower layers are quiescent.  If a LLDD<br>completed a scmd with error status, the LLDD and lower layers are<br>assumed to forget about the scmd at that point.  However, if a scmd<br>has timed out, unless hostt-&gt;eh_timed_out() made lower layers forget<br>about the scmd, which currently no LLDD does, the command is still<br>active as long as lower layers are concerned and completion could<br>occur at any time.  Of course, all such completions are ignored as the<br>timer has already expired.</p>
<p>We’ll talk about how SCSI EH takes actions to abort - make LLDD<br>forget about - timed out scmds later.</p>
</li>
</ol>
<p>[2] How SCSI EH works</p>
<p> LLDD’s can implement SCSI EH actions in one of the following two<br>ways.</p>
<ul>
<li><p>Fine-grained EH callbacks<br> LLDD can implement fine-grained EH callbacks and let SCSI<br> midlayer drive error handling and call appropriate callbacks.<br> This will be discussed further in [2-1].</p>
</li>
<li><p>eh_strategy_handler() callback<br> This is one big callback which should perform whole error<br> handling.  As such, it should do all chores the SCSI midlayer<br> performs during recovery.  This will be discussed in [2-2].</p>
<p>Once recovery is complete, SCSI EH resumes normal operation by<br>calling scsi_restart_operations(), which</p>
</li>
</ul>
<ol>
<li><p>Checks if door locking is needed and locks door.</p>
</li>
<li><p>Clears SHOST_RECOVERY shost_state bit</p>
</li>
<li><p>Wakes up waiters on shost-&gt;host_wait.  This occurs if someone<br>calls scsi_block_when_processing_errors() on the host.<br>(<em>QUESTION</em> why is it needed?  All operations will be blocked<br>anyway after it reaches blk queue.)</p>
</li>
<li><p>Kicks queues in all devices on the host in the asses</p>
</li>
</ol>
<p>[2-1] EH through fine-grained callbacks</p>
<p>[2-1-1] Overview</p>
<p> If eh_strategy_handler() is not present, SCSI midlayer takes charge<br>of driving error handling.  EH’s goals are two - make LLDD, host and<br>device forget about timed out scmds and make them ready for new<br>commands.  A scmd is said to be recovered if the scmd is forgotten by<br>lower layers and lower layers are ready to process or fail the scmd<br>again.</p>
<p> To achieve these goals, EH performs recovery actions with increasing<br>severity.  Some actions are performed by issuing SCSI commands and<br>others are performed by invoking one of the following fine-grained<br>hostt EH callbacks.  Callbacks may be omitted and omitted ones are<br>considered to fail always.</p>
<p>int (* eh_abort_handler)(struct scsi_cmnd <em>);<br>int (</em> eh_device_reset_handler)(struct scsi_cmnd <em>);<br>int (</em> eh_bus_reset_handler)(struct scsi_cmnd <em>);<br>int (</em> eh_host_reset_handler)(struct scsi_cmnd *);</p>
<p> Higher-severity actions are taken only when lower-severity actions<br>cannot recover some of failed scmds.  Also, note that failure of the<br>highest-severity action means EH failure and results in offlining of<br>all unrecovered devices.</p>
<p> During recovery, the following rules are followed</p>
<ul>
<li><p>Recovery actions are performed on failed scmds on the to do list,<br>eh_work_q.  If a recovery action succeeds for a scmd, recovered<br>scmds are removed from eh_work_q.</p>
<p>Note that single recovery action on a scmd can recover multiple<br>scmds.  e.g. resetting a device recovers all failed scmds on the<br>device.</p>
</li>
<li><p>Higher severity actions are taken iff eh_work_q is not empty after<br>lower severity actions are complete.</p>
</li>
<li><p>EH reuses failed scmds to issue commands for recovery.  For<br>timed-out scmds, SCSI EH ensures that LLDD forgets about a scmd<br>before reusing it for EH commands.</p>
<p>When a scmd is recovered, the scmd is moved from eh_work_q to EH<br>local eh_done_q using scsi_eh_finish_cmd().  After all scmds are<br>recovered (eh_work_q is empty), scsi_eh_flush_done_q() is invoked to<br>either retry or error-finish (notify upper layer of failure) recovered<br>scmds.</p>
<p>scmds are retried iff its sdev is still online (not offlined during<br>EH), REQ_FAILFAST is not set and ++scmd-&gt;retries is less than<br>scmd-&gt;allowed.</p>
</li>
</ul>
<p>[2-1-2] Flow of scmds through EH</p>
<ol>
<li><p>Error completion / time out<br>ACTION: scsi_eh_scmd_add() is invoked for scmd</p>
<ul>
<li>add scmd to shost-&gt;eh_cmd_q</li>
<li>set SHOST_RECOVERY</li>
<li>shost-&gt;host_failed++<br>LOCKING: shost-&gt;host_lock</li>
</ul>
</li>
<li><p>EH starts<br>ACTION: move all scmds to EH’s local eh_work_q.  shost-&gt;eh_cmd_q</p>
<pre><code>is cleared.
</code></pre>
<p>LOCKING: shost-&gt;host_lock (not strictly necessary, just for</p>
<pre><code>     consistency)
</code></pre>
</li>
<li><p>scmd recovered<br>ACTION: scsi_eh_finish_cmd() is invoked to EH-finish scmd</p>
<ul>
<li>scsi_setup_cmd_retry()</li>
<li>move from local eh_work_q to local eh_done_q<br>LOCKING: none<br>CONCURRENCY: at most one thread per separate eh_work_q to<br>   keep queue manipulation lockless</li>
</ul>
</li>
<li><p>EH completes<br>ACTION: scsi_eh_flush_done_q() retries scmds or notifies upper</p>
<pre><code>layer of failure. May be called concurrently but must have
a no more than one thread per separate eh_work_q to
manipulate the queue locklessly
</code></pre>
<ul>
<li>scmd is removed from eh_done_q and scmd-&gt;eh_entry is cleared</li>
<li>if retry is necessary, scmd is requeued using<pre><code>scsi_queue_insert()
</code></pre>
</li>
<li>otherwise, scsi_finish_command() is invoked for scmd</li>
<li>zero shost-&gt;host_failed<br>LOCKING: queue or finish function performs appropriate locking</li>
</ul>
</li>
</ol>
<p>[2-1-3] Flow of control</p>
<p> EH through fine-grained callbacks start from scsi_unjam_host().</p>
<p>&lt;<scsi_unjam_host>&gt;</p>
<pre><code>1. Lock shost-&gt;host_lock, splice_init shost-&gt;eh_cmd_q into local
   eh_work_q and unlock host_lock.  Note that shost-&gt;eh_cmd_q is
   cleared by this action.

2. Invoke scsi_eh_get_sense.

&lt;&lt;scsi_eh_get_sense&gt;&gt;

This action is taken for each error-completed
(!SCSI_EH_CANCEL_CMD) commands without valid sense data.  Most
SCSI transports/LLDDs automatically acquire sense data on
command failures (autosense).  Autosense is recommended for
performance reasons and as sense information could get out of
sync between occurrence of CHECK CONDITION and this action.

Note that if autosense is not supported, scmd-&gt;sense_buffer
contains invalid sense data when error-completing the scmd
with scsi_done().  scsi_decide_disposition() always returns
FAILED in such cases thus invoking SCSI EH.  When the scmd
reaches here, sense data is acquired and
scsi_decide_disposition() is called again.

1. Invoke scsi_request_sense() which issues REQUEST_SENSE
       command.  If fails, no action.  Note that taking no action
       causes higher-severity recovery to be taken for the scmd.

2. Invoke scsi_decide_disposition() on the scmd

   - SUCCESS
    scmd-&gt;retries is set to scmd-&gt;allowed preventing
    scsi_eh_flush_done_q() from retrying the scmd and
    scsi_eh_finish_cmd() is invoked.

   - NEEDS_RETRY
    scsi_eh_finish_cmd() invoked

   - otherwise
    No action.

3. If !list_empty(&amp;eh_work_q), invoke scsi_eh_abort_cmds().

&lt;&lt;scsi_eh_abort_cmds&gt;&gt;

This action is taken for each timed out command when
no_async_abort is enabled in the host template.
hostt-&gt;eh_abort_handler() is invoked for each scmd.  The
handler returns SUCCESS if it has succeeded to make LLDD and
all related hardware forget about the scmd.

If a timedout scmd is successfully aborted and the sdev is
either offline or ready, scsi_eh_finish_cmd() is invoked for
the scmd.  Otherwise, the scmd is left in eh_work_q for
higher-severity actions.

Note that both offline and ready status mean that the sdev is
ready to process new scmds, where processing also implies
immediate failing; thus, if a sdev is in one of the two
states, no further recovery action is needed.

Device readiness is tested using scsi_eh_tur() which issues
TEST_UNIT_READY command.  Note that the scmd must have been
aborted successfully before reusing it for TEST_UNIT_READY.

4. If !list_empty(&amp;eh_work_q), invoke scsi_eh_ready_devs()

&lt;&lt;scsi_eh_ready_devs&gt;&gt;

This function takes four increasingly more severe measures to
make failed sdevs ready for new commands.

1. Invoke scsi_eh_stu()

&lt;&lt;scsi_eh_stu&gt;&gt;

    For each sdev which has failed scmds with valid sense data
    of which scsi_check_sense()&#39;s verdict is FAILED,
    START_STOP_UNIT command is issued w/ start=1.  Note that
    as we explicitly choose error-completed scmds, it is known
    that lower layers have forgotten about the scmd and we can
    reuse it for STU.

    If STU succeeds and the sdev is either offline or ready,
    all failed scmds on the sdev are EH-finished with
    scsi_eh_finish_cmd().

    *NOTE* If hostt-&gt;eh_abort_handler() isn&#39;t implemented or
    failed, we may still have timed out scmds at this point
    and STU doesn&#39;t make lower layers forget about those
    scmds.  Yet, this function EH-finish all scmds on the sdev
    if STU succeeds leaving lower layers in an inconsistent
    state.  It seems that STU action should be taken only when
    a sdev has no timed out scmd.

2. If !list_empty(&amp;eh_work_q), invoke scsi_eh_bus_device_reset().

&lt;&lt;scsi_eh_bus_device_reset&gt;&gt;

    This action is very similar to scsi_eh_stu() except that,
    instead of issuing STU, hostt-&gt;eh_device_reset_handler()
    is used.  Also, as we&#39;re not issuing SCSI commands and
    resetting clears all scmds on the sdev, there is no need
    to choose error-completed scmds.

3. If !list_empty(&amp;eh_work_q), invoke scsi_eh_bus_reset()

&lt;&lt;scsi_eh_bus_reset&gt;&gt;

    hostt-&gt;eh_bus_reset_handler() is invoked for each channel
    with failed scmds.  If bus reset succeeds, all failed
    scmds on all ready or offline sdevs on the channel are
    EH-finished.

4. If !list_empty(&amp;eh_work_q), invoke scsi_eh_host_reset()

&lt;&lt;scsi_eh_host_reset&gt;&gt;

    This is the last resort.  hostt-&gt;eh_host_reset_handler()
    is invoked.  If host reset succeeds, all failed scmds on
    all ready or offline sdevs on the host are EH-finished.

5. If !list_empty(&amp;eh_work_q), invoke scsi_eh_offline_sdevs()

&lt;&lt;scsi_eh_offline_sdevs&gt;&gt;

    Take all sdevs which still have unrecovered scmds offline
    and EH-finish the scmds.

5. Invoke scsi_eh_flush_done_q().

&lt;&lt;scsi_eh_flush_done_q&gt;&gt;

    At this point all scmds are recovered (or given up) and
    put on eh_done_q by scsi_eh_finish_cmd().  This function
    flushes eh_done_q by either retrying or notifying upper
    layer of failure of the scmds.
</code></pre>
<p>[2-2] EH through transportt-&gt;eh_strategy_handler()</p>
<p> transportt-&gt;eh_strategy_handler() is invoked in the place of<br>scsi_unjam_host() and it is responsible for whole recovery process.<br>On completion, the handler should have made lower layers forget about<br>all failed scmds and either ready for new commands or offline.  Also,<br>it should perform SCSI EH maintenance chores to maintain integrity of<br>SCSI midlayer.  IOW, of the steps described in [2-1-2], all steps<br>except for #1 must be implemented by eh_strategy_handler().</p>
<p>[2-2-1] Pre transportt-&gt;eh_strategy_handler() SCSI midlayer conditions</p>
<p> The following conditions are true on entry to the handler.</p>
<ul>
<li><p>Each failed scmd’s eh_flags field is set appropriately.</p>
</li>
<li><p>Each failed scmd is linked on scmd-&gt;eh_cmd_q by scmd-&gt;eh_entry.</p>
</li>
<li><p>SHOST_RECOVERY is set.</p>
</li>
<li><p>shost-&gt;host_failed == shost-&gt;host_busy</p>
</li>
</ul>
<p>[2-2-2] Post transportt-&gt;eh_strategy_handler() SCSI midlayer conditions</p>
<p> The following conditions must be true on exit from the handler.</p>
<ul>
<li><p>shost-&gt;host_failed is zero.</p>
</li>
<li><p>Each scmd is in such a state that scsi_setup_cmd_retry() on the<br>scmd doesn’t make any difference.</p>
</li>
<li><p>shost-&gt;eh_cmd_q is cleared.</p>
</li>
<li><p>Each scmd-&gt;eh_entry is cleared.</p>
</li>
<li><p>Either scsi_queue_insert() or scsi_finish_command() is called on<br>each scmd.  Note that the handler is free to use scmd-&gt;retries and<br>-&gt;allowed to limit the number of retries.</p>
</li>
</ul>
<p>[2-2-3] Things to consider</p>
<ul>
<li><p>Know that timed out scmds are still active on lower layers.  Make<br>lower layers forget about them before doing anything else with<br>those scmds.</p>
</li>
<li><p>For consistency, when accessing/modifying shost data structure,<br>grab shost-&gt;host_lock.</p>
</li>
<li><p>On completion, each failed sdev must have forgotten about all<br>active scmds.</p>
</li>
<li><p>On completion, each failed sdev must be ready for new commands or<br>offline.</p>
</li>
</ul>
<p>–<br>Tejun Heo<br><a href="mailto:&#x68;&#x74;&#x65;&#106;&#117;&#110;&#64;&#103;&#x6d;&#x61;&#105;&#x6c;&#46;&#x63;&#x6f;&#x6d;">&#x68;&#x74;&#x65;&#106;&#117;&#110;&#64;&#103;&#x6d;&#x61;&#105;&#x6c;&#46;&#x63;&#x6f;&#x6d;</a><br>11th September 2005</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_scsi_eh/" title="Kernel-4.18.0-80.el8_scsi_eh" target="_blank" rel="external">http://www.oostech.com/2021/02/19/Kernel-4.18.0-80.el8_scsi_eh/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_scaling/" title="Kernel-4.18.0-80.el8_scaling"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/02/19/Kernel-4.18.0-80.el8_scsi_fc_transport/" title="Kernel-4.18.0-80.el8_scsi_fc_transport"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>