<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-3.10.0-957.el7_xfs-self-describing-metadata | oosTech.com</title>
  <meta name="description" content="XFS Self Describing MetadataIntroductionThe largest scalability problem facing XFS is not one of algorithmicscalability, but of verification of the filesystem structure. Scalabilty of thestructures an">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-3.10.0-957.el7_xfs-self-describing-metadata">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_xfs-self-describing-metadata/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="XFS Self Describing MetadataIntroductionThe largest scalability problem facing XFS is not one of algorithmicscalability, but of verification of the filesystem structure. Scalabilty of thestructures an">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_xfs-self-describing-metadata/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#XFS-Self-Describing-Metadata"><span class="toc-number">1.</span> <span class="toc-text">XFS Self Describing Metadata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">2.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Self-Describing-Metadata"><span class="toc-number">3.</span> <span class="toc-text">Self Describing Metadata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Runtime-Validation"><span class="toc-number">4.</span> <span class="toc-text">Runtime Validation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Structures"><span class="toc-number">5.</span> <span class="toc-text">Structures</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Inodes-and-Dquots"><span class="toc-number">6.</span> <span class="toc-text">Inodes and Dquots</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-3.10.0-957.el7_xfs-self-describing-metadata" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-3.10.0-957.el7_xfs-self-describing-metadata
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_xfs-self-describing-metadata/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_xfs-self-describing-metadata/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-3.10.0-957.el7_xfs-self-describing-metadata/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="XFS-Self-Describing-Metadata"><a href="#XFS-Self-Describing-Metadata" class="headerlink" title="XFS Self Describing Metadata"></a>XFS Self Describing Metadata</h2><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>The largest scalability problem facing XFS is not one of algorithmic<br>scalability, but of verification of the filesystem structure. Scalabilty of the<br>structures and indexes on disk and the algorithms for iterating them are<br>adequate for supporting PB scale filesystems with billions of inodes, however it<br>is this very scalability that causes the verification problem.</p>
<p>Almost all metadata on XFS is dynamically allocated. The only fixed location<br>metadata is the allocation group headers (SB, AGF, AGFL and AGI), while all<br>other metadata structures need to be discovered by walking the filesystem<br>structure in different ways. While this is already done by userspace tools for<br>validating and repairing the structure, there are limits to what they can<br>verify, and this in turn limits the supportable size of an XFS filesystem.</p>
<p>For example, it is entirely possible to manually use xfs_db and a bit of<br>scripting to analyse the structure of a 100TB filesystem when trying to<br>determine the root cause of a corruption problem, but it is still mainly a<br>manual task of verifying that things like single bit errors or misplaced writes<br>weren’t the ultimate cause of a corruption event. It may take a few hours to a<br>few days to perform such forensic analysis, so for at this scale root cause<br>analysis is entirely possible.</p>
<p>However, if we scale the filesystem up to 1PB, we now have 10x as much metadata<br>to analyse and so that analysis blows out towards weeks/months of forensic work.<br>Most of the analysis work is slow and tedious, so as the amount of analysis goes<br>up, the more likely that the cause will be lost in the noise.  Hence the primary<br>concern for supporting PB scale filesystems is minimising the time and effort<br>required for basic forensic analysis of the filesystem structure.</p>
<h2 id="Self-Describing-Metadata"><a href="#Self-Describing-Metadata" class="headerlink" title="Self Describing Metadata"></a>Self Describing Metadata</h2><p>One of the problems with the current metadata format is that apart from the<br>magic number in the metadata block, we have no other way of identifying what it<br>is supposed to be. We can’t even identify if it is the right place. Put simply,<br>you can’t look at a single metadata block in isolation and say “yes, it is<br>supposed to be there and the contents are valid”.</p>
<p>Hence most of the time spent on forensic analysis is spent doing basic<br>verification of metadata values, looking for values that are in range (and hence<br>not detected by automated verification checks) but are not correct. Finding and<br>understanding how things like cross linked block lists (e.g. sibling<br>pointers in a btree end up with loops in them) are the key to understanding what<br>went wrong, but it is impossible to tell what order the blocks were linked into<br>each other or written to disk after the fact.</p>
<p>Hence we need to record more information into the metadata to allow us to<br>quickly determine if the metadata is intact and can be ignored for the purpose<br>of analysis. We can’t protect against every possible type of error, but we can<br>ensure that common types of errors are easily detectable.  Hence the concept of<br>self describing metadata.</p>
<p>The first, fundamental requirement of self describing metadata is that the<br>metadata object contains some form of unique identifier in a well known<br>location. This allows us to identify the expected contents of the block and<br>hence parse and verify the metadata object. IF we can’t independently identify<br>the type of metadata in the object, then the metadata doesn’t describe itself<br>very well at all!</p>
<p>Luckily, almost all XFS metadata has magic numbers embedded already - only the<br>AGFL, remote symlinks and remote attribute blocks do not contain identifying<br>magic numbers. Hence we can change the on-disk format of all these objects to<br>add more identifying information and detect this simply by changing the magic<br>numbers in the metadata objects. That is, if it has the current magic number,<br>the metadata isn’t self identifying. If it contains a new magic number, it is<br>self identifying and we can do much more expansive automated verification of the<br>metadata object at runtime, during forensic analysis or repair.</p>
<p>As a primary concern, self describing metadata needs some form of overall<br>integrity checking. We cannot trust the metadata if we cannot verify that it has<br>not been changed as a result of external influences. Hence we need some form of<br>integrity check, and this is done by adding CRC32c validation to the metadata<br>block. If we can verify the block contains the metadata it was intended to<br>contain, a large amount of the manual verification work can be skipped.</p>
<p>CRC32c was selected as metadata cannot be more than 64k in length in XFS and<br>hence a 32 bit CRC is more than sufficient to detect multi-bit errors in<br>metadata blocks. CRC32c is also now hardware accelerated on common CPUs so it is<br>fast. So while CRC32c is not the strongest of possible integrity checks that<br>could be used, it is more than sufficient for our needs and has relatively<br>little overhead. Adding support for larger integrity fields and/or algorithms<br>does really provide any extra value over CRC32c, but it does add a lot of<br>complexity and so there is no provision for changing the integrity checking<br>mechanism.</p>
<p>Self describing metadata needs to contain enough information so that the<br>metadata block can be verified as being in the correct place without needing to<br>look at any other metadata. This means it needs to contain location information.<br>Just adding a block number to the metadata is not sufficient to protect against<br>mis-directed writes - a write might be misdirected to the wrong LUN and so be<br>written to the “correct block” of the wrong filesystem. Hence location<br>information must contain a filesystem identifier as well as a block number.</p>
<p>Another key information point in forensic analysis is knowing who the metadata<br>block belongs to. We already know the type, the location, that it is valid<br>and/or corrupted, and how long ago that it was last modified. Knowing the owner<br>of the block is important as it allows us to find other related metadata to<br>determine the scope of the corruption. For example, if we have a extent btree<br>object, we don’t know what inode it belongs to and hence have to walk the entire<br>filesystem to find the owner of the block. Worse, the corruption could mean that<br>no owner can be found (i.e. it’s an orphan block), and so without an owner field<br>in the metadata we have no idea of the scope of the corruption. If we have an<br>owner field in the metadata object, we can immediately do top down validation to<br>determine the scope of the problem.</p>
<p>Different types of metadata have different owner identifiers. For example,<br>directory, attribute and extent tree blocks are all owned by an inode, whilst<br>freespace btree blocks are owned by an allocation group. Hence the size and<br>contents of the owner field are determined by the type of metadata object we are<br>looking at.  The owner information can also identify misplaced writes (e.g.<br>freespace btree block written to the wrong AG).</p>
<p>Self describing metadata also needs to contain some indication of when it was<br>written to the filesystem. One of the key information points when doing forensic<br>analysis is how recently the block was modified. Correlation of set of corrupted<br>metadata blocks based on modification times is important as it can indicate<br>whether the corruptions are related, whether there’s been multiple corruption<br>events that lead to the eventual failure, and even whether there are corruptions<br>present that the run-time verification is not detecting.</p>
<p>For example, we can determine whether a metadata object is supposed to be free<br>space or still allocated if it is still referenced by its owner by looking at<br>when the free space btree block that contains the block was last written<br>compared to when the metadata object itself was last written.  If the free space<br>block is more recent than the object and the object’s owner, then there is a<br>very good chance that the block should have been removed from the owner.</p>
<p>To provide this “written timestamp”, each metadata block gets the Log Sequence<br>Number (LSN) of the most recent transaction it was modified on written into it.<br>This number will always increase over the life of the filesystem, and the only<br>thing that resets it is running xfs_repair on the filesystem. Further, by use of<br>the LSN we can tell if the corrupted metadata all belonged to the same log<br>checkpoint and hence have some idea of how much modification occurred between<br>the first and last instance of corrupt metadata on disk and, further, how much<br>modification occurred between the corruption being written and when it was<br>detected.</p>
<h2 id="Runtime-Validation"><a href="#Runtime-Validation" class="headerlink" title="Runtime Validation"></a>Runtime Validation</h2><p>Validation of self-describing metadata takes place at runtime in two places:</p>
<pre><code>- immediately after a successful read from disk
- immediately prior to write IO submission
</code></pre>
<p>The verification is completely stateless - it is done independently of the<br>modification process, and seeks only to check that the metadata is what it says<br>it is and that the metadata fields are within bounds and internally consistent.<br>As such, we cannot catch all types of corruption that can occur within a block<br>as there may be certain limitations that operational state enforces of the<br>metadata, or there may be corruption of interblock relationships (e.g. corrupted<br>sibling pointer lists). Hence we still need stateful checking in the main code<br>body, but in general most of the per-field validation is handled by the<br>verifiers.</p>
<p>For read verification, the caller needs to specify the expected type of metadata<br>that it should see, and the IO completion process verifies that the metadata<br>object matches what was expected. If the verification process fails, then it<br>marks the object being read as EFSCORRUPTED. The caller needs to catch this<br>error (same as for IO errors), and if it needs to take special action due to a<br>verification error it can do so by catching the EFSCORRUPTED error value. If we<br>need more discrimination of error type at higher levels, we can define new<br>error numbers for different errors as necessary.</p>
<p>The first step in read verification is checking the magic number and determining<br>whether CRC validating is necessary. If it is, the CRC32c is calculated and<br>compared against the value stored in the object itself. Once this is validated,<br>further checks are made against the location information, followed by extensive<br>object specific metadata validation. If any of these checks fail, then the<br>buffer is considered corrupt and the EFSCORRUPTED error is set appropriately.</p>
<p>Write verification is the opposite of the read verification - first the object<br>is extensively verified and if it is OK we then update the LSN from the last<br>modification made to the object, After this, we calculate the CRC and insert it<br>into the object. Once this is done the write IO is allowed to continue. If any<br>error occurs during this process, the buffer is again marked with a EFSCORRUPTED<br>error for the higher layers to catch.</p>
<h2 id="Structures"><a href="#Structures" class="headerlink" title="Structures"></a>Structures</h2><p>A typical on-disk structure needs to contain the following information:</p>
<p>struct xfs_ondisk_hdr {<br>        __be32  magic;        /* magic number <em>/<br>        __be32  crc;        /</em> CRC, not logged <em>/<br>        uuid_t  uuid;        /</em> filesystem identifier <em>/<br>        __be64  owner;        /</em> parent object <em>/<br>        __be64  blkno;        /</em> location on disk <em>/<br>        __be64  lsn;        /</em> last modification in log, not logged */<br>};</p>
<p>Depending on the metadata, this information may be part of a header structure<br>separate to the metadata contents, or may be distributed through an existing<br>structure. The latter occurs with metadata that already contains some of this<br>information, such as the superblock and AG headers.</p>
<p>Other metadata may have different formats for the information, but the same<br>level of information is generally provided. For example:</p>
<pre><code>- short btree blocks have a 32 bit owner (ag number) and a 32 bit block
  number for location. The two of these combined provide the same
  information as @owner and @blkno in eh above structure, but using 8
  bytes less space on disk.

- directory/attribute node blocks have a 16 bit magic number, and the
  header that contains the magic number has other information in it as
  well. hence the additional metadata headers change the overall format
  of the metadata.
</code></pre>
<p>A typical buffer read verifier is structured as follows:</p>
<p>#define XFS_FOO_CRC_OFF        offsetof(struct xfs_ondisk_hdr, crc)</p>
<p>static void<br>xfs_foo_read_verify(<br>    struct xfs_buf    *bp)<br>{<br>       struct xfs_mount *mp = bp-&gt;b_target-&gt;bt_mount;</p>
<pre><code>    if ((xfs_sb_version_hascrc(&amp;mp-&gt;m_sb) &amp;&amp;
         !xfs_verify_cksum(bp-&gt;b_addr, BBTOB(bp-&gt;b_length),
                XFS_FOO_CRC_OFF)) ||
        !xfs_foo_verify(bp)) &#123;
            XFS_CORRUPTION_ERROR(__func__, XFS_ERRLEVEL_LOW, mp, bp-&gt;b_addr);
            xfs_buf_ioerror(bp, EFSCORRUPTED);
    &#125;
</code></pre>
<p>}</p>
<p>The code ensures that the CRC is only checked if the filesystem has CRCs enabled<br>by checking the superblock of the feature bit, and then if the CRC verifies OK<br>(or is not needed) it verifies the actual contents of the block.</p>
<p>The verifier function will take a couple of different forms, depending on<br>whether the magic number can be used to determine the format of the block. In<br>the case it can’t, the code is structured as follows:</p>
<p>static bool<br>xfs_foo_verify(<br>    struct xfs_buf        *bp)<br>{<br>        struct xfs_mount    *mp = bp-&gt;b_target-&gt;bt_mount;<br>        struct xfs_ondisk_hdr    *hdr = bp-&gt;b_addr;</p>
<pre><code>    if (hdr-&gt;magic != cpu_to_be32(XFS_FOO_MAGIC))
            return false;

    if (!xfs_sb_version_hascrc(&amp;mp-&gt;m_sb)) &#123;
    if (!uuid_equal(&amp;hdr-&gt;uuid, &amp;mp-&gt;m_sb.sb_uuid))
        return false;
    if (bp-&gt;b_bn != be64_to_cpu(hdr-&gt;blkno))
        return false;
    if (hdr-&gt;owner == 0)
        return false;
&#125;

/* object specific verification checks here */

    return true;
</code></pre>
<p>}</p>
<p>If there are different magic numbers for the different formats, the verifier<br>will look like:</p>
<p>static bool<br>xfs_foo_verify(<br>    struct xfs_buf        *bp)<br>{<br>        struct xfs_mount    *mp = bp-&gt;b_target-&gt;bt_mount;<br>        struct xfs_ondisk_hdr    *hdr = bp-&gt;b_addr;</p>
<pre><code>    if (hdr-&gt;magic == cpu_to_be32(XFS_FOO_CRC_MAGIC)) &#123;
    if (!uuid_equal(&amp;hdr-&gt;uuid, &amp;mp-&gt;m_sb.sb_uuid))
        return false;
    if (bp-&gt;b_bn != be64_to_cpu(hdr-&gt;blkno))
        return false;
    if (hdr-&gt;owner == 0)
        return false;
&#125; else if (hdr-&gt;magic != cpu_to_be32(XFS_FOO_MAGIC))
    return false;

/* object specific verification checks here */

    return true;
</code></pre>
<p>}</p>
<p>Write verifiers are very similar to the read verifiers, they just do things in<br>the opposite order to the read verifiers. A typical write verifier:</p>
<p>static void<br>xfs_foo_write_verify(<br>    struct xfs_buf    *bp)<br>{<br>    struct xfs_mount    *mp = bp-&gt;b_target-&gt;bt_mount;<br>    struct xfs_buf_log_item    *bip = bp-&gt;b_fspriv;</p>
<pre><code>if (!xfs_foo_verify(bp)) &#123;
    XFS_CORRUPTION_ERROR(__func__, XFS_ERRLEVEL_LOW, mp, bp-&gt;b_addr);
    xfs_buf_ioerror(bp, EFSCORRUPTED);
    return;
&#125;

if (!xfs_sb_version_hascrc(&amp;mp-&gt;m_sb))
    return;


if (bip) &#123;
    struct xfs_ondisk_hdr    *hdr = bp-&gt;b_addr;
    hdr-&gt;lsn = cpu_to_be64(bip-&gt;bli_item.li_lsn);
&#125;
xfs_update_cksum(bp-&gt;b_addr, BBTOB(bp-&gt;b_length), XFS_FOO_CRC_OFF);
</code></pre>
<p>}</p>
<p>This will verify the internal structure of the metadata before we go any<br>further, detecting corruptions that have occurred as the metadata has been<br>modified in memory. If the metadata verifies OK, and CRCs are enabled, we then<br>update the LSN field (when it was last modified) and calculate the CRC on the<br>metadata. Once this is done, we can issue the IO.</p>
<h2 id="Inodes-and-Dquots"><a href="#Inodes-and-Dquots" class="headerlink" title="Inodes and Dquots"></a>Inodes and Dquots</h2><p>Inodes and dquots are special snowflakes. They have per-object CRC and<br>self-identifiers, but they are packed so that there are multiple objects per<br>buffer. Hence we do not use per-buffer verifiers to do the work of per-object<br>verification and CRC calculations. The per-buffer verifiers simply perform basic<br>identification of the buffer - that they contain inodes or dquots, and that<br>there are magic numbers in all the expected spots. All further CRC and<br>verification checks are done when each inode is read from or written back to the<br>buffer.</p>
<p>The structure of the verifiers and the identifiers checks is very similar to the<br>buffer code described above. The only difference is where they are called. For<br>example, inode read verification is done in xfs_iread() when the inode is first<br>read out of the buffer and the struct xfs_inode is instantiated. The inode is<br>already extensively verified during writeback in xfs_iflush_int, so the only<br>addition here is to add the LSN and CRC to the inode as it is copied back into<br>the buffer.</p>
<p>XXX: inode unlinked list modification doesn’t recalculate the inode CRC! None of<br>the unlinked list modifications check or update CRCs, neither during unlink nor<br>log recovery. So, it’s gone unnoticed until now. This won’t matter immediately -<br>repair will probably complain about it - but it needs to be fixed.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_xfs-self-describing-metadata/" title="Kernel-3.10.0-957.el7_xfs-self-describing-metadata" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_xfs-self-describing-metadata/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_z8530drv/" title="Kernel-3.10.0-957.el7_z8530drv"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_watchdog-parameters/" title="Kernel-3.10.0-957.el7_watchdog-parameters"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>