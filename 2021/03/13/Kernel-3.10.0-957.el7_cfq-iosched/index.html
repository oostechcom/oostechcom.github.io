<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-3.10.0-957.el7_cfq-iosche | oosTech.com</title>
  <meta name="description" content="CFQ (Complete Fairness Queueing)The main aim of CFQ scheduler is to provide a fair allocation of the diskI&#x2F;O bandwidth for all the processes which requests an I&#x2F;O operation. CFQ maintains the per proc">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-3.10.0-957.el7_cfq-iosche">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cfq-iosched/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="CFQ (Complete Fairness Queueing)The main aim of CFQ scheduler is to provide a fair allocation of the diskI&#x2F;O bandwidth for all the processes which requests an I&#x2F;O operation. CFQ maintains the per proc">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cfq-iosched/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_mpc5200/" class="title">Kernel-3.10.0-957.el7_mpc5200</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_6pack/" class="title">Kernel-3.10.0-957.el7_6pack</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CFQ-Complete-Fairness-Queueing"><span class="toc-number">1.</span> <span class="toc-text">CFQ (Complete Fairness Queueing)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CFQ-ioscheduler-tunables"><span class="toc-number">2.</span> <span class="toc-text">CFQ ioscheduler tunables</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#slice-idle"><span class="toc-number">2.1.</span> <span class="toc-text">slice_idle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#back-seek-max"><span class="toc-number">2.2.</span> <span class="toc-text">back_seek_max</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#back-seek-penalty"><span class="toc-number">2.3.</span> <span class="toc-text">back_seek_penalty</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fifo-expire-async"><span class="toc-number">2.4.</span> <span class="toc-text">fifo_expire_async</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fifo-expire-sync"><span class="toc-number">2.5.</span> <span class="toc-text">fifo_expire_sync</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#group-idle"><span class="toc-number">2.6.</span> <span class="toc-text">group_idle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#latency"><span class="toc-number">2.7.</span> <span class="toc-text">latency</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#target-latency"><span class="toc-number">2.8.</span> <span class="toc-text">target_latency</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#slice-async"><span class="toc-number">2.9.</span> <span class="toc-text">slice_async</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#slice-async-rq"><span class="toc-number">2.10.</span> <span class="toc-text">slice_async_rq</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#slice-sync"><span class="toc-number">2.11.</span> <span class="toc-text">slice_sync</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#quantum"><span class="toc-number">2.12.</span> <span class="toc-text">quantum</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CFQ-Group-scheduling"><span class="toc-number">3.</span> <span class="toc-text">CFQ Group scheduling</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CFQ-IOPS-Mode-for-group-scheduling"><span class="toc-number">4.</span> <span class="toc-text">CFQ IOPS Mode for group scheduling</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CFQ-IO-scheduler-Idling-Theory"><span class="toc-number">5.</span> <span class="toc-text">CFQ IO scheduler Idling Theory</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FAQ"><span class="toc-number">6.</span> <span class="toc-text">FAQ</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-3.10.0-957.el7_cfq-iosched" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-3.10.0-957.el7_cfq-iosche
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_cfq-iosched/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_cfq-iosched/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-3.10.0-957.el7_cfq-iosched/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="CFQ-Complete-Fairness-Queueing"><a href="#CFQ-Complete-Fairness-Queueing" class="headerlink" title="CFQ (Complete Fairness Queueing)"></a>CFQ (Complete Fairness Queueing)</h1><p>The main aim of CFQ scheduler is to provide a fair allocation of the disk<br>I/O bandwidth for all the processes which requests an I/O operation.</p>
<p>CFQ maintains the per process queue for the processes which request I/O<br>operation(synchronous requests). In case of asynchronous requests, all the<br>requests from all the processes are batched together according to their<br>process’s I/O priority.</p>
<h1 id="CFQ-ioscheduler-tunables"><a href="#CFQ-ioscheduler-tunables" class="headerlink" title="CFQ ioscheduler tunables"></a>CFQ ioscheduler tunables</h1><h2 id="slice-idle"><a href="#slice-idle" class="headerlink" title="slice_idle"></a>slice_idle</h2><p>This specifies how long CFQ should idle for next request on certain cfq queues<br>(for sequential workloads) and service trees (for random workloads) before<br>queue is expired and CFQ selects next queue to dispatch from.</p>
<p>By default slice_idle is a non-zero value. That means by default we idle on<br>queues/service trees. This can be very helpful on highly seeky media like<br>single spindle SATA/SAS disks where we can cut down on overall number of<br>seeks and see improved throughput.</p>
<p>Setting slice_idle to 0 will remove all the idling on queues/service tree<br>level and one should see an overall improved throughput on faster storage<br>devices like multiple SATA/SAS disks in hardware RAID configuration. The down<br>side is that isolation provided from WRITES also goes down and notion of<br>IO priority becomes weaker.</p>
<p>So depending on storage and workload, it might be useful to set slice_idle=0.<br>In general I think for SATA/SAS disks and software RAID of SATA/SAS disks<br>keeping slice_idle enabled should be useful. For any configurations where<br>there are multiple spindles behind single LUN (Host based hardware RAID<br>controller or for storage arrays), setting slice_idle=0 might end up in better<br>throughput and acceptable latencies.</p>
<h2 id="back-seek-max"><a href="#back-seek-max" class="headerlink" title="back_seek_max"></a>back_seek_max</h2><p>This specifies, given in Kbytes, the maximum “distance” for backward seeking.<br>The distance is the amount of space from the current head location to the<br>sectors that are backward in terms of distance.</p>
<p>This parameter allows the scheduler to anticipate requests in the “backward”<br>direction and consider them as being the “next” if they are within this<br>distance from the current head location.</p>
<h2 id="back-seek-penalty"><a href="#back-seek-penalty" class="headerlink" title="back_seek_penalty"></a>back_seek_penalty</h2><p>This parameter is used to compute the cost of backward seeking. If the<br>backward distance of request is just 1/back_seek_penalty from a “front”<br>request, then the seeking cost of two requests is considered equivalent.</p>
<p>So scheduler will not bias toward one or the other request (otherwise scheduler<br>will bias toward front request). Default value of back_seek_penalty is 2.</p>
<h2 id="fifo-expire-async"><a href="#fifo-expire-async" class="headerlink" title="fifo_expire_async"></a>fifo_expire_async</h2><p>This parameter is used to set the timeout of asynchronous requests. Default<br>value of this is 248ms.</p>
<h2 id="fifo-expire-sync"><a href="#fifo-expire-sync" class="headerlink" title="fifo_expire_sync"></a>fifo_expire_sync</h2><p>This parameter is used to set the timeout of synchronous requests. Default<br>value of this is 124ms. In case to favor synchronous requests over asynchronous<br>one, this value should be decreased relative to fifo_expire_async.</p>
<h2 id="group-idle"><a href="#group-idle" class="headerlink" title="group_idle"></a>group_idle</h2><p>This parameter forces idling at the CFQ group level instead of CFQ<br>queue level. This was introduced after after a bottleneck was observed<br>in higher end storage due to idle on sequential queue and allow dispatch<br>from a single queue. The idea with this parameter is that it can be run with<br>slice_idle=0 and group_idle=8, so that idling does not happen on individual<br>queues in the group but happens overall on the group and thus still keeps the<br>IO controller working.<br>Not idling on individual queues in the group will dispatch requests from<br>multiple queues in the group at the same time and achieve higher throughput<br>on higher end storage.</p>
<p>Default value for this parameter is 8ms.</p>
<h2 id="latency"><a href="#latency" class="headerlink" title="latency"></a>latency</h2><p>This parameter is used to enable/disable the latency mode of the CFQ<br>scheduler. If latency mode (called low_latency) is enabled, CFQ tries<br>to recompute the slice time for each process based on the target_latency set<br>for the system. This favors fairness over throughput. Disabling low<br>latency (setting it to 0) ignores target latency, allowing each process in the<br>system to get a full time slice.</p>
<p>By default low latency mode is enabled.</p>
<h2 id="target-latency"><a href="#target-latency" class="headerlink" title="target_latency"></a>target_latency</h2><p>This parameter is used to calculate the time slice for a process if cfq’s<br>latency mode is enabled. It will ensure that sync requests have an estimated<br>latency. But if sequential workload is higher(e.g. sequential read),<br>then to meet the latency constraints, throughput may decrease because of less<br>time for each process to issue I/O request before the cfq queue is switched.</p>
<p>Though this can be overcome by disabling the latency_mode, it may increase<br>the read latency for some applications. This parameter allows for changing<br>target_latency through the sysfs interface which can provide the balanced<br>throughput and read latency.</p>
<p>Default value for target_latency is 300ms.</p>
<h2 id="slice-async"><a href="#slice-async" class="headerlink" title="slice_async"></a>slice_async</h2><p>This parameter is same as of slice_sync but for asynchronous queue. The<br>default value is 40ms.</p>
<h2 id="slice-async-rq"><a href="#slice-async-rq" class="headerlink" title="slice_async_rq"></a>slice_async_rq</h2><p>This parameter is used to limit the dispatching of asynchronous request to<br>device request queue in queue’s slice time. The maximum number of request that<br>are allowed to be dispatched also depends upon the io priority. Default value<br>for this is 2.</p>
<h2 id="slice-sync"><a href="#slice-sync" class="headerlink" title="slice_sync"></a>slice_sync</h2><p>When a queue is selected for execution, the queues IO requests are only<br>executed for a certain amount of time(time_slice) before switching to another<br>queue. This parameter is used to calculate the time slice of synchronous<br>queue.</p>
<p>time_slice is computed using the below equation:-<br>time_slice = slice_sync + (slice_sync/5 * (4 - prio)). To increase the<br>time_slice of synchronous queue, increase the value of slice_sync. Default<br>value is 100ms.</p>
<h2 id="quantum"><a href="#quantum" class="headerlink" title="quantum"></a>quantum</h2><p>This specifies the number of request dispatched to the device queue. In a<br>queue’s time slice, a request will not be dispatched if the number of request<br>in the device exceeds this parameter. This parameter is used for synchronous<br>request.</p>
<p>In case of storage with several disk, this setting can limit the parallel<br>processing of request. Therefore, increasing the value can improve the<br>performance although this can cause the latency of some I/O to increase due<br>to more number of requests.</p>
<h1 id="CFQ-Group-scheduling"><a href="#CFQ-Group-scheduling" class="headerlink" title="CFQ Group scheduling"></a>CFQ Group scheduling</h1><p>CFQ supports blkio cgroup and has “blkio.” prefixed files in each<br>blkio cgroup directory. It is weight-based and there are four knobs<br>for configuration - weight[_device] and leaf_weight[_device].<br>Internal cgroup nodes (the ones with children) can also have tasks in<br>them, so the former two configure how much proportion the cgroup as a<br>whole is entitled to at its parent’s level while the latter two<br>configure how much proportion the tasks in the cgroup have compared to<br>its direct children.</p>
<p>Another way to think about it is assuming that each internal node has<br>an implicit leaf child node which hosts all the tasks whose weight is<br>configured by leaf_weight[_device]. Let’s assume a blkio hierarchy<br>composed of five cgroups - root, A, B, AA and AB - with the following<br>weights where the names represent the hierarchy.</p>
<pre><code>    weight leaf_weight
</code></pre>
<p> root :  125    125<br> A    :  500    750<br> B    :  250    500<br> AA   :  500    500<br> AB   : 1000    500</p>
<p>root never has a parent making its weight is meaningless. For backward<br>compatibility, weight is always kept in sync with leaf_weight. B, AA<br>and AB have no child and thus its tasks have no children cgroup to<br>compete with. They always get 100% of what the cgroup won at the<br>parent level. Considering only the weights which matter, the hierarchy<br>looks like the following.</p>
<pre><code>      root
   /    |   \
  A     B    leaf
 500   250   125
</code></pre>
<p>   /  |  <br>  AA  AB  leaf<br> 500 1000 750</p>
<p>If all cgroups have active IOs and competing with each other, disk<br>time will be distributed like the following.</p>
<p>Distribution below root. The total active weight at this level is<br>A:500 + B:250 + C:125 = 875.</p>
<p> root-leaf :   125 /  875      =~ 14%<br> A         :   500 /  875      =~ 57%<br> B(-leaf)  :   250 /  875      =~ 28%</p>
<p>A has children and further distributes its 57% among the children and<br>the implicit leaf node. The total active weight at this level is<br>AA:500 + AB:1000 + A-leaf:750 = 2250.</p>
<p> A-leaf    : ( 750 / 2250) * A =~ 19%<br> AA(-leaf) : ( 500 / 2250) * A =~ 12%<br> AB(-leaf) : (1000 / 2250) * A =~ 25%</p>
<h1 id="CFQ-IOPS-Mode-for-group-scheduling"><a href="#CFQ-IOPS-Mode-for-group-scheduling" class="headerlink" title="CFQ IOPS Mode for group scheduling"></a>CFQ IOPS Mode for group scheduling</h1><p>Basic CFQ design is to provide priority based time slices. Higher priority<br>process gets bigger time slice and lower priority process gets smaller time<br>slice. Measuring time becomes harder if storage is fast and supports NCQ and<br>it would be better to dispatch multiple requests from multiple cfq queues in<br>request queue at a time. In such scenario, it is not possible to measure time<br>consumed by single queue accurately.</p>
<p>What is possible though is to measure number of requests dispatched from a<br>single queue and also allow dispatch from multiple cfq queue at the same time.<br>This effectively becomes the fairness in terms of IOPS (IO operations per<br>second).</p>
<p>If one sets slice_idle=0 and if storage supports NCQ, CFQ internally switches<br>to IOPS mode and starts providing fairness in terms of number of requests<br>dispatched. Note that this mode switching takes effect only for group<br>scheduling. For non-cgroup users nothing should change.</p>
<h1 id="CFQ-IO-scheduler-Idling-Theory"><a href="#CFQ-IO-scheduler-Idling-Theory" class="headerlink" title="CFQ IO scheduler Idling Theory"></a>CFQ IO scheduler Idling Theory</h1><p>Idling on a queue is primarily about waiting for the next request to come<br>on same queue after completion of a request. In this process CFQ will not<br>dispatch requests from other cfq queues even if requests are pending there.</p>
<p>The rationale behind idling is that it can cut down on number of seeks<br>on rotational media. For example, if a process is doing dependent<br>sequential reads (next read will come on only after completion of previous<br>one), then not dispatching request from other queue should help as we<br>did not move the disk head and kept on dispatching sequential IO from<br>one queue.</p>
<p>CFQ has following service trees and various queues are put on these trees.</p>
<pre><code>sync-idle    sync-noidle    async
</code></pre>
<p>All cfq queues doing synchronous sequential IO go on to sync-idle tree.<br>On this tree we idle on each queue individually.</p>
<p>All synchronous non-sequential queues go on sync-noidle tree. Also any<br>request which are marked with REQ_NOIDLE go on this service tree. On this<br>tree we do not idle on individual queues instead idle on the whole group<br>of queues or the tree. So if there are 4 queues waiting for IO to dispatch<br>we will idle only once last queue has dispatched the IO and there is<br>no more IO on this service tree.</p>
<p>All async writes go on async service tree. There is no idling on async<br>queues.</p>
<p>CFQ has some optimizations for SSDs and if it detects a non-rotational<br>media which can support higher queue depth (multiple requests at in<br>flight at a time), then it cuts down on idling of individual queues and<br>all the queues move to sync-noidle tree and only tree idle remains. This<br>tree idling provides isolation with buffered write queues on async tree.</p>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><p>Q1. Why to idle at all on queues marked with REQ_NOIDLE.</p>
<p>A1. We only do tree idle (all queues on sync-noidle tree) on queues marked<br>    with REQ_NOIDLE. This helps in providing isolation with all the sync-idle<br>    queues. Otherwise in presence of many sequential readers, other<br>    synchronous IO might not get fair share of disk.</p>
<pre><code>For example, if there are 10 sequential readers doing IO and they get
100ms each. If a REQ_NOIDLE request comes in, it will be scheduled
roughly after 1 second. If after completion of REQ_NOIDLE request we
do not idle, and after a couple of milli seconds a another REQ_NOIDLE
request comes in, again it will be scheduled after 1second. Repeat it
and notice how a workload can lose its disk share and suffer due to
multiple sequential readers.

fsync can generate dependent IO where bunch of data is written in the
context of fsync, and later some journaling data is written. Journaling
data comes in only after fsync has finished its IO (atleast for ext4
that seemed to be the case). Now if one decides not to idle on fsync
thread due to REQ_NOIDLE, then next journaling write will not get
scheduled for another second. A process doing small fsync, will suffer
badly in presence of multiple sequential readers.

Hence doing tree idling on threads using REQ_NOIDLE flag on requests
provides isolation from multiple sequential readers and at the same
time we do not idle on individual threads.
</code></pre>
<p>Q2. When to specify REQ_NOIDLE<br>A2. I would think whenever one is doing synchronous write and not expecting<br>    more writes to be dispatched from same context soon, should be able<br>    to specify REQ_NOIDLE on writes and that probably should work well for<br>    most of the cases.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cfq-iosched/" title="Kernel-3.10.0-957.el7_cfq-iosche" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cfq-iosched/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_ceph/" title="Kernel-3.10.0-957.el7_ceph"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_cgroupstats/" title="Kernel-3.10.0-957.el7_cgroupstats"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>