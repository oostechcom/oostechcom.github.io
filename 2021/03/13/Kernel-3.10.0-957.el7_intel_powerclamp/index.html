<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-3.10.0-957.el7_intel_powerclamp | oosTech.com</title>
  <meta name="description" content="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;          INTEL POWERCLAMP DRIVER          &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  By: Arjan van de Ven &amp;#x61;&amp;#114;&amp;#106;&amp;#97;&amp;#110;&amp;#x40;&amp;#108;&amp;#105;&amp;#110;&amp;#x75;&amp;#120;&amp;#46;&amp;#105;&amp;#x">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-3.10.0-957.el7_intel_powerclamp">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_intel_powerclamp/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;          INTEL POWERCLAMP DRIVER          &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  By: Arjan van de Ven &amp;#x61;&amp;#114;&amp;#106;&amp;#97;&amp;#110;&amp;#x40;&amp;#108;&amp;#105;&amp;#110;&amp;#x75;&amp;#120;&amp;#46;&amp;#105;&amp;#x">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_intel_powerclamp/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Idle-Injection"><span class="toc-number">1.</span> <span class="toc-text">Idle Injection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Calibration"><span class="toc-number">2.</span> <span class="toc-text">Calibration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CPU-Online-Offline"><span class="toc-number">3.</span> <span class="toc-text">CPU Online&#x2F;Offline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Effectiveness-and-Limitations"><span class="toc-number">4.</span> <span class="toc-text">Effectiveness and Limitations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scalability"><span class="toc-number">5.</span> <span class="toc-text">Scalability</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-3.10.0-957.el7_intel_powerclamp" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-3.10.0-957.el7_intel_powerclamp
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_intel_powerclamp/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_intel_powerclamp/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-3.10.0-957.el7_intel_powerclamp/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <pre><code>         =======================
         INTEL POWERCLAMP DRIVER
         =======================
</code></pre>
<p>By: Arjan van de Ven <a href="mailto:&#x61;&#114;&#106;&#97;&#110;&#x40;&#108;&#105;&#110;&#x75;&#120;&#46;&#105;&#x6e;&#x74;&#101;&#108;&#x2e;&#99;&#111;&#x6d;">&#x61;&#114;&#106;&#97;&#110;&#x40;&#108;&#105;&#110;&#x75;&#120;&#46;&#105;&#x6e;&#x74;&#101;&#108;&#x2e;&#99;&#111;&#x6d;</a><br>    Jacob Pan <a href="mailto:&#106;&#x61;&#x63;&#x6f;&#98;&#46;&#106;&#x75;&#x6e;&#46;&#x70;&#97;&#x6e;&#64;&#x6c;&#105;&#x6e;&#117;&#120;&#x2e;&#105;&#x6e;&#116;&#101;&#x6c;&#46;&#x63;&#x6f;&#x6d;">&#106;&#x61;&#x63;&#x6f;&#98;&#46;&#106;&#x75;&#x6e;&#46;&#x70;&#97;&#x6e;&#64;&#x6c;&#105;&#x6e;&#117;&#120;&#x2e;&#105;&#x6e;&#116;&#101;&#x6c;&#46;&#x63;&#x6f;&#x6d;</a></p>
<p>Contents:<br>    (*) Introduction<br>        - Goals and Objectives</p>
<pre><code>(*) Theory of Operation
    - Idle Injection
    - Calibration

(*) Performance Analysis
    - Effectiveness and Limitations
    - Power vs Performance
    - Scalability
    - Calibration
    - Comparison with Alternative Techniques

(*) Usage and Interfaces
    - Generic Thermal Layer (sysfs)
    - Kernel APIs (TBD)
</code></pre>
<p>============<br>INTRODUCTION<br>============</p>
<p>Consider the situation where a systemâs power consumption must be<br>reduced at runtime, due to power budget, thermal constraint, or noise<br>level, and where active cooling is not preferred. Software managed<br>passive power reduction must be performed to prevent the hardware<br>actions that are designed for catastrophic scenarios.</p>
<p>Currently, P-states, T-states (clock modulation), and CPU offlining<br>are used for CPU throttling.</p>
<p>On Intel CPUs, C-states provide effective power reduction, but so far<br>theyâre only used opportunistically, based on workload. With the<br>development of intel_powerclamp driver, the method of synchronizing<br>idle injection across all online CPU threads was introduced. The goal<br>is to achieve forced and controllable C-state residency.</p>
<p>Test/Analysis has been made in the areas of power, performance,<br>scalability, and user experience. In many cases, clear advantage is<br>shown over taking the CPU offline or modulating the CPU clock.</p>
<p>===================<br>THEORY OF OPERATION<br>===================</p>
<h2 id="Idle-Injection"><a href="#Idle-Injection" class="headerlink" title="Idle Injection"></a>Idle Injection</h2><p>On modern Intel processors (Nehalem or later), package level C-state<br>residency is available in MSRs, thus also available to the kernel.</p>
<p>These MSRs are:<br>      #define MSR_PKG_C2_RESIDENCY    0x60D<br>      #define MSR_PKG_C3_RESIDENCY    0x3F8<br>      #define MSR_PKG_C6_RESIDENCY    0x3F9<br>      #define MSR_PKG_C7_RESIDENCY    0x3FA</p>
<p>If the kernel can also inject idle time to the system, then a<br>closed-loop control system can be established that manages package<br>level C-state. The intel_powerclamp driver is conceived as such a<br>control system, where the target set point is a user-selected idle<br>ratio (based on power reduction), and the error is the difference<br>between the actual package level C-state residency ratio and the target idle<br>ratio.</p>
<p>Injection is controlled by high priority kernel threads, spawned for<br>each online CPU.</p>
<p>These kernel threads, with SCHED_FIFO class, are created to perform<br>clamping actions of controlled duty ratio and duration. Each per-CPU<br>thread synchronizes its idle time and duration, based on the rounding<br>of jiffies, so accumulated errors can be prevented to avoid a jittery<br>effect. Threads are also bound to the CPU such that they cannot be<br>migrated, unless the CPU is taken offline. In this case, threads<br>belong to the offlined CPUs will be terminated immediately.</p>
<p>Running as SCHED_FIFO and relatively high priority, also allows such<br>scheme to work for both preemptable and non-preemptable kernels.<br>Alignment of idle time around jiffies ensures scalability for HZ<br>values. This effect can be better visualized using a Perf timechart.<br>The following diagram shows the behavior of kernel thread<br>kidle_inject/cpu. During idle injection, it runs monitor/mwait idle<br>for a given “duration”, then relinquishes the CPU to other tasks,<br>until the next time interval.</p>
<p>The NOHZ schedule tick is disabled during idle time, but interrupts<br>are not masked. Tests show that the extra wakeups from scheduler tick<br>have a dramatic impact on the effectiveness of the powerclamp driver<br>on large scale systems (Westmere system with 80 processors).</p>
<p>CPU0<br>          <strong><strong>____</strong></strong>          <strong><strong>____</strong></strong><br>kidle_inject/0   |   sleep    |  mwait |  sleep     |<br>    <strong><strong><strong>___|            |<strong>____</strong>|            |_</strong></strong></strong><br>                   duration<br>CPU1<br>          <strong><strong>____</strong></strong>          <strong><strong>____</strong></strong><br>kidle_inject/1   |   sleep    |  mwait |  sleep     |<br>    <strong><strong><strong>___|            |<strong>____</strong>|            |_</strong></strong></strong><br>                  ^<br>                  |<br>                  |<br>                  roundup(jiffies, interval)</p>
<p>Only one CPU is allowed to collect statistics and update global<br>control parameters. This CPU is referred to as the controlling CPU in<br>this document. The controlling CPU is elected at runtime, with a<br>policy that favors BSP, taking into account the possibility of a CPU<br>hot-plug.</p>
<p>In terms of dynamics of the idle control system, package level idle<br>time is considered largely as a non-causal system where its behavior<br>cannot be based on the past or current input. Therefore, the<br>intel_powerclamp driver attempts to enforce the desired idle time<br>instantly as given input (target idle ratio). After injection,<br>powerclamp moniors the actual idle for a given time window and adjust<br>the next injection accordingly to avoid over/under correction.</p>
<p>When used in a causal control system, such as a temperature control,<br>it is up to the user of this driver to implement algorithms where<br>past samples and outputs are included in the feedback. For example, a<br>PID-based thermal controller can use the powerclamp driver to<br>maintain a desired target temperature, based on integral and<br>derivative gains of the past samples.</p>
<h2 id="Calibration"><a href="#Calibration" class="headerlink" title="Calibration"></a>Calibration</h2><p>During scalability testing, it is observed that synchronized actions<br>among CPUs become challenging as the number of cores grows. This is<br>also true for the ability of a system to enter package level C-states.</p>
<p>To make sure the intel_powerclamp driver scales well, online<br>calibration is implemented. The goals for doing such a calibration<br>are:</p>
<p>a) determine the effective range of idle injection ratio<br>b) determine the amount of compensation needed at each target ratio</p>
<p>Compensation to each target ratio consists of two parts:</p>
<pre><code>    a) steady state error compensation
This is to offset the error occurring when the system can
enter idle without extra wakeups (such as external interrupts).

b) dynamic error compensation
When an excessive amount of wakeups occurs during idle, an
additional idle ratio can be added to quiet interrupts, by
slowing down CPU activities.
</code></pre>
<p>A debugfs file is provided for the user to examine compensation<br>progress and results, such as on a Westmere system.<br>[jacob@nex01 ~]$ cat<br>/sys/kernel/debug/intel_powerclamp/powerclamp_calib<br>controlling cpu: 0<br>pct confidence steady dynamic (compensation)<br>0    0    0    0<br>1    1    0    0<br>2    1    1    0<br>3    3    1    0<br>4    3    1    0<br>5    3    1    0<br>6    3    1    0<br>7    3    1    0<br>8    3    1    0<br>…<br>30    3    2    0<br>31    3    2    0<br>32    3    1    0<br>33    3    2    0<br>34    3    1    0<br>35    3    2    0<br>36    3    1    0<br>37    3    2    0<br>38    3    1    0<br>39    3    2    0<br>40    3    3    0<br>41    3    1    0<br>42    3    2    0<br>43    3    1    0<br>44    3    1    0<br>45    3    2    0<br>46    3    3    0<br>47    3    0    0<br>48    3    2    0<br>49    3    3    0</p>
<p>Calibration occurs during runtime. No offline method is available.<br>Steady state compensation is used only when confidence levels of all<br>adjacent ratios have reached satisfactory level. A confidence level<br>is accumulated based on clean data collected at runtime. Data<br>collected during a period without extra interrupts is considered<br>clean.</p>
<p>To compensate for excessive amounts of wakeup during idle, additional<br>idle time is injected when such a condition is detected. Currently,<br>we have a simple algorithm to double the injection ratio. A possible<br>enhancement might be to throttle the offending IRQ, such as delaying<br>EOI for level triggered interrupts. But it is a challenge to be<br>non-intrusive to the scheduler or the IRQ core code.</p>
<h2 id="CPU-Online-Offline"><a href="#CPU-Online-Offline" class="headerlink" title="CPU Online/Offline"></a>CPU Online/Offline</h2><p>Per-CPU kernel threads are started/stopped upon receiving<br>notifications of CPU hotplug activities. The intel_powerclamp driver<br>keeps track of clamping kernel threads, even after they are migrated<br>to other CPUs, after a CPU offline event.</p>
<p>=====================<br>Performance Analysis<br>=====================<br>This section describes the general performance data collected on<br>multiple systems, including Westmere (80P) and Ivy Bridge (4P, 8P).</p>
<h2 id="Effectiveness-and-Limitations"><a href="#Effectiveness-and-Limitations" class="headerlink" title="Effectiveness and Limitations"></a>Effectiveness and Limitations</h2><p>The maximum range that idle injection is allowed is capped at 50<br>percent. As mentioned earlier, since interrupts are allowed during<br>forced idle time, excessive interrupts could result in less<br>effectiveness. The extreme case would be doing a ping -f to generated<br>flooded network interrupts without much CPU acknowledgement. In this<br>case, little can be done from the idle injection threads. In most<br>normal cases, such as scp a large file, applications can be throttled<br>by the powerclamp driver, since slowing down the CPU also slows down<br>network protocol processing, which in turn reduces interrupts.</p>
<p>When control parameters change at runtime by the controlling CPU, it<br>may take an additional period for the rest of the CPUs to catch up<br>with the changes. During this time, idle injection is out of sync,<br>thus not able to enter package C- states at the expected ratio. But<br>this effect is minor, in that in most cases change to the target<br>ratio is updated much less frequently than the idle injection<br>frequency.</p>
<h2 id="Scalability"><a href="#Scalability" class="headerlink" title="Scalability"></a>Scalability</h2><p>Tests also show a minor, but measurable, difference between the 4P/8P<br>Ivy Bridge system and the 80P Westmere server under 50% idle ratio.<br>More compensation is needed on Westmere for the same amount of<br>target idle ratio. The compensation also increases as the idle ratio<br>gets larger. The above reason constitutes the need for the<br>calibration code.</p>
<p>On the IVB 8P system, compared to an offline CPU, powerclamp can<br>achieve up to 40% better performance per watt. (measured by a spin<br>counter summed over per CPU counting threads spawned for all running<br>CPUs).</p>
<p>====================<br>Usage and Interfaces<br>====================<br>The powerclamp driver is registered to the generic thermal layer as a<br>cooling device. Currently, itâs not bound to any thermal zones.</p>
<p>jacob@chromoly:/sys/class/thermal/cooling_device14$ grep . *<br>cur_state:0<br>max_state:50<br>type:intel_powerclamp</p>
<p>cur_state allows user to set the desired idle percentage. Writing 0 to<br>cur_state will stop idle injection. Writing a value between 1 and<br>max_state will start the idle injection. Reading cur_state returns the<br>actual and current idle percentage. This may not be the same value<br>set by the user in that current idle percentage depends on workload<br>and includes natural idle. When idle injection is disabled, reading<br>cur_state returns value -1 instead of 0 which is to avoid confusing<br>100% busy state with the disabled state.</p>
<p>Example usage:</p>
<ul>
<li>To inject 25% idle time<br>$ sudo sh -c “echo 25 &gt; /sys/class/thermal/cooling_device80/cur_state<br>“</li>
</ul>
<p>If the system is not busy and has more than 25% idle time already,<br>then the powerclamp driver will not start idle injection. Using Top<br>will not show idle injection kernel threads.</p>
<p>If the system is busy (spin test below) and has less than 25% natural<br>idle time, powerclamp kernel threads will do idle injection. Forced<br>idle time is accounted as normal idle in that common code path is<br>taken as the idle task.</p>
<p>In this example, 24.1% idle is shown. This helps the system admin or<br>user determine the cause of slowdown, when a powerclamp driver is in action.</p>
<p>Tasks: 197 total,   1 running, 196 sleeping,   0 stopped,   0 zombie<br>Cpu(s): 71.2%us,  4.7%sy,  0.0%ni, 24.1%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st<br>Mem:   3943228k total,  1689632k used,  2253596k free,    74960k buffers<br>Swap:  4087804k total,        0k used,  4087804k free,   945336k cached</p>
<p>  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND<br> 3352 jacob     20   0  262m  644  428 S  286  0.0   0:17.16 spin<br> 3341 root     -51   0     0    0    0 D   25  0.0   0:01.62 kidle_inject/0<br> 3344 root     -51   0     0    0    0 D   25  0.0   0:01.60 kidle_inject/3<br> 3342 root     -51   0     0    0    0 D   25  0.0   0:01.61 kidle_inject/1<br> 3343 root     -51   0     0    0    0 D   25  0.0   0:01.60 kidle_inject/2<br> 2935 jacob     20   0  696m 125m  35m S    5  3.3   0:31.11 firefox<br> 1546 root      20   0  158m  20m 6640 S    3  0.5   0:26.97 Xorg<br> 2100 jacob     20   0 1223m  88m  30m S    3  2.3   0:23.68 compiz</p>
<p>Tests have shown that by using the powerclamp driver as a cooling<br>device, a PID based userspace thermal controller can manage to<br>control CPU temperature effectively, when no other thermal influence<br>is added. For example, a UltraBook user can compile the kernel under<br>certain temperature (below most active trip points).</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_intel_powerclamp/" title="Kernel-3.10.0-957.el7_intel_powerclamp" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_intel_powerclamp/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_intel_mpx/" title="Kernel-3.10.0-957.el7_intel_mpx"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_intel_txt/" title="Kernel-3.10.0-957.el7_intel_txt"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>