<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-3.10.0-957.el7_assoc_array | oosTech.com</title>
  <meta name="description" content="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;        GENERIC ASSOCIATIVE ARRAY IMPLEMENTATION        &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  Contents:  Overview.  The public API.  Edit script. Ope">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-3.10.0-957.el7_assoc_array">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_assoc_array/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;        GENERIC ASSOCIATIVE ARRAY IMPLEMENTATION        &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  Contents:  Overview.  The public API.  Edit script. Ope">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_assoc_array/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_mpc5200/" class="title">Kernel-3.10.0-957.el7_mpc5200</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_6pack/" class="title">Kernel-3.10.0-957.el7_6pack</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#EDIT-SCRIPT"><span class="toc-number">1.</span> <span class="toc-text">EDIT SCRIPT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OPERATIONS-TABLE"><span class="toc-number">2.</span> <span class="toc-text">OPERATIONS TABLE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MANIPULATION-FUNCTIONS"><span class="toc-number">3.</span> <span class="toc-text">MANIPULATION FUNCTIONS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ACCESS-FUNCTIONS"><span class="toc-number">4.</span> <span class="toc-text">ACCESS FUNCTIONS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#INDEX-KEY-FORM"><span class="toc-number">5.</span> <span class="toc-text">INDEX KEY FORM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BASIC-INTERNAL-TREE-LAYOUT"><span class="toc-number">6.</span> <span class="toc-text">BASIC INTERNAL TREE LAYOUT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SHORTCUTS"><span class="toc-number">7.</span> <span class="toc-text">SHORTCUTS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SPLITTING-AND-COLLAPSING-NODES"><span class="toc-number">8.</span> <span class="toc-text">SPLITTING AND COLLAPSING NODES</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NON-RECURSIVE-ITERATION"><span class="toc-number">9.</span> <span class="toc-text">NON-RECURSIVE ITERATION</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SIMULTANEOUS-ALTERATION-AND-ITERATION"><span class="toc-number">10.</span> <span class="toc-text">SIMULTANEOUS ALTERATION AND ITERATION</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-3.10.0-957.el7_assoc_array" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-3.10.0-957.el7_assoc_array
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_assoc_array/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_assoc_array/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-3.10.0-957.el7_assoc_array/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <pre><code>       ========================================
       GENERIC ASSOCIATIVE ARRAY IMPLEMENTATION
       ========================================
</code></pre>
<p>Contents:</p>
<ul>
<li><p>Overview.</p>
</li>
<li><p>The public API.</p>
<ul>
<li>Edit script.</li>
<li>Operations table.</li>
<li>Manipulation functions.</li>
<li>Access functions.</li>
<li>Index key form.</li>
</ul>
</li>
<li><p>Internal workings.</p>
<ul>
<li>Basic internal tree layout.</li>
<li>Shortcuts.</li>
<li>Splitting and collapsing nodes.</li>
<li>Non-recursive iteration.</li>
<li>Simultaneous alteration and iteration.</li>
</ul>
</li>
</ul>
<p>========<br>OVERVIEW<br>========</p>
<p>This associative array implementation is an object container with the following<br>properties:</p>
<p> (1) Objects are opaque pointers.  The implementation does not care where they<br>     point (if anywhere) or what they point to (if anything).</p>
<pre><code> [!] NOTE: Pointers to objects _must_ be zero in the least significant bit.
</code></pre>
<p> (2) Objects do not need to contain linkage blocks for use by the array.  This<br>     permits an object to be located in multiple arrays simultaneously.<br>     Rather, the array is made up of metadata blocks that point to objects.</p>
<p> (3) Objects require index keys to locate them within the array.</p>
<p> (4) Index keys must be unique.  Inserting an object with the same key as one<br>     already in the array will replace the old object.</p>
<p> (5) Index keys can be of any length and can be of different lengths.</p>
<p> (6) Index keys should encode the length early on, before any variation due to<br>     length is seen.</p>
<p> (7) Index keys can include a hash to scatter objects throughout the array.</p>
<p> (8) The array can iterated over.  The objects will not necessarily come out in<br>     key order.</p>
<p> (9) The array can be iterated over whilst it is being modified, provided the<br>     RCU readlock is being held by the iterator.  Note, however, under these<br>     circumstances, some objects may be seen more than once.  If this is a<br>     problem, the iterator should lock against modification.  Objects will not<br>     be missed, however, unless deleted.</p>
<p>(10) Objects in the array can be looked up by means of their index key.</p>
<p>(11) Objects can be looked up whilst the array is being modified, provided the<br>     RCU readlock is being held by the thread doing the look up.</p>
<p>The implementation uses a tree of 16-pointer nodes internally that are indexed<br>on each level by nibbles from the index key in the same manner as in a radix<br>tree.  To improve memory efficiency, shortcuts can be emplaced to skip over<br>what would otherwise be a series of single-occupancy nodes.  Further, nodes<br>pack leaf object pointers into spare space in the node rather than making an<br>extra branch until as such time an object needs to be added to a full node.</p>
<p>==============<br>THE PUBLIC API<br>==============</p>
<p>The public API can be found in &lt;linux/assoc_array.h&gt;.  The associative array is<br>rooted on the following structure:</p>
<pre><code>struct assoc_array &#123;
    ...
&#125;;
</code></pre>
<p>The code is selected by enabling CONFIG_ASSOCIATIVE_ARRAY.</p>
<h2 id="EDIT-SCRIPT"><a href="#EDIT-SCRIPT" class="headerlink" title="EDIT SCRIPT"></a>EDIT SCRIPT</h2><p>The insertion and deletion functions produce an ‘edit script’ that can later be<br>applied to effect the changes without risking ENOMEM.  This retains the<br>preallocated metadata blocks that will be installed in the internal tree and<br>keeps track of the metadata blocks that will be removed from the tree when the<br>script is applied.</p>
<p>This is also used to keep track of dead blocks and dead objects after the<br>script has been applied so that they can be freed later.  The freeing is done<br>after an RCU grace period has passed - thus allowing access functions to<br>proceed under the RCU read lock.</p>
<p>The script appears as outside of the API as a pointer of the type:</p>
<pre><code>struct assoc_array_edit;
</code></pre>
<p>There are two functions for dealing with the script:</p>
<p> (1) Apply an edit script.</p>
<pre><code>void assoc_array_apply_edit(struct assoc_array_edit *edit);

 This will perform the edit functions, interpolating various write barriers
 to permit accesses under the RCU read lock to continue.  The edit script
 will then be passed to call_rcu() to free it and any dead stuff it points
 to.
</code></pre>
<p> (2) Cancel an edit script.</p>
<pre><code>void assoc_array_cancel_edit(struct assoc_array_edit *edit);

 This frees the edit script and all preallocated memory immediately.  If
 this was for insertion, the new object is _not_ released by this function,
 but must rather be released by the caller.
</code></pre>
<p>These functions are guaranteed not to fail.</p>
<h2 id="OPERATIONS-TABLE"><a href="#OPERATIONS-TABLE" class="headerlink" title="OPERATIONS TABLE"></a>OPERATIONS TABLE</h2><p>Various functions take a table of operations:</p>
<pre><code>struct assoc_array_ops &#123;
    ...
&#125;;
</code></pre>
<p>This points to a number of methods, all of which need to be provided:</p>
<p> (1) Get a chunk of index key from caller data:</p>
<pre><code>unsigned long (*get_key_chunk)(const void *index_key, int level);

 This should return a chunk of caller-supplied index key starting at the
 *bit* position given by the level argument.  The level argument will be a
 multiple of ASSOC_ARRAY_KEY_CHUNK_SIZE and the function should return
 ASSOC_ARRAY_KEY_CHUNK_SIZE bits.  No error is possible.
</code></pre>
<p> (2) Get a chunk of an object’s index key.</p>
<pre><code>unsigned long (*get_object_key_chunk)(const void *object, int level);

 As the previous function, but gets its data from an object in the array
 rather than from a caller-supplied index key.
</code></pre>
<p> (3) See if this is the object we’re looking for.</p>
<pre><code>bool (*compare_object)(const void *object, const void *index_key);

 Compare the object against an index key and return true if it matches and
 false if it doesn&#39;t.
</code></pre>
<p> (4) Diff the index keys of two objects.</p>
<pre><code>int (*diff_objects)(const void *object, const void *index_key);

 Return the bit position at which the index key of the specified object
 differs from the given index key or -1 if they are the same.
</code></pre>
<p> (5) Free an object.</p>
<pre><code>void (*free_object)(void *object);

 Free the specified object.  Note that this may be called an RCU grace
 period after assoc_array_apply_edit() was called, so synchronize_rcu() may
 be necessary on module unloading.
</code></pre>
<h2 id="MANIPULATION-FUNCTIONS"><a href="#MANIPULATION-FUNCTIONS" class="headerlink" title="MANIPULATION FUNCTIONS"></a>MANIPULATION FUNCTIONS</h2><p>There are a number of functions for manipulating an associative array:</p>
<p> (1) Initialise an associative array.</p>
<pre><code>void assoc_array_init(struct assoc_array *array);

 This initialises the base structure for an associative array.  It can&#39;t
 fail.
</code></pre>
<p> (2) Insert/replace an object in an associative array.</p>
<pre><code>struct assoc_array_edit *
assoc_array_insert(struct assoc_array *array,
           const struct assoc_array_ops *ops,
           const void *index_key,
           void *object);

 This inserts the given object into the array.  Note that the least
 significant bit of the pointer must be zero as it&#39;s used to type-mark
 pointers internally.

 If an object already exists for that key then it will be replaced with the
 new object and the old one will be freed automatically.

 The index_key argument should hold index key information and is
 passed to the methods in the ops table when they are called.

 This function makes no alteration to the array itself, but rather returns
 an edit script that must be applied.  -ENOMEM is returned in the case of
 an out-of-memory error.

 The caller should lock exclusively against other modifiers of the array.
</code></pre>
<p> (3) Delete an object from an associative array.</p>
<pre><code>struct assoc_array_edit *
assoc_array_delete(struct assoc_array *array,
           const struct assoc_array_ops *ops,
           const void *index_key);

 This deletes an object that matches the specified data from the array.

 The index_key argument should hold index key information and is
 passed to the methods in the ops table when they are called.

 This function makes no alteration to the array itself, but rather returns
 an edit script that must be applied.  -ENOMEM is returned in the case of
 an out-of-memory error.  NULL will be returned if the specified object is
 not found within the array.

 The caller should lock exclusively against other modifiers of the array.
</code></pre>
<p> (4) Delete all objects from an associative array.</p>
<pre><code>struct assoc_array_edit *
assoc_array_clear(struct assoc_array *array,
          const struct assoc_array_ops *ops);

 This deletes all the objects from an associative array and leaves it
 completely empty.

 This function makes no alteration to the array itself, but rather returns
 an edit script that must be applied.  -ENOMEM is returned in the case of
 an out-of-memory error.

 The caller should lock exclusively against other modifiers of the array.
</code></pre>
<p> (5) Destroy an associative array, deleting all objects.</p>
<pre><code>void assoc_array_destroy(struct assoc_array *array,
             const struct assoc_array_ops *ops);

 This destroys the contents of the associative array and leaves it
 completely empty.  It is not permitted for another thread to be traversing
 the array under the RCU read lock at the same time as this function is
 destroying it as no RCU deferral is performed on memory release -
 something that would require memory to be allocated.

 The caller should lock exclusively against other modifiers and accessors
 of the array.
</code></pre>
<p> (6) Garbage collect an associative array.</p>
<pre><code>int assoc_array_gc(struct assoc_array *array,
           const struct assoc_array_ops *ops,
           bool (*iterator)(void *object, void *iterator_data),
           void *iterator_data);

 This iterates over the objects in an associative array and passes each one
 to iterator().  If iterator() returns true, the object is kept.  If it
 returns false, the object will be freed.  If the iterator() function
 returns true, it must perform any appropriate refcount incrementing on the
 object before returning.

 The internal tree will be packed down if possible as part of the iteration
 to reduce the number of nodes in it.

 The iterator_data is passed directly to iterator() and is otherwise
 ignored by the function.

 The function will return 0 if successful and -ENOMEM if there wasn&#39;t
 enough memory.

 It is possible for other threads to iterate over or search the array under
 the RCU read lock whilst this function is in progress.  The caller should
 lock exclusively against other modifiers of the array.
</code></pre>
<h2 id="ACCESS-FUNCTIONS"><a href="#ACCESS-FUNCTIONS" class="headerlink" title="ACCESS FUNCTIONS"></a>ACCESS FUNCTIONS</h2><p>There are two functions for accessing an associative array:</p>
<p> (1) Iterate over all the objects in an associative array.</p>
<pre><code>int assoc_array_iterate(const struct assoc_array *array,
            int (*iterator)(const void *object,
                    void *iterator_data),
            void *iterator_data);

 This passes each object in the array to the iterator callback function.
 iterator_data is private data for that function.

 This may be used on an array at the same time as the array is being
 modified, provided the RCU read lock is held.  Under such circumstances,
 it is possible for the iteration function to see some objects twice.  If
 this is a problem, then modification should be locked against.  The
 iteration algorithm should not, however, miss any objects.

 The function will return 0 if no objects were in the array or else it will
 return the result of the last iterator function called.  Iteration stops
 immediately if any call to the iteration function results in a non-zero
 return.
</code></pre>
<p> (2) Find an object in an associative array.</p>
<pre><code>void *assoc_array_find(const struct assoc_array *array,
               const struct assoc_array_ops *ops,
               const void *index_key);

 This walks through the array&#39;s internal tree directly to the object
 specified by the index key..

 This may be used on an array at the same time as the array is being
 modified, provided the RCU read lock is held.

 The function will return the object if found (and set *_type to the object
 type) or will return NULL if the object was not found.
</code></pre>
<h2 id="INDEX-KEY-FORM"><a href="#INDEX-KEY-FORM" class="headerlink" title="INDEX KEY FORM"></a>INDEX KEY FORM</h2><p>The index key can be of any form, but since the algorithms aren’t told how long<br>the key is, it is strongly recommended that the index key includes its length<br>very early on before any variation due to the length would have an effect on<br>comparisons.</p>
<p>This will cause leaves with different length keys to scatter away from each<br>other - and those with the same length keys to cluster together.</p>
<p>It is also recommended that the index key begin with a hash of the rest of the<br>key to maximise scattering throughout keyspace.</p>
<p>The better the scattering, the wider and lower the internal tree will be.</p>
<p>Poor scattering isn’t too much of a problem as there are shortcuts and nodes<br>can contain mixtures of leaves and metadata pointers.</p>
<p>The index key is read in chunks of machine word.  Each chunk is subdivided into<br>one nibble (4 bits) per level, so on a 32-bit CPU this is good for 8 levels and<br>on a 64-bit CPU, 16 levels.  Unless the scattering is really poor, it is<br>unlikely that more than one word of any particular index key will have to be<br>used.</p>
<p>=================<br>INTERNAL WORKINGS<br>=================</p>
<p>The associative array data structure has an internal tree.  This tree is<br>constructed of two types of metadata blocks: nodes and shortcuts.</p>
<p>A node is an array of slots.  Each slot can contain one of four things:</p>
<p> (*) A NULL pointer, indicating that the slot is empty.</p>
<p> (*) A pointer to an object (a leaf).</p>
<p> (*) A pointer to a node at the next level.</p>
<p> (*) A pointer to a shortcut.</p>
<h2 id="BASIC-INTERNAL-TREE-LAYOUT"><a href="#BASIC-INTERNAL-TREE-LAYOUT" class="headerlink" title="BASIC INTERNAL TREE LAYOUT"></a>BASIC INTERNAL TREE LAYOUT</h2><p>Ignoring shortcuts for the moment, the nodes form a multilevel tree.  The index<br>key space is strictly subdivided by the nodes in the tree and nodes occur on<br>fixed levels.  For example:</p>
<p> Level:    0        1        2        3<br>    ===============    ===============    ===============    ===============<br>                            NODE D<br>            NODE B        NODE C    +——&gt;+—+<br>        +——&gt;+—+    +——&gt;+—+    |    | 0 |<br>    NODE A    |    | 0 |    |    | 0 |    |    +—+<br>    +—+    |    +—+    |    +—+    |    :   :<br>    | 0 |    |    :   :    |    :   :    |    +—+<br>    +—+    |    +—+    |    +—+    |    | f |<br>    | 1 |—+    | 3 |—+    | 7 |—+    +—+<br>    +—+        +—+        +—+<br>    :   :        :   :        | 8 |—+<br>    +—+        +—+        +—+    |    NODE E<br>    | e |—+    | f |        :   :   +——&gt;+—+<br>    +—+    |    +—+        +—+        | 0 |<br>    | f |    |            | f |        +—+<br>    +—+    |            +—+        :   :<br>        |    NODE F                +—+<br>        +——&gt;+—+                | f |<br>            | 0 |        NODE G        +—+<br>            +—+    +——&gt;+—+<br>            :   :    |    | 0 |<br>            +—+    |    +—+<br>            | 6 |—+    :   :<br>            +—+        +—+<br>            :   :        | f |<br>            +—+        +—+<br>            | f |<br>            +—+</p>
<p>In the above example, there are 7 nodes (A-G), each with 16 slots (0-f).<br>Assuming no other meta data nodes in the tree, the key space is divided thusly:</p>
<pre><code>KEY PREFIX    NODE
==========    ====
137*        D
138*        E
13[0-69-f]*    C
1[0-24-f]*    B
e6*        G
e[0-57-f]*    F
[02-df]*    A
</code></pre>
<p>So, for instance, keys with the following example index keys will be found in<br>the appropriate nodes:</p>
<pre><code>INDEX KEY    PREFIX    NODE
===============    =======    ====
13694892892489    13    C
13795289025897    137    D
13889dde88793    138    E
138bbb89003093    138    E
1394879524789    12    C
1458952489    1    B
9431809de993ba    -    A
b4542910809cd    -    A
e5284310def98    e    F
e68428974237    e6    G
e7fffcbd443    e    F
f3842239082    -    A
</code></pre>
<p>To save memory, if a node can hold all the leaves in its portion of keyspace,<br>then the node will have all those leaves in it and will not have any metadata<br>pointers - even if some of those leaves would like to be in the same slot.</p>
<p>A node can contain a heterogeneous mix of leaves and metadata pointers.<br>Metadata pointers must be in the slots that match their subdivisions of key<br>space.  The leaves can be in any slot not occupied by a metadata pointer.  It<br>is guaranteed that none of the leaves in a node will match a slot occupied by a<br>metadata pointer.  If the metadata pointer is there, any leaf whose key matches<br>the metadata key prefix must be in the subtree that the metadata pointer points<br>to.</p>
<p>In the above example list of index keys, node A will contain:</p>
<pre><code>SLOT    CONTENT        INDEX KEY (PREFIX)
====    ===============    ==================
1    PTR TO NODE B    1*
any    LEAF        9431809de993ba
any    LEAF        b4542910809cd
e    PTR TO NODE F    e*
any    LEAF        f3842239082
</code></pre>
<p>and node B:</p>
<pre><code>3    PTR TO NODE C    13*
any    LEAF        1458952489
</code></pre>
<h2 id="SHORTCUTS"><a href="#SHORTCUTS" class="headerlink" title="SHORTCUTS"></a>SHORTCUTS</h2><p>Shortcuts are metadata records that jump over a piece of keyspace.  A shortcut<br>is a replacement for a series of single-occupancy nodes ascending through the<br>levels.  Shortcuts exist to save memory and to speed up traversal.</p>
<p>It is possible for the root of the tree to be a shortcut - say, for example,<br>the tree contains at least 17 nodes all with key prefix ‘1111’.  The insertion<br>algorithm will insert a shortcut to skip over the ‘1111’ keyspace in a single<br>bound and get to the fourth level where these actually become different.</p>
<h2 id="SPLITTING-AND-COLLAPSING-NODES"><a href="#SPLITTING-AND-COLLAPSING-NODES" class="headerlink" title="SPLITTING AND COLLAPSING NODES"></a>SPLITTING AND COLLAPSING NODES</h2><p>Each node has a maximum capacity of 16 leaves and metadata pointers.  If the<br>insertion algorithm finds that it is trying to insert a 17th object into a<br>node, that node will be split such that at least two leaves that have a common<br>key segment at that level end up in a separate node rooted on that slot for<br>that common key segment.</p>
<p>If the leaves in a full node and the leaf that is being inserted are<br>sufficiently similar, then a shortcut will be inserted into the tree.</p>
<p>When the number of objects in the subtree rooted at a node falls to 16 or<br>fewer, then the subtree will be collapsed down to a single node - and this will<br>ripple towards the root if possible.</p>
<h2 id="NON-RECURSIVE-ITERATION"><a href="#NON-RECURSIVE-ITERATION" class="headerlink" title="NON-RECURSIVE ITERATION"></a>NON-RECURSIVE ITERATION</h2><p>Each node and shortcut contains a back pointer to its parent and the number of<br>slot in that parent that points to it.  None-recursive iteration uses these to<br>proceed rootwards through the tree, going to the parent node, slot N + 1 to<br>make sure progress is made without the need for a stack.</p>
<p>The backpointers, however, make simultaneous alteration and iteration tricky.</p>
<h2 id="SIMULTANEOUS-ALTERATION-AND-ITERATION"><a href="#SIMULTANEOUS-ALTERATION-AND-ITERATION" class="headerlink" title="SIMULTANEOUS ALTERATION AND ITERATION"></a>SIMULTANEOUS ALTERATION AND ITERATION</h2><p>There are a number of cases to consider:</p>
<p> (1) Simple insert/replace.  This involves simply replacing a NULL or old<br>     matching leaf pointer with the pointer to the new leaf after a barrier.<br>     The metadata blocks don’t change otherwise.  An old leaf won’t be freed<br>     until after the RCU grace period.</p>
<p> (2) Simple delete.  This involves just clearing an old matching leaf.  The<br>     metadata blocks don’t change otherwise.  The old leaf won’t be freed until<br>     after the RCU grace period.</p>
<p> (3) Insertion replacing part of a subtree that we haven’t yet entered.  This<br>     may involve replacement of part of that subtree - but that won’t affect<br>     the iteration as we won’t have reached the pointer to it yet and the<br>     ancestry blocks are not replaced (the layout of those does not change).</p>
<p> (4) Insertion replacing nodes that we’re actively processing.  This isn’t a<br>     problem as we’ve passed the anchoring pointer and won’t switch onto the<br>     new layout until we follow the back pointers - at which point we’ve<br>     already examined the leaves in the replaced node (we iterate over all the<br>     leaves in a node before following any of its metadata pointers).</p>
<pre><code> We might, however, re-see some leaves that have been split out into a new
 branch that&#39;s in a slot further along than we were at.
</code></pre>
<p> (5) Insertion replacing nodes that we’re processing a dependent branch of.<br>     This won’t affect us until we follow the back pointers.  Similar to (4).</p>
<p> (6) Deletion collapsing a branch under us.  This doesn’t affect us because the<br>     back pointers will get us back to the parent of the new node before we<br>     could see the new node.  The entire collapsed subtree is thrown away<br>     unchanged - and will still be rooted on the same slot, so we shouldn’t<br>     process it a second time as we’ll go back to slot + 1.</p>
<p>Note:</p>
<p> (*) Under some circumstances, we need to simultaneously change the parent<br>     pointer and the parent slot pointer on a node (say, for example, we<br>     inserted another node before it and moved it up a level).  We cannot do<br>     this without locking against a read - so we have to replace that node too.</p>
<pre><code> However, when we&#39;re changing a shortcut into a node this isn&#39;t a problem
 as shortcuts only have one slot and so the parent slot number isn&#39;t used
 when traversing backwards over one.  This means that it&#39;s okay to change
 the slot number first - provided suitable barriers are used to make sure
 the parent slot number is read after the back pointer.
</code></pre>
<p>Obsolete blocks and leaves are freed up after an RCU grace period has passed,<br>so as long as anyone doing walking or iteration holds the RCU read lock, the<br>old superstructure should not go away on them.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_assoc_array/" title="Kernel-3.10.0-957.el7_assoc_array" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_assoc_array/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_arcnet/" title="Kernel-3.10.0-957.el7_arcnet"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_atarikbd/" title="Kernel-3.10.0-957.el7_atarikb"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>