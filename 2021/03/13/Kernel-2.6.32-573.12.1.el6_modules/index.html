<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-2.6.32-573.12.1.el6_modules | oosTech.com</title>
  <meta name="description" content="In this document you will find information about:  how to build external modules how to make your module use the kbuild infrastructure how kbuild will install a kernel how to install modules in a non-">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-2.6.32-573.12.1.el6_modules">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_modules/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="In this document you will find information about:  how to build external modules how to make your module use the kbuild infrastructure how kbuild will install a kernel how to install modules in a non-">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_modules/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kernel-source"><span class="toc-number">1.</span> <span class="toc-text">Kernel source</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Output-from-kernel-compile"><span class="toc-number">2.</span> <span class="toc-text">Output from kernel compile</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-2.6.32-573.12.1.el6_modules" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-2.6.32-573.12.1.el6_modules
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_modules/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_modules/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_modules/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>In this document you will find information about:</p>
<ul>
<li>how to build external modules</li>
<li>how to make your module use the kbuild infrastructure</li>
<li>how kbuild will install a kernel</li>
<li>how to install modules in a non-standard location</li>
</ul>
<p>=== Table of Contents</p>
<pre><code>=== 1 Introduction
=== 2 How to build external modules
   --- 2.1 Building external modules
   --- 2.2 Available targets
   --- 2.3 Available options
   --- 2.4 Preparing the kernel tree for module build
   --- 2.5 Building separate files for a module
=== 3. Example commands
=== 4. Creating a kbuild file for an external module
=== 5. Include files
   --- 5.1 How to include files from the kernel include dir
   --- 5.2 External modules using an include/ dir
   --- 5.3 External modules using several directories
=== 6. Module installation
   --- 6.1 INSTALL_MOD_PATH
   --- 6.2 INSTALL_MOD_DIR
=== 7. Module versioning &amp; Module.symvers
   --- 7.1 Symbols from the kernel (vmlinux + modules)
   --- 7.2 Symbols and external modules
   --- 7.3 Symbols from another external module
=== 8. Tips &amp; Tricks
   --- 8.1 Testing for CONFIG_FOO_BAR
</code></pre>
<p>=== 1. Introduction</p>
<p>kbuild includes functionality for building modules both<br>within the kernel source tree and outside the kernel source tree.<br>The latter is usually referred to as external or “out-of-tree”<br>modules and is used both during development and for modules that<br>are not planned to be included in the kernel tree.</p>
<p>What is covered within this file is mainly information to authors<br>of modules. The author of an external module should supply<br>a makefile that hides most of the complexity, so one only has to type<br>‘make’ to build the module. A complete example will be presented in<br>chapter 4, “Creating a kbuild file for an external module”.</p>
<p>=== 2. How to build external modules</p>
<p>kbuild offers functionality to build external modules, with the<br>prerequisite that there is a pre-built kernel available with full source.<br>A subset of the targets available when building the kernel is available<br>when building an external module.</p>
<p>— 2.1 Building external modules</p>
<pre><code>Use the following command to build an external module:

    make -C &lt;path-to-kernel&gt; M=`pwd`

For the running kernel use:

    make -C /lib/modules/`uname -r`/build M=`pwd`

For the above command to succeed, the kernel must have been
built with modules enabled.

To install the modules that were just built:

    make -C &lt;path-to-kernel&gt; M=`pwd` modules_install

More complex examples will be shown later, the above should
be enough to get you started.
</code></pre>
<p>— 2.2 Available targets</p>
<pre><code>$KDIR refers to the path to the kernel source top-level directory

make -C $KDIR M=`pwd`
    Will build the module(s) located in current directory.
    All output files will be located in the same directory
    as the module source.
    No attempts are made to update the kernel source, and it is
    a precondition that a successful make has been executed
    for the kernel.

make -C $KDIR M=`pwd` modules
    The modules target is implied when no target is given.
    Same functionality as if no target was specified.
    See description above.

make -C $KDIR M=`pwd` modules_install
    Install the external module(s).
    Installation default is in /lib/modules/&lt;kernel-version&gt;/extra,
    but may be prefixed with INSTALL_MOD_PATH - see separate
    chapter.

make -C $KDIR M=`pwd` clean
    Remove all generated files for the module - the kernel
    source directory is not modified.

make -C $KDIR M=`pwd` help
    help will list the available target when building external
    modules.
</code></pre>
<p>— 2.3 Available options:</p>
<pre><code>$KDIR refers to the path to the kernel source top-level directory

make -C $KDIR
    Used to specify where to find the kernel source.
    &#39;$KDIR&#39; represent the directory where the kernel source is.
    Make will actually change directory to the specified directory
    when executed but change back when finished.

make -C $KDIR M=`pwd`
    M= is used to tell kbuild that an external module is
    being built.
    The option given to M= is the directory where the external
    module (kbuild file) is located.
    When an external module is being built only a subset of the
    usual targets are available.

make -C $KDIR SUBDIRS=`pwd`
    Same as M=. The SUBDIRS= syntax is kept for backwards
    compatibility.
</code></pre>
<p>— 2.4 Preparing the kernel tree for module build</p>
<pre><code>To make sure the kernel contains the information required to
build external modules the target &#39;modules_prepare&#39; must be used.
&#39;modules_prepare&#39; exists solely as a simple way to prepare
a kernel source tree for building external modules.
Note: modules_prepare will not build Module.symvers even if
CONFIG_MODVERSIONS is set. Therefore a full kernel build
needs to be executed to make module versioning work.
</code></pre>
<p>— 2.5 Building separate files for a module<br>    It is possible to build single files which are part of a module.<br>    This works equally well for the kernel, a module and even for<br>    external modules.<br>    Examples (module foo.ko, consist of bar.o, baz.o):<br>        make -C $KDIR M=<code>pwd</code> bar.lst<br>        make -C $KDIR M=<code>pwd</code> bar.o<br>        make -C $KDIR M=<code>pwd</code> foo.ko<br>        make -C $KDIR M=<code>pwd</code> /</p>
<p>=== 3. Example commands</p>
<p>This example shows the actual commands to be executed when building<br>an external module for the currently running kernel.<br>In the example below, the distribution is supposed to use the<br>facility to locate output files for a kernel compile in a different<br>directory than the kernel source - but the examples will also work<br>when the source and the output files are mixed in the same directory.</p>
<h1 id="Kernel-source"><a href="#Kernel-source" class="headerlink" title="Kernel source"></a>Kernel source</h1><p>/lib/modules/<kernel-version>/source -&gt; /usr/src/linux-<version></p>
<h1 id="Output-from-kernel-compile"><a href="#Output-from-kernel-compile" class="headerlink" title="Output from kernel compile"></a>Output from kernel compile</h1><p>/lib/modules/<kernel-version>/build -&gt; /usr/src/linux-<version>-up</p>
<p>Change to the directory where the kbuild file is located and execute<br>the following commands to build the module:</p>
<pre><code>cd /home/user/src/module
make -C /usr/src/`uname -r`/source            \
        O=/lib/modules/`uname-r`/build        \
        M=`pwd`
</code></pre>
<p>Then, to install the module use the following command:</p>
<pre><code>make -C /usr/src/`uname -r`/source            \
        O=/lib/modules/`uname-r`/build        \
        M=`pwd`                               \
    modules_install
</code></pre>
<p>If you look closely you will see that this is the same command as<br>listed before - with the directories spelled out.</p>
<p>The above are rather long commands, and the following chapter<br>lists a few tricks to make it all easier.</p>
<p>=== 4. Creating a kbuild file for an external module</p>
<p>kbuild is the build system for the kernel, and external modules<br>must use kbuild to stay compatible with changes in the build system<br>and to pick up the right flags to gcc etc.</p>
<p>The kbuild file used as input shall follow the syntax described<br>in Documentation/kbuild/makefiles.txt. This chapter will introduce a few<br>more tricks to be used when dealing with external modules.</p>
<p>In the following a Makefile will be created for a module with the<br>following files:<br>    8123_if.c<br>    8123_if.h<br>    8123_pci.c<br>    8123_bin.o_shipped    &lt;= Binary blob</p>
<p>— 4.1 Shared Makefile for module and kernel</p>
<pre><code>An external module always includes a wrapper Makefile supporting
building the module using &#39;make&#39; with no arguments.
The Makefile provided will most likely include additional
functionality such as test targets etc. and this part shall
be filtered away from kbuild since it may impact kbuild if
name clashes occurs.

Example 1:
    --&gt; filename: Makefile
    ifneq ($(KERNELRELEASE),)
    # kbuild part of makefile
    obj-m  := 8123.o
    8123-y := 8123_if.o 8123_pci.o 8123_bin.o

    else
    # Normal Makefile

    KERNELDIR := /lib/modules/`uname -r`/build
    all::
        $(MAKE) -C $(KERNELDIR) M=`pwd` $@

    # Module specific targets
    genbin:
        echo &quot;X&quot; &gt; 8123_bin.o_shipped

    endif

In example 1, the check for KERNELRELEASE is used to separate
the two parts of the Makefile. kbuild will only see the two
assignments whereas make will see everything except the two
kbuild assignments.

In recent versions of the kernel, kbuild will look for a file named
Kbuild and as second option look for a file named Makefile.
Utilising the Kbuild file makes us split up the Makefile in example 1
into two files as shown in example 2:

Example 2:
    --&gt; filename: Kbuild
    obj-m  := 8123.o
    8123-y := 8123_if.o 8123_pci.o 8123_bin.o

    --&gt; filename: Makefile
    KERNELDIR := /lib/modules/`uname -r`/build
    all::
        $(MAKE) -C $(KERNELDIR) M=`pwd` $@

    # Module specific targets
    genbin:
        echo &quot;X&quot; &gt; 8123_bin.o_shipped


In example 2, we are down to two fairly simple files and for simple
files as used in this example the split is questionable. But some
external modules use Makefiles of several hundred lines and here it
really pays off to separate the kbuild part from the rest.
Example 3 shows a backward compatible version.

Example 3:
    --&gt; filename: Kbuild
    obj-m  := 8123.o
    8123-y := 8123_if.o 8123_pci.o 8123_bin.o

    --&gt; filename: Makefile
    ifneq ($(KERNELRELEASE),)
    include Kbuild
    else
    # Normal Makefile

    KERNELDIR := /lib/modules/`uname -r`/build
    all::
        $(MAKE) -C $(KERNELDIR) M=`pwd` $@

    # Module specific targets
    genbin:
        echo &quot;X&quot; &gt; 8123_bin.o_shipped

    endif

The trick here is to include the Kbuild file from Makefile, so
if an older version of kbuild picks up the Makefile, the Kbuild
file will be included.
</code></pre>
<p>— 4.2 Binary blobs included in a module</p>
<pre><code>Some external modules needs to include a .o as a blob. kbuild
has support for this, but requires the blob file to be named
&lt;filename&gt;_shipped. In our example the blob is named
8123_bin.o_shipped and when the kbuild rules kick in the file
8123_bin.o is created as a simple copy off the 8213_bin.o_shipped file
with the _shipped part stripped of the filename.
This allows the 8123_bin.o filename to be used in the assignment to
the module.

Example 4:
    obj-m  := 8123.o
    8123-y := 8123_if.o 8123_pci.o 8123_bin.o

In example 4, there is no distinction between the ordinary .c/.h files
and the binary file. But kbuild will pick up different rules to create
the .o file.
</code></pre>
<p>=== 5. Include files</p>
<p>Include files are a necessity when a .c file uses something from other .c<br>files (not strictly in the sense of C, but if good programming practice is<br>used). Any module that consists of more than one .c file will have a .h file<br>for one of the .c files.</p>
<ul>
<li>If the .h file only describes a module internal interface, then the .h file<br>shall be placed in the same directory as the .c files.</li>
<li>If the .h files describe an interface used by other parts of the kernel<br>located in different directories, the .h files shall be located in<br>include/linux/ or other include/ directories as appropriate.</li>
</ul>
<p>One exception for this rule is larger subsystems that have their own directory<br>under include/ such as include/scsi. Another exception is arch-specific<br>.h files which are located under include/asm-$(ARCH)/*.</p>
<p>External modules have a tendency to locate include files in a separate include/<br>directory and therefore need to deal with this in their kbuild file.</p>
<p>— 5.1 How to include files from the kernel include dir</p>
<pre><code>When a module needs to include a file from include/linux/, then one
just uses:

    #include &lt;linux/modules.h&gt;

kbuild will make sure to add options to gcc so the relevant
directories are searched.
Likewise for .h files placed in the same directory as the .c file.

    #include &quot;8123_if.h&quot;

will do the job.
</code></pre>
<p>— 5.2 External modules using an include/ dir</p>
<pre><code>External modules often locate their .h files in a separate include/
directory although this is not usual kernel style. When an external
module uses an include/ dir then kbuild needs to be told so.
The trick here is to use either EXTRA_CFLAGS (take effect for all .c
files) or CFLAGS_$F.o (take effect only for a single file).

In our example, if we move 8123_if.h to a subdirectory named include/
the resulting Kbuild file would look like:

    --&gt; filename: Kbuild
    obj-m  := 8123.o

    EXTRA_CFLAGS := -Iinclude
    8123-y := 8123_if.o 8123_pci.o 8123_bin.o

Note that in the assignment there is no space between -I and the path.
This is a kbuild limitation:  there must be no space present.
</code></pre>
<p>— 5.3 External modules using several directories</p>
<pre><code>If an external module does not follow the usual kernel style, but
decides to spread files over several directories, then kbuild can
handle this too.

Consider the following example:

|
+- src/complex_main.c
|   +- hal/hardwareif.c
|   +- hal/include/hardwareif.h
+- include/complex.h

To build a single module named complex.ko, we then need the following
kbuild file:

Kbuild:
    obj-m := complex.o
    complex-y := src/complex_main.o
    complex-y += src/hal/hardwareif.o

    EXTRA_CFLAGS := -I$(src)/include
    EXTRA_CFLAGS += -I$(src)src/hal/include


kbuild knows how to handle .o files located in another directory -
although this is NOT recommended practice. The syntax is to specify
the directory relative to the directory where the Kbuild file is
located.

To find the .h files, we have to explicitly tell kbuild where to look
for the .h files. When kbuild executes, the current directory is always
the root of the kernel tree (argument to -C) and therefore we have to
tell kbuild how to find the .h files using absolute paths.
$(src) will specify the absolute path to the directory where the
Kbuild file are located when being build as an external module.
Therefore -I$(src)/ is used to point out the directory of the Kbuild
file and any additional path are just appended.
</code></pre>
<p>=== 6. Module installation</p>
<p>Modules which are included in the kernel are installed in the directory:</p>
<pre><code>/lib/modules/$(KERNELRELEASE)/kernel
</code></pre>
<p>External modules are installed in the directory:</p>
<pre><code>/lib/modules/$(KERNELRELEASE)/extra
</code></pre>
<p>— 6.1 INSTALL_MOD_PATH</p>
<pre><code>Above are the default directories, but as always, some level of
customization is possible. One can prefix the path using the variable
INSTALL_MOD_PATH:

    $ make INSTALL_MOD_PATH=/frodo modules_install
    =&gt; Install dir: /frodo/lib/modules/$(KERNELRELEASE)/kernel

INSTALL_MOD_PATH may be set as an ordinary shell variable or as in the
example above, can be specified on the command line when calling make.
INSTALL_MOD_PATH has effect both when installing modules included in
the kernel as well as when installing external modules.
</code></pre>
<p>— 6.2 INSTALL_MOD_DIR</p>
<pre><code>When installing external modules they are by default installed to a
directory under /lib/modules/$(KERNELRELEASE)/extra, but one may wish
to locate modules for a specific functionality in a separate
directory. For this purpose, one can use INSTALL_MOD_DIR to specify an
alternative name to &#39;extra&#39;.

    $ make INSTALL_MOD_DIR=gandalf -C KERNELDIR \
        M=`pwd` modules_install
    =&gt; Install dir: /lib/modules/$(KERNELRELEASE)/gandalf
</code></pre>
<p>=== 7. Module versioning &amp; Module.symvers</p>
<p>Module versioning is enabled by the CONFIG_MODVERSIONS tag.</p>
<p>Module versioning is used as a simple ABI consistency check. The Module<br>versioning creates a CRC value of the full prototype for an exported symbol and<br>when a module is loaded/used then the CRC values contained in the kernel are<br>compared with similar values in the module. If they are not equal, then the<br>kernel refuses to load the module.</p>
<p>Module.symvers contains a list of all exported symbols from a kernel build.</p>
<p>— 7.1 Symbols from the kernel (vmlinux + modules)</p>
<pre><code>During a kernel build, a file named Module.symvers will be generated.
Module.symvers contains all exported symbols from the kernel and
compiled modules. For each symbols, the corresponding CRC value
is stored too.

The syntax of the Module.symvers file is:
    &lt;CRC&gt;       &lt;Symbol&gt;           &lt;module&gt;
Sample:
    0x2d036834  scsi_remove_host   drivers/scsi/scsi_mod

For a kernel build without CONFIG_MODVERSIONS enabled, the crc
would read: 0x00000000

Module.symvers serves two purposes:
1) It lists all exported symbols both from vmlinux and all modules
2) It lists the CRC if CONFIG_MODVERSIONS is enabled
</code></pre>
<p>— 7.2 Symbols and external modules</p>
<pre><code>When building an external module, the build system needs access to
the symbols from the kernel to check if all external symbols are
defined. This is done in the MODPOST step and to obtain all
symbols, modpost reads Module.symvers from the kernel.
If a Module.symvers file is present in the directory where
the external module is being built, this file will be read too.
During the MODPOST step, a new Module.symvers file will be written
containing all exported symbols that were not defined in the kernel.
</code></pre>
<p>— 7.3 Symbols from another external module</p>
<pre><code>Sometimes, an external module uses exported symbols from another
external module. Kbuild needs to have full knowledge on all symbols
to avoid spitting out warnings about undefined symbols.
Three solutions exist to let kbuild know all symbols of more than
one external module.
The method with a top-level kbuild file is recommended but may be
impractical in certain situations.

Use a top-level Kbuild file
    If you have two modules: &#39;foo&#39; and &#39;bar&#39;, and &#39;foo&#39; needs
    symbols from &#39;bar&#39;, then one can use a common top-level kbuild
    file so both modules are compiled in same build.

    Consider following directory layout:
    ./foo/ &lt;= contains the foo module
    ./bar/ &lt;= contains the bar module
    The top-level Kbuild file would then look like:

    #./Kbuild: (this file may also be named Makefile)
        obj-y := foo/ bar/

    Executing:
        make -C $KDIR M=`pwd`

    will then do the expected and compile both modules with full
    knowledge on symbols from both modules.

Use an extra Module.symvers file
    When an external module is built, a Module.symvers file is
    generated containing all exported symbols which are not
    defined in the kernel.
    To get access to symbols from module &#39;bar&#39;, one can copy the
    Module.symvers file from the compilation of the &#39;bar&#39; module
    to the directory where the &#39;foo&#39; module is built.
    During the module build, kbuild will read the Module.symvers
    file in the directory of the external module and when the
    build is finished, a new Module.symvers file is created
    containing the sum of all symbols defined and not part of the
    kernel.

Use make variable KBUILD_EXTRA_SYMBOLS in the Makefile
    If it is impractical to copy Module.symvers from another
    module, you can assign a space separated list of files to
    KBUILD_EXTRA_SYMBOLS in your Makfile. These files will be
    loaded by modpost during the initialisation of its symbol
    tables.
</code></pre>
<p>=== 8. Tips &amp; Tricks</p>
<p>— 8.1 Testing for CONFIG_FOO_BAR</p>
<pre><code>Modules often need to check for certain CONFIG_ options to decide if
a specific feature shall be included in the module. When kbuild is used
this is done by referencing the CONFIG_ variable directly.

    #fs/ext2/Makefile
    obj-$(CONFIG_EXT2_FS) += ext2.o

    ext2-y := balloc.o bitmap.o dir.o
    ext2-$(CONFIG_EXT2_FS_XATTR) += xattr.o

External modules have traditionally used grep to check for specific
CONFIG_ settings directly in .config. This usage is broken.
As introduced before, external modules shall use kbuild when building
and therefore can use the same methods as in-kernel modules when
testing for CONFIG_ definitions.
</code></pre>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_modules/" title="Kernel-2.6.32-573.12.1.el6_modules" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_modules/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_multi-touch-protocol/" title="Kernel-2.6.32-573.12.1.el6_multi-touch-protocol"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_md/" title="Kernel-2.6.32-573.12.1.el6_"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>