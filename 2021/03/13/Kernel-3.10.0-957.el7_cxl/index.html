<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-3.10.0-957.el7_cxl | oosTech.com</title>
  <meta name="description" content="Coherent Accelerator Interface (CXL)IntroductionThe coherent accelerator interface is designed to allow the coherent connection of accelerators (FPGAs and other devices) to a POWER system. These devic">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-3.10.0-957.el7_cxl">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cxl/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="Coherent Accelerator Interface (CXL)IntroductionThe coherent accelerator interface is designed to allow the coherent connection of accelerators (FPGAs and other devices) to a POWER system. These devic">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cxl/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_mpc5200/" class="title">Kernel-3.10.0-957.el7_mpc5200</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_6pack/" class="title">Kernel-3.10.0-957.el7_6pack</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Coherent-Accelerator-Interface-CXL"><span class="toc-number">1.</span> <span class="toc-text">Coherent Accelerator Interface (CXL)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">2.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hardware-overview"><span class="toc-number">3.</span> <span class="toc-text">Hardware overview</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AFU-Modes"><span class="toc-number">4.</span> <span class="toc-text">AFU Modes</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MMIO-space"><span class="toc-number">5.</span> <span class="toc-text">MMIO space</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Interrupts"><span class="toc-number">6.</span> <span class="toc-text">Interrupts</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Work-Element-Descriptor-WED"><span class="toc-number">7.</span> <span class="toc-text">Work Element Descriptor (WED)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#User-API"><span class="toc-number">8.</span> <span class="toc-text">User API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#open"><span class="toc-number">8.1.</span> <span class="toc-text">open</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ioctl"><span class="toc-number">8.2.</span> <span class="toc-text">ioctl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mmap"><span class="toc-number">8.3.</span> <span class="toc-text">mmap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#read"><span class="toc-number">8.4.</span> <span class="toc-text">read</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#open-1"><span class="toc-number">8.5.</span> <span class="toc-text">open</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ioctl-1"><span class="toc-number">8.6.</span> <span class="toc-text">ioctl</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sysfs-Class"><span class="toc-number">9.</span> <span class="toc-text">Sysfs Class</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Udev-rules"><span class="toc-number">10.</span> <span class="toc-text">Udev rules</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-3.10.0-957.el7_cxl" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-3.10.0-957.el7_cxl
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_cxl/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_cxl/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-3.10.0-957.el7_cxl/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="Coherent-Accelerator-Interface-CXL"><a href="#Coherent-Accelerator-Interface-CXL" class="headerlink" title="Coherent Accelerator Interface (CXL)"></a>Coherent Accelerator Interface (CXL)</h1><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><pre><code>The coherent accelerator interface is designed to allow the
coherent connection of accelerators (FPGAs and other devices) to a
POWER system. These devices need to adhere to the Coherent
Accelerator Interface Architecture (CAIA).

IBM refers to this as the Coherent Accelerator Processor Interface
or CAPI. In the kernel it&#39;s referred to by the name CXL to avoid
confusion with the ISDN CAPI subsystem.

Coherent in this context means that the accelerator and CPUs can
both access system memory directly and with the same effective
addresses.
</code></pre>
<h1 id="Hardware-overview"><a href="#Hardware-overview" class="headerlink" title="Hardware overview"></a>Hardware overview</h1><pre><code>      POWER8               FPGA
   +----------+        +---------+
   |          |        |         |
   |   CPU    |        |   AFU   |
   |          |        |         |
   |          |        |         |
   |          |        |         |
   +----------+        +---------+
   |   PHB    |        |         |
   |   +------+        |   PSL   |
   |   | CAPP |&lt;------&gt;|         |
   +---+------+  PCIE  +---------+

The POWER8 chip has a Coherently Attached Processor Proxy (CAPP)
unit which is part of the PCIe Host Bridge (PHB). This is managed
by Linux by calls into OPAL. Linux doesn&#39;t directly program the
CAPP.

The FPGA (or coherently attached device) consists of two parts.
The POWER Service Layer (PSL) and the Accelerator Function Unit
(AFU). The AFU is used to implement specific functionality behind
the PSL. The PSL, among other things, provides memory address
translation services to allow each AFU direct access to userspace
memory.

The AFU is the core part of the accelerator (eg. the compression,
crypto etc function). The kernel has no knowledge of the function
of the AFU. Only userspace interacts directly with the AFU.

The PSL provides the translation and interrupt services that the
AFU needs. This is what the kernel interacts with. For example, if
the AFU needs to read a particular effective address, it sends
that address to the PSL, the PSL then translates it, fetches the
data from memory and returns it to the AFU. If the PSL has a
translation miss, it interrupts the kernel and the kernel services
the fault. The context to which this fault is serviced is based on
who owns that acceleration function.
</code></pre>
<h1 id="AFU-Modes"><a href="#AFU-Modes" class="headerlink" title="AFU Modes"></a>AFU Modes</h1><pre><code>There are two programming modes supported by the AFU. Dedicated
and AFU directed. AFU may support one or both modes.

When using dedicated mode only one MMU context is supported. In
this mode, only one userspace process can use the accelerator at
time.

When using AFU directed mode, up to 16K simultaneous contexts can
be supported. This means up to 16K simultaneous userspace
applications may use the accelerator (although specific AFUs may
support fewer). In this mode, the AFU sends a 16 bit context ID
with each of its requests. This tells the PSL which context is
associated with each operation. If the PSL can&#39;t translate an
operation, the ID can also be accessed by the kernel so it can
determine the userspace context associated with an operation.
</code></pre>
<h1 id="MMIO-space"><a href="#MMIO-space" class="headerlink" title="MMIO space"></a>MMIO space</h1><pre><code>A portion of the accelerator MMIO space can be directly mapped
from the AFU to userspace. Either the whole space can be mapped or
just a per context portion. The hardware is self describing, hence
the kernel can determine the offset and size of the per context
portion.
</code></pre>
<h1 id="Interrupts"><a href="#Interrupts" class="headerlink" title="Interrupts"></a>Interrupts</h1><pre><code>AFUs may generate interrupts that are destined for userspace. These
are received by the kernel as hardware interrupts and passed onto
userspace by a read syscall documented below.

Data storage faults and error interrupts are handled by the kernel
driver.
</code></pre>
<h1 id="Work-Element-Descriptor-WED"><a href="#Work-Element-Descriptor-WED" class="headerlink" title="Work Element Descriptor (WED)"></a>Work Element Descriptor (WED)</h1><pre><code>The WED is a 64-bit parameter passed to the AFU when a context is
started. Its format is up to the AFU hence the kernel has no
knowledge of what it represents. Typically it will be the
effective address of a work queue or status block where the AFU
and userspace can share control and status information.
</code></pre>
<h1 id="User-API"><a href="#User-API" class="headerlink" title="User API"></a>User API</h1><ol>
<li><p>AFU character devices</p>
<p> For AFUs operating in AFU directed mode, two character device<br> files will be created. /dev/cxl/afu0.0m will correspond to a<br> master context and /dev/cxl/afu0.0s will correspond to a slave<br> context. Master contexts have access to the full MMIO space an<br> AFU provides. Slave contexts have access to only the per process<br> MMIO space an AFU provides.</p>
<p> For AFUs operating in dedicated process mode, the driver will<br> only create a single character device per AFU called<br> /dev/cxl/afu0.0d. This will have access to the entire MMIO space<br> that the AFU provides (like master contexts in AFU directed).</p>
<p> The types described below are defined in include/uapi/misc/cxl.h</p>
<p> The following file operations are supported on both slave and<br> master devices.</p>
<p> A userspace library libcxl is avaliable here:<br> <a target="_blank" rel="noopener" href="https://github.com/ibm-capi/libcxl">https://github.com/ibm-capi/libcxl</a><br> This provides a C interface to this kernel API.</p>
</li>
</ol>
<h2 id="open"><a href="#open" class="headerlink" title="open"></a>open</h2><pre><code>Opens the device and allocates a file descriptor to be used with
the rest of the API.

A dedicated mode AFU only has one context and only allows the
device to be opened once.

An AFU directed mode AFU can have many contexts, the device can be
opened once for each context that is available.

When all available contexts are allocated the open call will fail
and return -ENOSPC.

Note: IRQs need to be allocated for each context, which may limit
      the number of contexts that can be created, and therefore
      how many times the device can be opened. The POWER8 CAPP
      supports 2040 IRQs and 3 are used by the kernel, so 2037 are
      left. If 1 IRQ is needed per context, then only 2037
      contexts can be allocated. If 4 IRQs are needed per context,
      then only 2037/4 = 509 contexts can be allocated.
</code></pre>
<h2 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a>ioctl</h2><pre><code>CXL_IOCTL_START_WORK:
    Starts the AFU context and associates it with the current
    process. Once this ioctl is successfully executed, all memory
    mapped into this process is accessible to this AFU context
    using the same effective addresses. No additional calls are
    required to map/unmap memory. The AFU memory context will be
    updated as userspace allocates and frees memory. This ioctl
    returns once the AFU context is started.

    Takes a pointer to a struct cxl_ioctl_start_work:

            struct cxl_ioctl_start_work &#123;
                    __u64 flags;
                    __u64 work_element_descriptor;
                    __u64 amr;
                    __s16 num_interrupts;
                    __s16 reserved1;
                    __s32 reserved2;
                    __u64 reserved3;
                    __u64 reserved4;
                    __u64 reserved5;
                    __u64 reserved6;
            &#125;;

        flags:
            Indicates which optional fields in the structure are
            valid.

        work_element_descriptor:
            The Work Element Descriptor (WED) is a 64-bit argument
            defined by the AFU. Typically this is an effective
            address pointing to an AFU specific structure
            describing what work to perform.

        amr:
            Authority Mask Register (AMR), same as the powerpc
            AMR. This field is only used by the kernel when the
            corresponding CXL_START_WORK_AMR value is specified in
            flags. If not specified the kernel will use a default
            value of 0.

        num_interrupts:
            Number of userspace interrupts to request. This field
            is only used by the kernel when the corresponding
            CXL_START_WORK_NUM_IRQS value is specified in flags.
            If not specified the minimum number required by the
            AFU will be allocated. The min and max number can be
            obtained from sysfs.

        reserved fields:
            For ABI padding and future extensions

CXL_IOCTL_GET_PROCESS_ELEMENT:
    Get the current context id, also known as the process element.
    The value is returned from the kernel as a __u32.
</code></pre>
<h2 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h2><pre><code>An AFU may have an MMIO space to facilitate communication with the
AFU. If it does, the MMIO space can be accessed via mmap. The size
and contents of this area are specific to the particular AFU. The
size can be discovered via sysfs.

In AFU directed mode, master contexts are allowed to map all of
the MMIO space and slave contexts are allowed to only map the per
process MMIO space associated with the context. In dedicated
process mode the entire MMIO space can always be mapped.

This mmap call must be done after the START_WORK ioctl.

Care should be taken when accessing MMIO space. Only 32 and 64-bit
accesses are supported by POWER8. Also, the AFU will be designed
with a specific endianness, so all MMIO accesses should consider
endianness (recommend endian(3) variants like: le64toh(),
be64toh() etc). These endian issues equally apply to shared memory
queues the WED may describe.
</code></pre>
<h2 id="read"><a href="#read" class="headerlink" title="read"></a>read</h2><pre><code>Reads events from the AFU. Blocks if no events are pending
(unless O_NONBLOCK is supplied). Returns -EIO in the case of an
unrecoverable error or if the card is removed.

read() will always return an integral number of events.

The buffer passed to read() must be at least 4K bytes.

The result of the read will be a buffer of one or more events,
each event is of type struct cxl_event, of varying size.

        struct cxl_event &#123;
                struct cxl_event_header header;
                union &#123;
                        struct cxl_event_afu_interrupt irq;
                        struct cxl_event_data_storage fault;
                        struct cxl_event_afu_error afu_error;
                &#125;;
        &#125;;

The struct cxl_event_header is defined as:

        struct cxl_event_header &#123;
                __u16 type;
                __u16 size;
                __u16 process_element;
                __u16 reserved1;
        &#125;;

    type:
        This defines the type of event. The type determines how
        the rest of the event is structured. These types are
        described below and defined by enum cxl_event_type.

    size:
        This is the size of the event in bytes including the
        struct cxl_event_header. The start of the next event can
        be found at this offset from the start of the current
        event.

    process_element:
        Context ID of the event.

    reserved field:
        For future extensions and padding.

If the event type is CXL_EVENT_AFU_INTERRUPT then the event
structure is defined as:

        struct cxl_event_afu_interrupt &#123;
                __u16 flags;
                __u16 irq; /* Raised AFU interrupt number */
                __u32 reserved1;
        &#125;;

    flags:
        These flags indicate which optional fields are present
        in this struct. Currently all fields are mandatory.

    irq:
        The IRQ number sent by the AFU.

    reserved field:
        For future extensions and padding.

If the event type is CXL_EVENT_DATA_STORAGE then the event
structure is defined as:

        struct cxl_event_data_storage &#123;
                __u16 flags;
                __u16 reserved1;
                __u32 reserved2;
                __u64 addr;
                __u64 dsisr;
                __u64 reserved3;
        &#125;;

    flags:
        These flags indicate which optional fields are present in
        this struct. Currently all fields are mandatory.

    address:
        The address that the AFU unsuccessfully attempted to
        access. Valid accesses will be handled transparently by the
        kernel but invalid accesses will generate this event.

    dsisr:
        This field gives information on the type of fault. It is a
        copy of the DSISR from the PSL hardware when the address
        fault occurred. The form of the DSISR is as defined in the
        CAIA.

    reserved fields:
        For future extensions

If the event type is CXL_EVENT_AFU_ERROR then the event structure
is defined as:

        struct cxl_event_afu_error &#123;
                __u16 flags;
                __u16 reserved1;
                __u32 reserved2;
                __u64 error;
        &#125;;

    flags:
        These flags indicate which optional fields are present in
        this struct. Currently all fields are Mandatory.

    error:
        Error status from the AFU. Defined by the AFU.

    reserved fields:
        For future extensions and padding
</code></pre>
<ol start="2">
<li><p>Card character device (powerVM guest only)</p>
<p> In a powerVM guest, an extra character device is created for the<br> card. The device is only used to write (flash) a new image on the<br> FPGA accelerator. Once the image is written and verified, the<br> device tree is updated and the card is reset to reload the updated<br> image.</p>
</li>
</ol>
<h2 id="open-1"><a href="#open-1" class="headerlink" title="open"></a>open</h2><pre><code>Opens the device and allocates a file descriptor to be used with
the rest of the API. The device can only be opened once.
</code></pre>
<h2 id="ioctl-1"><a href="#ioctl-1" class="headerlink" title="ioctl"></a>ioctl</h2><p>CXL_IOCTL_DOWNLOAD_IMAGE:<br>CXL_IOCTL_VALIDATE_IMAGE:<br>    Starts and controls flashing a new FPGA image. Partial<br>    reconfiguration is not supported (yet), so the image must contain<br>    a copy of the PSL and AFU(s). Since an image can be quite large,<br>    the caller may have to iterate, splitting the image in smaller<br>    chunks.</p>
<pre><code>Takes a pointer to a struct cxl_adapter_image:
    struct cxl_adapter_image &#123;
        __u64 flags;
        __u64 data;
        __u64 len_data;
        __u64 len_image;
        __u64 reserved1;
        __u64 reserved2;
        __u64 reserved3;
        __u64 reserved4;
    &#125;;

flags:
    These flags indicate which optional fields are present in
    this struct. Currently all fields are mandatory.

data:
    Pointer to a buffer with part of the image to write to the
    card.

len_data:
    Size of the buffer pointed to by data.

len_image:
    Full size of the image.
</code></pre>
<h1 id="Sysfs-Class"><a href="#Sysfs-Class" class="headerlink" title="Sysfs Class"></a>Sysfs Class</h1><pre><code>A cxl sysfs class is added under /sys/class/cxl to facilitate
enumeration and tuning of the accelerators. Its layout is
described in Documentation/ABI/testing/sysfs-class-cxl
</code></pre>
<h1 id="Udev-rules"><a href="#Udev-rules" class="headerlink" title="Udev rules"></a>Udev rules</h1><pre><code>The following udev rules could be used to create a symlink to the
most logical chardev to use in any programming mode (afuX.Yd for
dedicated, afuX.Ys for afu directed), since the API is virtually
identical for each:

SUBSYSTEM==&quot;cxl&quot;, ATTRS&#123;mode&#125;==&quot;dedicated_process&quot;, SYMLINK=&quot;cxl/%b&quot;
SUBSYSTEM==&quot;cxl&quot;, ATTRS&#123;mode&#125;==&quot;afu_directed&quot;, \
                  KERNEL==&quot;afu[0-9]*.[0-9]*s&quot;, SYMLINK=&quot;cxl/%b&quot;
</code></pre>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cxl/" title="Kernel-3.10.0-957.el7_cxl" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cxl/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_cxgb3i/" title="Kernel-3.10.0-957.el7_cxgb3i"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_da7219/" title="Kernel-3.10.0-957.el7_da7219"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>