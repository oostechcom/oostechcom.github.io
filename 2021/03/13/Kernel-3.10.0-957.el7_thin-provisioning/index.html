<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-3.10.0-957.el7_thin-provisioning | oosTech.com</title>
  <meta name="description" content="IntroductionThis document describes a collection of device-mapper targets thatbetween them implement thin-provisioning and snapshots. The main highlight of this implementation, compared to the previou">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-3.10.0-957.el7_thin-provisioning">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_thin-provisioning/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="IntroductionThis document describes a collection of device-mapper targets thatbetween them implement thin-provisioning and snapshots. The main highlight of this implementation, compared to the previou">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_thin-provisioning/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Status"><span class="toc-number">2.</span> <span class="toc-text">Status</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Cookbook"><span class="toc-number">3.</span> <span class="toc-text">Cookbook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pool-device"><span class="toc-number">3.1.</span> <span class="toc-text">Pool device</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Setting-up-a-fresh-pool-device"><span class="toc-number">3.2.</span> <span class="toc-text">Setting up a fresh pool device</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reloading-a-pool-table"><span class="toc-number">3.3.</span> <span class="toc-text">Reloading a pool table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-an-existing-pool-device"><span class="toc-number">3.4.</span> <span class="toc-text">Using an existing pool device</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Updating-on-disk-metadata"><span class="toc-number">3.5.</span> <span class="toc-text">Updating on-disk metadata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Thin-provisioning"><span class="toc-number">3.6.</span> <span class="toc-text">Thin provisioning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Internal-snapshots"><span class="toc-number">3.7.</span> <span class="toc-text">Internal snapshots</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#External-snapshots"><span class="toc-number">3.8.</span> <span class="toc-text">External snapshots</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deactivation"><span class="toc-number">3.9.</span> <span class="toc-text">Deactivation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%80%98thin-pool%E2%80%99-target"><span class="toc-number">4.1.</span> <span class="toc-text">‘thin-pool’ target</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%80%98thin%E2%80%99-target"><span class="toc-number">4.2.</span> <span class="toc-text">‘thin’ target</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-3.10.0-957.el7_thin-provisioning" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-3.10.0-957.el7_thin-provisioning
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_thin-provisioning/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_thin-provisioning/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-3.10.0-957.el7_thin-provisioning/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This document describes a collection of device-mapper targets that<br>between them implement thin-provisioning and snapshots.</p>
<p>The main highlight of this implementation, compared to the previous<br>implementation of snapshots, is that it allows many virtual devices to<br>be stored on the same data volume.  This simplifies administration and<br>allows the sharing of data between volumes, thus reducing disk usage.</p>
<p>Another significant feature is support for an arbitrary depth of<br>recursive snapshots (snapshots of snapshots of snapshots …).  The<br>previous implementation of snapshots did this by chaining together<br>lookup tables, and so performance was O(depth).  This new<br>implementation uses a single data structure to avoid this degradation<br>with depth.  Fragmentation may still be an issue, however, in some<br>scenarios.</p>
<p>Metadata is stored on a separate device from data, giving the<br>administrator some freedom, for example to:</p>
<ul>
<li><p>Improve metadata resilience by storing metadata on a mirrored volume<br>but data on a non-mirrored one.</p>
</li>
<li><p>Improve performance by storing the metadata on SSD.</p>
</li>
</ul>
<h1 id="Status"><a href="#Status" class="headerlink" title="Status"></a>Status</h1><p>These targets are very much still in the EXPERIMENTAL state.  Please<br>do not yet rely on them in production.  But do experiment and offer us<br>feedback.  Different use cases will have different performance<br>characteristics, for example due to fragmentation of the data volume.</p>
<p>If you find this software is not performing as expected please mail<br><a href="mailto:&#100;&#109;&#45;&#100;&#101;&#118;&#101;&#108;&#x40;&#114;&#101;&#100;&#x68;&#x61;&#116;&#46;&#x63;&#x6f;&#x6d;">&#100;&#109;&#45;&#100;&#101;&#118;&#101;&#108;&#x40;&#114;&#101;&#100;&#x68;&#x61;&#116;&#46;&#x63;&#x6f;&#x6d;</a> with details and we’ll try our best to improve<br>things for you.</p>
<p>Userspace tools for checking and repairing the metadata are under<br>development.</p>
<h1 id="Cookbook"><a href="#Cookbook" class="headerlink" title="Cookbook"></a>Cookbook</h1><p>This section describes some quick recipes for using thin provisioning.<br>They use the dmsetup program to control the device-mapper driver<br>directly.  End users will be advised to use a higher-level volume<br>manager such as LVM2 once support has been added.</p>
<h2 id="Pool-device"><a href="#Pool-device" class="headerlink" title="Pool device"></a>Pool device</h2><p>The pool device ties together the metadata volume and the data volume.<br>It maps I/O linearly to the data volume and updates the metadata via<br>two mechanisms:</p>
<ul>
<li><p>Function calls from the thin targets</p>
</li>
<li><p>Device-mapper ‘messages’ from userspace which control the creation of new<br>virtual devices amongst other things.</p>
</li>
</ul>
<h2 id="Setting-up-a-fresh-pool-device"><a href="#Setting-up-a-fresh-pool-device" class="headerlink" title="Setting up a fresh pool device"></a>Setting up a fresh pool device</h2><p>Setting up a pool device requires a valid metadata device, and a<br>data device.  If you do not have an existing metadata device you can<br>make one by zeroing the first 4k to indicate empty metadata.</p>
<pre><code>dd if=/dev/zero of=$metadata_dev bs=4096 count=1
</code></pre>
<p>The amount of metadata you need will vary according to how many blocks<br>are shared between thin devices (i.e. through snapshots).  If you have<br>less sharing than average you’ll need a larger-than-average metadata device.</p>
<p>As a guide, we suggest you calculate the number of bytes to use in the<br>metadata device as 48 * $data_dev_size / $data_block_size but round it up<br>to 2MB if the answer is smaller.  If you’re creating large numbers of<br>snapshots which are recording large amounts of change, you may find you<br>need to increase this.</p>
<p>The largest size supported is 16GB: If the device is larger,<br>a warning will be issued and the excess space will not be used.</p>
<h2 id="Reloading-a-pool-table"><a href="#Reloading-a-pool-table" class="headerlink" title="Reloading a pool table"></a>Reloading a pool table</h2><p>You may reload a pool’s table, indeed this is how the pool is resized<br>if it runs out of space.  (N.B. While specifying a different metadata<br>device when reloading is not forbidden at the moment, things will go<br>wrong if it does not route I/O to exactly the same on-disk location as<br>previously.)</p>
<h2 id="Using-an-existing-pool-device"><a href="#Using-an-existing-pool-device" class="headerlink" title="Using an existing pool device"></a>Using an existing pool device</h2><pre><code>dmsetup create pool \
--table &quot;0 20971520 thin-pool $metadata_dev $data_dev \
     $data_block_size $low_water_mark&quot;
</code></pre>
<p>$data_block_size gives the smallest unit of disk space that can be<br>allocated at a time expressed in units of 512-byte sectors.  People<br>primarily interested in thin provisioning may want to use a value such<br>as 1024 (512KB).  People doing lots of snapshotting may want a smaller value<br>such as 128 (64KB).  If you are not zeroing newly-allocated data,<br>a larger $data_block_size in the region of 256000 (128MB) is suggested.<br>$data_block_size must be the same for the lifetime of the<br>metadata device.</p>
<p>$low_water_mark is expressed in blocks of size $data_block_size.  If<br>free space on the data device drops below this level then a dm event<br>will be triggered which a userspace daemon should catch allowing it to<br>extend the pool device.  Only one such event will be sent.<br>Resuming a device with a new table itself triggers an event so the<br>userspace daemon can use this to detect a situation where a new table<br>already exceeds the threshold.</p>
<p>A low water mark for the metadata device is maintained in the kernel and<br>will trigger a dm event if free space on the metadata device drops below<br>it.</p>
<h2 id="Updating-on-disk-metadata"><a href="#Updating-on-disk-metadata" class="headerlink" title="Updating on-disk metadata"></a>Updating on-disk metadata</h2><p>On-disk metadata is committed every time a FLUSH or FUA bio is written.<br>If no such requests are made then commits will occur every second.  This<br>means the thin-provisioning target behaves like a physical disk that has<br>a volatile write cache.  If power is lost you may lose some recent<br>writes.  The metadata should always be consistent in spite of any crash.</p>
<p>If data space is exhausted the pool will either error or queue IO<br>according to the configuration (see: error_if_no_space).  If metadata<br>space is exhausted or a metadata operation fails: the pool will error IO<br>until the pool is taken offline and repair is performed to 1) fix any<br>potential inconsistencies and 2) clear the flag that imposes repair.<br>Once the pool’s metadata device is repaired it may be resized, which<br>will allow the pool to return to normal operation.  Note that if a pool<br>is flagged as needing repair, the pool’s data and metadata devices<br>cannot be resized until repair is performed.  It should also be noted<br>that when the pool’s metadata space is exhausted the current metadata<br>transaction is aborted.  Given that the pool will cache IO whose<br>completion may have already been acknowledged to upper IO layers<br>(e.g. filesystem) it is strongly suggested that consistency checks<br>(e.g. fsck) be performed on those layers when repair of the pool is<br>required.</p>
<h2 id="Thin-provisioning"><a href="#Thin-provisioning" class="headerlink" title="Thin provisioning"></a>Thin provisioning</h2><p>i) Creating a new thinly-provisioned volume.</p>
<p>  To create a new thinly- provisioned volume you must send a message to an<br>  active pool device, /dev/mapper/pool in this example.</p>
<pre><code>dmsetup message /dev/mapper/pool 0 &quot;create_thin 0&quot;
</code></pre>
<p>  Here ‘0’ is an identifier for the volume, a 24-bit number.  It’s up<br>  to the caller to allocate and manage these identifiers.  If the<br>  identifier is already in use, the message will fail with -EEXIST.</p>
<p>ii) Using a thinly-provisioned volume.</p>
<p>  Thinly-provisioned volumes are activated using the ‘thin’ target:</p>
<pre><code>dmsetup create thin --table &quot;0 2097152 thin /dev/mapper/pool 0&quot;
</code></pre>
<p>  The last parameter is the identifier for the thinp device.</p>
<h2 id="Internal-snapshots"><a href="#Internal-snapshots" class="headerlink" title="Internal snapshots"></a>Internal snapshots</h2><p>i) Creating an internal snapshot.</p>
<p>  Snapshots are created with another message to the pool.</p>
<p>  N.B.  If the origin device that you wish to snapshot is active, you<br>  must suspend it before creating the snapshot to avoid corruption.<br>  This is NOT enforced at the moment, so please be careful!</p>
<pre><code>dmsetup suspend /dev/mapper/thin
dmsetup message /dev/mapper/pool 0 &quot;create_snap 1 0&quot;
dmsetup resume /dev/mapper/thin
</code></pre>
<p>  Here ‘1’ is the identifier for the volume, a 24-bit number.  ‘0’ is the<br>  identifier for the origin device.</p>
<p>ii) Using an internal snapshot.</p>
<p>  Once created, the user doesn’t have to worry about any connection<br>  between the origin and the snapshot.  Indeed the snapshot is no<br>  different from any other thinly-provisioned device and can be<br>  snapshotted itself via the same method.  It’s perfectly legal to<br>  have only one of them active, and there’s no ordering requirement on<br>  activating or removing them both.  (This differs from conventional<br>  device-mapper snapshots.)</p>
<p>  Activate it exactly the same way as any other thinly-provisioned volume:</p>
<pre><code>dmsetup create snap --table &quot;0 2097152 thin /dev/mapper/pool 1&quot;
</code></pre>
<h2 id="External-snapshots"><a href="#External-snapshots" class="headerlink" title="External snapshots"></a>External snapshots</h2><p>You can use an external <em>read only</em> device as an origin for a<br>thinly-provisioned volume.  Any read to an unprovisioned area of the<br>thin device will be passed through to the origin.  Writes trigger<br>the allocation of new blocks as usual.</p>
<p>One use case for this is VM hosts that want to run guests on<br>thinly-provisioned volumes but have the base image on another device<br>(possibly shared between many VMs).</p>
<p>You must not write to the origin device if you use this technique!<br>Of course, you may write to the thin device and take internal snapshots<br>of the thin volume.</p>
<p>i) Creating a snapshot of an external device</p>
<p>  This is the same as creating a thin device.<br>  You don’t mention the origin at this stage.</p>
<pre><code>dmsetup message /dev/mapper/pool 0 &quot;create_thin 0&quot;
</code></pre>
<p>ii) Using a snapshot of an external device.</p>
<p>  Append an extra parameter to the thin target specifying the origin:</p>
<pre><code>dmsetup create snap --table &quot;0 2097152 thin /dev/mapper/pool 0 /dev/image&quot;
</code></pre>
<p>  N.B. All descendants (internal snapshots) of this snapshot require the<br>  same extra origin parameter.</p>
<h2 id="Deactivation"><a href="#Deactivation" class="headerlink" title="Deactivation"></a>Deactivation</h2><p>All devices using a pool must be deactivated before the pool itself<br>can be.</p>
<pre><code>dmsetup remove thin
dmsetup remove snap
dmsetup remove pool
</code></pre>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="‘thin-pool’-target"><a href="#‘thin-pool’-target" class="headerlink" title="‘thin-pool’ target"></a>‘thin-pool’ target</h2><p>i) Constructor</p>
<pre><code>thin-pool &lt;metadata dev&gt; &lt;data dev&gt; &lt;data block size (sectors)&gt; \
      &lt;low water mark (blocks)&gt; [&lt;number of feature args&gt; [&lt;arg&gt;]*]

Optional feature arguments:

  skip_block_zeroing: Skip the zeroing of newly-provisioned blocks.

  ignore_discard: Disable discard support.

  no_discard_passdown: Don&#39;t pass discards down to the underlying
           data device, but just remove the mapping.

  read_only: Don&#39;t allow any changes to be made to the pool
     metadata.  This mode is only available after the
     thin-pool has been created and first used in full
     read/write mode.  It cannot be specified on initial
     thin-pool creation.

  error_if_no_space: Error IOs, instead of queueing, if no space.

Data block size must be between 64KB (128 sectors) and 1GB
(2097152 sectors) inclusive.
</code></pre>
<p>ii) Status</p>
<pre><code>&lt;transaction id&gt; &lt;used metadata blocks&gt;/&lt;total metadata blocks&gt;
&lt;used data blocks&gt;/&lt;total data blocks&gt; &lt;held metadata root&gt;
[no_]discard_passdown ro|rw

transaction id:
A 64-bit number used by userspace to help synchronise with metadata
from volume managers.

used data blocks / total data blocks
If the number of free blocks drops below the pool&#39;s low water mark a
dm event will be sent to userspace.  This event is edge-triggered and
it will occur only once after each resume so volume manager writers
should register for the event and then check the target&#39;s status.

held metadata root:
The location, in blocks, of the metadata root that has been
&#39;held&#39; for userspace read access.  &#39;-&#39; indicates there is no
held root.

discard_passdown|no_discard_passdown
Whether or not discards are actually being passed down to the
underlying device.  When this is enabled when loading the table,
it can get disabled if the underlying device doesn&#39;t support it.

ro|rw|out_of_data_space
If the pool encounters certain types of device failures it will
drop into a read-only metadata mode in which no changes to
the pool metadata (like allocating new blocks) are permitted.

In serious cases where even a read-only mode is deemed unsafe
no further I/O will be permitted and the status will just
contain the string &#39;Fail&#39;.  The userspace recovery tools
should then be used.

error_if_no_space|queue_if_no_space
If the pool runs out of data or metadata space, the pool will
either queue or error the IO destined to the data device.  The
default is to queue the IO until more space is added or the
&#39;no_space_timeout&#39; expires.  The &#39;no_space_timeout&#39; dm-thin-pool
module parameter can be used to change this timeout -- it
defaults to 60 seconds but may be disabled using a value of 0.

needs_check
A metadata operation has failed, resulting in the needs_check
flag being set in the metadata&#39;s superblock.  The metadata
device must be deactivated and checked/repaired before the
thin-pool can be made fully operational again.  &#39;-&#39; indicates
needs_check is not set.
</code></pre>
<p>iii) Messages</p>
<pre><code>create_thin &lt;dev id&gt;

Create a new thinly-provisioned device.
&lt;dev id&gt; is an arbitrary unique 24-bit identifier chosen by
the caller.

create_snap &lt;dev id&gt; &lt;origin id&gt;

Create a new snapshot of another thinly-provisioned device.
&lt;dev id&gt; is an arbitrary unique 24-bit identifier chosen by
the caller.
&lt;origin id&gt; is the identifier of the thinly-provisioned device
of which the new device will be a snapshot.

delete &lt;dev id&gt;

Deletes a thin device.  Irreversible.

set_transaction_id &lt;current id&gt; &lt;new id&gt;

Userland volume managers, such as LVM, need a way to
synchronise their external metadata with the internal metadata of the
pool target.  The thin-pool target offers to store an
arbitrary 64-bit transaction id and return it on the target&#39;s
status line.  To avoid races you must provide what you think
the current transaction id is when you change it with this
compare-and-swap message.

reserve_metadata_snap

    Reserve a copy of the data mapping btree for use by userland.
    This allows userland to inspect the mappings as they were when
    this message was executed.  Use the pool&#39;s status command to
    get the root block associated with the metadata snapshot.

release_metadata_snap

    Release a previously reserved copy of the data mapping btree.
</code></pre>
<h2 id="‘thin’-target"><a href="#‘thin’-target" class="headerlink" title="‘thin’ target"></a>‘thin’ target</h2><p>i) Constructor</p>
<pre><code>thin &lt;pool dev&gt; &lt;dev id&gt; [&lt;external origin dev&gt;]

pool dev:
the thin-pool device, e.g. /dev/mapper/my_pool or 253:0

dev id:
the internal device identifier of the device to be
activated.

external origin dev:
an optional block device outside the pool to be treated as a
read-only snapshot origin: reads to unprovisioned areas of the
thin target will be mapped to this device.
</code></pre>
<p>The pool doesn’t store any size against the thin devices.  If you<br>load a thin target that is smaller than you’ve been using previously,<br>then you’ll have no access to blocks mapped beyond the end.  If you<br>load a target that is bigger than before, then extra blocks will be<br>provisioned as and when needed.</p>
<p>ii) Status</p>
<pre><code> &lt;nr mapped sectors&gt; &lt;highest mapped sector&gt;

If the pool has encountered device errors and failed, the status
will just contain the string &#39;Fail&#39;.  The userspace recovery
tools should then be used.
</code></pre>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_thin-provisioning/" title="Kernel-3.10.0-957.el7_thin-provisioning" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_thin-provisioning/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_tgafb/" title="Kernel-3.10.0-957.el7_tgafb"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_this_cpu_ops/" title="Kernel-3.10.0-957.el7_this_cpu_ops"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>