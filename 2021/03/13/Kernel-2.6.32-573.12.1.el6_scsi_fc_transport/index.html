<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-2.6.32-573.12.1.el6_scsi_fc_transport | oosTech.com</title>
  <meta name="description" content="SCSI FC Tansport              &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  Date:  11&#x2F;18&#x2F;2008Kernel Revisions for features:  rports : &lt;&gt;  vports : 2.6.22  bsg support :">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-2.6.32-573.12.1.el6_scsi_fc_transport">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_scsi_fc_transport/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="SCSI FC Tansport              &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  Date:  11&#x2F;18&#x2F;2008Kernel Revisions for features:  rports : &lt;&gt;  vports : 2.6.22  bsg support :">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_scsi_fc_transport/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FC-Remote-Ports-rports"><span class="toc-number">2.</span> <span class="toc-text">FC Remote Ports (rports)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FC-Virtual-Ports-vports"><span class="toc-number">3.</span> <span class="toc-text">FC Virtual Ports (vports)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">3.1.</span> <span class="toc-text">Overview:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Device-Trees-and-Vport-Objects"><span class="toc-number">3.2.</span> <span class="toc-text">Device Trees and Vport Objects:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vport-Attributes"><span class="toc-number">3.3.</span> <span class="toc-text">Vport Attributes:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vport-States"><span class="toc-number">3.4.</span> <span class="toc-text">Vport States:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transport-lt-gt-LLDD-Interfaces"><span class="toc-number">3.5.</span> <span class="toc-text">Transport &lt;-&gt; LLDD Interfaces :</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transport-supplied-functions"><span class="toc-number">3.6.</span> <span class="toc-text">Transport supplied functions</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FC-BSG-support-CT-amp-ELS-passthru-and-more"><span class="toc-number">4.</span> <span class="toc-text">FC BSG support (CT &amp; ELS passthru, and more)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Credits"><span class="toc-number">5.</span> <span class="toc-text">Credits</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-2.6.32-573.12.1.el6_scsi_fc_transport" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-2.6.32-573.12.1.el6_scsi_fc_transport
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_scsi_fc_transport/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_scsi_fc_transport/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_scsi_fc_transport/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <pre><code>                         SCSI FC Tansport
             =============================================
</code></pre>
<p>Date:  11/18/2008<br>Kernel Revisions for features:<br>  rports : &lt;<TBS>&gt;<br>  vports : 2.6.22<br>  bsg support : 2.6.30 (?TBD?)</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This file documents the features and components of the SCSI FC Transport.<br>It also provides documents the API between the transport and FC LLDDs.<br>The FC transport can be found at:<br>  drivers/scsi/scsi_transport_fc.c<br>  include/scsi/scsi_transport_fc.h<br>  include/scsi/scsi_netlink_fc.h<br>  include/scsi/scsi_bsg_fc.h</p>
<p>This file is found at Documentation/scsi/scsi_fc_transport.txt</p>
<h1 id="FC-Remote-Ports-rports"><a href="#FC-Remote-Ports-rports" class="headerlink" title="FC Remote Ports (rports)"></a>FC Remote Ports (rports)</h1><p>&lt;&lt; To Be Supplied &gt;&gt;</p>
<h1 id="FC-Virtual-Ports-vports"><a href="#FC-Virtual-Ports-vports" class="headerlink" title="FC Virtual Ports (vports)"></a>FC Virtual Ports (vports)</h1><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview:"></a>Overview:</h2><p>  New FC standards have defined mechanisms which allows for a single physical<br>  port to appear on as multiple communication ports. Using the N_Port Id<br>  Virtualization (NPIV) mechanism, a point-to-point connection to a Fabric<br>  can be assigned more than 1 N_Port_ID.  Each N_Port_ID appears as a<br>  separate port to other endpoints on the fabric, even though it shares one<br>  physical link to the switch for communication. Each N_Port_ID can have a<br>  unique view of the fabric based on fabric zoning and array lun-masking<br>  (just like a normal non-NPIV adapter).  Using the Virtual Fabric (VF)<br>  mechanism, adding a fabric header to each frame allows the port to<br>  interact with the Fabric Port to join multiple fabrics. The port will<br>  obtain an N_Port_ID on each fabric it joins. Each fabric will have its<br>  own unique view of endpoints and configuration parameters.  NPIV may be<br>  used together with VF so that the port can obtain multiple N_Port_IDs<br>  on each virtual fabric.</p>
<p>  The FC transport is now recognizing a new object - a vport.  A vport is<br>  an entity that has a world-wide unique World Wide Port Name (wwpn) and<br>  World Wide Node Name (wwnn). The transport also allows for the FC4’s to<br>  be specified for the vport, with FCP_Initiator being the primary role<br>  expected. Once instantiated by one of the above methods, it will have a<br>  distinct N_Port_ID and view of fabric endpoints and storage entities.<br>  The fc_host associated with the physical adapter will export the ability<br>  to create vports. The transport will create the vport object within the<br>  Linux device tree, and instruct the fc_host’s driver to instantiate the<br>  virtual port. Typically, the driver will create a new scsi_host instance<br>  on the vport, resulting in a unique &lt;H,C,T,L&gt; namespace for the vport.<br>  Thus, whether a FC port is based on a physical port or on a virtual port,<br>  each will appear as a unique scsi_host with its own target and lun space.</p>
<p>  Note: At this time, the transport is written to create only NPIV-based<br>    vports. However, consideration was given to VF-based vports and it<br>    should be a minor change to add support if needed.  The remaining<br>    discussion will concentrate on NPIV.</p>
<p>  Note: World Wide Name assignment (and uniqueness guarantees) are left<br>    up to an administrative entity controlling the vport. For example,<br>    if vports are to be associated with virtual machines, a XEN mgmt<br>    utility would be responsible for creating wwpn/wwnn’s for the vport,<br>    using it’s own naming authority and OUI. (Note: it already does this<br>    for virtual MAC addresses).</p>
<h2 id="Device-Trees-and-Vport-Objects"><a href="#Device-Trees-and-Vport-Objects" class="headerlink" title="Device Trees and Vport Objects:"></a>Device Trees and Vport Objects:</h2><p>  Today, the device tree typically contains the scsi_host object,<br>  with rports and scsi target objects underneath it. Currently the FC<br>  transport creates the vport object and places it under the scsi_host<br>  object corresponding to the physical adapter.  The LLDD will allocate<br>  a new scsi_host for the vport and link it’s object under the vport.<br>  The remainder of the tree under the vports scsi_host is the same<br>  as the non-NPIV case. The transport is written currently to easily<br>  allow the parent of the vport to be something other than the scsi_host.<br>  This could be used in the future to link the object onto a vm-specific<br>  device tree. If the vport’s parent is not the physical port’s scsi_host,<br>  a symbolic link to the vport object will be placed in the physical<br>  port’s scsi_host.</p>
<p>  Here’s what to expect in the device tree :<br>   The typical Physical Port’s Scsi_Host:<br>     /sys/devices/…/host17/<br>   and it has the typical descendant tree:<br>     /sys/devices/…/host17/rport-17:0-0/target17:0:0/17:0:0:0:<br>   and then the vport is created on the Physical Port:<br>     /sys/devices/…/host17/vport-17:0-0<br>   and the vport’s Scsi_Host is then created:<br>     /sys/devices/…/host17/vport-17:0-0/host18<br>   and then the rest of the tree progresses, such as:<br>     /sys/devices/…/host17/vport-17:0-0/host18/rport-18:0-0/target18:0:0/18:0:0:0:</p>
<p>  Here’s what to expect in the sysfs tree :<br>   scsi_hosts:<br>     /sys/class/scsi_host/host17                physical port’s scsi_host<br>     /sys/class/scsi_host/host18                vport’s scsi_host<br>   fc_hosts:<br>     /sys/class/fc_host/host17                  physical port’s fc_host<br>     /sys/class/fc_host/host18                  vport’s fc_host<br>   fc_vports:<br>     /sys/class/fc_vports/vport-17:0-0          the vport’s fc_vport<br>   fc_rports:<br>     /sys/class/fc_remote_ports/rport-17:0-0    rport on the physical port<br>     /sys/class/fc_remote_ports/rport-18:0-0    rport on the vport</p>
<h2 id="Vport-Attributes"><a href="#Vport-Attributes" class="headerlink" title="Vport Attributes:"></a>Vport Attributes:</h2><p>  The new fc_vport class object has the following attributes</p>
<pre><code> node_name:                                                 Read_Only
   The WWNN of the vport

 port_name:                                                 Read_Only
   The WWPN of the vport

 roles:                                                     Read_Only
   Indicates the FC4 roles enabled on the vport.

 symbolic_name:                                             Read_Write
   A string, appended to the driver&#39;s symbolic port name string, which
   is registered with the switch to identify the vport. For example,
   a hypervisor could set this string to &quot;Xen Domain 2 VM 5 Vport 2&quot;,
   and this set of identifiers can be seen on switch management screens
   to identify the port.

 vport_delete:                                              Write_Only
   When written with a &quot;1&quot;, will tear down the vport.

 vport_disable:                                             Write_Only
   When written with a &quot;1&quot;, will transition the vport to a disabled.
   state.  The vport will still be instantiated with the Linux kernel,
   but it will not be active on the FC link.
   When written with a &quot;0&quot;, will enable the vport.

 vport_last_state:                                          Read_Only
   Indicates the previous state of the vport.  See the section below on
   &quot;Vport States&quot;.

 vport_state:                                               Read_Only
   Indicates the state of the vport.  See the section below on
   &quot;Vport States&quot;.

 vport_type:                                                Read_Only
   Reflects the FC mechanism used to create the virtual port.
   Only NPIV is supported currently.
</code></pre>
<p>  For the fc_host class object, the following attributes are added for vports:</p>
<pre><code> max_npiv_vports:                                           Read_Only
   Indicates the maximum number of NPIV-based vports that the
   driver/adapter can support on the fc_host.

 npiv_vports_inuse:                                         Read_Only
   Indicates how many NPIV-based vports have been instantiated on the
   fc_host.

 vport_create:                                              Write_Only
   A &quot;simple&quot; create interface to instantiate a vport on an fc_host.
   A &quot;&lt;WWPN&gt;:&lt;WWNN&gt;&quot; string is written to the attribute. The transport
   then instantiates the vport object and calls the LLDD to create the
   vport with the role of FCP_Initiator.  Each WWN is specified as 16
   hex characters and may *not* contain any prefixes (e.g. 0x, x, etc).

 vport_delete:                                              Write_Only
    A &quot;simple&quot; delete interface to teardown a vport. A &quot;&lt;WWPN&gt;:&lt;WWNN&gt;&quot;
    string is written to the attribute. The transport will locate the
    vport on the fc_host with the same WWNs and tear it down.  Each WWN
    is specified as 16 hex characters and may *not* contain any prefixes
    (e.g. 0x, x, etc).
</code></pre>
<h2 id="Vport-States"><a href="#Vport-States" class="headerlink" title="Vport States:"></a>Vport States:</h2><p>  Vport instantiation consists of two parts:<br>    - Creation with the kernel and LLDD. This means all transport and<br>      driver data structures are built up, and device objects created.<br>      This is equivalent to a driver “attach” on an adapter, which is<br>      independent of the adapter’s link state.<br>    - Instantiation of the vport on the FC link via ELS traffic, etc.<br>      This is equivalent to a “link up” and successful link initialization.<br>  Further information can be found in the interfaces section below for<br>  Vport Creation.</p>
<p>  Once a vport has been instantiated with the kernel/LLDD, a vport state<br>  can be reported via the sysfs attribute. The following states exist:</p>
<pre><code>FC_VPORT_UNKNOWN            - Unknown
  An temporary state, typically set only while the vport is being
  instantiated with the kernel and LLDD.

FC_VPORT_ACTIVE             - Active
  The vport has been successfully been created on the FC link.
  It is fully functional.

FC_VPORT_DISABLED           - Disabled
  The vport instantiated, but &quot;disabled&quot;. The vport is not instantiated
  on the FC link. This is equivalent to a physical port with the
  link &quot;down&quot;.

FC_VPORT_LINKDOWN           - Linkdown
  The vport is not operational as the physical link is not operational.

FC_VPORT_INITIALIZING       - Initializing
  The vport is in the process of instantiating on the FC link.
  The LLDD will set this state just prior to starting the ELS traffic
  to create the vport. This state will persist until the vport is
  successfully created (state becomes FC_VPORT_ACTIVE) or it fails
  (state is one of the values below).  As this state is transitory,
  it will not be preserved in the &quot;vport_last_state&quot;.

FC_VPORT_NO_FABRIC_SUPP     - No Fabric Support
  The vport is not operational. One of the following conditions were
  encountered:
   - The FC topology is not Point-to-Point
   - The FC port is not connected to an F_Port
   - The F_Port has indicated that NPIV is not supported.

FC_VPORT_NO_FABRIC_RSCS     - No Fabric Resources
  The vport is not operational. The Fabric failed FDISC with a status
  indicating that it does not have sufficient resources to complete
  the operation.

FC_VPORT_FABRIC_LOGOUT      - Fabric Logout
  The vport is not operational. The Fabric has LOGO&#39;d the N_Port_ID
  associated with the vport.

FC_VPORT_FABRIC_REJ_WWN     - Fabric Rejected WWN
  The vport is not operational. The Fabric failed FDISC with a status
  indicating that the WWN&#39;s are not valid.

FC_VPORT_FAILED             - VPort Failed
  The vport is not operational. This is a catchall for all other
  error conditions.
</code></pre>
<p>  The following state table indicates the different state transitions:</p>
<pre><code>State              Event                            New State
--------------------------------------------------------------------
 n/a                Initialization                  Unknown
Unknown:            Link Down                       Linkdown
                    Link Up &amp; Loop                  No Fabric Support
                    Link Up &amp; no Fabric             No Fabric Support
                    Link Up &amp; FLOGI response        No Fabric Support
                      indicates no NPIV support
                    Link Up &amp; FDISC being sent      Initializing
                    Disable request                 Disable
Linkdown:           Link Up                         Unknown
Initializing:       FDISC ACC                       Active
                    FDISC LS_RJT w/ no resources    No Fabric Resources
                    FDISC LS_RJT w/ invalid         Fabric Rejected WWN
                      pname or invalid nport_id
                    FDISC LS_RJT failed for         Vport Failed
                      other reasons
                    Link Down                       Linkdown
                    Disable request                 Disable
Disable:            Enable request                  Unknown
Active:             LOGO received from fabric       Fabric Logout
                    Link Down                       Linkdown
                    Disable request                 Disable
Fabric Logout:      Link still up                   Unknown

     The following 4 error states all have the same transitions:
No Fabric Support:
No Fabric Resources:
Fabric Rejected WWN:
Vport Failed:
                    Disable request                 Disable
                    Link goes down                  Linkdown
</code></pre>
<h2 id="Transport-lt-gt-LLDD-Interfaces"><a href="#Transport-lt-gt-LLDD-Interfaces" class="headerlink" title="Transport &lt;-&gt; LLDD Interfaces :"></a>Transport &lt;-&gt; LLDD Interfaces :</h2><p>Vport support by LLDD:</p>
<p>  The LLDD indicates support for vports by supplying a vport_create()<br>  function in the transport template.  The presense of this function will<br>  cause the creation of the new attributes on the fc_host.  As part of<br>  the physical port completing its initialization relative to the<br>  transport, it should set the max_npiv_vports attribute to indicate the<br>  maximum number of vports the driver and/or adapter supports.</p>
<p>Vport Creation:</p>
<p>  The LLDD vport_create() syntax is:</p>
<pre><code>  int vport_create(struct fc_vport *vport, bool disable)

where:
  vport:    Is the newly allocated vport object
  disable:  If &quot;true&quot;, the vport is to be created in a disabled stated.
            If &quot;false&quot;, the vport is to be enabled upon creation.
</code></pre>
<p>  When a request is made to create a new vport (via sgio/netlink, or the<br>  vport_create fc_host attribute), the transport will validate that the LLDD<br>  can support another vport (e.g. max_npiv_vports &gt; npiv_vports_inuse).<br>  If not, the create request will be failed.  If space remains, the transport<br>  will increment the vport count, create the vport object, and then call the<br>  LLDD’s vport_create() function with the newly allocated vport object.</p>
<p>  As mentioned above, vport creation is divided into two parts:<br>    - Creation with the kernel and LLDD. This means all transport and<br>      driver data structures are built up, and device objects created.<br>      This is equivalent to a driver “attach” on an adapter, which is<br>      independent of the adapter’s link state.<br>    - Instantiation of the vport on the FC link via ELS traffic, etc.<br>      This is equivalent to a “link up” and successful link initialization.</p>
<p>  The LLDD’s vport_create() function will not synchronously wait for both<br>  parts to be fully completed before returning. It must validate that the<br>  infrastructure exists to support NPIV, and complete the first part of<br>  vport creation (data structure build up) before returning.  We do not<br>  hinge vport_create() on the link-side operation mainly because:<br>    - The link may be down. It is not a failure if it is. It simply<br>      means the vport is in an inoperable state until the link comes up.<br>      This is consistent with the link bouncing post vport creation.<br>    - The vport may be created in a disabled state.<br>    - This is consistent with a model where:  the vport equates to a<br>      FC adapter. The vport_create is synonymous with driver attachment<br>      to the adapter, which is independent of link state.</p>
<pre><code>Note: special error codes have been defined to delineate infrastructure
  failure cases for quicker resolution.
</code></pre>
<p>  The expected behavior for the LLDD’s vport_create() function is:<br>    - Validate Infrastructure:<br>        - If the driver or adapter cannot support another vport, whether<br>            due to improper firmware, (a lie about) max_npiv, or a lack of<br>            some other resource - return VPCERR_UNSUPPORTED.<br>        - If the driver validates the WWN’s against those already active on<br>            the adapter and detects an overlap - return VPCERR_BAD_WWN.<br>        - If the driver detects the topology is loop, non-fabric, or the<br>            FLOGI did not support NPIV - return VPCERR_NO_FABRIC_SUPP.<br>    - Allocate data structures. If errors are encountered, such as out<br>        of memory conditions, return the respective negative Exxx error code.<br>    - If the role is FCP Initiator, the LLDD is to :<br>        - Call scsi_host_alloc() to allocate a scsi_host for the vport.<br>        - Call scsi_add_host(new_shost, &amp;vport-&gt;dev) to start the scsi_host<br>          and bind it as a child of the vport device.<br>        - Initializes the fc_host attribute values.<br>    - Kick of further vport state transitions based on the disable flag and<br>        link state - and return success (zero).</p>
<p>  LLDD Implementers Notes:</p>
<ul>
<li>It is suggested that there be a different fc_function_templates for<br>the physical port and the virtual port.  The physical port’s template<br>would have the vport_create, vport_delete, and vport_disable functions,<br>while the vports would not.</li>
<li>It is suggested that there be different scsi_host_templates<br>for the physical port and virtual port. Likely, there are driver<br>attributes, embedded into the scsi_host_template, that are applicable<br>for the physical port only (link speed, topology setting, etc). This<br>ensures that the attributes are applicable to the respective scsi_host.</li>
</ul>
<p>Vport Disable/Enable:</p>
<p>  The LLDD vport_disable() syntax is:</p>
<pre><code>  int vport_disable(struct fc_vport *vport, bool disable)

where:
  vport:    Is vport to be enabled or disabled
  disable:  If &quot;true&quot;, the vport is to be disabled.
            If &quot;false&quot;, the vport is to be enabled.
</code></pre>
<p>  When a request is made to change the disabled state on a vport, the<br>  transport will validate the request against the existing vport state.<br>  If the request is to disable and the vport is already disabled, the<br>  request will fail. Similarly, if the request is to enable, and the<br>  vport is not in a disabled state, the request will fail.  If the request<br>  is valid for the vport state, the transport will call the LLDD to<br>  change the vport’s state.</p>
<p>  Within the LLDD, if a vport is disabled, it remains instantiated with<br>  the kernel and LLDD, but it is not active or visible on the FC link in<br>  any way. (see Vport Creation and the 2 part instantiation discussion).<br>  The vport will remain in this state until it is deleted or re-enabled.<br>  When enabling a vport, the LLDD reinstantiates the vport on the FC<br>  link - essentially restarting the LLDD statemachine (see Vport States<br>  above).</p>
<p>Vport Deletion:</p>
<p>  The LLDD vport_delete() syntax is:</p>
<pre><code>  int vport_delete(struct fc_vport *vport)

where:
  vport:    Is vport to delete
</code></pre>
<p>  When a request is made to delete a vport (via sgio/netlink, or via the<br>  fc_host or fc_vport vport_delete attributes), the transport will call<br>  the LLDD to terminate the vport on the FC link, and teardown all other<br>  datastructures and references.  If the LLDD completes successfully,<br>  the transport will teardown the vport objects and complete the vport<br>  removal.  If the LLDD delete request fails, the vport object will remain,<br>  but will be in an indeterminate state.</p>
<p>  Within the LLDD, the normal code paths for a scsi_host teardown should<br>  be followed. E.g. If the vport has a FCP Initiator role, the LLDD<br>  will call fc_remove_host() for the vports scsi_host, followed by<br>  scsi_remove_host() and scsi_host_put() for the vports scsi_host.</p>
<p>Other:<br>  fc_host port_type attribute:<br>    There is a new fc_host port_type value - FC_PORTTYPE_NPIV. This value<br>    must be set on all vport-based fc_hosts.  Normally, on a physical port,<br>    the port_type attribute would be set to NPORT, NLPORT, etc based on the<br>    topology type and existence of the fabric. As this is not applicable to<br>    a vport, it makes more sense to report the FC mechanism used to create<br>    the vport.</p>
<p>  Driver unload:<br>    FC drivers are required to call fc_remove_host() prior to calling<br>    scsi_remove_host().  This allows the fc_host to tear down all remote<br>    ports prior the scsi_host being torn down.  The fc_remove_host() call<br>    was updated to remove all vports for the fc_host as well.</p>
<h2 id="Transport-supplied-functions"><a href="#Transport-supplied-functions" class="headerlink" title="Transport supplied functions"></a>Transport supplied functions</h2><p>The following functions are supplied by the FC-transport for use by LLDs.</p>
<p>   fc_vport_create - create a vport<br>   fc_vport_terminate - detach and remove a vport</p>
<p>Details:</p>
<p>/**</p>
<ul>
<li>fc_vport_create - Admin App or LLDD requests creation of a vport</li>
<li>@shost:     scsi host the virtual port is connected to.</li>
<li>@ids:       The world wide names, FC4 port roles, etc for</li>
<li><pre><code>         the virtual port.
</code></pre>
</li>
<li></li>
<li>Notes:</li>
<li><pre><code>This routine assumes no locks are held on entry.
</code></pre>
</li>
<li>/<br>struct fc_vport *<br>fc_vport_create(struct Scsi_Host *shost, struct fc_vport_identifiers *ids)</li>
</ul>
<p>/**</p>
<ul>
<li>fc_vport_terminate - Admin App or LLDD requests termination of a vport</li>
<li>@vport:      fc_vport to be terminated</li>
<li></li>
<li>Calls the LLDD vport_delete() function, then deallocates and removes</li>
<li>the vport from the shost and object tree.</li>
<li></li>
<li>Notes:</li>
<li><pre><code> This routine assumes no locks are held on entry.
</code></pre>
</li>
<li>/<br>int<br>fc_vport_terminate(struct fc_vport *vport)</li>
</ul>
<h1 id="FC-BSG-support-CT-amp-ELS-passthru-and-more"><a href="#FC-BSG-support-CT-amp-ELS-passthru-and-more" class="headerlink" title="FC BSG support (CT &amp; ELS passthru, and more)"></a>FC BSG support (CT &amp; ELS passthru, and more)</h1><p>&lt;&lt; To Be Supplied &gt;&gt;</p>
<h1 id="Credits"><a href="#Credits" class="headerlink" title="Credits"></a>Credits</h1><p>The following people have contributed to this document:</p>
<p>James Smart<br><a href="mailto:&#x6a;&#97;&#109;&#101;&#x73;&#x2e;&#115;&#109;&#x61;&#114;&#x74;&#64;&#101;&#109;&#x75;&#x6c;&#x65;&#x78;&#46;&#x63;&#x6f;&#109;">&#x6a;&#97;&#109;&#101;&#x73;&#x2e;&#115;&#109;&#x61;&#114;&#x74;&#64;&#101;&#109;&#x75;&#x6c;&#x65;&#x78;&#46;&#x63;&#x6f;&#109;</a></p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_scsi_fc_transport/" title="Kernel-2.6.32-573.12.1.el6_scsi_fc_transport" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_scsi_fc_transport/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_sentelic/" title="Kernel-2.6.32-573.12.1.el6_sentelic"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_scsi_eh/" title="Kernel-2.6.32-573.12.1.el6_scsi_eh"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>