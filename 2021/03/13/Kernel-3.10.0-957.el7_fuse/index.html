<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-3.10.0-957.el7_fuse | oosTech.com</title>
  <meta name="description" content="Definitions  Userspace filesystem:    A filesystem in which data and metadata are provided by an ordinary   userspace process.  The filesystem can be accessed normally through   the kernel interface.">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-3.10.0-957.el7_fuse">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_fuse/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="Definitions  Userspace filesystem:    A filesystem in which data and metadata are provided by an ordinary   userspace process.  The filesystem can be accessed normally through   the kernel interface.">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_fuse/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Scenario-1-Simple-deadlock"><span class="toc-number">1.</span> <span class="toc-text">Scenario 1 -  Simple deadlock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scenario-2-Tricky-deadlock"><span class="toc-number">2.</span> <span class="toc-text">Scenario 2 - Tricky deadlock</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-3.10.0-957.el7_fuse" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-3.10.0-957.el7_fuse
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_fuse/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_fuse/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-3.10.0-957.el7_fuse/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>Definitions</p>
<pre><code>
Userspace filesystem:

  A filesystem in which data and metadata are provided by an ordinary
  userspace process.  The filesystem can be accessed normally through
  the kernel interface.

Filesystem daemon:

  The process(es) providing the data and metadata of the filesystem.

Non-privileged mount (or user mount):

  A userspace filesystem mounted by a non-privileged (non-root) user.
  The filesystem daemon is running with the privileges of the mounting
  user.  NOTE: this is not the same as mounts allowed with the &quot;user&quot;
  option in /etc/fstab, which is not discussed here.

Filesystem connection:

  A connection between the filesystem daemon and the kernel.  The
  connection exists until either the daemon dies, or the filesystem is
  umounted.  Note that detaching (or lazy umounting) the filesystem
  does _not_ break the connection, in this case it will exist until
  the last reference to the filesystem is released.

Mount owner:

  The user who does the mounting.

User:

  The user who is performing filesystem operations.

What is FUSE?
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">FUSE is a userspace filesystem framework.  It consists of a kernel</span><br><span class="line">module (fuse.ko), a userspace library (libfuse.*) and a mount utility</span><br><span class="line">(fusermount).</span><br><span class="line"></span><br><span class="line">One of the most important features of FUSE is allowing secure,</span><br><span class="line">non-privileged mounts.  This opens up new possibilities for the use of</span><br><span class="line">filesystems.  A good example is sshfs: a secure network filesystem</span><br><span class="line">using the sftp protocol.</span><br><span class="line"></span><br><span class="line">The userspace library and utilities are available from the FUSE</span><br><span class="line">homepage:</span><br><span class="line"></span><br><span class="line">  http:&#x2F;&#x2F;fuse.sourceforge.net&#x2F;</span><br><span class="line"></span><br><span class="line">Filesystem type</span><br><span class="line">~~~~~~~~~~~~~~~</span><br><span class="line"></span><br><span class="line">The filesystem type given to mount(2) can be one of the following:</span><br><span class="line"></span><br><span class="line">&#39;fuse&#39;</span><br><span class="line"></span><br><span class="line">  This is the usual way to mount a FUSE filesystem.  The first</span><br><span class="line">  argument of the mount system call may contain an arbitrary string,</span><br><span class="line">  which is not interpreted by the kernel.</span><br><span class="line"></span><br><span class="line">&#39;fuseblk&#39;</span><br><span class="line"></span><br><span class="line">  The filesystem is block device based.  The first argument of the</span><br><span class="line">  mount system call is interpreted as the name of the device.</span><br><span class="line"></span><br><span class="line">Mount options</span><br></pre></td></tr></table></figure>

&#39;fd=N&#39;

  The file descriptor to use for communication between the userspace
  filesystem and the kernel.  The file descriptor must have been
  obtained by opening the FUSE device (&#39;/dev/fuse&#39;).

&#39;rootmode=M&#39;

  The file mode of the filesystem&#39;s root in octal representation.

&#39;user_id=N&#39;

  The numeric user id of the mount owner.

&#39;group_id=N&#39;

  The numeric group id of the mount owner.

&#39;default_permissions&#39;

  By default FUSE doesn&#39;t check file access permissions, the
  filesystem is free to implement its access policy or leave it to
  the underlying file access mechanism (e.g. in case of network
  filesystems).  This option enables permission checking, restricting
  access based on file mode.  It is usually useful together with the
  &#39;allow_other&#39; mount option.

&#39;allow_other&#39;

  This option overrides the security measure restricting file access
  to the user mounting the filesystem.  This option is by default only
  allowed to root, but this restriction can be removed with a
  (userspace) configuration option.

&#39;max_read=N&#39;

  With this option the maximum size of read operations can be set.
  The default is infinite.  Note that the size of read requests is
  limited anyway to 32 pages (which is 128kbyte on i386).

&#39;blksize=N&#39;

  Set the block size for the filesystem.  The default is 512.  This
  option is only valid for &#39;fuseblk&#39; type mounts.

Control filesystem
</code></pre>
<p>There’s a control filesystem for FUSE, which can be mounted by:</p>
<p>  mount -t fusectl none /sys/fs/fuse/connections</p>
<p>Mounting it under the ‘/sys/fs/fuse/connections’ directory makes it<br>backwards compatible with earlier versions.</p>
<p>Under the fuse control filesystem each connection has a directory<br>named by a unique number.</p>
<p>For each connection the following files exist within this directory:</p>
<p> ‘waiting’</p>
<p>  The number of requests which are waiting to be transferred to<br>  userspace or being processed by the filesystem daemon.  If there is<br>  no filesystem activity and ‘waiting’ is non-zero, then the<br>  filesystem is hung or deadlocked.</p>
<p> ‘abort’</p>
<p>  Writing anything into this file will abort the filesystem<br>  connection.  This means that all waiting requests will be aborted an<br>  error returned for all aborted and new requests.</p>
<p>Only the owner of the mount may read or write these files.</p>
<p>Interrupting filesystem operations</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">If a process issuing a FUSE filesystem request is interrupted, the</span><br><span class="line">following will happen:</span><br><span class="line"></span><br><span class="line">  1) If the request is not yet sent to userspace AND the signal is</span><br><span class="line">     fatal (SIGKILL or unhandled fatal signal), then the request is</span><br><span class="line">     dequeued and returns immediately.</span><br><span class="line"></span><br><span class="line">  2) If the request is not yet sent to userspace AND the signal is not</span><br><span class="line">     fatal, then an &#39;interrupted&#39; flag is set for the request.  When</span><br><span class="line">     the request has been successfully transferred to userspace and</span><br><span class="line">     this flag is set, an INTERRUPT request is queued.</span><br><span class="line"></span><br><span class="line">  3) If the request is already sent to userspace, then an INTERRUPT</span><br><span class="line">     request is queued.</span><br><span class="line"></span><br><span class="line">INTERRUPT requests take precedence over other requests, so the</span><br><span class="line">userspace filesystem will receive queued INTERRUPTs before any others.</span><br><span class="line"></span><br><span class="line">The userspace filesystem may ignore the INTERRUPT requests entirely,</span><br><span class="line">or may honor them by sending a reply to the _original_ request, with</span><br><span class="line">the error set to EINTR.</span><br><span class="line"></span><br><span class="line">It is also possible that there&#39;s a race between processing the</span><br><span class="line">original request and its INTERRUPT request.  There are two possibilities:</span><br><span class="line"></span><br><span class="line">  1) The INTERRUPT request is processed before the original request is</span><br><span class="line">     processed</span><br><span class="line"></span><br><span class="line">  2) The INTERRUPT request is processed after the original request has</span><br><span class="line">     been answered</span><br><span class="line"></span><br><span class="line">If the filesystem cannot find the original request, it should wait for</span><br><span class="line">some timeout and&#x2F;or a number of new requests to arrive, after which it</span><br><span class="line">should reply to the INTERRUPT request with an EAGAIN error.  In case</span><br><span class="line">1) the INTERRUPT request will be requeued.  In case 2) the INTERRUPT</span><br><span class="line">reply will be ignored.</span><br><span class="line"></span><br><span class="line">Aborting a filesystem connection</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"></span><br><span class="line">It is possible to get into certain situations where the filesystem is</span><br><span class="line">not responding.  Reasons for this may be:</span><br><span class="line"></span><br><span class="line">  a) Broken userspace filesystem implementation</span><br><span class="line"></span><br><span class="line">  b) Network connection down</span><br><span class="line"></span><br><span class="line">  c) Accidental deadlock</span><br><span class="line"></span><br><span class="line">  d) Malicious deadlock</span><br><span class="line"></span><br><span class="line">(For more on c) and d) see later sections)</span><br><span class="line"></span><br><span class="line">In either of these cases it may be useful to abort the connection to</span><br><span class="line">the filesystem.  There are several ways to do this:</span><br><span class="line"></span><br><span class="line">  - Kill the filesystem daemon.  Works in case of a) and b)</span><br><span class="line"></span><br><span class="line">  - Kill the filesystem daemon and all users of the filesystem.  Works</span><br><span class="line">    in all cases except some malicious deadlocks</span><br><span class="line"></span><br><span class="line">  - Use forced umount (umount -f).  Works in all cases but only if</span><br><span class="line">    filesystem is still attached (it hasn&#39;t been lazy unmounted)</span><br><span class="line"></span><br><span class="line">  - Abort filesystem through the FUSE control filesystem.  Most</span><br><span class="line">    powerful method, always works.</span><br><span class="line"></span><br><span class="line">How do non-privileged mounts work?</span><br></pre></td></tr></table></figure>

<p>Since the mount() system call is a privileged operation, a helper<br>program (fusermount) is needed, which is installed setuid root.</p>
<p>The implication of providing non-privileged mounts is that the mount<br>owner must not be able to use this capability to compromise the<br>system.  Obvious requirements arising from this are:</p>
<p> A) mount owner should not be able to get elevated privileges with the<br>    help of the mounted filesystem</p>
<p> B) mount owner should not get illegitimate access to information from<br>    other users’ and the super user’s processes</p>
<p> C) mount owner should not be able to induce undesired behavior in<br>    other users’ or the super user’s processes</p>
<p>How are requirements fulfilled?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> A) The mount owner could gain elevated privileges by either:</span><br><span class="line"></span><br><span class="line">     1) creating a filesystem containing a device file, then opening</span><br><span class="line">	this device</span><br><span class="line"></span><br><span class="line">     2) creating a filesystem containing a suid or sgid application,</span><br><span class="line">	then executing this application</span><br><span class="line"></span><br><span class="line">    The solution is not to allow opening device files and ignore</span><br><span class="line">    setuid and setgid bits when executing programs.  To ensure this</span><br><span class="line">    fusermount always adds &quot;nosuid&quot; and &quot;nodev&quot; to the mount options</span><br><span class="line">    for non-privileged mounts.</span><br><span class="line"></span><br><span class="line"> B) If another user is accessing files or directories in the</span><br><span class="line">    filesystem, the filesystem daemon serving requests can record the</span><br><span class="line">    exact sequence and timing of operations performed.  This</span><br><span class="line">    information is otherwise inaccessible to the mount owner, so this</span><br><span class="line">    counts as an information leak.</span><br><span class="line"></span><br><span class="line">    The solution to this problem will be presented in point 2) of C).</span><br><span class="line"></span><br><span class="line"> C) There are several ways in which the mount owner can induce</span><br><span class="line">    undesired behavior in other users&#39; processes, such as:</span><br><span class="line"></span><br><span class="line">     1) mounting a filesystem over a file or directory which the mount</span><br><span class="line">        owner could otherwise not be able to modify (or could only</span><br><span class="line">        make limited modifications).</span><br><span class="line"></span><br><span class="line">        This is solved in fusermount, by checking the access</span><br><span class="line">        permissions on the mountpoint and only allowing the mount if</span><br><span class="line">        the mount owner can do unlimited modification (has write</span><br><span class="line">        access to the mountpoint, and mountpoint is not a &quot;sticky&quot;</span><br><span class="line">        directory)</span><br><span class="line"></span><br><span class="line">     2) Even if 1) is solved the mount owner can change the behavior</span><br><span class="line">        of other users&#39; processes.</span><br><span class="line"></span><br><span class="line">         i) It can slow down or indefinitely delay the execution of a</span><br><span class="line">           filesystem operation creating a DoS against the user or the</span><br><span class="line">           whole system.  For example a suid application locking a</span><br><span class="line">           system file, and then accessing a file on the mount owner&#39;s</span><br><span class="line">           filesystem could be stopped, and thus causing the system</span><br><span class="line">           file to be locked forever.</span><br><span class="line"></span><br><span class="line">         ii) It can present files or directories of unlimited length, or</span><br><span class="line">           directory structures of unlimited depth, possibly causing a</span><br><span class="line">           system process to eat up diskspace, memory or other</span><br><span class="line">           resources, again causing DoS.</span><br><span class="line"></span><br><span class="line">	The solution to this as well as B) is not to allow processes</span><br><span class="line">	to access the filesystem, which could otherwise not be</span><br><span class="line">	monitored or manipulated by the mount owner.  Since if the</span><br><span class="line">	mount owner can ptrace a process, it can do all of the above</span><br><span class="line">	without using a FUSE mount, the same criteria as used in</span><br><span class="line">	ptrace can be used to check if a process is allowed to access</span><br><span class="line">	the filesystem or not.</span><br><span class="line"></span><br><span class="line">	Note that the ptrace check is not strictly necessary to</span><br><span class="line">	prevent B&#x2F;2&#x2F;i, it is enough to check if mount owner has enough</span><br><span class="line">	privilege to send signal to the process accessing the</span><br><span class="line">	filesystem, since SIGSTOP can be used to get a similar effect.</span><br><span class="line"></span><br><span class="line">I think these limitations are unacceptable?</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"></span><br><span class="line">If a sysadmin trusts the users enough, or can ensure through other</span><br><span class="line">measures, that system processes will never enter non-privileged</span><br><span class="line">mounts, it can relax the last limitation with a &quot;user_allow_other&quot;</span><br><span class="line">config option.  If this config option is set, the mounting user can</span><br><span class="line">add the &quot;allow_other&quot; mount option which disables the check for other</span><br><span class="line">users&#39; processes.</span><br><span class="line"></span><br><span class="line">Kernel - userspace interface</span><br></pre></td></tr></table></figure>

<p>The following diagram shows how a filesystem operation (in this<br>example unlink) is performed in FUSE.</p>
<p>NOTE: everything in this description is greatly simplified</p>
<p> |  “rm /mnt/fuse/file”               |  FUSE filesystem daemon<br> |                                    |<br> |                                    |  &gt;sys_read()<br> |                                    |    &gt;fuse_dev_read()<br> |                                    |      &gt;request_wait()<br> |                                    |        [sleep on fc-&gt;waitq]<br> |                                    |<br> |  &gt;sys_unlink()                     |<br> |    &gt;fuse_unlink()                  |<br> |      [get request from             |<br> |       fc-&gt;unused_list]             |<br> |      &gt;request_send()               |<br> |        [queue req on fc-&gt;pending]  |<br> |        [wake up fc-&gt;waitq]         |        [woken up]<br> |        &gt;request_wait_answer()      |<br> |          [sleep on req-&gt;waitq]     |<br> |                                    |      &lt;request_wait()<br> |                                    |      [remove req from fc-&gt;pending]<br> |                                    |      [copy req to read buffer]<br> |                                    |      [add req to fc-&gt;processing]<br> |                                    |    &lt;fuse_dev_read()<br> |                                    |  &lt;sys_read()<br> |                                    |<br> |                                    |  [perform unlink]<br> |                                    |<br> |                                    |  &gt;sys_write()<br> |                                    |    &gt;fuse_dev_write()<br> |                                    |      [look up req in fc-&gt;processing]<br> |                                    |      [remove from fc-&gt;processing]<br> |                                    |      [copy write buffer to req]<br> |          [woken up]                |      [wake up req-&gt;waitq]<br> |                                    |    &lt;fuse_dev_write()<br> |                                    |  &lt;sys_write()<br> |        &lt;request_wait_answer()      |<br> |      &lt;request_send()               |<br> |      [add request to               |<br> |       fc-&gt;unused_list]             |<br> |    &lt;fuse_unlink()                  |<br> |  &lt;sys_unlink()                     |</p>
<p>There are a couple of ways in which to deadlock a FUSE filesystem.<br>Since we are talking about unprivileged userspace programs,<br>something must be done about these.</p>
<h2 id="Scenario-1-Simple-deadlock"><a href="#Scenario-1-Simple-deadlock" class="headerlink" title="Scenario 1 -  Simple deadlock"></a>Scenario 1 -  Simple deadlock</h2><p> |  “rm /mnt/fuse/file”               |  FUSE filesystem daemon<br> |                                    |<br> |  &gt;sys_unlink(“/mnt/fuse/file”)     |<br> |    [acquire inode semaphore        |<br> |     for “file”]                    |<br> |    &gt;fuse_unlink()                  |<br> |      [sleep on req-&gt;waitq]         |<br> |                                    |  &lt;sys_read()<br> |                                    |  &gt;sys_unlink(“/mnt/fuse/file”)<br> |                                    |    [acquire inode semaphore<br> |                                    |     for “file”]<br> |                                    |    <em>DEADLOCK</em></p>
<p>The solution for this is to allow the filesystem to be aborted.</p>
<h2 id="Scenario-2-Tricky-deadlock"><a href="#Scenario-2-Tricky-deadlock" class="headerlink" title="Scenario 2 - Tricky deadlock"></a>Scenario 2 - Tricky deadlock</h2><p>This one needs a carefully crafted filesystem.  It’s a variation on<br>the above, only the call back to the filesystem is not explicit,<br>but is caused by a pagefault.</p>
<p> |  Kamikaze filesystem thread 1      |  Kamikaze filesystem thread 2<br> |                                    |<br> |  [fd = open(“/mnt/fuse/file”)]     |  [request served normally]<br> |  [mmap fd to ‘addr’]               |<br> |  [close fd]                        |  [FLUSH triggers ‘magic’ flag]<br> |  [read a byte from addr]           |<br> |    &gt;do_page_fault()                |<br> |      [find or create page]         |<br> |      [lock page]                   |<br> |      &gt;fuse_readpage()              |<br> |         [queue READ request]       |<br> |         [sleep on req-&gt;waitq]      |<br> |                                    |  [read request to buffer]<br> |                                    |  [create reply header before addr]<br> |                                    |  &gt;sys_write(addr - headerlength)<br> |                                    |    &gt;fuse_dev_write()<br> |                                    |      [look up req in fc-&gt;processing]<br> |                                    |      [remove from fc-&gt;processing]<br> |                                    |      [copy write buffer to req]<br> |                                    |        &gt;do_page_fault()<br> |                                    |           [find or create page]<br> |                                    |           [lock page]<br> |                                    |           * DEADLOCK *</p>
<p>Solution is basically the same as above.</p>
<p>An additional problem is that while the write buffer is being copied<br>to the request, the request must not be interrupted/aborted.  This is<br>because the destination address of the copy may not be valid after the<br>request has returned.</p>
<p>This is solved with doing the copy atomically, and allowing abort<br>while the page(s) belonging to the write buffer are faulted with<br>get_user_pages().  The ‘req-&gt;locked’ flag indicates when the copy is<br>taking place, and abort is delayed until this flag is unset.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_fuse/" title="Kernel-3.10.0-957.el7_fuse" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_fuse/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_functionfs/" title="Kernel-3.10.0-957.el7_functionfs"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_futex-requeue-pi/" title="Kernel-3.10.0-957.el7_futex-requeue-pi"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>