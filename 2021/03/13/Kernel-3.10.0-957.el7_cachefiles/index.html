<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-3.10.0-957.el7_cachefiles | oosTech.com</title>
  <meta name="description" content="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;        CacheFiles: CACHE ON ALREADY MOUNTED FILESYSTEM        &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  Contents:  (*) Overview.  (*) Requ">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-3.10.0-957.el7_cachefiles">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cachefiles/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;        CacheFiles: CACHE ON ALREADY MOUNTED FILESYSTEM        &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  Contents:  (*) Overview.  (*) Requ">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cachefiles/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-3.10.0-957.el7_cachefiles" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-3.10.0-957.el7_cachefiles
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_cachefiles/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_cachefiles/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-3.10.0-957.el7_cachefiles/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <pre><code>       ===============================================
       CacheFiles: CACHE ON ALREADY MOUNTED FILESYSTEM
       ===============================================
</code></pre>
<p>Contents:</p>
<p> (*) Overview.</p>
<p> (*) Requirements.</p>
<p> (*) Configuration.</p>
<p> (*) Starting the cache.</p>
<p> (*) Things to avoid.</p>
<p> (*) Cache culling.</p>
<p> (*) Cache structure.</p>
<p> (*) Security model and SELinux.</p>
<p> (*) A note on security.</p>
<p> (*) Statistical information.</p>
<p> (*) Debugging.</p>
<p>========<br>OVERVIEW<br>========</p>
<p>CacheFiles is a caching backend that’s meant to use as a cache a directory on<br>an already mounted filesystem of a local type (such as Ext3).</p>
<p>CacheFiles uses a userspace daemon to do some of the cache management - such as<br>reaping stale nodes and culling.  This is called cachefilesd and lives in<br>/sbin.</p>
<p>The filesystem and data integrity of the cache are only as good as those of the<br>filesystem providing the backing services.  Note that CacheFiles does not<br>attempt to journal anything since the journalling interfaces of the various<br>filesystems are very specific in nature.</p>
<p>CacheFiles creates a misc character device - “/dev/cachefiles” - that is used<br>to communication with the daemon.  Only one thing may have this open at once,<br>and whilst it is open, a cache is at least partially in existence.  The daemon<br>opens this and sends commands down it to control the cache.</p>
<p>CacheFiles is currently limited to a single cache.</p>
<p>CacheFiles attempts to maintain at least a certain percentage of free space on<br>the filesystem, shrinking the cache by culling the objects it contains to make<br>space if necessary - see the “Cache Culling” section.  This means it can be<br>placed on the same medium as a live set of data, and will expand to make use of<br>spare space and automatically contract when the set of data requires more<br>space.</p>
<p>============<br>REQUIREMENTS<br>============</p>
<p>The use of CacheFiles and its daemon requires the following features to be<br>available in the system and in the cache filesystem:</p>
<pre><code>- dnotify.

- extended attributes (xattrs).

- openat() and friends.

- bmap() support on files in the filesystem (FIBMAP ioctl).

- The use of bmap() to detect a partial page at the end of the file.
</code></pre>
<p>It is strongly recommended that the “dir_index” option is enabled on Ext3<br>filesystems being used as a cache.</p>
<p>=============<br>CONFIGURATION<br>=============</p>
<p>The cache is configured by a script in /etc/cachefilesd.conf.  These commands<br>set up cache ready for use.  The following script commands are available:</p>
<p> (<em>) brun <N>%<br> (</em>) bcull <N>%<br> (<em>) bstop <N>%<br> (</em>) frun <N>%<br> (<em>) fcull <N>%<br> (</em>) fstop <N>%</p>
<pre><code>Configure the culling limits.  Optional.  See the section on culling
The defaults are 7% (run), 5% (cull) and 1% (stop) respectively.

The commands beginning with a &#39;b&#39; are file space (block) limits, those
beginning with an &#39;f&#39; are file count limits.
</code></pre>
<p> (*) dir <path></p>
<pre><code>Specify the directory containing the root of the cache.  Mandatory.
</code></pre>
<p> (*) tag <name></p>
<pre><code>Specify a tag to FS-Cache to use in distinguishing multiple caches.
Optional.  The default is &quot;CacheFiles&quot;.
</code></pre>
<p> (*) debug <mask></p>
<pre><code>Specify a numeric bitmask to control debugging in the kernel module.
Optional.  The default is zero (all off).  The following values can be
OR&#39;d into the mask to collect various information:

    1    Turn on trace of function entry (_enter() macros)
    2    Turn on trace of function exit (_leave() macros)
    4    Turn on trace of internal debug points (_debug())

This mask can also be set through sysfs, eg:

    echo 5 &gt;/sys/modules/cachefiles/parameters/debug
</code></pre>
<p>==================<br>STARTING THE CACHE<br>==================</p>
<p>The cache is started by running the daemon.  The daemon opens the cache device,<br>configures the cache and tells it to begin caching.  At that point the cache<br>binds to fscache and the cache becomes live.</p>
<p>The daemon is run as follows:</p>
<pre><code>/sbin/cachefilesd [-d]* [-s] [-n] [-f &lt;configfile&gt;]
</code></pre>
<p>The flags are:</p>
<p> (*) -d</p>
<pre><code>Increase the debugging level.  This can be specified multiple times and
is cumulative with itself.
</code></pre>
<p> (*) -s</p>
<pre><code>Send messages to stderr instead of syslog.
</code></pre>
<p> (*) -n</p>
<pre><code>Don&#39;t daemonise and go into background.
</code></pre>
<p> (*) -f <configfile></p>
<pre><code>Use an alternative configuration file rather than the default one.
</code></pre>
<p>===============<br>THINGS TO AVOID<br>===============</p>
<p>Do not mount other things within the cache as this will cause problems.  The<br>kernel module contains its own very cut-down path walking facility that ignores<br>mountpoints, but the daemon can’t avoid them.</p>
<p>Do not create, rename or unlink files and directories in the cache whilst the<br>cache is active, as this may cause the state to become uncertain.</p>
<p>Renaming files in the cache might make objects appear to be other objects (the<br>filename is part of the lookup key).</p>
<p>Do not change or remove the extended attributes attached to cache files by the<br>cache as this will cause the cache state management to get confused.</p>
<p>Do not create files or directories in the cache, lest the cache get confused or<br>serve incorrect data.</p>
<p>Do not chmod files in the cache.  The module creates things with minimal<br>permissions to prevent random users being able to access them directly.</p>
<p>=============<br>CACHE CULLING<br>=============</p>
<p>The cache may need culling occasionally to make space.  This involves<br>discarding objects from the cache that have been used less recently than<br>anything else.  Culling is based on the access time of data objects.  Empty<br>directories are culled if not in use.</p>
<p>Cache culling is done on the basis of the percentage of blocks and the<br>percentage of files available in the underlying filesystem.  There are six<br>“limits”:</p>
<p> (<em>) brun<br> (</em>) frun</p>
<pre><code> If the amount of free space and the number of available files in the cache
 rises above both these limits, then culling is turned off.
</code></pre>
<p> (<em>) bcull<br> (</em>) fcull</p>
<pre><code> If the amount of available space or the number of available files in the
 cache falls below either of these limits, then culling is started.
</code></pre>
<p> (<em>) bstop<br> (</em>) fstop</p>
<pre><code> If the amount of available space or the number of available files in the
 cache falls below either of these limits, then no further allocation of
 disk space or files is permitted until culling has raised things above
 these limits again.
</code></pre>
<p>These must be configured thusly:</p>
<pre><code>0 &lt;= bstop &lt; bcull &lt; brun &lt; 100
0 &lt;= fstop &lt; fcull &lt; frun &lt; 100
</code></pre>
<p>Note that these are percentages of available space and available files, and do<br><em>not</em> appear as 100 minus the percentage displayed by the “df” program.</p>
<p>The userspace daemon scans the cache to build up a table of cullable objects.<br>These are then culled in least recently used order.  A new scan of the cache is<br>started as soon as space is made in the table.  Objects will be skipped if<br>their atimes have changed or if the kernel module says it is still using them.</p>
<p>===============<br>CACHE STRUCTURE<br>===============</p>
<p>The CacheFiles module will create two directories in the directory it was<br>given:</p>
<p> (*) cache/</p>
<p> (*) graveyard/</p>
<p>The active cache objects all reside in the first directory.  The CacheFiles<br>kernel module moves any retired or culled objects that it can’t simply unlink<br>to the graveyard from which the daemon will actually delete them.</p>
<p>The daemon uses dnotify to monitor the graveyard directory, and will delete<br>anything that appears therein.</p>
<p>The module represents index objects as directories with the filename “I…” or<br>“J…”.  Note that the “cache/“ directory is itself a special index.</p>
<p>Data objects are represented as files if they have no children, or directories<br>if they do.  Their filenames all begin “D…” or “E…”.  If represented as a<br>directory, data objects will have a file in the directory called “data” that<br>actually holds the data.</p>
<p>Special objects are similar to data objects, except their filenames begin<br>“S…” or “T…”.</p>
<p>If an object has children, then it will be represented as a directory.<br>Immediately in the representative directory are a collection of directories<br>named for hash values of the child object keys with an ‘@’ prepended.  Into<br>this directory, if possible, will be placed the representations of the child<br>objects:</p>
<pre><code>INDEX     INDEX      INDEX                             DATA FILES
========= ========== ================================= ================
cache/@4a/I03nfs/@30/Ji000000000000000--fHg8hi8400
cache/@4a/I03nfs/@30/Ji000000000000000--fHg8hi8400/@75/Es0g000w...DB1ry
cache/@4a/I03nfs/@30/Ji000000000000000--fHg8hi8400/@75/Es0g000w...N22ry
cache/@4a/I03nfs/@30/Ji000000000000000--fHg8hi8400/@75/Es0g000w...FP1ry
</code></pre>
<p>If the key is so long that it exceeds NAME_MAX with the decorations added on to<br>it, then it will be cut into pieces, the first few of which will be used to<br>make a nest of directories, and the last one of which will be the objects<br>inside the last directory.  The names of the intermediate directories will have<br>‘+’ prepended:</p>
<pre><code>J1223/@23/+xy...z/+kl...m/Epqr
</code></pre>
<p>Note that keys are raw data, and not only may they exceed NAME_MAX in size,<br>they may also contain things like ‘/‘ and NUL characters, and so they may not<br>be suitable for turning directly into a filename.</p>
<p>To handle this, CacheFiles will use a suitably printable filename directly and<br>“base-64” encode ones that aren’t directly suitable.  The two versions of<br>object filenames indicate the encoding:</p>
<pre><code>OBJECT TYPE    PRINTABLE    ENCODED
===============    ===============    ===============
Index        &quot;I...&quot;        &quot;J...&quot;
Data        &quot;D...&quot;        &quot;E...&quot;
Special        &quot;S...&quot;        &quot;T...&quot;
</code></pre>
<p>Intermediate directories are always “@” or “+” as appropriate.</p>
<p>Each object in the cache has an extended attribute label that holds the object<br>type ID (required to distinguish special objects) and the auxiliary data from<br>the netfs.  The latter is used to detect stale objects in the cache and update<br>or retire them.</p>
<p>Note that CacheFiles will erase from the cache any file it doesn’t recognise or<br>any file of an incorrect type (such as a FIFO file or a device file).</p>
<p>==========================<br>SECURITY MODEL AND SELINUX<br>==========================</p>
<p>CacheFiles is implemented to deal properly with the LSM security features of<br>the Linux kernel and the SELinux facility.</p>
<p>One of the problems that CacheFiles faces is that it is generally acting on<br>behalf of a process, and running in that process’s context, and that includes a<br>security context that is not appropriate for accessing the cache - either<br>because the files in the cache are inaccessible to that process, or because if<br>the process creates a file in the cache, that file may be inaccessible to other<br>processes.</p>
<p>The way CacheFiles works is to temporarily change the security context (fsuid,<br>fsgid and actor security label) that the process acts as - without changing the<br>security context of the process when it the target of an operation performed by<br>some other process (so signalling and suchlike still work correctly).</p>
<p>When the CacheFiles module is asked to bind to its cache, it:</p>
<p> (1) Finds the security label attached to the root cache directory and uses<br>     that as the security label with which it will create files.  By default,<br>     this is:</p>
<pre><code>cachefiles_var_t
</code></pre>
<p> (2) Finds the security label of the process which issued the bind request<br>     (presumed to be the cachefilesd daemon), which by default will be:</p>
<pre><code>cachefilesd_t

 and asks LSM to supply a security ID as which it should act given the
 daemon&#39;s label.  By default, this will be:

cachefiles_kernel_t

 SELinux transitions the daemon&#39;s security ID to the module&#39;s security ID
 based on a rule of this form in the policy.

type_transition &lt;daemon&#39;s-ID&gt; kernel_t : process &lt;module&#39;s-ID&gt;;

 For instance:

type_transition cachefilesd_t kernel_t : process cachefiles_kernel_t;
</code></pre>
<p>The module’s security ID gives it permission to create, move and remove files<br>and directories in the cache, to find and access directories and files in the<br>cache, to set and access extended attributes on cache objects, and to read and<br>write files in the cache.</p>
<p>The daemon’s security ID gives it only a very restricted set of permissions: it<br>may scan directories, stat files and erase files and directories.  It may<br>not read or write files in the cache, and so it is precluded from accessing the<br>data cached therein; nor is it permitted to create new files in the cache.</p>
<p>There are policy source files available in:</p>
<pre><code>http://people.redhat.com/~dhowells/fscache/cachefilesd-0.8.tar.bz2
</code></pre>
<p>and later versions.  In that tarball, see the files:</p>
<pre><code>cachefilesd.te
cachefilesd.fc
cachefilesd.if
</code></pre>
<p>They are built and installed directly by the RPM.</p>
<p>If a non-RPM based system is being used, then copy the above files to their own<br>directory and run:</p>
<pre><code>make -f /usr/share/selinux/devel/Makefile
semodule -i cachefilesd.pp
</code></pre>
<p>You will need checkpolicy and selinux-policy-devel installed prior to the<br>build.</p>
<p>By default, the cache is located in /var/fscache, but if it is desirable that<br>it should be elsewhere, than either the above policy files must be altered, or<br>an auxiliary policy must be installed to label the alternate location of the<br>cache.</p>
<p>For instructions on how to add an auxiliary policy to enable the cache to be<br>located elsewhere when SELinux is in enforcing mode, please see:</p>
<pre><code>/usr/share/doc/cachefilesd-*/move-cache.txt
</code></pre>
<p>When the cachefilesd rpm is installed; alternatively, the document can be found<br>in the sources.</p>
<p>==================<br>A NOTE ON SECURITY<br>==================</p>
<p>CacheFiles makes use of the split security in the task_struct.  It allocates<br>its own task_security structure, and redirects current-&gt;cred to point to it<br>when it acts on behalf of another process, in that process’s context.</p>
<p>The reason it does this is that it calls vfs_mkdir() and suchlike rather than<br>bypassing security and calling inode ops directly.  Therefore the VFS and LSM<br>may deny the CacheFiles access to the cache data because under some<br>circumstances the caching code is running in the security context of whatever<br>process issued the original syscall on the netfs.</p>
<p>Furthermore, should CacheFiles create a file or directory, the security<br>parameters with that object is created (UID, GID, security label) would be<br>derived from that process that issued the system call, thus potentially<br>preventing other processes from accessing the cache - including CacheFiles’s<br>cache management daemon (cachefilesd).</p>
<p>What is required is to temporarily override the security of the process that<br>issued the system call.  We can’t, however, just do an in-place change of the<br>security data as that affects the process as an object, not just as a subject.<br>This means it may lose signals or ptrace events for example, and affects what<br>the process looks like in /proc.</p>
<p>So CacheFiles makes use of a logical split in the security between the<br>objective security (task-&gt;real_cred) and the subjective security (task-&gt;cred).<br>The objective security holds the intrinsic security properties of a process and<br>is never overridden.  This is what appears in /proc, and is what is used when a<br>process is the target of an operation by some other process (SIGKILL for<br>example).</p>
<p>The subjective security holds the active security properties of a process, and<br>may be overridden.  This is not seen externally, and is used whan a process<br>acts upon another object, for example SIGKILLing another process or opening a<br>file.</p>
<p>LSM hooks exist that allow SELinux (or Smack or whatever) to reject a request<br>for CacheFiles to run in a context of a specific security label, or to create<br>files and directories with another security label.</p>
<p>=======================<br>STATISTICAL INFORMATION<br>=======================</p>
<p>If FS-Cache is compiled with the following option enabled:</p>
<pre><code>CONFIG_CACHEFILES_HISTOGRAM=y
</code></pre>
<p>then it will gather certain statistics and display them through a proc file.</p>
<p> (*) /proc/fs/cachefiles/histogram</p>
<pre><code>cat /proc/fs/cachefiles/histogram
JIFS  SECS  LOOKUPS   MKDIRS    CREATES
===== ===== ========= ========= =========

 This shows the breakdown of the number of times each amount of time
 between 0 jiffies and HZ-1 jiffies a variety of tasks took to run.  The
 columns are as follows:

COLUMN        TIME MEASUREMENT
=======        =======================================================
LOOKUPS        Length of time to perform a lookup on the backing fs
MKDIRS        Length of time to perform a mkdir on the backing fs
CREATES        Length of time to perform a create on the backing fs

 Each row shows the number of events that took a particular range of times.
 Each step is 1 jiffy in size.  The JIFS column indicates the particular
 jiffy range covered, and the SECS field the equivalent number of seconds.
</code></pre>
<p>=========<br>DEBUGGING<br>=========</p>
<p>If CONFIG_CACHEFILES_DEBUG is enabled, the CacheFiles facility can have runtime<br>debugging enabled by adjusting the value in:</p>
<pre><code>/sys/module/cachefiles/parameters/debug
</code></pre>
<p>This is a bitmask of debugging streams to enable:</p>
<pre><code>BIT    VALUE    STREAM                POINT
=======    =======    ===============================    =======================
0    1    General                Function entry trace
1    2                    Function exit trace
2    4                    General
</code></pre>
<p>The appropriate set of values should be OR’d together and the result written to<br>the control file.  For example:</p>
<pre><code>echo $((1|4|8)) &gt;/sys/module/cachefiles/parameters/debug
</code></pre>
<p>will turn on all function entry debugging.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cachefiles/" title="Kernel-3.10.0-957.el7_cachefiles" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_cachefiles/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_cachetlb/" title="Kernel-3.10.0-957.el7_cachetlb"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_blkio-controller/" title="Kernel-3.10.0-957.el7_blkio-controller"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>