<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-3.10.0-957.el7_configfs | oosTech.com</title>
  <meta name="description" content="configfs - Userspace-driven kernel object configuration. Joel Becker &amp;#x6a;&amp;#111;&amp;#101;&amp;#x6c;&amp;#46;&amp;#x62;&amp;#101;&amp;#x63;&amp;#x6b;&amp;#x65;&amp;#x72;&amp;#x40;&amp;#x6f;&amp;#114;&amp;#x61;&amp;#x63;&amp;#x6c;&amp;#x65;&amp;#46;&amp;#x63;&amp;#x6f;&amp;#x6d;">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-3.10.0-957.el7_configfs">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_configfs/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="configfs - Userspace-driven kernel object configuration. Joel Becker &amp;#x6a;&amp;#111;&amp;#101;&amp;#x6c;&amp;#46;&amp;#x62;&amp;#101;&amp;#x63;&amp;#x6b;&amp;#x65;&amp;#x72;&amp;#x40;&amp;#x6f;&amp;#114;&amp;#x61;&amp;#x63;&amp;#x6c;&amp;#x65;&amp;#46;&amp;#x63;&amp;#x6f;&amp;#x6d;">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_configfs/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-3.10.0-957.el7_configfs" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-3.10.0-957.el7_configfs
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_configfs/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_configfs/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-3.10.0-957.el7_configfs/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>configfs - Userspace-driven kernel object configuration.</p>
<p>Joel Becker <a href="mailto:&#x6a;&#111;&#101;&#x6c;&#46;&#x62;&#101;&#x63;&#x6b;&#x65;&#x72;&#x40;&#x6f;&#114;&#x61;&#x63;&#x6c;&#x65;&#46;&#x63;&#x6f;&#x6d;">&#x6a;&#111;&#101;&#x6c;&#46;&#x62;&#101;&#x63;&#x6b;&#x65;&#x72;&#x40;&#x6f;&#114;&#x61;&#x63;&#x6c;&#x65;&#46;&#x63;&#x6f;&#x6d;</a></p>
<p>Updated: 31 March 2005</p>
<p>Copyright (c) 2005 Oracle Corporation,<br>    Joel Becker <a href="mailto:&#106;&#x6f;&#x65;&#x6c;&#46;&#x62;&#101;&#x63;&#x6b;&#101;&#114;&#64;&#x6f;&#114;&#x61;&#99;&#x6c;&#x65;&#46;&#x63;&#x6f;&#x6d;">&#106;&#x6f;&#x65;&#x6c;&#46;&#x62;&#101;&#x63;&#x6b;&#101;&#114;&#64;&#x6f;&#114;&#x61;&#99;&#x6c;&#x65;&#46;&#x63;&#x6f;&#x6d;</a></p>
<p>[What is configfs?]</p>
<p>configfs is a ram-based filesystem that provides the converse of<br>sysfs’s functionality.  Where sysfs is a filesystem-based view of<br>kernel objects, configfs is a filesystem-based manager of kernel<br>objects, or config_items.</p>
<p>With sysfs, an object is created in kernel (for example, when a device<br>is discovered) and it is registered with sysfs.  Its attributes then<br>appear in sysfs, allowing userspace to read the attributes via<br>readdir(3)/read(2).  It may allow some attributes to be modified via<br>write(2).  The important point is that the object is created and<br>destroyed in kernel, the kernel controls the lifecycle of the sysfs<br>representation, and sysfs is merely a window on all this.</p>
<p>A configfs config_item is created via an explicit userspace operation:<br>mkdir(2).  It is destroyed via rmdir(2).  The attributes appear at<br>mkdir(2) time, and can be read or modified via read(2) and write(2).<br>As with sysfs, readdir(3) queries the list of items and/or attributes.<br>symlink(2) can be used to group items together.  Unlike sysfs, the<br>lifetime of the representation is completely driven by userspace.  The<br>kernel modules backing the items must respond to this.</p>
<p>Both sysfs and configfs can and should exist together on the same<br>system.  One is not a replacement for the other.</p>
<p>[Using configfs]</p>
<p>configfs can be compiled as a module or into the kernel.  You can access<br>it by doing</p>
<pre><code>mount -t configfs none /config
</code></pre>
<p>The configfs tree will be empty unless client modules are also loaded.<br>These are modules that register their item types with configfs as<br>subsystems.  Once a client subsystem is loaded, it will appear as a<br>subdirectory (or more than one) under /config.  Like sysfs, the<br>configfs tree is always there, whether mounted on /config or not.</p>
<p>An item is created via mkdir(2).  The item’s attributes will also<br>appear at this time.  readdir(3) can determine what the attributes are,<br>read(2) can query their default values, and write(2) can store new<br>values.  Like sysfs, attributes should be ASCII text files, preferably<br>with only one value per file.  The same efficiency caveats from sysfs<br>apply.  Don’t mix more than one attribute in one attribute file.</p>
<p>Like sysfs, configfs expects write(2) to store the entire buffer at<br>once.  When writing to configfs attributes, userspace processes should<br>first read the entire file, modify the portions they wish to change, and<br>then write the entire buffer back.  Attribute files have a maximum size<br>of one page (PAGE_SIZE, 4096 on i386).</p>
<p>When an item needs to be destroyed, remove it with rmdir(2).  An<br>item cannot be destroyed if any other item has a link to it (via<br>symlink(2)).  Links can be removed via unlink(2).</p>
<p>[Configuring FakeNBD: an Example]</p>
<p>Imagine there’s a Network Block Device (NBD) driver that allows you to<br>access remote block devices.  Call it FakeNBD.  FakeNBD uses configfs<br>for its configuration.  Obviously, there will be a nice program that<br>sysadmins use to configure FakeNBD, but somehow that program has to tell<br>the driver about it.  Here’s where configfs comes in.</p>
<p>When the FakeNBD driver is loaded, it registers itself with configfs.<br>readdir(3) sees this just fine:</p>
<pre><code># ls /config
fakenbd
</code></pre>
<p>A fakenbd connection can be created with mkdir(2).  The name is<br>arbitrary, but likely the tool will make some use of the name.  Perhaps<br>it is a uuid or a disk name:</p>
<pre><code># mkdir /config/fakenbd/disk1
# ls /config/fakenbd/disk1
target device rw
</code></pre>
<p>The target attribute contains the IP address of the server FakeNBD will<br>connect to.  The device attribute is the device on the server.<br>Predictably, the rw attribute determines whether the connection is<br>read-only or read-write.</p>
<pre><code># echo 10.0.0.1 &gt; /config/fakenbd/disk1/target
# echo /dev/sda1 &gt; /config/fakenbd/disk1/device
# echo 1 &gt; /config/fakenbd/disk1/rw
</code></pre>
<p>That’s it.  That’s all there is.  Now the device is configured, via the<br>shell no less.</p>
<p>[Coding With configfs]</p>
<p>Every object in configfs is a config_item.  A config_item reflects an<br>object in the subsystem.  It has attributes that match values on that<br>object.  configfs handles the filesystem representation of that object<br>and its attributes, allowing the subsystem to ignore all but the<br>basic show/store interaction.</p>
<p>Items are created and destroyed inside a config_group.  A group is a<br>collection of items that share the same attributes and operations.<br>Items are created by mkdir(2) and removed by rmdir(2), but configfs<br>handles that.  The group has a set of operations to perform these tasks</p>
<p>A subsystem is the top level of a client module.  During initialization,<br>the client module registers the subsystem with configfs, the subsystem<br>appears as a directory at the top of the configfs filesystem.  A<br>subsystem is also a config_group, and can do everything a config_group<br>can.</p>
<p>[struct config_item]</p>
<pre><code>struct config_item &#123;
    char                    *ci_name;
    char                    ci_namebuf[UOBJ_NAME_LEN];
    struct kref             ci_kref;
    struct list_head        ci_entry;
    struct config_item      *ci_parent;
    struct config_group     *ci_group;
    struct config_item_type *ci_type;
    struct dentry           *ci_dentry;
&#125;;

void config_item_init(struct config_item *);
void config_item_init_type_name(struct config_item *,
                const char *name,
                struct config_item_type *type);
struct config_item *config_item_get(struct config_item *);
void config_item_put(struct config_item *);
</code></pre>
<p>Generally, struct config_item is embedded in a container structure, a<br>structure that actually represents what the subsystem is doing.  The<br>config_item portion of that structure is how the object interacts with<br>configfs.</p>
<p>Whether statically defined in a source file or created by a parent<br>config_group, a config_item must have one of the _init() functions<br>called on it.  This initializes the reference count and sets up the<br>appropriate fields.</p>
<p>All users of a config_item should have a reference on it via<br>config_item_get(), and drop the reference when they are done via<br>config_item_put().</p>
<p>By itself, a config_item cannot do much more than appear in configfs.<br>Usually a subsystem wants the item to display and/or store attributes,<br>among other things.  For that, it needs a type.</p>
<p>[struct config_item_type]</p>
<pre><code>struct configfs_item_operations &#123;
    void (*release)(struct config_item *);
    ssize_t (*show_attribute)(struct config_item *,
                  struct configfs_attribute *,
                  char *);
    ssize_t (*store_attribute)(struct config_item *,
                   struct configfs_attribute *,
                   const char *, size_t);
    int (*allow_link)(struct config_item *src,
              struct config_item *target);
    int (*drop_link)(struct config_item *src,
             struct config_item *target);
&#125;;

struct config_item_type &#123;
    struct module                           *ct_owner;
    struct configfs_item_operations         *ct_item_ops;
    struct configfs_group_operations        *ct_group_ops;
    struct configfs_attribute               **ct_attrs;
&#125;;
</code></pre>
<p>The most basic function of a config_item_type is to define what<br>operations can be performed on a config_item.  All items that have been<br>allocated dynamically will need to provide the ct_item_ops-&gt;release()<br>method.  This method is called when the config_item’s reference count<br>reaches zero.  Items that wish to display an attribute need to provide<br>the ct_item_ops-&gt;show_attribute() method.  Similarly, storing a new<br>attribute value uses the store_attribute() method.</p>
<p>[struct configfs_attribute]</p>
<pre><code>struct configfs_attribute &#123;
    char                    *ca_name;
    struct module           *ca_owner;
    umode_t                  ca_mode;
&#125;;
</code></pre>
<p>When a config_item wants an attribute to appear as a file in the item’s<br>configfs directory, it must define a configfs_attribute describing it.<br>It then adds the attribute to the NULL-terminated array<br>config_item_type-&gt;ct_attrs.  When the item appears in configfs, the<br>attribute file will appear with the configfs_attribute-&gt;ca_name<br>filename.  configfs_attribute-&gt;ca_mode specifies the file permissions.</p>
<p>If an attribute is readable and the config_item provides a<br>ct_item_ops-&gt;show_attribute() method, that method will be called<br>whenever userspace asks for a read(2) on the attribute.  The converse<br>will happen for write(2).</p>
<p>[struct config_group]</p>
<p>A config_item cannot live in a vacuum.  The only way one can be created<br>is via mkdir(2) on a config_group.  This will trigger creation of a<br>child item.</p>
<pre><code>struct config_group &#123;
    struct config_item        cg_item;
    struct list_head        cg_children;
    struct configfs_subsystem     *cg_subsys;
    struct list_head        default_groups;
    struct list_head        group_entry;
&#125;;

void config_group_init(struct config_group *group);
void config_group_init_type_name(struct config_group *group,
                 const char *name,
                 struct config_item_type *type);
</code></pre>
<p>The config_group structure contains a config_item.  Properly configuring<br>that item means that a group can behave as an item in its own right.<br>However, it can do more: it can create child items or groups.  This is<br>accomplished via the group operations specified on the group’s<br>config_item_type.</p>
<pre><code>struct configfs_group_operations &#123;
    struct config_item *(*make_item)(struct config_group *group,
                     const char *name);
    struct config_group *(*make_group)(struct config_group *group,
                       const char *name);
    int (*commit_item)(struct config_item *item);
    void (*disconnect_notify)(struct config_group *group,
                  struct config_item *item);
    void (*drop_item)(struct config_group *group,
              struct config_item *item);
&#125;;
</code></pre>
<p>A group creates child items by providing the<br>ct_group_ops-&gt;make_item() method.  If provided, this method is called from mkdir(2) in the group’s directory.  The subsystem allocates a new<br>config_item (or more likely, its container structure), initializes it,<br>and returns it to configfs.  Configfs will then populate the filesystem<br>tree to reflect the new item.</p>
<p>If the subsystem wants the child to be a group itself, the subsystem<br>provides ct_group_ops-&gt;make_group().  Everything else behaves the same,<br>using the group _init() functions on the group.</p>
<p>Finally, when userspace calls rmdir(2) on the item or group,<br>ct_group_ops-&gt;drop_item() is called.  As a config_group is also a<br>config_item, it is not necessary for a separate drop_group() method.<br>The subsystem must config_item_put() the reference that was initialized<br>upon item allocation.  If a subsystem has no work to do, it may omit<br>the ct_group_ops-&gt;drop_item() method, and configfs will call<br>config_item_put() on the item on behalf of the subsystem.</p>
<p>IMPORTANT: drop_item() is void, and as such cannot fail.  When rmdir(2)<br>is called, configfs WILL remove the item from the filesystem tree<br>(assuming that it has no children to keep it busy).  The subsystem is<br>responsible for responding to this.  If the subsystem has references to<br>the item in other threads, the memory is safe.  It may take some time<br>for the item to actually disappear from the subsystem’s usage.  But it<br>is gone from configfs.</p>
<p>When drop_item() is called, the item’s linkage has already been torn<br>down.  It no longer has a reference on its parent and has no place in<br>the item hierarchy.  If a client needs to do some cleanup before this<br>teardown happens, the subsystem can implement the<br>ct_group_ops-&gt;disconnect_notify() method.  The method is called after<br>configfs has removed the item from the filesystem view but before the<br>item is removed from its parent group.  Like drop_item(),<br>disconnect_notify() is void and cannot fail.  Client subsystems should<br>not drop any references here, as they still must do it in drop_item().</p>
<p>A config_group cannot be removed while it still has child items.  This<br>is implemented in the configfs rmdir(2) code.  -&gt;drop_item() will not be<br>called, as the item has not been dropped.  rmdir(2) will fail, as the<br>directory is not empty.</p>
<p>[struct configfs_subsystem]</p>
<p>A subsystem must register itself, usually at module_init time.  This<br>tells configfs to make the subsystem appear in the file tree.</p>
<pre><code>struct configfs_subsystem &#123;
    struct config_group    su_group;
    struct mutex        su_mutex;
&#125;;

int configfs_register_subsystem(struct configfs_subsystem *subsys);
void configfs_unregister_subsystem(struct configfs_subsystem *subsys);

A subsystem consists of a toplevel config_group and a mutex.
</code></pre>
<p>The group is where child config_items are created.  For a subsystem,<br>this group is usually defined statically.  Before calling<br>configfs_register_subsystem(), the subsystem must have initialized the<br>group via the usual group _init() functions, and it must also have<br>initialized the mutex.<br>    When the register call returns, the subsystem is live, and it<br>will be visible via configfs.  At that point, mkdir(2) can be called and<br>the subsystem must be ready for it.</p>
<p>[An Example]</p>
<p>The best example of these basic concepts is the simple_children<br>subsystem/group and the simple_child item in configfs_example_explicit.c<br>and configfs_example_macros.c.  It shows a trivial object displaying and<br>storing an attribute, and a simple group creating and destroying these<br>children.</p>
<p>The only difference between configfs_example_explicit.c and<br>configfs_example_macros.c is how the attributes of the childless item<br>are defined.  The childless item has extended attributes, each with<br>their own show()/store() operation.  This follows a convention commonly<br>used in sysfs.  configfs_example_explicit.c creates these attributes<br>by explicitly defining the structures involved.  Conversely<br>configfs_example_macros.c uses some convenience macros from configfs.h<br>to define the attributes.  These macros are similar to their sysfs<br>counterparts.</p>
<p>[Hierarchy Navigation and the Subsystem Mutex]</p>
<p>There is an extra bonus that configfs provides.  The config_groups and<br>config_items are arranged in a hierarchy due to the fact that they<br>appear in a filesystem.  A subsystem is NEVER to touch the filesystem<br>parts, but the subsystem might be interested in this hierarchy.  For<br>this reason, the hierarchy is mirrored via the config_group-&gt;cg_children<br>and config_item-&gt;ci_parent structure members.</p>
<p>A subsystem can navigate the cg_children list and the ci_parent pointer<br>to see the tree created by the subsystem.  This can race with configfs’<br>management of the hierarchy, so configfs uses the subsystem mutex to<br>protect modifications.  Whenever a subsystem wants to navigate the<br>hierarchy, it must do so under the protection of the subsystem<br>mutex.</p>
<p>A subsystem will be prevented from acquiring the mutex while a newly<br>allocated item has not been linked into this hierarchy.   Similarly, it<br>will not be able to acquire the mutex while a dropping item has not<br>yet been unlinked.  This means that an item’s ci_parent pointer will<br>never be NULL while the item is in configfs, and that an item will only<br>be in its parent’s cg_children list for the same duration.  This allows<br>a subsystem to trust ci_parent and cg_children while they hold the<br>mutex.</p>
<p>[Item Aggregation Via symlink(2)]</p>
<p>configfs provides a simple group via the group-&gt;item parent/child<br>relationship.  Often, however, a larger environment requires aggregation<br>outside of the parent/child connection.  This is implemented via<br>symlink(2).</p>
<p>A config_item may provide the ct_item_ops-&gt;allow_link() and<br>ct_item_ops-&gt;drop_link() methods.  If the -&gt;allow_link() method exists,<br>symlink(2) may be called with the config_item as the source of the link.<br>These links are only allowed between configfs config_items.  Any<br>symlink(2) attempt outside the configfs filesystem will be denied.</p>
<p>When symlink(2) is called, the source config_item’s -&gt;allow_link()<br>method is called with itself and a target item.  If the source item<br>allows linking to target item, it returns 0.  A source item may wish to<br>reject a link if it only wants links to a certain type of object (say,<br>in its own subsystem).</p>
<p>When unlink(2) is called on the symbolic link, the source item is<br>notified via the -&gt;drop_link() method.  Like the -&gt;drop_item() method,<br>this is a void function and cannot return failure.  The subsystem is<br>responsible for responding to the change.</p>
<p>A config_item cannot be removed while it links to any other item, nor<br>can it be removed while an item links to it.  Dangling symlinks are not<br>allowed in configfs.</p>
<p>[Automatically Created Subgroups]</p>
<p>A new config_group may want to have two types of child config_items.<br>While this could be codified by magic names in -&gt;make_item(), it is much<br>more explicit to have a method whereby userspace sees this divergence.</p>
<p>Rather than have a group where some items behave differently than<br>others, configfs provides a method whereby one or many subgroups are<br>automatically created inside the parent at its creation.  Thus,<br>mkdir(“parent”) results in “parent”, “parent/subgroup1”, up through<br>“parent/subgroupN”.  Items of type 1 can now be created in<br>“parent/subgroup1”, and items of type N can be created in<br>“parent/subgroupN”.</p>
<p>These automatic subgroups, or default groups, do not preclude other<br>children of the parent group.  If ct_group_ops-&gt;make_group() exists,<br>other child groups can be created on the parent group directly.</p>
<p>A configfs subsystem specifies default groups by adding them using the<br>configfs_add_default_group() function to the parent config_group<br>structure.  Each added group is populated in the configfs tree at the same<br>time as the parent group.  Similarly, they are removed at the same time<br>as the parent.  No extra notification is provided.  When a -&gt;drop_item()<br>method call notifies the subsystem the parent group is going away, it<br>also means every default group child associated with that parent group.</p>
<p>As a consequence of this, default groups cannot be removed directly via<br>rmdir(2).  They also are not considered when rmdir(2) on the parent<br>group is checking for children.</p>
<p>[Dependent Subsystems]</p>
<p>Sometimes other drivers depend on particular configfs items.  For<br>example, ocfs2 mounts depend on a heartbeat region item.  If that<br>region item is removed with rmdir(2), the ocfs2 mount must BUG or go<br>readonly.  Not happy.</p>
<p>configfs provides two additional API calls: configfs_depend_item() and<br>configfs_undepend_item().  A client driver can call<br>configfs_depend_item() on an existing item to tell configfs that it is<br>depended on.  configfs will then return -EBUSY from rmdir(2) for that<br>item.  When the item is no longer depended on, the client driver calls<br>configfs_undepend_item() on it.</p>
<p>These API cannot be called underneath any configfs callbacks, as<br>they will conflict.  They can block and allocate.  A client driver<br>probably shouldn’t calling them of its own gumption.  Rather it should<br>be providing an API that external subsystems call.</p>
<p>How does this work?  Imagine the ocfs2 mount process.  When it mounts,<br>it asks for a heartbeat region item.  This is done via a call into the<br>heartbeat code.  Inside the heartbeat code, the region item is looked<br>up.  Here, the heartbeat code calls configfs_depend_item().  If it<br>succeeds, then heartbeat knows the region is safe to give to ocfs2.<br>If it fails, it was being torn down anyway, and heartbeat can gracefully<br>pass up an error.</p>
<p>[Committable Items]</p>
<p>NOTE: Committable items are currently unimplemented.</p>
<p>Some config_items cannot have a valid initial state.  That is, no<br>default values can be specified for the item’s attributes such that the<br>item can do its work.  Userspace must configure one or more attributes,<br>after which the subsystem can start whatever entity this item<br>represents.</p>
<p>Consider the FakeNBD device from above.  Without a target address <em>and</em><br>a target device, the subsystem has no idea what block device to import.<br>The simple example assumes that the subsystem merely waits until all the<br>appropriate attributes are configured, and then connects.  This will,<br>indeed, work, but now every attribute store must check if the attributes<br>are initialized.  Every attribute store must fire off the connection if<br>that condition is met.</p>
<p>Far better would be an explicit action notifying the subsystem that the<br>config_item is ready to go.  More importantly, an explicit action allows<br>the subsystem to provide feedback as to whether the attributes are<br>initialized in a way that makes sense.  configfs provides this as<br>committable items.</p>
<p>configfs still uses only normal filesystem operations.  An item is<br>committed via rename(2).  The item is moved from a directory where it<br>can be modified to a directory where it cannot.</p>
<p>Any group that provides the ct_group_ops-&gt;commit_item() method has<br>committable items.  When this group appears in configfs, mkdir(2) will<br>not work directly in the group.  Instead, the group will have two<br>subdirectories: “live” and “pending”.  The “live” directory does not<br>support mkdir(2) or rmdir(2) either.  It only allows rename(2).  The<br>“pending” directory does allow mkdir(2) and rmdir(2).  An item is<br>created in the “pending” directory.  Its attributes can be modified at<br>will.  Userspace commits the item by renaming it into the “live”<br>directory.  At this point, the subsystem receives the -&gt;commit_item()<br>callback.  If all required attributes are filled to satisfaction, the<br>method returns zero and the item is moved to the “live” directory.</p>
<p>As rmdir(2) does not work in the “live” directory, an item must be<br>shutdown, or “uncommitted”.  Again, this is done via rename(2), this<br>time from the “live” directory back to the “pending” one.  The subsystem<br>is notified by the ct_group_ops-&gt;uncommit_object() method.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_configfs/" title="Kernel-3.10.0-957.el7_configfs" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_configfs/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_cpu-hotplug/" title="Kernel-3.10.0-957.el7_cpu-hotplug"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_cluster-pm-race-avoidance/" title="Kernel-3.10.0-957.el7_cluster-pm-race-avoidance"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>