<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-3.10.0-957.el7_workqueue | oosTech.com</title>
  <meta name="description" content="Concurrency Managed Workqueue (cmwq) September, 2010        Tejun Heo &amp;#x74;&amp;#106;&amp;#x40;&amp;#x6b;&amp;#x65;&amp;#x72;&amp;#110;&amp;#x65;&amp;#x6c;&amp;#x2e;&amp;#111;&amp;#x72;&amp;#103;            Florian Mickler &amp;#x66;&amp;#x6c;&amp;#x6f;&amp;#114;">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-3.10.0-957.el7_workqueue">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_workqueue/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="Concurrency Managed Workqueue (cmwq) September, 2010        Tejun Heo &amp;#x74;&amp;#106;&amp;#x40;&amp;#x6b;&amp;#x65;&amp;#x72;&amp;#110;&amp;#x65;&amp;#x6c;&amp;#x2e;&amp;#111;&amp;#x72;&amp;#103;            Florian Mickler &amp;#x66;&amp;#x6c;&amp;#x6f;&amp;#114;">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_workqueue/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-3.10.0-957.el7_workqueue" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-3.10.0-957.el7_workqueue
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_workqueue/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-3.10.0-957.el7_workqueue/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-3.10.0-957.el7_workqueue/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>Concurrency Managed Workqueue (cmwq)</p>
<p>September, 2010        Tejun Heo <a href="mailto:&#x74;&#106;&#x40;&#x6b;&#x65;&#x72;&#110;&#x65;&#x6c;&#x2e;&#111;&#x72;&#103;">&#x74;&#106;&#x40;&#x6b;&#x65;&#x72;&#110;&#x65;&#x6c;&#x2e;&#111;&#x72;&#103;</a><br>            Florian Mickler <a href="mailto:&#x66;&#x6c;&#x6f;&#114;&#x69;&#x61;&#x6e;&#x40;&#x6d;&#105;&#99;&#x6b;&#x6c;&#101;&#x72;&#46;&#111;&#x72;&#103;">&#x66;&#x6c;&#x6f;&#114;&#x69;&#x61;&#x6e;&#x40;&#x6d;&#105;&#99;&#x6b;&#x6c;&#101;&#x72;&#46;&#111;&#x72;&#103;</a></p>
<p>CONTENTS</p>
<ol>
<li>Introduction</li>
<li>Why cmwq?</li>
<li>The Design</li>
<li>Application Programming Interface (API)</li>
<li>Example Execution Scenarios</li>
<li>Guidelines</li>
<li>Debugging</li>
</ol>
<ol>
<li>Introduction</li>
</ol>
<p>There are many cases where an asynchronous process execution context<br>is needed and the workqueue (wq) API is the most commonly used<br>mechanism for such cases.</p>
<p>When such an asynchronous execution context is needed, a work item<br>describing which function to execute is put on a queue.  An<br>independent thread serves as the asynchronous execution context.  The<br>queue is called workqueue and the thread is called worker.</p>
<p>While there are work items on the workqueue the worker executes the<br>functions associated with the work items one after the other.  When<br>there is no work item left on the workqueue the worker becomes idle.<br>When a new work item gets queued, the worker begins executing again.</p>
<ol start="2">
<li>Why cmwq?</li>
</ol>
<p>In the original wq implementation, a multi threaded (MT) wq had one<br>worker thread per CPU and a single threaded (ST) wq had one worker<br>thread system-wide.  A single MT wq needed to keep around the same<br>number of workers as the number of CPUs.  The kernel grew a lot of MT<br>wq users over the years and with the number of CPU cores continuously<br>rising, some systems saturated the default 32k PID space just booting<br>up.</p>
<p>Although MT wq wasted a lot of resource, the level of concurrency<br>provided was unsatisfactory.  The limitation was common to both ST and<br>MT wq albeit less severe on MT.  Each wq maintained its own separate<br>worker pool.  A MT wq could provide only one execution context per CPU<br>while a ST wq one for the whole system.  Work items had to compete for<br>those very limited execution contexts leading to various problems<br>including proneness to deadlocks around the single execution context.</p>
<p>The tension between the provided level of concurrency and resource<br>usage also forced its users to make unnecessary tradeoffs like libata<br>choosing to use ST wq for polling PIOs and accepting an unnecessary<br>limitation that no two polling PIOs can progress at the same time.  As<br>MT wq don’t provide much better concurrency, users which require<br>higher level of concurrency, like async or fscache, had to implement<br>their own thread pool.</p>
<p>Concurrency Managed Workqueue (cmwq) is a reimplementation of wq with<br>focus on the following goals.</p>
<ul>
<li><p>Maintain compatibility with the original workqueue API.</p>
</li>
<li><p>Use per-CPU unified worker pools shared by all wq to provide<br>flexible level of concurrency on demand without wasting a lot of<br>resource.</p>
</li>
<li><p>Automatically regulate worker pool and level of concurrency so that<br>the API users don’t need to worry about such details.</p>
</li>
</ul>
<ol start="3">
<li>The Design</li>
</ol>
<p>In order to ease the asynchronous execution of functions a new<br>abstraction, the work item, is introduced.</p>
<p>A work item is a simple struct that holds a pointer to the function<br>that is to be executed asynchronously.  Whenever a driver or subsystem<br>wants a function to be executed asynchronously it has to set up a work<br>item pointing to that function and queue that work item on a<br>workqueue.</p>
<p>Special purpose threads, called worker threads, execute the functions<br>off of the queue, one after the other.  If no work is queued, the<br>worker threads become idle.  These worker threads are managed in so<br>called thread-pools.</p>
<p>The cmwq design differentiates between the user-facing workqueues that<br>subsystems and drivers queue work items on and the backend mechanism<br>which manages thread-pools and processes the queued work items.</p>
<p>The backend is called gcwq.  There is one gcwq for each possible CPU<br>and one gcwq to serve work items queued on unbound workqueues.  Each<br>gcwq has two thread-pools - one for normal work items and the other<br>for high priority ones.</p>
<p>Subsystems and drivers can create and queue work items through special<br>workqueue API functions as they see fit. They can influence some<br>aspects of the way the work items are executed by setting flags on the<br>workqueue they are putting the work item on. These flags include<br>things like CPU locality, reentrancy, concurrency limits, priority and<br>more.  To get a detailed overview refer to the API description of<br>alloc_workqueue() below.</p>
<p>When a work item is queued to a workqueue, the target gcwq and<br>thread-pool is determined according to the queue parameters and<br>workqueue attributes and appended on the shared worklist of the<br>thread-pool.  For example, unless specifically overridden, a work item<br>of a bound workqueue will be queued on the worklist of either normal<br>or highpri thread-pool of the gcwq that is associated to the CPU the<br>issuer is running on.</p>
<p>For any worker pool implementation, managing the concurrency level<br>(how many execution contexts are active) is an important issue.  cmwq<br>tries to keep the concurrency at a minimal but sufficient level.<br>Minimal to save resources and sufficient in that the system is used at<br>its full capacity.</p>
<p>Each thread-pool bound to an actual CPU implements concurrency<br>management by hooking into the scheduler.  The thread-pool is notified<br>whenever an active worker wakes up or sleeps and keeps track of the<br>number of the currently runnable workers.  Generally, work items are<br>not expected to hog a CPU and consume many cycles.  That means<br>maintaining just enough concurrency to prevent work processing from<br>stalling should be optimal.  As long as there are one or more runnable<br>workers on the CPU, the thread-pool doesn’t start execution of a new<br>work, but, when the last running worker goes to sleep, it immediately<br>schedules a new worker so that the CPU doesn’t sit idle while there<br>are pending work items.  This allows using a minimal number of workers<br>without losing execution bandwidth.</p>
<p>Keeping idle workers around doesn’t cost other than the memory space<br>for kthreads, so cmwq holds onto idle ones for a while before killing<br>them.</p>
<p>For an unbound wq, the above concurrency management doesn’t apply and<br>the thread-pools for the pseudo unbound CPU try to start executing all<br>work items as soon as possible.  The responsibility of regulating<br>concurrency level is on the users.  There is also a flag to mark a<br>bound wq to ignore the concurrency management.  Please refer to the<br>API section for details.</p>
<p>Forward progress guarantee relies on that workers can be created when<br>more execution contexts are necessary, which in turn is guaranteed<br>through the use of rescue workers.  All work items which might be used<br>on code paths that handle memory reclaim are required to be queued on<br>wq’s that have a rescue-worker reserved for execution under memory<br>pressure.  Else it is possible that the thread-pool deadlocks waiting<br>for execution contexts to free up.</p>
<ol start="4">
<li>Application Programming Interface (API)</li>
</ol>
<p>alloc_workqueue() allocates a wq.  The original create_*workqueue()<br>functions are deprecated and scheduled for removal.  alloc_workqueue()<br>takes three arguments - @name, @flags and @max_active.  @name is the<br>name of the wq and also used as the name of the rescuer thread if<br>there is one.</p>
<p>A wq no longer manages execution resources but serves as a domain for<br>forward progress guarantee, flush and work item attributes.  @flags<br>and @max_active control how work items are assigned execution<br>resources, scheduled and executed.</p>
<p>@flags:</p>
<p>  WQ_NON_REENTRANT</p>
<pre><code>By default, a wq guarantees non-reentrance only on the same
CPU.  A work item may not be executed concurrently on the same
CPU by multiple workers but is allowed to be executed
concurrently on multiple CPUs.  This flag makes sure
non-reentrance is enforced across all CPUs.  Work items queued
to a non-reentrant wq are guaranteed to be executed by at most
one worker system-wide at any given time.
</code></pre>
<p>  WQ_UNBOUND</p>
<pre><code>Work items queued to an unbound wq are served by a special
gcwq which hosts workers which are not bound to any specific
CPU.  This makes the wq behave as a simple execution context
provider without concurrency management.  The unbound gcwq
tries to start execution of work items as soon as possible.
Unbound wq sacrifices locality but is useful for the following
cases.

* Wide fluctuation in the concurrency level requirement is
  expected and using bound wq may end up creating large number
  of mostly unused workers across different CPUs as the issuer
  hops through different CPUs.

* Long running CPU intensive workloads which can be better
  managed by the system scheduler.
</code></pre>
<p>  WQ_FREEZABLE</p>
<pre><code>A freezable wq participates in the freeze phase of the system
suspend operations.  Work items on the wq are drained and no
new work item starts execution until thawed.
</code></pre>
<p>  WQ_MEM_RECLAIM</p>
<pre><code>All wq which might be used in the memory reclaim paths _MUST_
have this flag set.  The wq is guaranteed to have at least one
execution context regardless of memory pressure.
</code></pre>
<p>  WQ_HIGHPRI</p>
<pre><code>Work items of a highpri wq are queued to the highpri
thread-pool of the target gcwq.  Highpri thread-pools are
served by worker threads with elevated nice level.

Note that normal and highpri thread-pools don&#39;t interact with
each other.  Each maintain its separate pool of workers and
implements concurrency management among its workers.
</code></pre>
<p>  WQ_CPU_INTENSIVE</p>
<pre><code>Work items of a CPU intensive wq do not contribute to the
concurrency level.  In other words, runnable CPU intensive
work items will not prevent other work items in the same
thread-pool from starting execution.  This is useful for bound
work items which are expected to hog CPU cycles so that their
execution is regulated by the system scheduler.

Although CPU intensive work items don&#39;t contribute to the
concurrency level, start of their executions is still
regulated by the concurrency management and runnable
non-CPU-intensive work items can delay execution of CPU
intensive work items.

This flag is meaningless for unbound wq.
</code></pre>
<p>@max_active:</p>
<p>@max_active determines the maximum number of execution contexts per<br>CPU which can be assigned to the work items of a wq.  For example,<br>with @max_active of 16, at most 16 work items of the wq can be<br>executing at the same time per CPU.</p>
<p>Currently, for a bound wq, the maximum limit for @max_active is 512<br>and the default value used when 0 is specified is 256.  For an unbound<br>wq, the limit is higher of 512 and 4 * num_possible_cpus().  These<br>values are chosen sufficiently high such that they are not the<br>limiting factor while providing protection in runaway cases.</p>
<p>The number of active work items of a wq is usually regulated by the<br>users of the wq, more specifically, by how many work items the users<br>may queue at the same time.  Unless there is a specific need for<br>throttling the number of active work items, specifying ‘0’ is<br>recommended.</p>
<p>Some users depend on the strict execution ordering of ST wq.  The<br>combination of @max_active of 1 and WQ_UNBOUND is used to achieve this<br>behavior.  Work items on such wq are always queued to the unbound gcwq<br>and only one work item can be active at any given time thus achieving<br>the same ordering property as ST wq.</p>
<ol start="5">
<li>Example Execution Scenarios</li>
</ol>
<p>The following example execution scenarios try to illustrate how cmwq<br>behave under different configurations.</p>
<p> Work items w0, w1, w2 are queued to a bound wq q0 on the same CPU.<br> w0 burns CPU for 5ms then sleeps for 10ms then burns CPU for 5ms<br> again before finishing.  w1 and w2 burn CPU for 5ms then sleep for<br> 10ms.</p>
<p>Ignoring all other tasks, works and processing overhead, and assuming<br>simple FIFO scheduling, the following is one highly simplified version<br>of possible sequences of events with the original wq.</p>
<p> TIME IN MSECS    EVENT<br> 0        w0 starts and burns CPU<br> 5        w0 sleeps<br> 15        w0 wakes up and burns CPU<br> 20        w0 finishes<br> 20        w1 starts and burns CPU<br> 25        w1 sleeps<br> 35        w1 wakes up and finishes<br> 35        w2 starts and burns CPU<br> 40        w2 sleeps<br> 50        w2 wakes up and finishes</p>
<p>And with cmwq with @max_active &gt;= 3,</p>
<p> TIME IN MSECS    EVENT<br> 0        w0 starts and burns CPU<br> 5        w0 sleeps<br> 5        w1 starts and burns CPU<br> 10        w1 sleeps<br> 10        w2 starts and burns CPU<br> 15        w2 sleeps<br> 15        w0 wakes up and burns CPU<br> 20        w0 finishes<br> 20        w1 wakes up and finishes<br> 25        w2 wakes up and finishes</p>
<p>If @max_active == 2,</p>
<p> TIME IN MSECS    EVENT<br> 0        w0 starts and burns CPU<br> 5        w0 sleeps<br> 5        w1 starts and burns CPU<br> 10        w1 sleeps<br> 15        w0 wakes up and burns CPU<br> 20        w0 finishes<br> 20        w1 wakes up and finishes<br> 20        w2 starts and burns CPU<br> 25        w2 sleeps<br> 35        w2 wakes up and finishes</p>
<p>Now, let’s assume w1 and w2 are queued to a different wq q1 which has<br>WQ_CPU_INTENSIVE set,</p>
<p> TIME IN MSECS    EVENT<br> 0        w0 starts and burns CPU<br> 5        w0 sleeps<br> 5        w1 and w2 start and burn CPU<br> 10        w1 sleeps<br> 15        w2 sleeps<br> 15        w0 wakes up and burns CPU<br> 20        w0 finishes<br> 20        w1 wakes up and finishes<br> 25        w2 wakes up and finishes</p>
<ol start="6">
<li>Guidelines</li>
</ol>
<ul>
<li><p>Do not forget to use WQ_MEM_RECLAIM if a wq may process work items<br>which are used during memory reclaim.  Each wq with WQ_MEM_RECLAIM<br>set has an execution context reserved for it.  If there is<br>dependency among multiple work items used during memory reclaim,<br>they should be queued to separate wq each with WQ_MEM_RECLAIM.</p>
</li>
<li><p>Unless strict ordering is required, there is no need to use ST wq.</p>
</li>
<li><p>Unless there is a specific need, using 0 for @max_active is<br>recommended.  In most use cases, concurrency level usually stays<br>well under the default limit.</p>
</li>
<li><p>A wq serves as a domain for forward progress guarantee<br>(WQ_MEM_RECLAIM, flush and work item attributes.  Work items which<br>are not involved in memory reclaim and don’t need to be flushed as a<br>part of a group of work items, and don’t require any special<br>attribute, can use one of the system wq.  There is no difference in<br>execution characteristics between using a dedicated wq and a system<br>wq.</p>
</li>
<li><p>Unless work items are expected to consume a huge amount of CPU<br>cycles, using a bound wq is usually beneficial due to the increased<br>level of locality in wq operations and work item execution.</p>
</li>
</ul>
<ol start="7">
<li>Debugging</li>
</ol>
<p>Because the work functions are executed by generic worker threads<br>there are a few tricks needed to shed some light on misbehaving<br>workqueue users.</p>
<p>Worker threads show up in the process list as:</p>
<p>root      5671  0.0  0.0      0     0 ?        S    12:07   0:00 [kworker/0:1]<br>root      5672  0.0  0.0      0     0 ?        S    12:07   0:00 [kworker/1:2]<br>root      5673  0.0  0.0      0     0 ?        S    12:12   0:00 [kworker/0:0]<br>root      5674  0.0  0.0      0     0 ?        S    12:13   0:00 [kworker/1:0]</p>
<p>If kworkers are going crazy (using too much cpu), there are two types<br>of possible problems:</p>
<pre><code>1. Something beeing scheduled in rapid succession
2. A single work item that consumes lots of cpu cycles
</code></pre>
<p>The first one can be tracked using tracing:</p>
<pre><code>$ echo workqueue:workqueue_queue_work &gt; /sys/kernel/debug/tracing/set_event
$ cat /sys/kernel/debug/tracing/trace_pipe &gt; out.txt
(wait a few secs)
^C
</code></pre>
<p>If something is busy looping on work queueing, it would be dominating<br>the output and the offender can be determined with the work item<br>function.</p>
<p>For the second type of problems it should be possible to just check<br>the stack trace of the offending worker thread.</p>
<pre><code>$ cat /proc/THE_OFFENDING_KWORKER/stack
</code></pre>
<p>The work item’s function should be trivially visible in the stack<br>trace.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_workqueue/" title="Kernel-3.10.0-957.el7_workqueue" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-3.10.0-957.el7_workqueue/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_wm8994/" title="Kernel-3.10.0-957.el7_wm8994"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-3.10.0-957.el7_writeback_cache_control/" title="Kernel-3.10.0-957.el7_writeback_cache_control"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>