<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kernel-2.6.32-573.12.1.el6_laptop-mode | oosTech.com</title>
  <meta name="description" content="How to conserve battery power using laptop-modeDocument Author: Bart Samwel (&amp;#x62;&amp;#x61;&amp;#114;&amp;#x74;&amp;#x40;&amp;#115;&amp;#x61;&amp;#109;&amp;#119;&amp;#101;&amp;#x6c;&amp;#46;&amp;#116;&amp;#x6b;)Date created: January 2, 2004Last modif">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel-2.6.32-573.12.1.el6_laptop-mode">
<meta property="og:url" content="http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_laptop-mode/index.html">
<meta property="og:site_name" content="oosTech">
<meta property="og:description" content="How to conserve battery power using laptop-modeDocument Author: Bart Samwel (&amp;#x62;&amp;#x61;&amp;#114;&amp;#x74;&amp;#x40;&amp;#115;&amp;#x61;&amp;#109;&amp;#119;&amp;#101;&amp;#x6c;&amp;#46;&amp;#116;&amp;#x6b;)Date created: January 2, 2004Last modif">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-12T16:00:00.000Z">
<meta property="article:author" content="Sam Lee">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_laptop-mode/index.html">
  
    <link rel="alternate" href="/atom.xml" title="oosTech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img src="/images/avatar.png" width="400" height="400">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">oosTech by Sam Lee</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="站内搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">站点首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档文档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">文档分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">常用链接</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">共享白板</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告牌</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p> 欢迎来到oosTech ，我是一个Linux 拥趸：D。 目前正在用的Linux 版本是 Red Hat Enterprise Linux release 8.3 </p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">文档分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a><span class="category-list-count">830</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a><span class="category-list-count">1658</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel-4-18-0-80-el8-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_4.18.0-80.el8_内核文档</a><span class="category-list-count">3937</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3270/" class="title">Kernel-3.10.0-957.el7_3270</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_devices/" class="title">Kernel-2.6.32-573.12.1.el6_devices</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_3c509/" class="title">Kernel-3.10.0-957.el7_3c509</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_4CCs/" class="title">Kernel-3.10.0-957.el7_4CCs</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kernel-3-10-0-957-el7-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_3.10.0-957.el7_内核文档</a>
              </p>
              <p class="item-title">
                <a href="/2021/03/13/Kernel-3.10.0-957.el7_53c700/" class="title">Kernel-3.10.0-957.el7_53c700</a>
              </p>
              <p class="item-date">
                <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-conserve-battery-power-using-laptop-mode"><span class="toc-number">1.</span> <span class="toc-text">How to conserve battery power using laptop-mode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">2.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Contents"><span class="toc-number">3.</span> <span class="toc-text">Contents</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Installation"><span class="toc-number">4.</span> <span class="toc-text">Installation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Caveats"><span class="toc-number">5.</span> <span class="toc-text">Caveats</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Details"><span class="toc-number">6.</span> <span class="toc-text">The Details</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configuration"><span class="toc-number">7.</span> <span class="toc-text">Configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tips-amp-Tricks"><span class="toc-number">8.</span> <span class="toc-text">Tips &amp; Tricks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configuration-file-for-control-and-ACPI-battery-scripts"><span class="toc-number">9.</span> <span class="toc-text">Configuration file for control and ACPI battery scripts</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Maximum-time-in-seconds-of-hard-drive-spindown-time-that-you-are"><span class="toc-number"></span> <span class="toc-text">Maximum time, in seconds, of hard drive spindown time that you are</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#comfortable-with-Worst-case-it%E2%80%99s-possible-that-you-could-lose-this"><span class="toc-number"></span> <span class="toc-text">comfortable with. Worst case, it’s possible that you could lose this</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#amount-of-work-if-your-battery-fails-you-while-in-laptop-mode"><span class="toc-number"></span> <span class="toc-text">amount of work if your battery fails you while in laptop mode.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Automatically-disable-laptop-mode-when-the-number-of-minutes-of-battery"><span class="toc-number"></span> <span class="toc-text">Automatically disable laptop mode when the number of minutes of battery</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#that-you-have-left-goes-below-this-threshold"><span class="toc-number"></span> <span class="toc-text">that you have left goes below this threshold.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Read-ahead-in-512-byte-sectors-You-can-spin-down-the-disk-while-playing-MP3-OGG"><span class="toc-number"></span> <span class="toc-text">Read-ahead, in 512-byte sectors. You can spin down the disk while playing MP3&#x2F;OGG</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#by-setting-the-disk-readahead-to-8MB-READAHEAD-16384-Effectively-the-disk"><span class="toc-number"></span> <span class="toc-text">by setting the disk readahead to 8MB (READAHEAD&#x3D;16384). Effectively, the disk</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#will-read-a-complete-MP3-at-once-and-will-then-spin-down-while-the-MP3-OGG-is"><span class="toc-number"></span> <span class="toc-text">will read a complete MP3 at once, and will then spin down while the MP3&#x2F;OGG is</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#playing"><span class="toc-number"></span> <span class="toc-text">playing.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shall-we-remount-journaled-fs-with-appropriate-commit-interval-1-yes"><span class="toc-number"></span> <span class="toc-text">Shall we remount journaled fs. with appropriate commit interval? (1&#x3D;yes)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#And-shall-we-add-the-%E2%80%9Cnoatime%E2%80%9D-option-to-that-as-well-1-yes"><span class="toc-number"></span> <span class="toc-text">And shall we add the “noatime” option to that as well? (1&#x3D;yes)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Dirty-synchronous-ratio-At-this-percentage-of-dirty-pages-the-process"><span class="toc-number"></span> <span class="toc-text">Dirty synchronous ratio.  At this percentage of dirty pages the process</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#which"><span class="toc-number"></span> <span class="toc-text">which</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#calls-write-does-its-own-writeback"><span class="toc-number"></span> <span class="toc-text">calls write() does its own writeback</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Allowed-dirty-background-ratio-in-percent-Once-DIRTY-RATIO-has-been"><span class="toc-number"></span> <span class="toc-text">Allowed dirty background ratio, in percent.  Once DIRTY_RATIO has been</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exceeded-the-kernel-will-wake-flusher-threads-which-will-then-reduce-the"><span class="toc-number"></span> <span class="toc-text">exceeded, the kernel will wake flusher threads which will then reduce the</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#amount-of-dirty-memory-to-dirty-background-ratio-Set-this-nice-and-low"><span class="toc-number"></span> <span class="toc-text">amount of dirty memory to dirty_background_ratio.  Set this nice and low,</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#so-once-some-writeout-has-commenced-we-do-a-lot-of-it"><span class="toc-number"></span> <span class="toc-text">so once some writeout has commenced, we do a lot of it.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-1"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kernel-default-dirty-buffer-age"><span class="toc-number"></span> <span class="toc-text">kernel default dirty buffer age</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#This-must-be-adjusted-manually-to-the-value-of-HZ-in-the-running-kernel"><span class="toc-number"></span> <span class="toc-text">This must be adjusted manually to the value of HZ in the running kernel</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#on-2-4-until-the-XFS-people-change-their-2-4-external-interfaces-to-work-in"><span class="toc-number"></span> <span class="toc-text">on 2.4, until the XFS people change their 2.4 external interfaces to work in</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#centisecs-This-can-be-automated-but-it%E2%80%99s-a-work-in-progress-that-still"><span class="toc-number"></span> <span class="toc-text">centisecs. This can be automated, but it’s a work in progress that still</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#needs-some-fixes-On-2-6-kernels-XFS-uses-USER-HZ-instead-of-HZ-for"><span class="toc-number"></span> <span class="toc-text">needs# some fixes. On 2.6 kernels, XFS uses USER_HZ instead of HZ for</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#external-interfaces-and-that-is-currently-always-set-to-100-So-you-don%E2%80%99t"><span class="toc-number"></span> <span class="toc-text">external interfaces, and that is currently always set to 100. So you don’t</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#need-to-change-this-on-2-6"><span class="toc-number"></span> <span class="toc-text">need to change this on 2.6.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Should-the-maximum-CPU-frequency-be-adjusted-down-while-on-battery"><span class="toc-number"></span> <span class="toc-text">Should the maximum CPU frequency be adjusted down while on battery?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Requires-CPUFreq-to-be-setup"><span class="toc-number"></span> <span class="toc-text">Requires CPUFreq to be setup.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#See-Documentation-cpu-freq-user-guide-txt-for-more-info"><span class="toc-number"></span> <span class="toc-text">See Documentation&#x2F;cpu-freq&#x2F;user-guide.txt for more info</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#When-on-battery-what-is-the-maximum-CPU-speed-that-the-system-should"><span class="toc-number"></span> <span class="toc-text">When on battery what is the maximum CPU speed that the system should</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#use-Legal-values-are-%E2%80%9Cslowest%E2%80%9D-for-the-slowest-speed-that-your"><span class="toc-number"></span> <span class="toc-text">use? Legal values are “slowest” for the slowest speed that your</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CPU-is-able-to-operate-at-or-a-value-listed-in"><span class="toc-number"></span> <span class="toc-text">CPU is able to operate at, or a value listed in:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sys-devices-system-cpu-cpu0-cpufreq-scaling-available-frequencies"><span class="toc-number"></span> <span class="toc-text">&#x2F;sys&#x2F;devices&#x2F;system&#x2F;cpu&#x2F;cpu0&#x2F;cpufreq&#x2F;scaling_available_frequencies</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Only-applicable-if-DO-CPU-1"><span class="toc-number"></span> <span class="toc-text">Only applicable if DO_CPU&#x3D;1.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Idle-timeout-for-your-hard-drive-man-hdparm-for-valid-values-S-option"><span class="toc-number"></span> <span class="toc-text">Idle timeout for your hard drive (man hdparm for valid values, -S option)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Default-is-2-hours-on-AC-AC-HD-244-and-20-seconds-for-battery-BATT-HD-4"><span class="toc-number"></span> <span class="toc-text">Default is 2 hours on AC (AC_HD&#x3D;244) and 20 seconds for battery (BATT_HD&#x3D;4).</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-drives-for-which-to-adjust-the-idle-timeout-Separate-them-by-a-space"><span class="toc-number"></span> <span class="toc-text">The drives for which to adjust the idle timeout. Separate them by a space,</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#e-g-HD-%E2%80%9D-dev-hda-dev-hdb%E2%80%9D"><span class="toc-number"></span> <span class="toc-text">e.g. HD&#x3D;”&#x2F;dev&#x2F;hda &#x2F;dev&#x2F;hdb”.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Set-the-spindown-timeout-on-a-hard-drive"><span class="toc-number"></span> <span class="toc-text">Set the spindown timeout on a hard drive?</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Control-script"><span class="toc-number">1.</span> <span class="toc-text">Control script</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#start-or-stop-laptop-mode-best-run-by-a-power-management-daemon-when"><span class="toc-number"></span> <span class="toc-text">start or stop laptop_mode, best run by a power management daemon when</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ac-gets-connected-disconnected-from-a-laptop"><span class="toc-number"></span> <span class="toc-text">ac gets connected&#x2F;disconnected from a laptop</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-2"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#install-as-sbin-laptop-mode"><span class="toc-number"></span> <span class="toc-text">install as &#x2F;sbin&#x2F;laptop_mode</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-3"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Contributors-to-this-script-Kiko-Piris"><span class="toc-number"></span> <span class="toc-text">Contributors to this script:   Kiko Piris</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bart-Samwel"><span class="toc-number"></span> <span class="toc-text">Bart Samwel</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Micha-Feigin"><span class="toc-number"></span> <span class="toc-text">Micha Feigin</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Andrew-Morton"><span class="toc-number"></span> <span class="toc-text">Andrew Morton</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Herve-Eychenne"><span class="toc-number"></span> <span class="toc-text">Herve Eychenne</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Dax-Kelson"><span class="toc-number"></span> <span class="toc-text">Dax Kelson</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-4"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Original-Linux-2-4-version-by-Jens-Axboe"><span class="toc-number"></span> <span class="toc-text">Original Linux 2.4 version by: Jens Axboe</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Source-config"><span class="toc-number"></span> <span class="toc-text">Source config</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Don%E2%80%99t-raise-an-error-if-the-config-file-is-incomplete"><span class="toc-number"></span> <span class="toc-text">Don’t raise an error if the config file is incomplete</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#set-defaults-instead"><span class="toc-number"></span> <span class="toc-text">set defaults instead:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Maximum-time-in-seconds-of-hard-drive-spindown-time-that-you-are-1"><span class="toc-number"></span> <span class="toc-text">Maximum time, in seconds, of hard drive spindown time that you are</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#comfortable-with-Worst-case-it%E2%80%99s-possible-that-you-could-lose-this-1"><span class="toc-number"></span> <span class="toc-text">comfortable with. Worst case, it’s possible that you could lose this</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#amount-of-work-if-your-battery-fails-you-while-in-laptop-mode-1"><span class="toc-number"></span> <span class="toc-text">amount of work if your battery fails you while in laptop mode.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Read-ahead-in-kilobytes"><span class="toc-number"></span> <span class="toc-text">Read-ahead, in kilobytes</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shall-we-remount-journaled-fs-with-appropriate-commit-interval-1-yes-1"><span class="toc-number"></span> <span class="toc-text">Shall we remount journaled fs. with appropriate commit interval? (1&#x3D;yes)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#And-shall-we-add-the-%E2%80%9Cnoatime%E2%80%9D-option-to-that-as-well-1-yes-1"><span class="toc-number"></span> <span class="toc-text">And shall we add the “noatime” option to that as well? (1&#x3D;yes)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shall-we-adjust-the-idle-timeout-on-a-hard-drive"><span class="toc-number"></span> <span class="toc-text">Shall we adjust the idle timeout on a hard drive?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Adjust-idle-timeout-on-which-hard-drive"><span class="toc-number"></span> <span class="toc-text">Adjust idle timeout on which hard drive?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#spindown-time-for-HD-hdparm-S-values"><span class="toc-number"></span> <span class="toc-text">spindown time for HD (hdparm -S values)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Dirty-synchronous-ratio-At-this-percentage-of-dirty-pages-the-process-which"><span class="toc-number"></span> <span class="toc-text">Dirty synchronous ratio.  At this percentage of dirty pages the process which</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#calls-write-does-its-own-writeback-1"><span class="toc-number"></span> <span class="toc-text">calls write() does its own writeback</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cpu-frequency-scaling"><span class="toc-number"></span> <span class="toc-text">cpu frequency scaling</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#See-Documentation-cpu-freq-user-guide-txt-for-more-info-1"><span class="toc-number"></span> <span class="toc-text">See Documentation&#x2F;cpu-freq&#x2F;user-guide.txt for more info</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-5"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Allowed-dirty-background-ratio-in-percent-Once-DIRTY-RATIO-has-been-1"><span class="toc-number"></span> <span class="toc-text">Allowed dirty background ratio, in percent.  Once DIRTY_RATIO has been</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exceeded-the-kernel-will-wake-flusher-threads-which-will-then-reduce-the-1"><span class="toc-number"></span> <span class="toc-text">exceeded, the kernel will wake flusher threads which will then reduce the</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#amount-of-dirty-memory-to-dirty-background-ratio-Set-this-nice-and-low-1"><span class="toc-number"></span> <span class="toc-text">amount of dirty memory to dirty_background_ratio.  Set this nice and low,</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#so-once-some-writeout-has-commenced-we-do-a-lot-of-it-1"><span class="toc-number"></span> <span class="toc-text">so once some writeout has commenced, we do a lot of it.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-6"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kernel-default-dirty-buffer-age-1"><span class="toc-number"></span> <span class="toc-text">kernel default dirty buffer age</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#This-must-be-adjusted-manually-to-the-value-of-HZ-in-the-running-kernel-1"><span class="toc-number"></span> <span class="toc-text">This must be adjusted manually to the value of HZ in the running kernel</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#on-2-4-until-the-XFS-people-change-their-2-4-external-interfaces-to-work-in-1"><span class="toc-number"></span> <span class="toc-text">on 2.4, until the XFS people change their 2.4 external interfaces to work in</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#centisecs-This-can-be-automated-but-it%E2%80%99s-a-work-in-progress-that-still-needs"><span class="toc-number"></span> <span class="toc-text">centisecs. This can be automated, but it’s a work in progress that still needs</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#some-fixes-On-2-6-kernels-XFS-uses-USER-HZ-instead-of-HZ-for-external"><span class="toc-number"></span> <span class="toc-text">some fixes. On 2.6 kernels, XFS uses USER_HZ instead of HZ for external</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#interfaces-and-that-is-currently-always-set-to-100-So-you-don%E2%80%99t-need-to"><span class="toc-number"></span> <span class="toc-text">interfaces, and that is currently always set to 100. So you don’t need to</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#change-this-on-2-6"><span class="toc-number"></span> <span class="toc-text">change this on 2.6.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Remove-an-option-the-first-parameter-of-the-form-option-from"><span class="toc-number"></span> <span class="toc-text">Remove an option (the first parameter) of the form option&#x3D; from</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#a-mount-options-string-the-rest-of-the-parameters"><span class="toc-number"></span> <span class="toc-text">a mount options string (the rest of the parameters).</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Remove-an-option-the-first-parameter-without-any-arguments-from"><span class="toc-number"></span> <span class="toc-text">Remove an option (the first parameter) without any arguments from</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#a-mount-option-string-the-rest-of-the-parameters"><span class="toc-number"></span> <span class="toc-text">a mount option string (the rest of the parameters).</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Find-out-the-state-of-a-yes-no-option-e-g-%E2%80%9Catime%E2%80%9D-%E2%80%9Cnoatime%E2%80%9D-in"><span class="toc-number"></span> <span class="toc-text">Find out the state of a yes&#x2F;no option (e.g. “atime”&#x2F;“noatime”) in</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fstab-for-a-given-filesystem-and-use-this-state-to-replace-the"><span class="toc-number"></span> <span class="toc-text">fstab for a given filesystem, and use this state to replace the</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#value-of-the-option-in-another-mount-options-string-The-device"><span class="toc-number"></span> <span class="toc-text">value of the option in another mount options string. The device</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#is-the-first-argument-the-option-name-the-second-and-the-default"><span class="toc-number"></span> <span class="toc-text">is the first argument, the option name the second, and the default</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#value-the-third-The-remainder-is-the-mount-options-string"><span class="toc-number"></span> <span class="toc-text">value the third. The remainder is the mount options string.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-7"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Example"><span class="toc-number"></span> <span class="toc-text">Example:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#parse-yesno-opts-wfstab-dev-hda1-atime-atime-defaults-noatime"><span class="toc-number"></span> <span class="toc-text">parse_yesno_opts_wfstab &#x2F;dev&#x2F;hda1 atime atime defaults,noatime</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-8"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#If-fstab-contains-say-%E2%80%9Crw%E2%80%9D-for-this-filesystem-then-the-result"><span class="toc-number"></span> <span class="toc-text">If fstab contains, say, “rw” for this filesystem, then the result</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#will-be-%E2%80%9Cdefaults-atime%E2%80%9D"><span class="toc-number"></span> <span class="toc-text">will be “defaults,atime”.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Find-out-the-state-of-a-numbered-option-e-g-%E2%80%9Ccommit-NNN%E2%80%9D-in"><span class="toc-number"></span> <span class="toc-text">Find out the state of a numbered option (e.g. “commit&#x3D;NNN”) in</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fstab-for-a-given-filesystem-and-use-this-state-to-replace-the-1"><span class="toc-number"></span> <span class="toc-text">fstab for a given filesystem, and use this state to replace the</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#value-of-the-option-in-another-mount-options-string-The-device-1"><span class="toc-number"></span> <span class="toc-text">value of the option in another mount options string. The device</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#is-the-first-argument-and-the-option-name-the-second-The"><span class="toc-number"></span> <span class="toc-text">is the first argument, and the option name the second. The</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#remainder-is-the-mount-options-string-in-which-the-replacement"><span class="toc-number"></span> <span class="toc-text">remainder is the mount options string in which the replacement</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#must-be-done"><span class="toc-number"></span> <span class="toc-text">must be done.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-9"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Example-1"><span class="toc-number"></span> <span class="toc-text">Example:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#parse-mount-opts-wfstab-dev-hda1-commit-defaults-commit-7"><span class="toc-number"></span> <span class="toc-text">parse_mount_opts_wfstab &#x2F;dev&#x2F;hda1 commit defaults,commit&#x3D;7</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-10"><span class="toc-number"></span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#If-fstab-contains-say-%E2%80%9Ccommit-3-rw%E2%80%9D-for-this-filesystem-then-the"><span class="toc-number"></span> <span class="toc-text">If fstab contains, say, “commit&#x3D;3,rw” for this filesystem, then the</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#result-will-be-%E2%80%9Crw-commit-3%E2%80%9D"><span class="toc-number"></span> <span class="toc-text">result will be “rw,commit&#x3D;3”.</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ACPI-integration"><span class="toc-number">1.</span> <span class="toc-text">ACPI integration</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ac-on-offline-event-handler"><span class="toc-number"></span> <span class="toc-text">ac on&#x2F;offline event handler</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Automatically-disable-laptop-mode-when-the-battery-almost-runs-out"><span class="toc-number"></span> <span class="toc-text">Automatically disable laptop mode when the battery almost runs out.</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Monitoring-tool"><span class="toc-number">1.</span> <span class="toc-text">Monitoring tool</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kernel-2.6.32-573.12.1.el6_laptop-mode" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kernel-2.6.32-573.12.1.el6_laptop-mode
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_laptop-mode/" class="article-date">
	 published: <time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time>
	</a>
</span>

        
	<a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_laptop-mode/" class="article-date">
	   updated: <time datetime="2021-03-12T16:00:00.000Z" itemprop="dateUpdated">2021-03-13</time>
	</a>


        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kernel-2-6-32-573-12-1-el6-%E5%86%85%E6%A0%B8%E6%96%87%E6%A1%A3/">Kernel_2.6.32-573.12.1.el6_内核文档</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill"></i>
	    <!--<span id="busuanzi_container_page_pv" style="display:inline;">-->
			<span id="busuanzi_value_page_pv" style="display:inline;"></span>
		<!--</span>-->
	</span>



        <!--<span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_laptop-mode/#comments" class="article-comment-link">评论</a></span> -->
        
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="How-to-conserve-battery-power-using-laptop-mode"><a href="#How-to-conserve-battery-power-using-laptop-mode" class="headerlink" title="How to conserve battery power using laptop-mode"></a>How to conserve battery power using laptop-mode</h2><p>Document Author: Bart Samwel (<a href="mailto:&#x62;&#x61;&#114;&#x74;&#x40;&#115;&#x61;&#109;&#119;&#101;&#x6c;&#46;&#116;&#x6b;">&#x62;&#x61;&#114;&#x74;&#x40;&#115;&#x61;&#109;&#119;&#101;&#x6c;&#46;&#116;&#x6b;</a>)<br>Date created: January 2, 2004<br>Last modified: December 06, 2004</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Laptop mode is used to minimize the time that the hard disk needs to be spun up,<br>to conserve battery power on laptops. It has been reported to cause significant<br>power savings.</p>
<h2 id="Contents"><a href="#Contents" class="headerlink" title="Contents"></a>Contents</h2><ul>
<li>Introduction</li>
<li>Installation</li>
<li>Caveats</li>
<li>The Details</li>
<li>Tips &amp; Tricks</li>
<li>Control script</li>
<li>ACPI integration</li>
<li>Monitoring tool</li>
</ul>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><p>To use laptop mode, you don’t need to set any kernel configuration options<br>or anything. Simply install all the files included in this document, and<br>laptop mode will automatically be started when you’re on battery. For<br>your convenience, a tarball containing an installer can be downloaded at:</p>
<p><a target="_blank" rel="noopener" href="http://www.samwel.tk/laptop_mode/laptop_mode/">http://www.samwel.tk/laptop_mode/laptop_mode/</a></p>
<p>To configure laptop mode, you need to edit the configuration file, which is<br>located in /etc/default/laptop-mode on Debian-based systems, or in<br>/etc/sysconfig/laptop-mode on other systems.</p>
<p>Unfortunately, automatic enabling of laptop mode does not work for<br>laptops that don’t have ACPI. On those laptops, you need to start laptop<br>mode manually. To start laptop mode, run “laptop_mode start”, and to<br>stop it, run “laptop_mode stop”. (Note: The laptop mode tools package now<br>has experimental support for APM, you might want to try that first.)</p>
<h2 id="Caveats"><a href="#Caveats" class="headerlink" title="Caveats"></a>Caveats</h2><ul>
<li><p>The downside of laptop mode is that you have a chance of losing up to 10<br>minutes of work. If you cannot afford this, don’t use it! The supplied ACPI<br>scripts automatically turn off laptop mode when the battery almost runs out,<br>so that you won’t lose any data at the end of your battery life.</p>
</li>
<li><p>Most desktop hard drives have a very limited lifetime measured in spindown<br>cycles, typically about 50.000 times (it’s usually listed on the spec sheet).<br>Check your drive’s rating, and don’t wear down your drive’s lifetime if you<br>don’t need to.</p>
</li>
<li><p>If you mount some of your ext3/reiserfs filesystems with the -n option, then<br>the control script will not be able to remount them correctly. You must set<br>DO_REMOUNTS=0 in the control script, otherwise it will remount them with the<br>wrong options – or it will fail because it cannot write to /etc/mtab.</p>
</li>
<li><p>If you have your filesystems listed as type “auto” in fstab, like I did, then<br>the control script will not recognize them as filesystems that need remounting.<br>You must list the filesystems with their true type instead.</p>
</li>
<li><p>It has been reported that some versions of the mutt mail client use file access<br>times to determine whether a folder contains new mail. If you use mutt and<br>experience this, you must disable the noatime remounting by setting the option<br>DO_REMOUNT_NOATIME to 0 in the configuration file.</p>
</li>
</ul>
<h2 id="The-Details"><a href="#The-Details" class="headerlink" title="The Details"></a>The Details</h2><p>Laptop mode is controlled by the knob /proc/sys/vm/laptop_mode. This knob is<br>present for all kernels that have the laptop mode patch, regardless of any<br>configuration options. When the knob is set, any physical disk I/O (that might<br>have caused the hard disk to spin up) causes Linux to flush all dirty blocks. The<br>result of this is that after a disk has spun down, it will not be spun up<br>anymore to write dirty blocks, because those blocks had already been written<br>immediately after the most recent read operation. The value of the laptop_mode<br>knob determines the time between the occurrence of disk I/O and when the flush<br>is triggered. A sensible value for the knob is 5 seconds. Setting the knob to<br>0 disables laptop mode.</p>
<p>To increase the effectiveness of the laptop_mode strategy, the laptop_mode<br>control script increases dirty_expire_centisecs and dirty_writeback_centisecs in<br>/proc/sys/vm to about 10 minutes (by default), which means that pages that are<br>dirtied are not forced to be written to disk as often. The control script also<br>changes the dirty background ratio, so that background writeback of dirty pages<br>is not done anymore. Combined with a higher commit value (also 10 minutes) for<br>ext3 or ReiserFS filesystems (also done automatically by the control script),<br>this results in concentration of disk activity in a small time interval which<br>occurs only once every 10 minutes, or whenever the disk is forced to spin up by<br>a cache miss. The disk can then be spun down in the periods of inactivity.</p>
<p>If you want to find out which process caused the disk to spin up, you can<br>gather information by setting the flag /proc/sys/vm/block_dump. When this flag<br>is set, Linux reports all disk read and write operations that take place, and<br>all block dirtyings done to files. This makes it possible to debug why a disk<br>needs to spin up, and to increase battery life even more. The output of<br>block_dump is written to the kernel output, and it can be retrieved using<br>“dmesg”. When you use block_dump and your kernel logging level also includes<br>kernel debugging messages, you probably want to turn off klogd, otherwise<br>the output of block_dump will be logged, causing disk activity that is not<br>normally there.</p>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>The laptop mode configuration file is located in /etc/default/laptop-mode on<br>Debian-based systems, or in /etc/sysconfig/laptop-mode on other systems. It<br>contains the following options:</p>
<p>MAX_AGE:</p>
<p>Maximum time, in seconds, of hard drive spindown time that you are<br>comfortable with. Worst case, it’s possible that you could lose this<br>amount of work if your battery fails while you’re in laptop mode.</p>
<p>MINIMUM_BATTERY_MINUTES:</p>
<p>Automatically disable laptop mode if the remaining number of minutes of<br>battery power is less than this value. Default is 10 minutes.</p>
<p>AC_HD/BATT_HD:</p>
<p>The idle timeout that should be set on your hard drive when laptop mode<br>is active (BATT_HD) and when it is not active (AC_HD). The defaults are<br>20 seconds (value 4) for BATT_HD  and 2 hours (value 244) for AC_HD. The<br>possible values are those listed in the manual page for “hdparm” for the<br>“-S” option.</p>
<p>HD:</p>
<p>The devices for which the spindown timeout should be adjusted by laptop mode.<br>Default is /dev/hda. If you specify multiple devices, separate them by a space.</p>
<p>READAHEAD:</p>
<p>Disk readahead, in 512-byte sectors, while laptop mode is active. A large<br>readahead can prevent disk accesses for things like executable pages (which are<br>loaded on demand while the application executes) and sequentially accessed data<br>(MP3s).</p>
<p>DO_REMOUNTS:</p>
<p>The control script automatically remounts any mounted journaled filesystems<br>with appropriate commit interval options. When this option is set to 0, this<br>feature is disabled.</p>
<p>DO_REMOUNT_NOATIME:</p>
<p>When remounting, should the filesystems be remounted with the noatime option?<br>Normally, this is set to “1” (enabled), but there may be programs that require<br>access time recording.</p>
<p>DIRTY_RATIO:</p>
<p>The percentage of memory that is allowed to contain “dirty” or unsaved data<br>before a writeback is forced, while laptop mode is active. Corresponds to<br>the /proc/sys/vm/dirty_ratio sysctl.</p>
<p>DIRTY_BACKGROUND_RATIO:</p>
<p>The percentage of memory that is allowed to contain “dirty” or unsaved data<br>after a forced writeback is done due to an exceeding of DIRTY_RATIO. Set<br>this nice and low. This corresponds to the /proc/sys/vm/dirty_background_ratio<br>sysctl.</p>
<p>Note that the behaviour of dirty_background_ratio is quite different<br>when laptop mode is active and when it isn’t. When laptop mode is inactive,<br>dirty_background_ratio is the threshold percentage at which background writeouts<br>start taking place. When laptop mode is active, however, background writeouts<br>are disabled, and the dirty_background_ratio only determines how much writeback<br>is done when dirty_ratio is reached.</p>
<p>DO_CPU:</p>
<p>Enable CPU frequency scaling when in laptop mode. (Requires CPUFreq to be setup.<br>See Documentation/cpu-freq/user-guide.txt for more info. Disabled by default.)</p>
<p>CPU_MAXFREQ:</p>
<p>When on battery, what is the maximum CPU speed that the system should use? Legal<br>values are “slowest” for the slowest speed that your CPU is able to operate at,<br>or a value listed in /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_frequencies.</p>
<h2 id="Tips-amp-Tricks"><a href="#Tips-amp-Tricks" class="headerlink" title="Tips &amp; Tricks"></a>Tips &amp; Tricks</h2><ul>
<li><p>Bartek Kania reports getting up to 50 minutes of extra battery life (on top<br>of his regular 3 to 3.5 hours) using a spindown time of 5 seconds (BATT_HD=1).</p>
</li>
<li><p>You can spin down the disk while playing MP3, by setting disk readahead<br>to 8MB (READAHEAD=16384). Effectively, the disk will read a complete MP3 at<br>once, and will then spin down while the MP3 is playing. (Thanks to Bartek<br>Kania.)</p>
</li>
<li><p>Drew Scott Daniels observed: “I don’t know why, but when I decrease the number<br>of colours that my display uses it consumes less battery power. I’ve seen<br>this on powerbooks too. I hope that this is a piece of information that<br>might be useful to the Laptop Mode patch or it’s users.”</p>
</li>
<li><p>In syslog.conf, you can prefix entries with a dash ``-‘’ to omit syncing the<br>file after every logging. When you’re using laptop-mode and your disk doesn’t<br>spin down, this is a likely culprit.</p>
</li>
<li><p>Richard Atterer observed that laptop mode does not work well with noflushd<br>(<a target="_blank" rel="noopener" href="http://noflushd.sourceforge.net/">http://noflushd.sourceforge.net/</a>), it seems that noflushd prevents laptop-mode<br>from doing its thing.</p>
</li>
<li><p>If you’re worried about your data, you might want to consider using a USB<br>memory stick or something like that as a “working area”. (Be aware though<br>that flash memory can only handle a limited number of writes, and overuse<br>may wear out your memory stick pretty quickly. Do <em>not</em> use journalling<br>filesystems on flash memory sticks.)</p>
</li>
</ul>
<h2 id="Configuration-file-for-control-and-ACPI-battery-scripts"><a href="#Configuration-file-for-control-and-ACPI-battery-scripts" class="headerlink" title="Configuration file for control and ACPI battery scripts"></a>Configuration file for control and ACPI battery scripts</h2><p>This allows the tunables to be changed for the scripts via an external<br>configuration file</p>
<p>It should be installed as /etc/default/laptop-mode on Debian, and as<br>/etc/sysconfig/laptop-mode on Red Hat, SUSE, Mandrake, and other work-alikes.</p>
<p>——————–CONFIG FILE BEGIN——————————————-</p>
<h1 id="Maximum-time-in-seconds-of-hard-drive-spindown-time-that-you-are"><a href="#Maximum-time-in-seconds-of-hard-drive-spindown-time-that-you-are" class="headerlink" title="Maximum time, in seconds, of hard drive spindown time that you are"></a>Maximum time, in seconds, of hard drive spindown time that you are</h1><h1 id="comfortable-with-Worst-case-it’s-possible-that-you-could-lose-this"><a href="#comfortable-with-Worst-case-it’s-possible-that-you-could-lose-this" class="headerlink" title="comfortable with. Worst case, it’s possible that you could lose this"></a>comfortable with. Worst case, it’s possible that you could lose this</h1><h1 id="amount-of-work-if-your-battery-fails-you-while-in-laptop-mode"><a href="#amount-of-work-if-your-battery-fails-you-while-in-laptop-mode" class="headerlink" title="amount of work if your battery fails you while in laptop mode."></a>amount of work if your battery fails you while in laptop mode.</h1><p>#MAX_AGE=600</p>
<h1 id="Automatically-disable-laptop-mode-when-the-number-of-minutes-of-battery"><a href="#Automatically-disable-laptop-mode-when-the-number-of-minutes-of-battery" class="headerlink" title="Automatically disable laptop mode when the number of minutes of battery"></a>Automatically disable laptop mode when the number of minutes of battery</h1><h1 id="that-you-have-left-goes-below-this-threshold"><a href="#that-you-have-left-goes-below-this-threshold" class="headerlink" title="that you have left goes below this threshold."></a>that you have left goes below this threshold.</h1><p>MINIMUM_BATTERY_MINUTES=10</p>
<h1 id="Read-ahead-in-512-byte-sectors-You-can-spin-down-the-disk-while-playing-MP3-OGG"><a href="#Read-ahead-in-512-byte-sectors-You-can-spin-down-the-disk-while-playing-MP3-OGG" class="headerlink" title="Read-ahead, in 512-byte sectors. You can spin down the disk while playing MP3/OGG"></a>Read-ahead, in 512-byte sectors. You can spin down the disk while playing MP3/OGG</h1><h1 id="by-setting-the-disk-readahead-to-8MB-READAHEAD-16384-Effectively-the-disk"><a href="#by-setting-the-disk-readahead-to-8MB-READAHEAD-16384-Effectively-the-disk" class="headerlink" title="by setting the disk readahead to 8MB (READAHEAD=16384). Effectively, the disk"></a>by setting the disk readahead to 8MB (READAHEAD=16384). Effectively, the disk</h1><h1 id="will-read-a-complete-MP3-at-once-and-will-then-spin-down-while-the-MP3-OGG-is"><a href="#will-read-a-complete-MP3-at-once-and-will-then-spin-down-while-the-MP3-OGG-is" class="headerlink" title="will read a complete MP3 at once, and will then spin down while the MP3/OGG is"></a>will read a complete MP3 at once, and will then spin down while the MP3/OGG is</h1><h1 id="playing"><a href="#playing" class="headerlink" title="playing."></a>playing.</h1><p>#READAHEAD=4096</p>
<h1 id="Shall-we-remount-journaled-fs-with-appropriate-commit-interval-1-yes"><a href="#Shall-we-remount-journaled-fs-with-appropriate-commit-interval-1-yes" class="headerlink" title="Shall we remount journaled fs. with appropriate commit interval? (1=yes)"></a>Shall we remount journaled fs. with appropriate commit interval? (1=yes)</h1><p>#DO_REMOUNTS=1</p>
<h1 id="And-shall-we-add-the-“noatime”-option-to-that-as-well-1-yes"><a href="#And-shall-we-add-the-“noatime”-option-to-that-as-well-1-yes" class="headerlink" title="And shall we add the “noatime” option to that as well? (1=yes)"></a>And shall we add the “noatime” option to that as well? (1=yes)</h1><p>#DO_REMOUNT_NOATIME=1</p>
<h1 id="Dirty-synchronous-ratio-At-this-percentage-of-dirty-pages-the-process"><a href="#Dirty-synchronous-ratio-At-this-percentage-of-dirty-pages-the-process" class="headerlink" title="Dirty synchronous ratio.  At this percentage of dirty pages the process"></a>Dirty synchronous ratio.  At this percentage of dirty pages the process</h1><h1 id="which"><a href="#which" class="headerlink" title="which"></a>which</h1><h1 id="calls-write-does-its-own-writeback"><a href="#calls-write-does-its-own-writeback" class="headerlink" title="calls write() does its own writeback"></a>calls write() does its own writeback</h1><p>#DIRTY_RATIO=40</p>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="Allowed-dirty-background-ratio-in-percent-Once-DIRTY-RATIO-has-been"><a href="#Allowed-dirty-background-ratio-in-percent-Once-DIRTY-RATIO-has-been" class="headerlink" title="Allowed dirty background ratio, in percent.  Once DIRTY_RATIO has been"></a>Allowed dirty background ratio, in percent.  Once DIRTY_RATIO has been</h1><h1 id="exceeded-the-kernel-will-wake-flusher-threads-which-will-then-reduce-the"><a href="#exceeded-the-kernel-will-wake-flusher-threads-which-will-then-reduce-the" class="headerlink" title="exceeded, the kernel will wake flusher threads which will then reduce the"></a>exceeded, the kernel will wake flusher threads which will then reduce the</h1><h1 id="amount-of-dirty-memory-to-dirty-background-ratio-Set-this-nice-and-low"><a href="#amount-of-dirty-memory-to-dirty-background-ratio-Set-this-nice-and-low" class="headerlink" title="amount of dirty memory to dirty_background_ratio.  Set this nice and low,"></a>amount of dirty memory to dirty_background_ratio.  Set this nice and low,</h1><h1 id="so-once-some-writeout-has-commenced-we-do-a-lot-of-it"><a href="#so-once-some-writeout-has-commenced-we-do-a-lot-of-it" class="headerlink" title="so once some writeout has commenced, we do a lot of it."></a>so once some writeout has commenced, we do a lot of it.</h1><h1 id="-1"><a href="#-1" class="headerlink" title=""></a></h1><p>#DIRTY_BACKGROUND_RATIO=5</p>
<h1 id="kernel-default-dirty-buffer-age"><a href="#kernel-default-dirty-buffer-age" class="headerlink" title="kernel default dirty buffer age"></a>kernel default dirty buffer age</h1><p>#DEF_AGE=30<br>#DEF_UPDATE=5<br>#DEF_DIRTY_BACKGROUND_RATIO=10<br>#DEF_DIRTY_RATIO=40<br>#DEF_XFS_AGE_BUFFER=15<br>#DEF_XFS_SYNC_INTERVAL=30<br>#DEF_XFS_BUFD_INTERVAL=1</p>
<h1 id="This-must-be-adjusted-manually-to-the-value-of-HZ-in-the-running-kernel"><a href="#This-must-be-adjusted-manually-to-the-value-of-HZ-in-the-running-kernel" class="headerlink" title="This must be adjusted manually to the value of HZ in the running kernel"></a>This must be adjusted manually to the value of HZ in the running kernel</h1><h1 id="on-2-4-until-the-XFS-people-change-their-2-4-external-interfaces-to-work-in"><a href="#on-2-4-until-the-XFS-people-change-their-2-4-external-interfaces-to-work-in" class="headerlink" title="on 2.4, until the XFS people change their 2.4 external interfaces to work in"></a>on 2.4, until the XFS people change their 2.4 external interfaces to work in</h1><h1 id="centisecs-This-can-be-automated-but-it’s-a-work-in-progress-that-still"><a href="#centisecs-This-can-be-automated-but-it’s-a-work-in-progress-that-still" class="headerlink" title="centisecs. This can be automated, but it’s a work in progress that still"></a>centisecs. This can be automated, but it’s a work in progress that still</h1><h1 id="needs-some-fixes-On-2-6-kernels-XFS-uses-USER-HZ-instead-of-HZ-for"><a href="#needs-some-fixes-On-2-6-kernels-XFS-uses-USER-HZ-instead-of-HZ-for" class="headerlink" title="needs# some fixes. On 2.6 kernels, XFS uses USER_HZ instead of HZ for"></a>needs# some fixes. On 2.6 kernels, XFS uses USER_HZ instead of HZ for</h1><h1 id="external-interfaces-and-that-is-currently-always-set-to-100-So-you-don’t"><a href="#external-interfaces-and-that-is-currently-always-set-to-100-So-you-don’t" class="headerlink" title="external interfaces, and that is currently always set to 100. So you don’t"></a>external interfaces, and that is currently always set to 100. So you don’t</h1><h1 id="need-to-change-this-on-2-6"><a href="#need-to-change-this-on-2-6" class="headerlink" title="need to change this on 2.6."></a>need to change this on 2.6.</h1><p>#XFS_HZ=100</p>
<h1 id="Should-the-maximum-CPU-frequency-be-adjusted-down-while-on-battery"><a href="#Should-the-maximum-CPU-frequency-be-adjusted-down-while-on-battery" class="headerlink" title="Should the maximum CPU frequency be adjusted down while on battery?"></a>Should the maximum CPU frequency be adjusted down while on battery?</h1><h1 id="Requires-CPUFreq-to-be-setup"><a href="#Requires-CPUFreq-to-be-setup" class="headerlink" title="Requires CPUFreq to be setup."></a>Requires CPUFreq to be setup.</h1><h1 id="See-Documentation-cpu-freq-user-guide-txt-for-more-info"><a href="#See-Documentation-cpu-freq-user-guide-txt-for-more-info" class="headerlink" title="See Documentation/cpu-freq/user-guide.txt for more info"></a>See Documentation/cpu-freq/user-guide.txt for more info</h1><p>#DO_CPU=0</p>
<h1 id="When-on-battery-what-is-the-maximum-CPU-speed-that-the-system-should"><a href="#When-on-battery-what-is-the-maximum-CPU-speed-that-the-system-should" class="headerlink" title="When on battery what is the maximum CPU speed that the system should"></a>When on battery what is the maximum CPU speed that the system should</h1><h1 id="use-Legal-values-are-“slowest”-for-the-slowest-speed-that-your"><a href="#use-Legal-values-are-“slowest”-for-the-slowest-speed-that-your" class="headerlink" title="use? Legal values are “slowest” for the slowest speed that your"></a>use? Legal values are “slowest” for the slowest speed that your</h1><h1 id="CPU-is-able-to-operate-at-or-a-value-listed-in"><a href="#CPU-is-able-to-operate-at-or-a-value-listed-in" class="headerlink" title="CPU is able to operate at, or a value listed in:"></a>CPU is able to operate at, or a value listed in:</h1><h1 id="sys-devices-system-cpu-cpu0-cpufreq-scaling-available-frequencies"><a href="#sys-devices-system-cpu-cpu0-cpufreq-scaling-available-frequencies" class="headerlink" title="/sys/devices/system/cpu/cpu0/cpufreq/scaling_available_frequencies"></a>/sys/devices/system/cpu/cpu0/cpufreq/scaling_available_frequencies</h1><h1 id="Only-applicable-if-DO-CPU-1"><a href="#Only-applicable-if-DO-CPU-1" class="headerlink" title="Only applicable if DO_CPU=1."></a>Only applicable if DO_CPU=1.</h1><p>#CPU_MAXFREQ=slowest</p>
<h1 id="Idle-timeout-for-your-hard-drive-man-hdparm-for-valid-values-S-option"><a href="#Idle-timeout-for-your-hard-drive-man-hdparm-for-valid-values-S-option" class="headerlink" title="Idle timeout for your hard drive (man hdparm for valid values, -S option)"></a>Idle timeout for your hard drive (man hdparm for valid values, -S option)</h1><h1 id="Default-is-2-hours-on-AC-AC-HD-244-and-20-seconds-for-battery-BATT-HD-4"><a href="#Default-is-2-hours-on-AC-AC-HD-244-and-20-seconds-for-battery-BATT-HD-4" class="headerlink" title="Default is 2 hours on AC (AC_HD=244) and 20 seconds for battery (BATT_HD=4)."></a>Default is 2 hours on AC (AC_HD=244) and 20 seconds for battery (BATT_HD=4).</h1><p>#AC_HD=244<br>#BATT_HD=4</p>
<h1 id="The-drives-for-which-to-adjust-the-idle-timeout-Separate-them-by-a-space"><a href="#The-drives-for-which-to-adjust-the-idle-timeout-Separate-them-by-a-space" class="headerlink" title="The drives for which to adjust the idle timeout. Separate them by a space,"></a>The drives for which to adjust the idle timeout. Separate them by a space,</h1><h1 id="e-g-HD-”-dev-hda-dev-hdb”"><a href="#e-g-HD-”-dev-hda-dev-hdb”" class="headerlink" title="e.g. HD=”/dev/hda /dev/hdb”."></a>e.g. HD=”/dev/hda /dev/hdb”.</h1><p>#HD=”/dev/hda”</p>
<h1 id="Set-the-spindown-timeout-on-a-hard-drive"><a href="#Set-the-spindown-timeout-on-a-hard-drive" class="headerlink" title="Set the spindown timeout on a hard drive?"></a>Set the spindown timeout on a hard drive?</h1><p>#DO_HD=1</p>
<p>——————–CONFIG FILE END———————————————</p>
<h2 id="Control-script"><a href="#Control-script" class="headerlink" title="Control script"></a>Control script</h2><p>Please note that this control script works for the Linux 2.4 and 2.6 series (thanks<br>to Kiko Piris).</p>
<p>——————–CONTROL SCRIPT BEGIN—————————————-<br>#!/bin/bash</p>
<h1 id="start-or-stop-laptop-mode-best-run-by-a-power-management-daemon-when"><a href="#start-or-stop-laptop-mode-best-run-by-a-power-management-daemon-when" class="headerlink" title="start or stop laptop_mode, best run by a power management daemon when"></a>start or stop laptop_mode, best run by a power management daemon when</h1><h1 id="ac-gets-connected-disconnected-from-a-laptop"><a href="#ac-gets-connected-disconnected-from-a-laptop" class="headerlink" title="ac gets connected/disconnected from a laptop"></a>ac gets connected/disconnected from a laptop</h1><h1 id="-2"><a href="#-2" class="headerlink" title=""></a></h1><h1 id="install-as-sbin-laptop-mode"><a href="#install-as-sbin-laptop-mode" class="headerlink" title="install as /sbin/laptop_mode"></a>install as /sbin/laptop_mode</h1><h1 id="-3"><a href="#-3" class="headerlink" title=""></a></h1><h1 id="Contributors-to-this-script-Kiko-Piris"><a href="#Contributors-to-this-script-Kiko-Piris" class="headerlink" title="Contributors to this script:   Kiko Piris"></a>Contributors to this script:   Kiko Piris</h1><h1 id="Bart-Samwel"><a href="#Bart-Samwel" class="headerlink" title="Bart Samwel"></a>Bart Samwel</h1><h1 id="Micha-Feigin"><a href="#Micha-Feigin" class="headerlink" title="Micha Feigin"></a>Micha Feigin</h1><h1 id="Andrew-Morton"><a href="#Andrew-Morton" class="headerlink" title="Andrew Morton"></a>Andrew Morton</h1><h1 id="Herve-Eychenne"><a href="#Herve-Eychenne" class="headerlink" title="Herve Eychenne"></a>Herve Eychenne</h1><h1 id="Dax-Kelson"><a href="#Dax-Kelson" class="headerlink" title="Dax Kelson"></a>Dax Kelson</h1><h1 id="-4"><a href="#-4" class="headerlink" title=""></a></h1><h1 id="Original-Linux-2-4-version-by-Jens-Axboe"><a href="#Original-Linux-2-4-version-by-Jens-Axboe" class="headerlink" title="Original Linux 2.4 version by: Jens Axboe"></a>Original Linux 2.4 version by: Jens Axboe</h1><p>#############################################################################</p>
<h1 id="Source-config"><a href="#Source-config" class="headerlink" title="Source config"></a>Source config</h1><p>if [ -f /etc/default/laptop-mode ] ; then<br>    # Debian<br>    . /etc/default/laptop-mode<br>elif [ -f /etc/sysconfig/laptop-mode ] ; then<br>    # Others<br>        . /etc/sysconfig/laptop-mode<br>fi</p>
<h1 id="Don’t-raise-an-error-if-the-config-file-is-incomplete"><a href="#Don’t-raise-an-error-if-the-config-file-is-incomplete" class="headerlink" title="Don’t raise an error if the config file is incomplete"></a>Don’t raise an error if the config file is incomplete</h1><h1 id="set-defaults-instead"><a href="#set-defaults-instead" class="headerlink" title="set defaults instead:"></a>set defaults instead:</h1><h1 id="Maximum-time-in-seconds-of-hard-drive-spindown-time-that-you-are-1"><a href="#Maximum-time-in-seconds-of-hard-drive-spindown-time-that-you-are-1" class="headerlink" title="Maximum time, in seconds, of hard drive spindown time that you are"></a>Maximum time, in seconds, of hard drive spindown time that you are</h1><h1 id="comfortable-with-Worst-case-it’s-possible-that-you-could-lose-this-1"><a href="#comfortable-with-Worst-case-it’s-possible-that-you-could-lose-this-1" class="headerlink" title="comfortable with. Worst case, it’s possible that you could lose this"></a>comfortable with. Worst case, it’s possible that you could lose this</h1><h1 id="amount-of-work-if-your-battery-fails-you-while-in-laptop-mode-1"><a href="#amount-of-work-if-your-battery-fails-you-while-in-laptop-mode-1" class="headerlink" title="amount of work if your battery fails you while in laptop mode."></a>amount of work if your battery fails you while in laptop mode.</h1><p>MAX_AGE=${MAX_AGE:-‘600’}</p>
<h1 id="Read-ahead-in-kilobytes"><a href="#Read-ahead-in-kilobytes" class="headerlink" title="Read-ahead, in kilobytes"></a>Read-ahead, in kilobytes</h1><p>READAHEAD=${READAHEAD:-‘4096’}</p>
<h1 id="Shall-we-remount-journaled-fs-with-appropriate-commit-interval-1-yes-1"><a href="#Shall-we-remount-journaled-fs-with-appropriate-commit-interval-1-yes-1" class="headerlink" title="Shall we remount journaled fs. with appropriate commit interval? (1=yes)"></a>Shall we remount journaled fs. with appropriate commit interval? (1=yes)</h1><p>DO_REMOUNTS=${DO_REMOUNTS:-‘1’}</p>
<h1 id="And-shall-we-add-the-“noatime”-option-to-that-as-well-1-yes-1"><a href="#And-shall-we-add-the-“noatime”-option-to-that-as-well-1-yes-1" class="headerlink" title="And shall we add the “noatime” option to that as well? (1=yes)"></a>And shall we add the “noatime” option to that as well? (1=yes)</h1><p>DO_REMOUNT_NOATIME=${DO_REMOUNT_NOATIME:-‘1’}</p>
<h1 id="Shall-we-adjust-the-idle-timeout-on-a-hard-drive"><a href="#Shall-we-adjust-the-idle-timeout-on-a-hard-drive" class="headerlink" title="Shall we adjust the idle timeout on a hard drive?"></a>Shall we adjust the idle timeout on a hard drive?</h1><p>DO_HD=${DO_HD:-‘1’}</p>
<h1 id="Adjust-idle-timeout-on-which-hard-drive"><a href="#Adjust-idle-timeout-on-which-hard-drive" class="headerlink" title="Adjust idle timeout on which hard drive?"></a>Adjust idle timeout on which hard drive?</h1><p>HD=”${HD:-‘/dev/hda’}”</p>
<h1 id="spindown-time-for-HD-hdparm-S-values"><a href="#spindown-time-for-HD-hdparm-S-values" class="headerlink" title="spindown time for HD (hdparm -S values)"></a>spindown time for HD (hdparm -S values)</h1><p>AC_HD=${AC_HD:-‘244’}<br>BATT_HD=${BATT_HD:-‘4’}</p>
<h1 id="Dirty-synchronous-ratio-At-this-percentage-of-dirty-pages-the-process-which"><a href="#Dirty-synchronous-ratio-At-this-percentage-of-dirty-pages-the-process-which" class="headerlink" title="Dirty synchronous ratio.  At this percentage of dirty pages the process which"></a>Dirty synchronous ratio.  At this percentage of dirty pages the process which</h1><h1 id="calls-write-does-its-own-writeback-1"><a href="#calls-write-does-its-own-writeback-1" class="headerlink" title="calls write() does its own writeback"></a>calls write() does its own writeback</h1><p>DIRTY_RATIO=${DIRTY_RATIO:-‘40’}</p>
<h1 id="cpu-frequency-scaling"><a href="#cpu-frequency-scaling" class="headerlink" title="cpu frequency scaling"></a>cpu frequency scaling</h1><h1 id="See-Documentation-cpu-freq-user-guide-txt-for-more-info-1"><a href="#See-Documentation-cpu-freq-user-guide-txt-for-more-info-1" class="headerlink" title="See Documentation/cpu-freq/user-guide.txt for more info"></a>See Documentation/cpu-freq/user-guide.txt for more info</h1><p>DO_CPU=${CPU_MANAGE:-‘0’}<br>CPU_MAXFREQ=${CPU_MAXFREQ:-‘slowest’}</p>
<h1 id="-5"><a href="#-5" class="headerlink" title=""></a></h1><h1 id="Allowed-dirty-background-ratio-in-percent-Once-DIRTY-RATIO-has-been-1"><a href="#Allowed-dirty-background-ratio-in-percent-Once-DIRTY-RATIO-has-been-1" class="headerlink" title="Allowed dirty background ratio, in percent.  Once DIRTY_RATIO has been"></a>Allowed dirty background ratio, in percent.  Once DIRTY_RATIO has been</h1><h1 id="exceeded-the-kernel-will-wake-flusher-threads-which-will-then-reduce-the-1"><a href="#exceeded-the-kernel-will-wake-flusher-threads-which-will-then-reduce-the-1" class="headerlink" title="exceeded, the kernel will wake flusher threads which will then reduce the"></a>exceeded, the kernel will wake flusher threads which will then reduce the</h1><h1 id="amount-of-dirty-memory-to-dirty-background-ratio-Set-this-nice-and-low-1"><a href="#amount-of-dirty-memory-to-dirty-background-ratio-Set-this-nice-and-low-1" class="headerlink" title="amount of dirty memory to dirty_background_ratio.  Set this nice and low,"></a>amount of dirty memory to dirty_background_ratio.  Set this nice and low,</h1><h1 id="so-once-some-writeout-has-commenced-we-do-a-lot-of-it-1"><a href="#so-once-some-writeout-has-commenced-we-do-a-lot-of-it-1" class="headerlink" title="so once some writeout has commenced, we do a lot of it."></a>so once some writeout has commenced, we do a lot of it.</h1><h1 id="-6"><a href="#-6" class="headerlink" title=""></a></h1><p>DIRTY_BACKGROUND_RATIO=${DIRTY_BACKGROUND_RATIO:-‘5’}</p>
<h1 id="kernel-default-dirty-buffer-age-1"><a href="#kernel-default-dirty-buffer-age-1" class="headerlink" title="kernel default dirty buffer age"></a>kernel default dirty buffer age</h1><p>DEF_AGE=${DEF_AGE:-‘30’}<br>DEF_UPDATE=${DEF_UPDATE:-‘5’}<br>DEF_DIRTY_BACKGROUND_RATIO=${DEF_DIRTY_BACKGROUND_RATIO:-‘10’}<br>DEF_DIRTY_RATIO=${DEF_DIRTY_RATIO:-‘40’}<br>DEF_XFS_AGE_BUFFER=${DEF_XFS_AGE_BUFFER:-‘15’}<br>DEF_XFS_SYNC_INTERVAL=${DEF_XFS_SYNC_INTERVAL:-‘30’}<br>DEF_XFS_BUFD_INTERVAL=${DEF_XFS_BUFD_INTERVAL:-‘1’}</p>
<h1 id="This-must-be-adjusted-manually-to-the-value-of-HZ-in-the-running-kernel-1"><a href="#This-must-be-adjusted-manually-to-the-value-of-HZ-in-the-running-kernel-1" class="headerlink" title="This must be adjusted manually to the value of HZ in the running kernel"></a>This must be adjusted manually to the value of HZ in the running kernel</h1><h1 id="on-2-4-until-the-XFS-people-change-their-2-4-external-interfaces-to-work-in-1"><a href="#on-2-4-until-the-XFS-people-change-their-2-4-external-interfaces-to-work-in-1" class="headerlink" title="on 2.4, until the XFS people change their 2.4 external interfaces to work in"></a>on 2.4, until the XFS people change their 2.4 external interfaces to work in</h1><h1 id="centisecs-This-can-be-automated-but-it’s-a-work-in-progress-that-still-needs"><a href="#centisecs-This-can-be-automated-but-it’s-a-work-in-progress-that-still-needs" class="headerlink" title="centisecs. This can be automated, but it’s a work in progress that still needs"></a>centisecs. This can be automated, but it’s a work in progress that still needs</h1><h1 id="some-fixes-On-2-6-kernels-XFS-uses-USER-HZ-instead-of-HZ-for-external"><a href="#some-fixes-On-2-6-kernels-XFS-uses-USER-HZ-instead-of-HZ-for-external" class="headerlink" title="some fixes. On 2.6 kernels, XFS uses USER_HZ instead of HZ for external"></a>some fixes. On 2.6 kernels, XFS uses USER_HZ instead of HZ for external</h1><h1 id="interfaces-and-that-is-currently-always-set-to-100-So-you-don’t-need-to"><a href="#interfaces-and-that-is-currently-always-set-to-100-So-you-don’t-need-to" class="headerlink" title="interfaces, and that is currently always set to 100. So you don’t need to"></a>interfaces, and that is currently always set to 100. So you don’t need to</h1><h1 id="change-this-on-2-6"><a href="#change-this-on-2-6" class="headerlink" title="change this on 2.6."></a>change this on 2.6.</h1><p>XFS_HZ=${XFS_HZ:-‘100’}</p>
<p>#############################################################################</p>
<p>KLEVEL=”$(uname -r |<br>             {<br>           IFS=’.’ read a b c<br>           echo $a.$b<br>         }<br>)”<br>case “$KLEVEL” in<br>    “2.4”|”2.6”)<br>        ;;<br>    *)<br>        echo “Unhandled kernel version: $KLEVEL (‘uname -r’ = ‘$(uname -r)’)” &gt;&amp;2<br>        exit 1<br>        ;;<br>esac</p>
<p>if [ ! -e /proc/sys/vm/laptop_mode ] ; then<br>    echo “Kernel is not patched with laptop_mode patch.” &gt;&amp;2<br>    exit 1<br>fi</p>
<p>if [ ! -w /proc/sys/vm/laptop_mode ] ; then<br>    echo “You do not have enough privileges to enable laptop_mode.” &gt;&amp;2<br>    exit 1<br>fi</p>
<h1 id="Remove-an-option-the-first-parameter-of-the-form-option-from"><a href="#Remove-an-option-the-first-parameter-of-the-form-option-from" class="headerlink" title="Remove an option (the first parameter) of the form option= from"></a>Remove an option (the first parameter) of the form option=<number> from</h1><h1 id="a-mount-options-string-the-rest-of-the-parameters"><a href="#a-mount-options-string-the-rest-of-the-parameters" class="headerlink" title="a mount options string (the rest of the parameters)."></a>a mount options string (the rest of the parameters).</h1><p>parse_mount_opts () {<br>    OPT=”$1”<br>    shift<br>    echo “,$<em>,” | sed        <br>     -e ‘s/,’”$OPT”‘=[0-9]</em>,/,/g’    <br>     -e ‘s/,,*/,/g’            <br>     -e ‘s/^,//‘            <br>     -e ‘s/,$//‘<br>}</p>
<h1 id="Remove-an-option-the-first-parameter-without-any-arguments-from"><a href="#Remove-an-option-the-first-parameter-without-any-arguments-from" class="headerlink" title="Remove an option (the first parameter) without any arguments from"></a>Remove an option (the first parameter) without any arguments from</h1><h1 id="a-mount-option-string-the-rest-of-the-parameters"><a href="#a-mount-option-string-the-rest-of-the-parameters" class="headerlink" title="a mount option string (the rest of the parameters)."></a>a mount option string (the rest of the parameters).</h1><p>parse_nonumber_mount_opts () {<br>    OPT=”$1”<br>    shift<br>    echo “,$<em>,” | sed        <br>     -e ‘s/,’”$OPT”‘,/,/g’        <br>     -e ‘s/,,</em>/,/g’            <br>     -e ‘s/^,//‘            <br>     -e ‘s/,$//‘<br>}</p>
<h1 id="Find-out-the-state-of-a-yes-no-option-e-g-“atime”-“noatime”-in"><a href="#Find-out-the-state-of-a-yes-no-option-e-g-“atime”-“noatime”-in" class="headerlink" title="Find out the state of a yes/no option (e.g. “atime”/“noatime”) in"></a>Find out the state of a yes/no option (e.g. “atime”/“noatime”) in</h1><h1 id="fstab-for-a-given-filesystem-and-use-this-state-to-replace-the"><a href="#fstab-for-a-given-filesystem-and-use-this-state-to-replace-the" class="headerlink" title="fstab for a given filesystem, and use this state to replace the"></a>fstab for a given filesystem, and use this state to replace the</h1><h1 id="value-of-the-option-in-another-mount-options-string-The-device"><a href="#value-of-the-option-in-another-mount-options-string-The-device" class="headerlink" title="value of the option in another mount options string. The device"></a>value of the option in another mount options string. The device</h1><h1 id="is-the-first-argument-the-option-name-the-second-and-the-default"><a href="#is-the-first-argument-the-option-name-the-second-and-the-default" class="headerlink" title="is the first argument, the option name the second, and the default"></a>is the first argument, the option name the second, and the default</h1><h1 id="value-the-third-The-remainder-is-the-mount-options-string"><a href="#value-the-third-The-remainder-is-the-mount-options-string" class="headerlink" title="value the third. The remainder is the mount options string."></a>value the third. The remainder is the mount options string.</h1><h1 id="-7"><a href="#-7" class="headerlink" title=""></a></h1><h1 id="Example"><a href="#Example" class="headerlink" title="Example:"></a>Example:</h1><h1 id="parse-yesno-opts-wfstab-dev-hda1-atime-atime-defaults-noatime"><a href="#parse-yesno-opts-wfstab-dev-hda1-atime-atime-defaults-noatime" class="headerlink" title="parse_yesno_opts_wfstab /dev/hda1 atime atime defaults,noatime"></a>parse_yesno_opts_wfstab /dev/hda1 atime atime defaults,noatime</h1><h1 id="-8"><a href="#-8" class="headerlink" title=""></a></h1><h1 id="If-fstab-contains-say-“rw”-for-this-filesystem-then-the-result"><a href="#If-fstab-contains-say-“rw”-for-this-filesystem-then-the-result" class="headerlink" title="If fstab contains, say, “rw” for this filesystem, then the result"></a>If fstab contains, say, “rw” for this filesystem, then the result</h1><h1 id="will-be-“defaults-atime”"><a href="#will-be-“defaults-atime”" class="headerlink" title="will be “defaults,atime”."></a>will be “defaults,atime”.</h1><p>parse_yesno_opts_wfstab () {<br>    L_DEV=”$1”<br>    OPT=”$2”<br>    DEF_OPT=”$3”<br>    shift 3<br>    L_OPTS=”$*”<br>    PARSEDOPTS1=”$(parse_nonumber_mount_opts $OPT $L_OPTS)”<br>    PARSEDOPTS1=”$(parse_nonumber_mount_opts no$OPT $PARSEDOPTS1)”<br>    # Watch for a default atime in fstab<br>    FSTAB_OPTS=”$(awk ‘$1 == “‘$L_DEV’” { print $4 }’ /etc/fstab)”<br>    if echo “$FSTAB_OPTS” | grep “$OPT” &gt; /dev/null ; then<br>        # option specified in fstab: extract the value and use it<br>        if echo “$FSTAB_OPTS” | grep “no$OPT” &gt; /dev/null ; then<br>            echo “$PARSEDOPTS1,no$OPT”<br>        else<br>            # no$OPT not found – so we must have $OPT.<br>            echo “$PARSEDOPTS1,$OPT”<br>        fi<br>    else<br>        # option not specified in fstab – choose the default.<br>        echo “$PARSEDOPTS1,$DEF_OPT”<br>    fi<br>}</p>
<h1 id="Find-out-the-state-of-a-numbered-option-e-g-“commit-NNN”-in"><a href="#Find-out-the-state-of-a-numbered-option-e-g-“commit-NNN”-in" class="headerlink" title="Find out the state of a numbered option (e.g. “commit=NNN”) in"></a>Find out the state of a numbered option (e.g. “commit=NNN”) in</h1><h1 id="fstab-for-a-given-filesystem-and-use-this-state-to-replace-the-1"><a href="#fstab-for-a-given-filesystem-and-use-this-state-to-replace-the-1" class="headerlink" title="fstab for a given filesystem, and use this state to replace the"></a>fstab for a given filesystem, and use this state to replace the</h1><h1 id="value-of-the-option-in-another-mount-options-string-The-device-1"><a href="#value-of-the-option-in-another-mount-options-string-The-device-1" class="headerlink" title="value of the option in another mount options string. The device"></a>value of the option in another mount options string. The device</h1><h1 id="is-the-first-argument-and-the-option-name-the-second-The"><a href="#is-the-first-argument-and-the-option-name-the-second-The" class="headerlink" title="is the first argument, and the option name the second. The"></a>is the first argument, and the option name the second. The</h1><h1 id="remainder-is-the-mount-options-string-in-which-the-replacement"><a href="#remainder-is-the-mount-options-string-in-which-the-replacement" class="headerlink" title="remainder is the mount options string in which the replacement"></a>remainder is the mount options string in which the replacement</h1><h1 id="must-be-done"><a href="#must-be-done" class="headerlink" title="must be done."></a>must be done.</h1><h1 id="-9"><a href="#-9" class="headerlink" title=""></a></h1><h1 id="Example-1"><a href="#Example-1" class="headerlink" title="Example:"></a>Example:</h1><h1 id="parse-mount-opts-wfstab-dev-hda1-commit-defaults-commit-7"><a href="#parse-mount-opts-wfstab-dev-hda1-commit-defaults-commit-7" class="headerlink" title="parse_mount_opts_wfstab /dev/hda1 commit defaults,commit=7"></a>parse_mount_opts_wfstab /dev/hda1 commit defaults,commit=7</h1><h1 id="-10"><a href="#-10" class="headerlink" title=""></a></h1><h1 id="If-fstab-contains-say-“commit-3-rw”-for-this-filesystem-then-the"><a href="#If-fstab-contains-say-“commit-3-rw”-for-this-filesystem-then-the" class="headerlink" title="If fstab contains, say, “commit=3,rw” for this filesystem, then the"></a>If fstab contains, say, “commit=3,rw” for this filesystem, then the</h1><h1 id="result-will-be-“rw-commit-3”"><a href="#result-will-be-“rw-commit-3”" class="headerlink" title="result will be “rw,commit=3”."></a>result will be “rw,commit=3”.</h1><p>parse_mount_opts_wfstab () {<br>    L_DEV=”$1”<br>    OPT=”$2”<br>    shift 2<br>    L_OPTS=”$<em>“<br>    PARSEDOPTS1=”$(parse_mount_opts $OPT $L_OPTS)”<br>    # Watch for a default commit in fstab<br>    FSTAB_OPTS=”$(awk ‘$1 == “‘$L_DEV’” { print $4 }’ /etc/fstab)”<br>    if echo “$FSTAB_OPTS” | grep “$OPT=” &gt; /dev/null ; then<br>        # option specified in fstab: extract the value, and use it<br>        echo -n “$PARSEDOPTS1,$OPT=”<br>        echo “,$FSTAB_OPTS,” | sed <br>         -e ‘s/.</em>,’”$OPT”‘=//‘    <br>         -e ‘s/,.*//‘<br>    else<br>        # option not specified in fstab: set it to 0<br>        echo “$PARSEDOPTS1,$OPT=0”<br>    fi<br>}</p>
<p>deduce_fstype () {<br>    MP=”$1”<br>    # My root filesystem unfortunately has<br>    # type “unknown” in /etc/mtab. If we encounter<br>    # “unknown”, we try to get the type from fstab.<br>    cat /etc/fstab |<br>    grep -v ‘^#’ |<br>    while read FSTAB_DEV FSTAB_MP FSTAB_FST FSTAB_OPTS FSTAB_DUMP FSTAB_DUMP ; do<br>        if [ “$FSTAB_MP” = “$MP” ]; then<br>            echo $FSTAB_FST<br>            exit 0<br>        fi<br>    done<br>}</p>
<p>if [ $DO_REMOUNT_NOATIME -eq 1 ] ; then<br>    NOATIME_OPT=”,noatime”<br>fi</p>
<p>case “$1” in<br>    start)<br>        AGE=$((100*$MAX_AGE))<br>        XFS_AGE=$(($XFS_HZ*$MAX_AGE))<br>        echo -n “Starting laptop_mode”</p>
<pre><code>    if [ -d /proc/sys/vm/pagebuf ] ; then
        # (For 2.4 and early 2.6.)
        # This only needs to be set, not reset -- it is only used when
        # laptop mode is enabled.
        echo $XFS_AGE &gt; /proc/sys/vm/pagebuf/lm_flush_age
        echo $XFS_AGE &gt; /proc/sys/fs/xfs/lm_sync_interval
    elif [ -f /proc/sys/fs/xfs/lm_age_buffer ] ; then
        # (A couple of early 2.6 laptop mode patches had these.)
        # The same goes for these.
        echo $XFS_AGE &gt; /proc/sys/fs/xfs/lm_age_buffer
        echo $XFS_AGE &gt; /proc/sys/fs/xfs/lm_sync_interval
    elif [ -f /proc/sys/fs/xfs/age_buffer ] ; then
        # (2.6.6)
        # But not for these -- they are also used in normal
        # operation.
        echo $XFS_AGE &gt; /proc/sys/fs/xfs/age_buffer
        echo $XFS_AGE &gt; /proc/sys/fs/xfs/sync_interval
    elif [ -f /proc/sys/fs/xfs/age_buffer_centisecs ] ; then
        # (2.6.7 upwards)
        # And not for these either. These are in centisecs,
        # not USER_HZ, so we have to use $AGE, not $XFS_AGE.
        echo $AGE &gt; /proc/sys/fs/xfs/age_buffer_centisecs
        echo $AGE &gt; /proc/sys/fs/xfs/xfssyncd_centisecs
        echo 3000 &gt; /proc/sys/fs/xfs/xfsbufd_centisecs
    fi

    case &quot;$KLEVEL&quot; in
        &quot;2.4&quot;)
            echo 1                    &gt; /proc/sys/vm/laptop_mode
            echo &quot;30 500 0 0 $AGE $AGE 60 20 0&quot;    &gt; /proc/sys/vm/bdflush
            ;;
        &quot;2.6&quot;)
            echo 5                    &gt; /proc/sys/vm/laptop_mode
            echo &quot;$AGE&quot;                &gt; /proc/sys/vm/dirty_writeback_centisecs
            echo &quot;$AGE&quot;                &gt; /proc/sys/vm/dirty_expire_centisecs
            echo &quot;$DIRTY_RATIO&quot;            &gt; /proc/sys/vm/dirty_ratio
            echo &quot;$DIRTY_BACKGROUND_RATIO&quot;        &gt; /proc/sys/vm/dirty_background_ratio
            ;;
    esac
    if [ $DO_REMOUNTS -eq 1 ]; then
        cat /etc/mtab | while read DEV MP FST OPTS DUMP PASS ; do
            PARSEDOPTS=&quot;$(parse_mount_opts &quot;$OPTS&quot;)&quot;
            if [ &quot;$FST&quot; = &#39;unknown&#39; ]; then
                FST=$(deduce_fstype $MP)
            fi
            case &quot;$FST&quot; in
                &quot;ext3&quot;|&quot;reiserfs&quot;)
                    PARSEDOPTS=&quot;$(parse_mount_opts commit &quot;$OPTS&quot;)&quot;
                    mount $DEV -t $FST $MP -o remount,$PARSEDOPTS,commit=$MAX_AGE$NOATIME_OPT
                    ;;
                &quot;xfs&quot;)
                    mount $DEV -t $FST $MP -o remount,$OPTS$NOATIME_OPT
                    ;;
            esac
            if [ -b $DEV ] ; then
                blockdev --setra $(($READAHEAD * 2)) $DEV
            fi
        done
    fi
    if [ $DO_HD -eq 1 ] ; then
        for THISHD in $HD ; do
            /sbin/hdparm -S $BATT_HD $THISHD &gt; /dev/null 2&gt;&amp;1
            /sbin/hdparm -B 1 $THISHD &gt; /dev/null 2&gt;&amp;1
        done
    fi
    if [ $DO_CPU -eq 1 -a -e /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_min_freq ]; then
        if [ $CPU_MAXFREQ = &#39;slowest&#39; ]; then
            CPU_MAXFREQ=`cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_min_freq`
        fi
        echo $CPU_MAXFREQ &gt; /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
    fi
    echo &quot;.&quot;
    ;;
stop)
    U_AGE=$((100*$DEF_UPDATE))
    B_AGE=$((100*$DEF_AGE))
    echo -n &quot;Stopping laptop_mode&quot;
    echo 0 &gt; /proc/sys/vm/laptop_mode
    if [ -f /proc/sys/fs/xfs/age_buffer -a ! -f /proc/sys/fs/xfs/lm_age_buffer ] ; then
        # These need to be restored, if there are no lm_*.
        echo $(($XFS_HZ*$DEF_XFS_AGE_BUFFER))         &gt; /proc/sys/fs/xfs/age_buffer
        echo $(($XFS_HZ*$DEF_XFS_SYNC_INTERVAL))     &gt; /proc/sys/fs/xfs/sync_interval
    elif [ -f /proc/sys/fs/xfs/age_buffer_centisecs ] ; then
        # These need to be restored as well.
        echo $((100*$DEF_XFS_AGE_BUFFER))    &gt; /proc/sys/fs/xfs/age_buffer_centisecs
        echo $((100*$DEF_XFS_SYNC_INTERVAL))    &gt; /proc/sys/fs/xfs/xfssyncd_centisecs
        echo $((100*$DEF_XFS_BUFD_INTERVAL))    &gt; /proc/sys/fs/xfs/xfsbufd_centisecs
    fi
    case &quot;$KLEVEL&quot; in
        &quot;2.4&quot;)
            echo &quot;30 500 0 0 $U_AGE $B_AGE 60 20 0&quot;    &gt; /proc/sys/vm/bdflush
            ;;
        &quot;2.6&quot;)
            echo &quot;$U_AGE&quot;                &gt; /proc/sys/vm/dirty_writeback_centisecs
            echo &quot;$B_AGE&quot;                &gt; /proc/sys/vm/dirty_expire_centisecs
            echo &quot;$DEF_DIRTY_RATIO&quot;            &gt; /proc/sys/vm/dirty_ratio
            echo &quot;$DEF_DIRTY_BACKGROUND_RATIO&quot;    &gt; /proc/sys/vm/dirty_background_ratio
            ;;
    esac
    if [ $DO_REMOUNTS -eq 1 ] ; then
        cat /etc/mtab | while read DEV MP FST OPTS DUMP PASS ; do
            # Reset commit and atime options to defaults.
            if [ &quot;$FST&quot; = &#39;unknown&#39; ]; then
                FST=$(deduce_fstype $MP)
            fi
            case &quot;$FST&quot; in
                &quot;ext3&quot;|&quot;reiserfs&quot;)
                    PARSEDOPTS=&quot;$(parse_mount_opts_wfstab $DEV commit $OPTS)&quot;
                    PARSEDOPTS=&quot;$(parse_yesno_opts_wfstab $DEV atime atime $PARSEDOPTS)&quot;
                    mount $DEV -t $FST $MP -o remount,$PARSEDOPTS
                    ;;
                &quot;xfs&quot;)
                    PARSEDOPTS=&quot;$(parse_yesno_opts_wfstab $DEV atime atime $OPTS)&quot;
                    mount $DEV -t $FST $MP -o remount,$PARSEDOPTS
                    ;;
            esac
            if [ -b $DEV ] ; then
                blockdev --setra 256 $DEV
            fi
        done
    fi
    if [ $DO_HD -eq 1 ] ; then
        for THISHD in $HD ; do
            /sbin/hdparm -S $AC_HD $THISHD &gt; /dev/null 2&gt;&amp;1
            /sbin/hdparm -B 255 $THISHD &gt; /dev/null 2&gt;&amp;1
        done
    fi
    if [ $DO_CPU -eq 1 -a -e /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_min_freq ]; then
        echo `cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq` &gt; /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
    fi
    echo &quot;.&quot;
    ;;
*)
    echo &quot;Usage: $0 &#123;start|stop&#125;&quot; 2&gt;&amp;1
    exit 1
    ;;
</code></pre>
<p>esac</p>
<p>exit 0<br>——————–CONTROL SCRIPT END——————————————</p>
<h2 id="ACPI-integration"><a href="#ACPI-integration" class="headerlink" title="ACPI integration"></a>ACPI integration</h2><p>Dax Kelson submitted this so that the ACPI acpid daemon will<br>kick off the laptop_mode script and run hdparm. The part that<br>automatically disables laptop mode when the battery is low was<br>written by Jan Topinski.</p>
<p>—————–/etc/acpi/events/ac_adapter BEGIN——————————<br>event=ac_adapter<br>action=/etc/acpi/actions/ac.sh %e<br>—————-/etc/acpi/events/ac_adapter END———————————</p>
<p>—————–/etc/acpi/events/battery BEGIN———————————<br>event=battery.*<br>action=/etc/acpi/actions/battery.sh %e<br>—————-/etc/acpi/events/battery END————————————</p>
<p>—————-/etc/acpi/actions/ac.sh BEGIN———————————–<br>#!/bin/bash</p>
<h1 id="ac-on-offline-event-handler"><a href="#ac-on-offline-event-handler" class="headerlink" title="ac on/offline event handler"></a>ac on/offline event handler</h1><p>status=<code>awk &#39;/^state: / &#123; print $2 &#125;&#39; /proc/acpi/ac_adapter/$2/state</code></p>
<p>case $status in<br>        “on-line”)<br>                /sbin/laptop_mode stop<br>                exit 0<br>        ;;<br>        “off-line”)<br>                /sbin/laptop_mode start<br>                exit 0<br>        ;;<br>esac<br>—————————/etc/acpi/actions/ac.sh END————————–</p>
<p>—————————/etc/acpi/actions/battery.sh BEGIN——————-<br>#! /bin/bash</p>
<h1 id="Automatically-disable-laptop-mode-when-the-battery-almost-runs-out"><a href="#Automatically-disable-laptop-mode-when-the-battery-almost-runs-out" class="headerlink" title="Automatically disable laptop mode when the battery almost runs out."></a>Automatically disable laptop mode when the battery almost runs out.</h1><p>BATT_INFO=/proc/acpi/battery/$2/state</p>
<p>if [[ -f /proc/sys/vm/laptop_mode ]]<br>then<br>   LM=<code>cat /proc/sys/vm/laptop_mode</code><br>   if [[ $LM -gt 0 ]]<br>   then<br>     if [[ -f $BATT_INFO ]]<br>     then<br>        # Source the config file only now that we know we need<br>        if [ -f /etc/default/laptop-mode ] ; then<br>                # Debian<br>                . /etc/default/laptop-mode<br>        elif [ -f /etc/sysconfig/laptop-mode ] ; then<br>                # Others<br>                . /etc/sysconfig/laptop-mode<br>        fi<br>        MINIMUM_BATTERY_MINUTES=${MINIMUM_BATTERY_MINUTES:-‘10’}</p>
<pre><code>    ACTION=&quot;`cat $BATT_INFO | grep charging | cut -c 26-`&quot;
    if [[ ACTION -eq &quot;discharging&quot; ]]
    then
       PRESENT_RATE=`cat $BATT_INFO | grep &quot;present rate:&quot; | sed  &quot;s/.* \([0-9][0-9]* \).*/\1/&quot; `
       REMAINING=`cat $BATT_INFO | grep &quot;remaining capacity:&quot; | sed  &quot;s/.* \([0-9][0-9]* \).*/\1/&quot; `
    fi
    if (($REMAINING * 60 / $PRESENT_RATE &lt; $MINIMUM_BATTERY_MINUTES))
    then
       /sbin/laptop_mode stop
    fi
 else
   logger -p daemon.warning &quot;You are using laptop mode and your battery interface $BATT_INFO is missing. This may lead to loss of data when the battery runs out. Check kernel ACPI support and /proc/acpi/battery folder, and edit /etc/acpi/battery.sh to set BATT_INFO to the correct path.&quot;
 fi
</code></pre>
<p>   fi<br>fi<br>—————————/etc/acpi/actions/battery.sh END——————–</p>
<h2 id="Monitoring-tool"><a href="#Monitoring-tool" class="headerlink" title="Monitoring tool"></a>Monitoring tool</h2><p>Bartek Kania submitted this, it can be used to measure how much time your disk<br>spends spun up/down.</p>
<p>—————————dslm.c BEGIN—————————————–<br>/*</p>
<ul>
<li>Simple Disk Sleep Monitor</li>
<li> by Bartek Kania</li>
<li>Licenced under the GPL</li>
<li>/<br>#include &lt;unistd.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;stdio.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;errno.h&gt;<br>#include &lt;time.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;signal.h&gt;<br>#include &lt;sys/ioctl.h&gt;<br>#include &lt;linux/hdreg.h&gt;</li>
</ul>
<p>#ifdef DEBUG<br>#define D(x) x<br>#else<br>#define D(x)<br>#endif</p>
<p>int endit = 0;</p>
<p>/* Check if the disk is in powersave-mode</p>
<ul>
<li><p>Most of the code is stolen from hdparm.</p>
</li>
<li><p>1 = active, 0 = standby/sleep, -1 = unknown */<br>int check_powermode(int fd)<br>{<br> unsigned char args[4] = {WIN_CHECKPOWERMODE1,0,0,0};<br> int state;</p>
<p> if (ioctl(fd, HDIO_DRIVE_CMD, &amp;args)<br> &amp;&amp; (args[0] = WIN_CHECKPOWERMODE2) /* try again with 0x98 */<br> &amp;&amp; ioctl(fd, HDIO_DRIVE_CMD, &amp;args)) {<br> if (errno != EIO || args[0] != 0 || args[1] != 0) {</p>
<pre><code> state = -1; /* &quot;unknown&quot;; */
</code></pre>
<p> } else</p>
<pre><code> state = 0; /* &quot;sleeping&quot;; */
</code></pre>
<p> } else {<br> state = (args[2] == 255) ? 1 : 0;<br> }<br> D(printf(“ drive state is:  %d\n”, state));</p>
<p> return state;<br>}</p>
</li>
</ul>
<p>char *state_name(int i)<br>{<br>    if (i == -1) return “unknown”;<br>    if (i == 0) return “sleeping”;<br>    if (i == 1) return “active”;</p>
<pre><code>return &quot;internal error&quot;;
</code></pre>
<p>}</p>
<p>char *myctime(time_t time)<br>{<br>    char *ts = ctime(&amp;time);<br>    ts[strlen(ts) - 1] = 0;</p>
<pre><code>return ts;
</code></pre>
<p>}</p>
<p>void measure(int fd)<br>{<br>    time_t start_time;<br>    int last_state;<br>    time_t last_time;<br>    int curr_state;<br>    time_t curr_time = 0;<br>    time_t time_diff;<br>    time_t active_time = 0;<br>    time_t sleep_time = 0;<br>    time_t unknown_time = 0;<br>    time_t total_time = 0;<br>    int changes = 0;<br>    float tmp;</p>
<pre><code>printf(&quot;Starting measurements\n&quot;);

last_state = check_powermode(fd);
start_time = last_time = time(0);
printf(&quot;  System is in state %s\n\n&quot;, state_name(last_state));

while(!endit) &#123;
sleep(1);
curr_state = check_powermode(fd);

if (curr_state != last_state || endit) &#123;
    changes++;
    curr_time = time(0);
    time_diff = curr_time - last_time;

    if (last_state == 1) active_time += time_diff;
    else if (last_state == 0) sleep_time += time_diff;
    else unknown_time += time_diff;

    last_state = curr_state;
    last_time = curr_time;

    printf(&quot;%s: State-change to %s\n&quot;, myctime(curr_time),
       state_name(curr_state));
&#125;
&#125;
changes--; /* Compensate for SIGINT */

total_time = time(0) - start_time;
printf(&quot;\nTotal running time:  %lus\n&quot;, curr_time - start_time);
printf(&quot; State changed %d times\n&quot;, changes);

tmp = (float)sleep_time / (float)total_time * 100;
printf(&quot; Time in sleep state:   %lus (%.2f%%)\n&quot;, sleep_time, tmp);
tmp = (float)active_time / (float)total_time * 100;
printf(&quot; Time in active state:  %lus (%.2f%%)\n&quot;, active_time, tmp);
tmp = (float)unknown_time / (float)total_time * 100;
printf(&quot; Time in unknown state: %lus (%.2f%%)\n&quot;, unknown_time, tmp);
</code></pre>
<p>}</p>
<p>void ender(int s)<br>{<br>    endit = 1;<br>}</p>
<p>void usage()<br>{<br>    puts(“usage: dslm [-w <time>] <disk>“);<br>    exit(0);<br>}</p>
<p>int main(int argc, char **argv)<br>{<br>    int fd;<br>    char *disk = 0;<br>    int settle_time = 60;</p>
<pre><code>/* Parse the simple command-line */
if (argc == 2)
disk = argv[1];
else if (argc == 4) &#123;
settle_time = atoi(argv[2]);
disk = argv[3];
&#125; else
usage();

if (!(fd = open(disk, O_RDONLY|O_NONBLOCK))) &#123;
printf(&quot;Can&#39;t open %s, because: %s\n&quot;, disk, strerror(errno));
exit(-1);
&#125;

if (settle_time) &#123;
printf(&quot;Waiting %d seconds for the system to settle down to &quot;
       &quot;&#39;normal&#39;\n&quot;, settle_time);
sleep(settle_time);
&#125; else
puts(&quot;Not waiting for system to settle down&quot;);

signal(SIGINT, ender);

measure(fd);

close(fd);

return 0;
</code></pre>
<p>}<br>—————————dslm.c END——————————————-</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_laptop-mode/" title="Kernel-2.6.32-573.12.1.el6_laptop-mode" target="_blank" rel="external">http://www.oostech.com/2021/03/13/Kernel-2.6.32-573.12.1.el6_laptop-mode/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">oosTech by Sam Lee</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_libsas/" title="Kernel-2.6.32-573.12.1.el6_libsas"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/13/Kernel-2.6.32-573.12.1.el6_kprobes/" title="Kernel-2.6.32-573.12.1.el6_kprobes"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,wechat"></div>
    
  </div>
  </div>
    <div class="container" align="left">
    <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <img src="/images/wechatp.png" itemprop="contentUrl">
      <span>欢迎关注公众号</span>
    </div>
    </div>
</nav>

  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>您能有收获就是我们最大的动力</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码捐赠</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">不管多少都是对分享的肯定</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码捐赠</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://google.com/" target="_blank" title="Google" data-toggle=tooltip data-placement=top><i class="icon icon-google"></i></a></li>
        
        <li><a href="https://twitter.com/" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
	<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn" text-align: center >粤ICP备2021024811号</a>
        </div>
<!--    
    <div>
     <img src="/images/logo.png" width="140" height="140">
    </div>
-->
    </div>


        <!-- 不蒜子统计    //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <!--<span id="busuanzi_container_site_pv" style="display:inline;">-->本站总访问量<span id="busuanzi_value_site_pv" style="display:inline;></span>次</span>
        <span class="post-meta-divider">|</span>
  
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>







   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>











</body>
</html>